<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Logic for Systems: Lightweight Formal Methods for Everybody</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="././mdbook-admonish.css">
        <link rel="stylesheet" href="./mdbook-admonish.css">
        <link rel="stylesheet" href="./custom.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="welcome.html">How to Read this book</a></li><li class="chapter-item affix "><li class="part-title">Preamble: Beyond Testing</li><li class="chapter-item "><a href="chapters/manifesto/job.html">What good is this book?</a></li><li class="chapter-item "><a href="chapters/manifesto/manifesto.html">Logic for Systems</a></li><li class="chapter-item "><a href="chapters/properties/pbt.html">From Tests to Properties</a></li><li class="chapter-item affix "><li class="part-title">Modeling Static Scenarios</li><li class="chapter-item "><a href="chapters/ttt/ttt.html">Tic-Tac-Toe</a></li><li class="chapter-item "><a href="chapters/bst/bst.html">Binary Search Trees</a></li><li class="chapter-item "><a href="chapters/adder/rca.html">Ripple-Carry Adder</a></li><li class="chapter-item "><a href="chapters/qna/static.html">Q&A: Static Modeling</a></li><li class="chapter-item affix "><li class="part-title">Discrete Event Systems</li><li class="chapter-item "><a href="chapters/ttt/ttt_games.html">Transitions, Traces, and Verification</a></li><li class="chapter-item "><a href="chapters/inductive/bsearch.html">Counterexamples to Induction</a></li><li class="chapter-item "><a href="chapters/bst/descent.html">BSTs: Recursive Descent</a></li><li class="chapter-item "><a href="chapters/validation/validating_events.html">Validating Models (in progress)</a></li><li class="chapter-item "><a href="chapters/qna/events.html">Q&A: Event Systems (in progress)</a></li><li class="chapter-item affix "><li class="part-title">Modeling Relationships</li><li class="chapter-item "><a href="chapters/relations/modeling-booleans-1.html">Relational Forge, Modeling Logic</a></li><li class="chapter-item "><a href="chapters/relations/reachability.html">Transitive Closure</a></li><li class="chapter-item "><a href="chapters/relations/sets-induction-mutex.html">Modeling Mutual Exclusion</a></li><li class="chapter-item "><a href="chapters/relations/sets-beyond-assertions.html">Going Beyond Assertions</a></li><li class="chapter-item "><a href="chapters/solvers/bounds_booleans_how_forge_works.html">How does Forge Work?</a></li><li class="chapter-item "><a href="chapters/qna/relations.html">Q&A: Relations</a></li><li class="chapter-item affix "><li class="part-title">Temporal Specification</li><li class="chapter-item "><a href="chapters/temporal/liveness_and_lassos.html">Liveness and Lassos</a></li><li class="chapter-item "><a href="chapters/temporal/temporal_operators.html">Temporal Forge</a></li><li class="chapter-item "><a href="chapters/temporal/temporal_operators_2.html">Linear Temporal Logic</a></li><li class="chapter-item "><a href="chapters/temporal/obligations_past.html">Obligations and the Past</a></li><li class="chapter-item "><a href="chapters/temporal/fixing_lock_temporal.html">Mutual Exclusion, Revisited</a></li><li class="chapter-item affix "><li class="part-title">Additional Examples, Case Studies, and Further Reading</li><li class="chapter-item "><a href="chapters/raft/raft.html">Modeling Raft in Anger (in progress)</a></li><li class="chapter-item "><div>Forge: Comparing Prim's and Dijkstra's Algorithms (in progress)</div></li><li class="chapter-item "><div>Forge+Industry: Policy and Network Analysis (in progress; DEMO: ABAC, Margrave, Zelkova)</div></li><li class="chapter-item "><div>Forge+Industry: Crypto Protocol Analysis (in progress; DEMO: crypto lang, CPSA or other)</div></li><li class="chapter-item "><div>Program Synthesis (in progress; DEMO: SSA synth, Sygus)</div></li><li class="chapter-item "><a href="further_reading.html">Further Reading (in progress)</a></li><li class="chapter-item affix "><li class="part-title">Construction Storage</li><li class="chapter-item "><a href="chapters/solvers/dpll.html">DPLL (to edit)</a></li><li class="chapter-item "><a href="chapters/solvers/resolution.html">Propositional resolution (to edit)</a></li><li class="chapter-item affix "><li class="part-title">Forge Documentation</li><li class="chapter-item "><a href="chapters/docs/test.html">Forge Version</a></li><li class="chapter-item "><a href="docs/getting-started/installation.html">Installation</a></li><li class="chapter-item "><a href="docs/building-models/overview.html">Overview</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="docs/building-models/alloy-user-overview.html">Addendum for Alloy Users</a></li></ol></li><li class="chapter-item "><a href="docs/building-models/sigs/sigs.html">Sigs</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="docs/building-models/sigs/inheritance.html">Inheritance</a></li><li class="chapter-item "><a href="docs/building-models/sigs/singleton-maybe-sigs.html">Singleton, Maybe, and Abstract Sigs</a></li><li class="chapter-item "><a href="docs/building-models/sigs/multiplicity.html">Field Multiplicity</a></li><li class="chapter-item "><a href="docs/building-models/sigs/advanced.html">Advanced: Sigs and fields, under-the-hood</a></li></ol></li><li class="chapter-item "><a href="docs/building-models/constraints/constraints.html">Constraints</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="docs/building-models/constraints/instances.html">Instances</a></li><li class="chapter-item "><a href="docs/building-models/constraints/formulas/formulas.html">Formulas</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="docs/building-models/constraints/formulas/operators.html">Operators</a></li><li class="chapter-item "><a href="docs/building-models/constraints/formulas/cardinality-membership.html">Cardinality and Membership</a></li><li class="chapter-item "><a href="docs/building-models/constraints/formulas/quantifiers.html">Quantifiers</a></li><li class="chapter-item "><a href="docs/building-models/constraints/formulas/predicates.html">Predicates</a></li></ol></li><li class="chapter-item "><a href="docs/building-models/constraints/expressions/expressions.html">Expressions</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="docs/building-models/constraints/expressions/relational-expressions/relational-expressions.html">Relational Operators</a></li><li class="chapter-item "><a href="docs/building-models/constraints/expressions/functions.html">Functions</a></li><li class="chapter-item "><a href="docs/building-models/constraints/expressions/let-expressions.html">Let-Expressions</a></li></ol></li></ol></li><li class="chapter-item "><a href="docs/building-models/comments.html">Comments</a></li><li class="chapter-item "><a href="docs/running-models/running.html">Running</a></li><li class="chapter-item "><a href="docs/running-models/sterling-visualizer.html">Sterling Visualizer</a></li><li class="chapter-item "><a href="docs/running-models/bounds.html">Bounds</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="docs/running-models/concrete-instance-bounds.html">Concrete Instance Bounds</a></li></ol></li><li class="chapter-item "><a href="docs/running-models/options.html">Options</a></li><li class="chapter-item "><a href="docs/testing-chapter/testing.html">Testing</a></li><li class="chapter-item "><a href="docs/forge-standard-library/integers.html">Integers</a></li><li class="chapter-item "><a href="docs/forge-standard-library/constants-and-keywords.html">Constants and Keywords</a></li><li class="chapter-item "><a href="docs/forge-standard-library/helpers.html">Helpers: Sequences and Reachability</a></li><li class="chapter-item "><a href="docs/electrum/electrum-overview.html">Temporal Forge Overview and Operators</a></li><li class="chapter-item "><a href="docs/sterling/custom-basics.html">Custom Visualization Basics</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="docs/sterling/d3fx_apr23.html">D3FX Helpers (April 2023)</a></li><li class="chapter-item "><a href="docs/sterling/svg-tips.html">Working with SVG and Imports</a></li></ol></li><li class="chapter-item "><a href="docs/dsl/abac.html">Attribute-Based Access Control</a></li><li class="chapter-item "><a href="docs/glossary.html">What should I do if...</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Logic for Systems: Lightweight Formal Methods for Everybody</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h2 id="how-to-read-this-book"><a class="header" href="#how-to-read-this-book">How To Read This Book</a></h2>
<p>Welcome to Logic for Systems! Here are some quick hints that will help you use this book effectively.</p>
<div id="admonition-this-book-is-a-draft" class="admonition admonish-note">
<div class="admonition-title">
<p>This book is a draft!</p>
<p><a class="admonition-anchor-link" href="welcome.html#admonition-this-book-is-a-draft"></a></p>
</div>
<div>
<p>This book is a draft, and there are some sections that are currently being filled in. If you want to use these materials and need support (e.g., you want to use the Forge homeworks that go with it, or a specific section you need is incomplete), please contact <code>Tim_Nelson@brown.edu</code>.</p>
</div>
</div>
<hr />
<h3 id="organization"><a class="header" href="#organization">Organization</a></h3>
<p>The book is organized into a series of short sections, each of which are grouped into chapters: </p>
<ul>
<li><strong>Chapter 1 (Beyond Testing)</strong> briefly motivates the content in this book and sets the stage with a new technique for testing your software. </li>
<li><strong>Chapter 2 (Modeling Static Scenarios)</strong> provides an introduction to modeling systems in Forge by focusing on systems that don't change over time. </li>
<li><strong>Chapter 3 (Discrete Event Systems)</strong> shows a common way to model the state of a system changing over time. </li>
<li><strong>Chapter 4 (Modeling Relationships)</strong> enriches the modeling language to support arbitrary relations between objects in the world.</li>
<li><strong>Chapter 5 (Temporal Specification)</strong> covers temporal operators, which are commonly used in industrial modeling and specification, and how to use them. </li>
<li><strong>Chapter 6 (Case Studies)</strong> touches on some larger applications of lightweight formal methods. Some of these will involve large models written in Forge, and others will lean more heavily on industrial systems.</li>
<li>The <strong>Forge Documentation</strong>, which covers the syntax of the language more concisely and isn't focused on teaching.</li>
</ul>
<p>Each chapter contains a variety of examples: data structures, puzzles, algorithms, hardware concepts, etc. We hope that the diversity of domains covered means that everyone will see an example that resonates with them. Full language and tool documentation come <em>after</em> the main body of the book. </p>
<h4 id="what-does-this-book-assume-what-is-its-goal"><a class="header" href="#what-does-this-book-assume-what-is-its-goal">What does this book assume? What is its goal?</a></h4>
<p>This book does not assume <em>any</em> prior background with formal methods or even discrete math. It does assume the reader has written programs before at the level of an introductory college course. </p>
<p>The goal of this chapter progression is to prepare the reader to formally model and reason about a domain <em>of their own choosing</em> in Forge (or perhaps in a related tool, such as an SMT solver). </p>
<p>With that in mind...</p>
<h4 id="do-more-than-read"><a class="header" href="#do-more-than-read">Do More Than Read</a></h4>
<p>This book is example driven, and the examples are almost always built up from the beginning. The flow of the examples is deliberate, and might even take a &quot;wrong turn&quot; that is meant to teach a specific lesson before changing direction. If you try to read the book passively, you're likely to be very disappointed. Worse, you may not actually be able to <em>do</em> much with the material after reading.</p>
<p>Instead, <strong>follow along</strong>, pasting each snippet of code or Forge model into the appropriate tool, and try it! Better yet, try modifying it and see what happens. You'll get much more out of each section as a result. Forge especially is designed to aid experimentation. Let your motto be:</p>
<center><strong>Let's find out!</strong></center>
<br/>
<hr />
<h3 id="navigating-the-book-site"><a class="header" href="#navigating-the-book-site">Navigating the Book Site</a></h3>
<p>With JavaScript enabled, the table of contents (to the left, by default) will allow you to select a specific section of this book. Likewise, the search bar (enabled via the &quot;Toggle Searchbar&quot; icon) should allow you to search for arbitrary alphanumeric phrases in the full text; unfortunately, non alphanumeric operators are not supported by search at present.</p>
<div id="admonition-table-of-contents-theme-and-search" class="admonition admonish-tip">
<div class="admonition-title">
<p>Table of Contents, Theme, and Search</p>
<p><a class="admonition-anchor-link" href="welcome.html#admonition-table-of-contents-theme-and-search"></a></p>
</div>
<div>
<p>The three buttons for popping out the table of contents, changing the color theme, and searching are in the upper-left corner of this page, by default. If you do not see them, please ensure that JavaScript is enabled.</p>
<center>
If the table of contents isn't open, click this button:
<label id="sidebar-toggle-alternate" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents (Alternate Button)" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
<p>The table of contents for the Forge documentation is expandable. Once it is open, click the ❱ icons to expand individual sections and subsections to browse more easily! </p>
<p>To change the color theme of the page, click this button:
<button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme (Alternate Button)" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
<i class="fa fa-paint-brush"></i>
</button></p>
<p>To search, click this button:
<button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar (Alternate Button)" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
<i class="fa fa-search"></i>
</button></p>
</center>
</div>
</div>
<hr />
<h3 id="callout-boxes"><a class="header" href="#callout-boxes">Callout Boxes</a></h3>
<p>Callout boxes can give valuable warnings, helpful hints, and other supplemental information. They are color- and symbol-coded depending on the type of information. For example:</p>
<div id="admonition-this-is-a-helpful-tip" class="admonition admonish-tip">
<div class="admonition-title">
<p>This is a helpful tip.</p>
<p><a class="admonition-anchor-link" href="welcome.html#admonition-this-is-a-helpful-tip"></a></p>
</div>
<div>
<p>Make sure to stay hydrated; it will help you learn.</p>
</div>
</div>
<div id="admonition-this-is-a-warning" class="admonition admonish-warning">
<div class="admonition-title">
<p>This is a warning!</p>
<p><a class="admonition-anchor-link" href="welcome.html#admonition-this-is-a-warning"></a></p>
</div>
<div>
<p>Look both ways before you cross the street!</p>
</div>
</div>
<div id="admonition-this-is-a-side-note" class="admonition admonish-note">
<div class="admonition-title">
<p>This is a side note.</p>
<p><a class="admonition-anchor-link" href="welcome.html#admonition-this-is-a-side-note"></a></p>
</div>
<div>
<p>This book is written using the <code>mdbook</code> package.</p>
</div>
</div>
<p>If you see a callout labeled &quot;CSCI 1710&quot;, it means that it's specifically for students in Brown University's CSCI 1710 course, Logic for Systems.</p>
<hr />
<h3 id="exercises"><a class="header" href="#exercises">Exercises</a></h3>
<p>Every now and then, you'll find question prompts, followed by a clickable header that looks like this: </p>
<details>
<summary>Think, then click!</summary>
<p><strong>SPOILER TEXT</strong></p>
</details> 
<p>If you click the arrow, it will expand to show hidden text, often revealing an answer or some other piece of information that is meant to be read <em>after</em> you've thought about the question. When you see these exercises, <strong>don't skip past them</strong>, and <strong>don't just read the hidden text</strong>. </p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h2 id="our-value-proposition"><a class="header" href="#our-value-proposition">Our Value Proposition</a></h2>
<p>Everybody has endless demands on their time. If you're a student, you might be deciding which classes to take. There's never enough time to take them all, so you need to prioritize based on expected value. If you're a professional, you're deciding how to best use your limited &quot;free&quot; time to learn new skills and stay current. Either way, you're probably wondering: <strong>What good is this book?</strong> (And if you aren't asking that, you ought to be.)</p>
<p>You need many different skills for a successful career. This book won't teach you how to work with other people, or manage your tasks, or give and receive feedback. It won't teach you to program either; there are plenty of other books for that. Instead, this book will teach you:</p>
<ul>
<li>how to think more richly about what matters about a system; </li>
<li>how to better express what you want from it;</li>
<li>how to more thoroughly evaluate what a system actually does give you; and</li>
<li>how to use constraints and constraint solvers in your work (because we'll use them as tools to help us out).
It will also give you a set of baseline skills that will aid you in using any further formal-methods techniques you might encounter in your work, such as <a href="https://rust-book.cs.brown.edu">advanced type systems</a>, <a href="https://dafny.org">program verification</a>, <a href="https://lean-lang.org">theorem proving</a>, and more. </li>
</ul>
<h3 id="modeling-what-really-matters"><a class="header" href="#modeling-what-really-matters">Modeling: What really matters?</a></h3>
<p>There's a useful maxim by George Box: <strong>&quot;All models are wrong, but some are useful&quot;</strong>. The only completely accurate model of a system is that system itself, including all of its real external context. This is impractical; instead, a modeler needs to make choices about what really matters to them: what do you keep, and what do you disregard? Done well, a model gets at the essence of a system. Done poorly, a model yields nothing useful or, worse, gives a false sense of security. </p>
<div id="admonition-george-box-1978" class="admonition admonish-note">
<div class="admonition-title">
<p>George Box (1978)</p>
<p><a class="admonition-anchor-link" href="chapters/manifesto/job.html#admonition-george-box-1978"></a></p>
</div>
<div>
<p>I suspect that people were saying &quot;All models are wrong&quot; long before Box did! But it's worth reading <a href="https://doi.org/10.1016%2FB978-0-12-438150-6.50018-2">this quote of his from 1978</a>, and thinking about the implications.</p>
<blockquote>
<p>Now it would be very remarkable if any system existing in the real world could be exactly represented by any simple model. However, cunningly chosen parsimonious models often do provide remarkably useful approximations. For example, the law <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.13889em;">RT</span></span></span></span> relating pressure <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>, volume <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> and temperature <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> of an &quot;ideal&quot; gas via a constant <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span> is not exactly true for any real gas, but it frequently provides a useful approximation and furthermore its structure is informative since it springs from a physical view of the behavior of gas molecules. For such a model there is no need to ask the question &quot;Is the model true?&quot;. If &quot;truth&quot; is to be the &quot;whole truth&quot; the answer must be &quot;No&quot;. <strong>The only question of interest is &quot;Is the model illuminating and useful?&quot;.</strong> </p>
</blockquote>
<p>(Bolding mine.) <strong>TODO: check quote text, Wiki link does not lead to a readable paper.</strong></p>
</div>
</div>
<p>If you want to do software (or hardware) engineering, some amount of modeling is unavoidable. Here are two basic examples of many.</p>
<h4 id="data-models-everywhere"><a class="header" href="#data-models-everywhere">Data Models Everywhere</a></h4>
<p>You might already have benefitted from a good model (or suffered from a poor one) in your programming work. Whenever you write data definitions or class declarations in a program, <a href="https://en.wikipedia.org/wiki/Data_model">you're modeling</a>. The ground truth of the data is rarely identical to its representation. You decide on a particular way that it should be stored, transformed, and accessed. You say how one piece of data relates to another. </p>
<p>Your data-modeling choices affect more than just execution speed: if a pizza order can't have a delivery address that is separate from the user's billing address, important user needs will be neglected. On the other hand, it is probably OK to leave the choice of cardboard box out of the user-facing order. An order has a delivery time, which probably comes with a time zone. You could model the time zone as an integer offset from UTC, but this is a <a href="https://en.wikipedia.org/wiki/Time_zone">very bad idea</a>. And, since there are 24 hours in a day, the real world imposes range limits: a timezone that's a million hours ahead of UTC is probably a buggy value, even though the value <code>1000000</code> is much smaller than even a signed 32-bit <code>int</code> can represent. </p>
<h4 id="data-vs-its-representation"><a class="header" href="#data-vs-its-representation">Data vs. Its Representation</a></h4>
<p>The <em>level</em> of abstraction matters, too. Suppose that your app scans handwritten orders. Then handwriting becomes pixels, which are converted into an instance of your data model, which is implemented as bytes, which are stored in hardware flip-flops and so on. You probably don't need, or want, to keep all those perspectives in mind simultaneously. Languages are valuable in part because of the abstractions they foster, even if those abstractions are incomplete—they can be usefully incomplete! What matters is whether the abstraction level suits your needs, and your users'.</p>
<div id="admonition-memory-management" class="admonition admonish-tip">
<div class="admonition-title">
<p>Memory Management</p>
<p><a class="admonition-anchor-link" href="chapters/manifesto/job.html#admonition-memory-management"></a></p>
</div>
<div>
<p>I learned to program in the 1990s, when practitioners were at odds over automated vs. manual memory management. It was often claimed that a programmer needed to <em>really understand</em> what was happening at the hardware level, and manually control memory allocation and deallocation for the sake of performance. Most of us don't think that anymore, <em>unless we need to</em>! Sometimes we do; often we don't. Focus your attention on what matters for the task at hand.</p>
</div>
</div>
<p>The examples don't stop: In security, a <em>threat model</em> says what powers an attacker has. In robotics and AI, reinforcement learning works over a probabilistic model of real space. And so on. The key is: <strong>what matters for your needs?</strong> Box had something to say about that, too:</p>
<blockquote>
<p>Since all models are wrong the scientist must be alert to what is importantly wrong. It is inappropriate to be concerned about safety from mice when there are tigers abroad.</p>
</blockquote>
<p><strong>TODO: add citation</strong></p>
<h3 id="specification-what-do-you-want"><a class="header" href="#specification-what-do-you-want">Specification: What do you want?</a></h3>
<p>Suppose that I want to store date-and-time values in a computer program. That's easy enough to say, right? But the devil is in the details: What is the layout of the data? Which fields will be stored, and which will be omitted? Which values are valid, and which are out of bounds? Is the format efficiently serializable? How far backward in time should the format extend, and <a href="https://en.wikipedia.org/wiki/Year_2000_problem">how far into the future should it reach</a>?</p>
<p>And which calendar are we using, anyway? </p>
<div id="admonition-yes-thats-a-real-question" class="admonition admonish-note">
<div class="admonition-title">
<p>Yes, that's a real question.</p>
<p><a class="admonition-anchor-link" href="chapters/manifesto/job.html#admonition-yes-thats-a-real-question"></a></p>
</div>
<div>
<p>If our programs are meant to work with dates prior to the 1600's, only their historical context can say whether they should be interpreted with the <a href="https://en.wikipedia.org/wiki/Gregorian_calendar">Gregorian calendar</a> or the <a href="https://en.wikipedia.org/wiki/Julian_calendar">Julian calendar</a>. And that's just two (Eurocentric) possibilities!</p>
</div>
</div>
<p>If you're just building a food delivery app, you probably only need to think about some of these aspects of dates and times. If you're defining <a href="https://en.wikipedia.org/wiki/ISO_8601">an international standard</a>, you need to think about them all.</p>
<p>Either way, being able to think carefully about your specification can separate quiet success from famous failure.</p>
<h3 id="validation-and-verification-did-you-get-what-you-wanted"><a class="header" href="#validation-and-verification-did-you-get-what-you-wanted">Validation and Verification: Did you get what you wanted?</a></h3>
<p>Whether you're working out an algorithm on paper or checking a finished implementation, you need some means of judging correctness. Here, too, precision (and a little bit of adversarial thinking) matters in industry:</p>
<ul>
<li>When ordinary testing isn't good enough, techniques like fuzzing, <a href="chapters/manifesto/../properties/pbt.html">property-based testing</a>, and others give you new evaluative power. </li>
<li>When you're updating, refactoring, or optimizing a system, a model of its ideal behavior can be leveraged for validation. <a href="https://news.ycombinator.com/item?id=34726919">Here's an example from 2014</a>—click through the header of the linked article to read the original blog post.)</li>
<li>A model of the system's behavior is also useful for test-case generation, and <a href="https://hypothesis.readthedocs.io/en/latest/stateful.html">enable tools to generate test suites</a> that have a higher coverage of the potential state space. </li>
</ul>
<p>And all that's even before we consider more heavyweight methods, like model checking and program verification.</p>
<h3 id="formalism-isnt-absolute"><a class="header" href="#formalism-isnt-absolute">Formalism Isn't Absolute</a></h3>
<p>The word &quot;formal&quot; has accumulated some unfortunate connotations: pedantry, stuffiness, ivory-tower snootiness, being an <a href="https://en.wikipedia.org/wiki/Architecture_astronaut">architecture astronaut</a>, etc. The truth is that formalism is a sliding scale. <em>We can take what we need and leave the rest.</em> What really matters is the ability to precisely express your goals, and the ability to take advantage of that precision. </p>
<p>In fact, formalism powers many <em>software tools</em> that help us to reason about the systems we create. In the next section, we'll start sketching what that means for us as engineers and humans.</p>
<!-- You might not be used to thinking of programming as a "formal" activity, but it is. A programming language is a formal artifact: it has a precise meaning, usually defined in a detailed specification that few people need to read fully. Some factors are often left unspecified, and thus "implementation dependent", which is one reason why the difference between specification and implementation is more fluid than you might think.  -->
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="logic-for-systems"><a class="header" href="#logic-for-systems">Logic for Systems</a></h1>
<h2 id="setting-the-stage"><a class="header" href="#setting-the-stage">Setting the Stage</a></h2>
<p>If you're reading this book, you've probably had to complete some programming assignments—or at least written some small program for a course or an online tutorial. Take a moment to list a handful of such assignments: what did you have to build? </p>
<p>Now ask yourself:</p>
<ul>
<li>How did you know what behavior to implement?</li>
<li>How did you know which data structures or algorithms were the right ones to use?</li>
<li>How did you know your program &quot;worked&quot;, in the end?</li>
</ul>
<p>In the context of assignments, there are expected answers to these questions. For instance, you might say you know your code worked because you tested it (<em>very</em> thoroughly, I'm sure)! But is that really the truth? In terms of consequences, the true bar for excellence in a programming class is the grade you got. That is:</p>
<ul>
<li>You knew what to do because <em>you were told what to do</em>.</li>
<li>You probably knew which algorithms to use because they'd <em>just been taught to you</em>.</li>
<li>You were confident that your programs worked because <em>you were told by an authority figure</em>.</li>
</ul>
<p>But outside that context, as (say) a professional engineer, you lose the safety net. You might be working on a program that controls the fate of billions of dollars, tempers geopolitical strife, or controls a patient's insulin pump. Even if you had a TA, would you trust them to tell you that those programs worked? Would you trust your boss to understand <em>exactly</em> what needed to happen, and tell you <em>exactly</em> how to do it? Probably not! Instead, you need to think carefully about what you want, how to build it, and how to evaluate what you and others have built. </p>
<div id="admonition-dont-let-the-perfect-be-the-enemy-of-the-good" class="admonition admonish-warning">
<div class="admonition-title">
<p>Don't let the perfect be the enemy of the good.</p>
<p><a class="admonition-anchor-link" href="chapters/manifesto/manifesto.html#admonition-dont-let-the-perfect-be-the-enemy-of-the-good"></a></p>
</div>
<div>
<p>As engineers, we strive for perfection. But perfection is an ideal; it's not obtainable. Why? First: we're human. Even if we could read our customers' minds, that's no guarantee that <em>they</em> know what they really need. And even if we can prove our code is correct, we might be checking for the wrong things. Second: our environment is hostile. Computers break. Patches to dependencies introduce errors. Cosmic radiation can flip bits in memory. 100% reliability is hopeless. Anyone who tells you differently is trying to sell you something. </p>
<p>But that doesn't mean we should give up. It just means that we should moderate our expectations. Instead of focusing on perfect correctness, instead try to <em>increase your confidence</em> in correctness.</p>
</div>
</div>
<h2 id="unit-testing"><a class="header" href="#unit-testing">Unit Testing</a></h2>
<p>Hopefully we all agree that unit testing with concrete input-output pairs has its virtues and that we should keep doing it. But let's investigate what it does and doesn't do well. </p>
<p><strong>Exercise:</strong> Make two lists: What does unit testing do well? What doesn't it do well? (Hint: Why do we test? What could go wrong, and how can the sort of testing you've done in other classes let us down?)</p>
<details>
<summary>Think, then click!</summary>
<p>You might have observed that (for most interesting programs, anyway) tests cannot be exhaustive because there are infinitely many possible inputs. And since we're forced to test non-exhaustively, we have to hope we pick good tests---tests that not only focus on our own implementation, but on others (like the implementation that replaces yours eventually) too.</p>
<p>Worse, we can't test the things we don't think of, or don't know about; we're vulnerable to our limited knowledge, the availability heuristic, confirmation bias, and so on. In fact, we humans are generally ill equipped for logical reasoning, even if trained. </p>
</details> 
<h2 id="humans-and-reasoning"><a class="header" href="#humans-and-reasoning">Humans and Reasoning</a></h2>
<h3 id="a-toy-example"><a class="header" href="#a-toy-example">A Toy Example</a></h3>
<p>Suppose we're thinking about the workings of a small company. We're given some facts about the company, and have to answer a question based on those facts. Here's an example. We know that:</p>
<ul>
<li>Alice directly supervises Bob.</li>
<li>Bob directly supervises Charlie.</li>
<li>Alice graduated Brown.</li>
<li>Charlie graduated Harvale.</li>
</ul>
<p>To keep things simple, we'll assume that all three people graduated some university.</p>
<p><strong>Exercise:</strong> Does someone who graduated from Brown directly supervise someone who graduated from another University?</p>
<details>
<summary>Think, then click.</summary>
<p>Yes! Regardless of whether Bob graduated from Brown, <em>some</em> Brown graduate supervises <em>some</em> non-Brown graduate. Reasoning by hypotheticals, there is one fact we don't know: where Bob graduated. In case he graduated Brown, he supervises Charlie, a non-Brown graduate. In case he graduated from another school, he's supervised by Alice, a Brown graduate.</p>
<p>Humans tend to be very bad at reasoning by hypotheticals. There's a temptation to think that this puzzle isn't solvable because we don't know where Bob graduated from. Even Tim thought this at first after seeing the puzzle—in grad school! For logic!</p>
</details>
<hr />
<p>Now imagine a puzzle with a thousand of these unknowns. A thousand boolean variables means <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1000</span></span></span></span></span></span></span></span></span></span></span></span> cases to reason through. Want to use a computer yet?</p>
<!-- ### Reasoning about knowledge

There is a prison in a magical world where an evil wizard holds a family of four gnomes. Every day, the wizard forces the gnomes to play a game for their freedom: he lines them up, single-file, in one or more rooms, facing the wall. The gnomes cannot move or communicate with each other; they can only look straight ahead. The wizard then pulls out four hats: two orange and two blue, and magics one onto each gnome's head.

The wizard then walks the line, asking each gnome: "What is your hat color?" They may try to answer, or remain silent for 10 seconds (and then the wizard moves on). If a gnome guesses correctly, they all immediately go free. But if one guesses incorrectly, they become the wizard's magical servants forever. So it's in their best interest to not answer unless they are absolutely convinced that they have guessed correctly.

Neither the wizard nor the gnomes can cheat. It's against magical law. The gnomes are, however, very intelligent. Smarter than the wizard for sure: they're perfect logical reasoners.

Here's an example configuration of the puzzle room:

| ![Picture of gnomes-puzzle setup](https://i.imgur.com/SFAoYZy.jpg) |
|:--:| 
|  *(Why are they smiling?)* |

**Exercise:** In this configuration, can the gnomes escape? If so, why?

<details>
    <summary>Think, then click.</summary>

Yes! The gnomes can escape, because they're able to use the knowledge of other gnomes _without explicit communication_. When the wizard asks Gnome #2 what color their hat is, Gnome #2 can conclude nothing, and is silent. Gnome #3 can then reason that his hat, and the hat of Gnome #4, must be different colors. Only two colors are possible. And so the wizard is thwarted.
</details>

To solve this puzzle, you need to reason about what the other agents know, and what we expect them to do with that knowledge. These sorts of epistemic statements can be useful in practice. -->
<p><strong>This isn't really about logic puzzles.</strong></p>
<h3 id="a-real-scenario"><a class="header" href="#a-real-scenario">A Real Scenario</a></h3>
<p>There's a real cryptographic protocol called the Needham-Schroeder public-key protocol. You can read about it <a href="https://en.wikipedia.org/wiki/Needham%E2%80%93Schroeder_protocol#The_public-key_protocol">here</a>. Unfortunately the protocol has a bug: it's vulnerable to attack if one of the principles can be fooled into starting an exchange with a badly-behaved or compromised agent. We won't go into specifics. Instead, let's focus on the fact that it's quite easy to get things like protocols wrong, and sometimes challenging for us humans to completely explore all possible behaviors -- especially since there might be behaviors we'd never even considered! It sure would be nice if we could get a computer to help out with that.</p>
<p>A pair of former 1710 students did an <a href="http://cs.brown.edu/~tbn/publications/ssdnk-fest21-forge.pdf">ISP on modeling crypto protocols</a>, using the tools you'll learn in class. Here's an example picture, generated by their model, of the flaw in the Needham-Schroeder protocol:</p>
<p><img src="chapters/manifesto/./ns-custom.png" alt="An execution of the Needham-Schroeder protocol." /></p>
<p>You don't need to understand the specifics of the visualization; the point is that someone who has studied crypto protocols <strong>would</strong>. And this really does show the classic attack on Needham-Schroeder. You may not be a crypto-protocol person, but you probably are an expert in something subtle that you'd like to model, reason about, and understand better. </p>
<div id="admonition-brown-csci-1710" class="admonition admonish-warning">
<div class="admonition-title">
<p>Brown CSCI 1710</p>
<p><a class="admonition-anchor-link" href="chapters/manifesto/manifesto.html#admonition-brown-csci-1710"></a></p>
</div>
<div>
<p>In fact, if you're reading this as part of your coursework for CSCI 1710, you will be <em>expected</em> to select, research, and model something yourself based on your interests. This is one of our main end-goals for the course.</p>
</div>
</div>
<h2 id="automated-reasoning-as-an-assistive-device"><a class="header" href="#automated-reasoning-as-an-assistive-device">Automated Reasoning as an Assistive Device</a></h2>
<p>The human species has been so successful, in part, because of our ability to use assistive devices—tools! Eyeglasses, bicycles, hammers, bridges: all devices that assist us in navigating the world in our fragile meat-bodies. One of our oldest inventions, writing, is an assistive device that increases our long-term memory space and makes that memory <em>persistent</em>. Computers are only one in a long line of such inventions.</p>
<p>So, naturally, we've found ways to:</p>
<ul>
<li>use computers to help us test our ideas;</li>
<li>use computers to exhaustively check program correctness;</li>
<li>use computers to help us find gaps in our intuition about a program;</li>
<li>use computers to help us explore the design space of a data structure, or algorithm, card game, or chemical reaction; </li>
<li>etc.</li>
</ul>
<p>There's a large body of work in Computer Science that uses logic to do all those things. We tend to call it <em>formal methods</em>, especially when the focus is on reasoning about systems. It touches on topics like system modeling, constraint solving, program analysis, design exploration, and more. That's what this book is about: the foundational knowledge to engage with many different applications of these ideas, even if you don't end up working with them directly every day. </p>
<p>More concretely, we'll focus on a class of techniques called <em>lightweight</em> formal methods, which are characterized by tradeoffs that favor ease of use over strong guarantees (although we'll sometimes achieve those as well).</p>
<div id="admonition-further-reading" class="admonition admonish-tip">
<div class="admonition-title">
<p>Further Reading</p>
<p><a class="admonition-anchor-link" href="chapters/manifesto/manifesto.html#admonition-further-reading"></a></p>
</div>
<div>
<p>Jeanette Wing and Daniel Jackson wrote a short article coining the term &quot;lightweight FM&quot; in the 90's, which you can find <a href="http://www.cs.cmu.edu/~wing/publications/JacksonWing96.pdf">online</a>.</p>
</div>
</div>
<div id="admonition-what-is-a-system" class="admonition admonish-warning">
<div class="admonition-title">
<p>What is a system?</p>
<p><a class="admonition-anchor-link" href="chapters/manifesto/manifesto.html#admonition-what-is-a-system"></a></p>
</div>
<div>
<p>When we say &quot;systems&quot; in this book we don't necessarily mean the kind of systems you see in a class on networks, hardware architecture, or operating systems. You can apply the techniques in this book to those subjects quite naturally, but you can also apply it to user interfaces, type systems in programming, hardware, version control systems like Git, web security, cryptographic protocols, robotics, puzzles, sports and games, and much more. So we construe the word &quot;system&quot; very broadly.</p>
<p>Here are some examples of &quot;systems&quot; that students have modeled in Forge: lifetimes in Rust, network reachability, and poker!</p>
<div class="showcase">
  <div class="example">
    <div class="vizimg"><img width="100%" src="chapters/manifesto/./borrow-newt-custom.png"/></div>
    <div class="viztext">
      <div class="vizlabel">Rust Lifetimes and Borrowing</div>
      <div class="vizauthor">Thomas Castleman and Ria Rajesh</div>
      <div class="vizpub">Course Project</div>
    </div>
  </div>
  <div class="example">
    <div class="vizimg"><img width="100%" src="chapters/manifesto/./netlab-custom-def1.png"/></div>
    <div class="viztext">
      <div class="vizlabel">Network Reachability</div>
      <div class="vizauthor">Tim Nelson and Pamela Zave</div>
      <div class="vizpub"><a href="https://fm.csl.sri.com/SSFT23/">(link to lab)</a></div>
    </div>
  </div>
  <div class="example">
    <div class="vizimg"><img width="100%" src="chapters/manifesto/./texas.png"/></div>
    <div class="viztext">
      <div class="vizlabel">Texas Hold 'Em</div>
      <div class="vizauthor">Matthew Boranian and Austin Lang</div>
      <div class="vizpub">Course Project</div>
    </div>
  </div>
</div>
</div>
</div>
<h2 id="the-future-of-computing"><a class="header" href="#the-future-of-computing">The Future of Computing</a></h2>
<p>For better or worse, The shape of engineering is changing. Lots of people are excited, scared, or both about large language models like ChatGPT. This book won't teach you how to use generative AI, so it's reasonable to wonder: <em>why learn from this book, instead of reading yet another book on another (deservedly) hot topic, like machine learning?</em></p>
<p>There are two questions that will never go out of style, and won't be answered by AI (at least, not in our lifetimes):</p>
<ul>
<li><strong>What do you want to build?</strong> What does your customer really need? Answering this requires talking to them and other stakeholders, watching their processes, seeking their feedback, and adjusting your design based on it. And no matter who (or what) is writing the actual code, you need to be able to express all this precisely enough that they (or it) can succeed at the implementation.</li>
<li><strong>How will you evaluate what you get?</strong> No matter who (or what) is building the system, verification is needed before the system can be trusted.</li>
</ul>
<p>Even setting aside the customer-facing aspects, we'll still need to think critically about what it is we want and how to evaluate whether we're getting it. The skills you learn here will remain useful (or become even more so) as engineering evolves. In the next chapter, we'll try to convince you that these skills will be useful for more than just code.</p>
<h2 id="formal-methods"><a class="header" href="#formal-methods">&quot;Formal Methods&quot;</a></h2>
<p><em>Formal methods</em> (FM) are ways to help you think carefully about a domain, process, or system. They use math-based techniques (which are usually implemented in tools) to help. They aren't an academic exercise; they are used widely in industry and have likely saved billions of dollars and thousands of lives.</p>
<p>Some industrial examples I'm fond of include:</p>
<ul>
<li><a href="https://aws.amazon.com/blogs/security/protect-sensitive-data-in-the-cloud-with-automated-reasoning-zelkova/">Amazon Web Services' Zelkova</a>, which helps administrators author better security policies for their services. This book will give you the tools to build a policy-analysis system like Zelkova yourself. </li>
<li><a href="https://www.microsoft.com/en-us/research/publication/thorough-static-analysis-of-device-drivers/">Microsoft's static driver verifier</a>, which helps increase the reliability of low-level device drivers in Windows. While this book doesn't cover the techniques they used, I love to showcase this work (which helped Microsoft ship more stable drivers and, at this point, is now decades old).</li>
<li><a href="https://github.com/visualzhou/mongo-repl-tla">MongoDB's work on modeling replication</a>, which found a real bug in their code. Quoting the linked page: &quot;We've never encountered this issue in testing or in the field and only found it by reasoning about the edge cases. This shows writing and model checking ... specs is an excellent alternative way to find and verify edge cases.&quot; (Ellipsis mine.) We won't use this exact <em>tool</em>, but we'll cover other model checkers in this book.</li>
</ul>
<p>We can find real applications for FM outside Computer Science too---even the law. <a href="https://roundtablelaw.medium.com/utterly-unpersuasive-formal-methods-and-law-bb8ecf048374">Here's an article</a> about the value of modeling <em>legal concepts</em> to find loopholes in the law. This is the sort of FM we'll be learning how to do in 1710.</p>
<p><a href="https://github.com/ligurio/practical-fm">This Github repository</a> keeps a (reasonably up to date, but not exhaustive!) list of other industrial applications of formal methods. Check it out! </p>
<h3 id="exercise"><a class="header" href="#exercise">Exercise</a></h3>
<p>Can you think of one or two domains, systems, or processes that especially interest you? Think about the kinds of &quot;system&quot; you interact with regularly or have learned about in your life. What would you like to understand better about those systems? </p>
<p>Remember that we construe the word <em>system</em> broadly. A cryptographic protocol is a system, but so is the game of baseball. A data structure is a system, but so are chemical reactions. </p>
<h2 id="looking-ahead-tools"><a class="header" href="#looking-ahead-tools">Looking Ahead: Tools</a></h2>
<p>The main tool we'll use in this book is <a href="http://forge-fm.org">Forge</a>, a tool for modeling systems. In the course of the book, we'll be progressing through three <em>language levels</em> in Forge:</p>
<ul>
<li><strong>Froglet</strong>, which restricts the set of operations so that we can jump right in more easily. If you have intuitions about object-oriented programming, those intuitions will be useful in Froglet, although there are a few important differences that we'll talk about.</li>
<li><strong>Relational Forge</strong>, which expands the set of operations available to include sets, relations, and relational operators. These are useful for reasoning about complex relationships between objects and for representing certain domains, like databases or graphs.</li>
<li><strong>Temporal Forge</strong>, which helps us cleanly model how a system's state evolves over time. Temporal Forge is based on the industry-standard specification language LTL—Linear Temporal Logic.</li>
</ul>
<p>We'll also use some other tools, like:</p>
<ul>
<li><a href="https://hypothesis.readthedocs.io/en/latest/">Hypothesis</a>, a testing library for Python; and</li>
<li><a href="https://github.com/Z3Prover/z3">Z3</a>, an SMT solver library. </li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h2 id="from-tests-to-properties"><a class="header" href="#from-tests-to-properties">From Tests to Properties</a></h2>
<!-- Other examples we could include

Implementation of a linked list. 
* What should `add` guarantee?

* change-making 
  * simple greedy algorithm (largest coins first)
  * apply PBT (correct total, in drawer)
  * let's try this on LLM-generated code

 -->
<p>We'll talk about more than just software soon. For now, let's go back to testing. Most of us have learned how to write test cases. Given an input, here's the output to expect. Tests are a kind of pointwise <em>specification</em>; a partial one, and not great for fully describing what you want, but a kind of specification nonetheless. They're cheap, non-trivially useful, and better than nothing.</p>
<p>But they also carry our biases, they can't cover an infinite input space, etc. Even more, they're not always adequate carriers of intent: if I am writing a program to compute the statistical median of a dataset, and write <code>assert median([1,2,3]) == 2</code>, what exactly is the behavior of the system I'm trying to confirm? Surely I'm not writing the test because I care specifically about <code>[1,2,3]</code> only, and not about <code>[3,4,5]</code> in the same way? Maybe there was some broader aspect, some <em>property</em> of median I cared about when I wrote that test. </p>
<p><strong>Exercise:</strong> What do you think it was? What makes an implementation of <code>median</code> correct?</p>
<details>
<summary>Think, then click!</summary>
<p>There might be many things! One particular idea is that, if the input list has odd length, the median needs to be an element of the list. Or that, once the set is sorted, the median should be the &quot;middle&quot; element.</p>
</details>
<hr />
<p>There isn't always an easy-to-extract property for every unit test. But this idea—encoding <em>goals</em> instead of specific behaviors—forces us to start thinking critically about <em>what exactly we want</em> from a system and helps us to express it in a way that others (including, perhaps, LLMs) can better use. It's only a short hop from there to some of the real applications we talked about last time, like verifying firewalls or modeling the Java type system.</p>
<div id="admonition-sometimes-you-can-test-exhaustively" class="admonition admonish-note">
<div class="admonition-title">
<p>Sometimes, you can test exhaustively!</p>
<p><a class="admonition-anchor-link" href="chapters/properties/pbt.html#admonition-sometimes-you-can-test-exhaustively"></a></p>
</div>
<div>
<p>Sometimes the input space is small enough that exhaustive testing works well. This blog post, entitled <a href="https://news.ycombinator.com/item?id=34726919">&quot;There are only four billion floats&quot;</a> is an example.</p>
<p>Depending on your experience, this may also be a different kind from testing from what you're used to. Building a repertoire of different tools is essential for any engineer!</p>
</div>
</div>
<h3 id="a-new-kind-of-testing"><a class="header" href="#a-new-kind-of-testing">A New Kind of Testing</a></h3>
<h4 id="cheapest-paths"><a class="header" href="#cheapest-paths">Cheapest Paths</a></h4>
<p>Consider the problem of finding cheapest paths in a weighted graph. There are quite a few algorithms you might use: Dijkstra, Bellman-Ford, even a plain breadth-first search for an unweighted graph. You might have implemented one of these for another class! </p>
<p>The problem statement seems simple: take a graph <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">GR</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span></span> and two vertex names <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord">1</span></span></span></span> and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord">2</span></span></span></span> as input. Produce the cheapest path from <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord">1</span></span></span></span> to <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord">2</span></span></span></span> in <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">GR</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span></span>. But it turns out that this problem hides a lurking issue.</p>
<p><strong>Exercise:</strong> Find the cheapest path from vertex <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">G</span></span></span></span> to vertex <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span></span></span></span> on the graph below.</p>
<p><img src="https://i.imgur.com/CT7MSgl.jpg" alt="" /></p>
<details>
<summary>Think, then click!</summary>
The path is G to A to B to E.    
<p>Great! We have the answer. Now we can go and add a test case for with that graph as input and (G, A, B, E) as the output. </p>
<p>Wait -- you found a different path? G to D to B to E?</p>
<p>And another path? G to H to F to E?</p>
</details>
<hr />
<p>If we add a traditional test case corresponding to <em>one</em> of the correct answers, our test suite will falsely raise alarms for correct implementations that happen to find different answers. In short, we'll be over-fitting our tests to @italic{one specific implementation}: ours. But there's a fix. Maybe instead of writing:</p>
<p><code>shortest(GRAPH, G, E) == [(G, A), (A, B), (B, E)]</code></p>
<p>we write:</p>
<pre><code>shortest(GRAPH, G, E) == [(G, A), (A, B), (B, E)] or
shortest(GRAPH, G, E) == [(G, D), (D, B), (B, E)] or
shortest(GRAPH, G, E) == [(G, H), (H, F), (F, E)]
</code></pre>
<p><strong>Exercise:</strong> What's wrong with the &quot;big or&quot; strategy? Can you think of a graph where it'd be unwise to try to do this?</p>
<details>
    <summary>Think, then click!</summary>
<p>There are at least two problems. First, we might have missed some possible solutions, which is quite easy to do; the first time Tim was preparing these notes, he missed the third path above! Second, there might be an unmanageable number of equally correct solutions. The most pathological case might be something like a graph with all possible edges present, all of which have weight zero. Then, every path is cheapest.</p>
</details>
<hr />
<p>This problem -- multiple correct answers -- occurs in every part of Computer Science. Once you're looking for it, you can't stop seeing it. Most graph problems exhibit it. Worse, so do most optimization problems. Unique solutions are convenient, but the universe isn't built for our convenience. </p>
<p><strong>Exercise:</strong> What's the solution? If <em>test cases</em> won't work, is there an alternative? (Hint: instead of defining correctness bottom-up, by small test cases, think top-down: can we say what it <strong>means</strong> for an implementation to be correct, at a high level?)</p>
<details>
<summary>Think, then click!</summary>
<p>In the cheapest-path case, we can notice that the costs of all cheapest paths are the same. This enables us to write:</p>
<p><code>cost(cheapest(GRAPH, G, E)) = 11</code></p>
<p>which is now robust against multiple implementations of <code>cheapest</code>.</p>
</details>
<hr />
<p>This might be something you were taught to do when implementing cheapest-path algorithms, or it might be something you did on your own, unconsciously. (You might also have been told to ignore this problem, or not told about it at all...) We're not going to stop there, however.</p>
<p>Notice that we just did something subtle and interesting. Even if there are a billion cheapest paths between two vertices in the input graph, they all have that same, minimal length. Our testing strategy has just evolved past naming <em>specific</em> values of output to checking broader <em>properties</em> of output.</p>
<p>Similarly, we can move past specific inputs: randomly generate them. Then, write a function <code>is_valid</code> that takes an arbitrary <code>input, output</code> pair and returns true if and only if the output is a valid solution for the input. Just pipe in a bunch of inputs, and the function will try them all. You can apply this strategy to most any problem, in any programming language. (For your homework this week, you'll be using Python.) Let's be more careful, though.</p>
<p><strong>Exercise:</strong> Is there something <em>else</em> that <code>cheapest</code> needs to guarantee for that input, beyond finding a path with the same cost as our solution?</p>
<details>
<summary>Think, then click!</summary>
<p>We also need to confirm that the path returned by <code>cheapest</code> is indeed a path in the graph! </p>
</details>
<hr />
<p><strong>Exercise:</strong> Now take that list of goals, and see if you can outline a function that tests for it. Remember that the function should take the problem input (in this case, a graph and the source and destination vertices) and the output (in this case, a path). You might generate something like this pseudocode:</p>
<details>
<summary>Think, then click!</summary>
<pre><code>isValid : input: (graph, vertex, vertex), output: list(vertex) -&gt; bool
  returns true IFF:
    (1) output.cost == trustedImplementation(input).cost
    (2) every vertex in output is in input's graph
    (3) every step in output is an edge in input
    ... and so on ...
</code></pre>
</details>
<hr />
<p>This style of testing is called Property-Based Testing (PBT). When we're using a trusted implementation—or some other artifact—to either evaluate the output or to help generate useful inputs, it is also a variety of Model-Based Testing (MBT). </p>
<div id="admonition-model-based-testing" class="admonition admonish-note">
<div class="admonition-title">
<p>Model-Based Testing</p>
<p><a class="admonition-anchor-link" href="chapters/properties/pbt.html#admonition-model-based-testing"></a></p>
</div>
<div>
<p>There's a lot of techniques under the umbrella of MBT. A model can be another program, a formal specification, or some other type of artifact that we can &quot;run&quot;. Often, MBT is used in a more stateful way: to generate sequences of user interactions that drive the system into interesting states. </p>
<p>For now, know that modeling systems can be helpful in generating good tests, in addition to everything else.</p>
</div>
</div>
<p>There are a few questions, though...</p>
<p><strong>Question:</strong> Can we really trust a &quot;trusted&quot; implementation?</p>
<p>No, not completely. It's impossible to reach a hundred percent trust; anybody who tells you otherwise is selling something. Even if you spend years creating a correct-by-construction system, there could be a bug in (say) how it is deployed or connected to other systems. </p>
<p>But often, questions of correctness are really about the <em>transfer of confidence</em>: my old, slow implementation has worked for a couple of years now, and it's probably mostly right. I don't trust my new, optimized implementation at all: maybe it uses an obscure data structure, or a language I'm not familiar with, or maybe I don't even have access to the source code at all. </p>
<p>And anyway, often we don't need recourse to any trusted model; we can just phrase the properties directly. </p>
<p><strong>Exercise:</strong> What if we don't have a trusted implementation?</p>
<details>
<summary>Think, then click!</summary>
<p>You can use this approach whenever you can write a function that checks the correctness of a given output. It doesn't need to use an existing implementation (it's just easier to talk about that way). In the next example we won't use a trusted implementation at all!</p>
</details>
<h4 id="input-generation"><a class="header" href="#input-generation">Input Generation</a></h4>
<p>Now you might wonder: <em>Where do the inputs come from</em>?</p>
<p>Great question! Some we will manually create based on our own cleverness and understanding of the problem. Others, we'll generate randomly.</p>
<p>Random inputs are used for many purposes in software engineering: &quot;fuzz testing&quot;, for instance, creates vast quantities of random inputs in an attempt to find crashes and other serious errors. We'll use that same idea here, except that our notion of correctness is usually a bit more nuanced.</p>
<p>Concretely:</p>
<p><img src="https://i.imgur.com/gCGDK6m.jpg" alt="A diagram of property-based testing. A random input generator, plus some manually-chosen inputs, are sent to the implementation under test. The outputs are then run through the validator function." /></p>
<p>It's important to note that some creativity is still involved here: you need to come up with an <code>is_valid</code> function (the &quot;property&quot;), and you'll almost always want to create some hand-crafted inputs (don't trust a random generator to find the subtle corner cases you already know about!) The strength of this approach lies in its resilience against problems with multiple correct answers, and in its ability to <em>mine for bugs while you sleep</em>. Did your random testing find a bug? Fix it, and then add that input to your list of regression tests. Rinse, repeat.</p>
<p>If we were still thinking in terms of traditional test cases, this would make no sense: where would the outputs come from? Instead, we've created a testing system where concrete outputs aren't something we need to provide. Instead, we check whether the program under test produces <em>any valid output</em>.</p>
<h3 id="the-hypothesis-library"><a class="header" href="#the-hypothesis-library">The Hypothesis Library</a></h3>
<p>There are PBT libraries for most every popular language. In this book, we'll be using a library for Python called <a href="https://hypothesis.readthedocs.io/en/latest/index.html">Hypothesis</a>. Hypothesis has many helper functions to make generating random inputs relatively easy. It's worth spending a little time stepping through the library. Let's test a function in Python itself: the <code>median</code> function in the <code>statistics</code> library, which we began this chapter with. What are some important properties of <code>median</code>?</p>
<div id="admonition-csci-1710-llms-and-testing" class="admonition admonish-note">
<div class="admonition-title">
<p>CSCI 1710: LLMs and Testing</p>
<p><a class="admonition-anchor-link" href="chapters/properties/pbt.html#admonition-csci-1710-llms-and-testing"></a></p>
</div>
<div>
<p>If you're in CSCI 1710, your first homework starts by asking you to generate code using an LLM of your choice, such as ChatGPT. Then, you'll use property-based testing to assess its correctness.  To be clear, <strong>you will not be graded on the correctness of the code you prompt an LLM to generate</strong>. Rather, you will be graded on how good your property-based testing is. </p>
<p>Later in the semester, you'll be using PBT again to test more complex software!</p>
</div>
</div>
<p>Now let's use Hypothesis to test at least one of those properties. We'll start with this <a href="chapters/properties/./pbt.py">template</a>:</p>
<pre><code class="language-python">from hypothesis import given, settings
from hypothesis.strategies import integers, lists
from statistics import median

# Tell Hypothesis: inputs for the following function are non-empty lists of integers
@given(lists(integers(), min_size=1)) 
# Tell Hypothesis: run up to 500 random inputs
@settings(max_examples=500)
def test_python_median(input_list):    
    pass

# Because of how Python's imports work, this if statement is needed to prevent 
# the test function from running whenever a module imports this one. This is a 
# common feature in Python modules that are meant to be run as scripts. 
if __name__ == &quot;__main__&quot;: # ...if this is the main module, then...
    test_python_median()

</code></pre>
<p>Let's start by filling in the <em>shape</em> of the property-based test case:</p>
<pre><code class="language-python">def test_python_median(input_list):    
    output_median = median(input_list) # call the implementation under test
    print(f'{input_list} -&gt; {output_median}') # for debugging our property function
    if len(input_list) % 2 == 1:
        assert output_median in input_list 
    # The above checks a conditional property. But what if the list length isn't even?
    # We should be able to do better!
</code></pre>
<p><strong>Exercise</strong>: Take a moment to try to express what it means for <code>median</code> to be correct in the language of your choice. Then continue on with reading this section.</p>
<p>Expressing properties can often be challenging. After some back and forth, we might reach a candidate function like this:</p>
<pre><code class="language-python">def test_python_median(input_list):
    output_median = median(input_list)
    print(f'{input_list} -&gt; {output_median}')
    if len(input_list) % 2 == 1:
        assert output_median in input_list
    
    lower_or_eq =  [val for val in input_list if val &lt;= output_median]
    higher_or_eq = [val for val in input_list if val &gt;= output_median]
    assert len(lower_or_eq) &gt;= len(input_list) // 2    # int division, drops decimal part
    assert len(higher_or_eq) &gt;= len(input_list) // 2   # int division, drops decimal part
</code></pre>
<p>Unfortunately, there's a problem with this solution. Python's <code>median</code> implementation <em>fails</em> this test! Hypothesis provides a random input on which the function fails: <code>input_list=[9502318016360823, 9502318016360823]</code>. Give it a try! This is what <em>my</em> computer produced; what happens on yours?</p>
<p>Exercise: <strong>What do you think is going wrong?</strong></p>
<details>
  <summary>Think, then click!</summary>
<p>Here's what my Python console reports:</p>
<pre><code class="language-python">&gt;&gt;&gt; statistics.median([9502318016360823, 9502318016360823])
9502318016360824.0
</code></pre>
<p>I really don't like seeing a number that's larger than both numbers in the input set. But I'm also suspicious of that trailing <code>.0</code>. <code>median</code> has returned a <code>float</code>, not an <code>int</code>. That might matter. But first, we'll try the computation that we might expect <code>median</code> to run:</p>
<pre><code class="language-python">&gt;&gt;&gt; (9502318016360823*2)/2
9502318016360824.0
</code></pre>
<p>What if we force Python to perform <em>integer</em> division?</p>
<pre><code class="language-python">&gt;&gt;&gt; (9502318016360823*2)//2
9502318016360823
</code></pre>
<p>Could this be a floating-point imprecision problem? Let's see if Hypothesis can find another failing input where the values are smaller. We'll change the generator to produce only small numbers, and increase the number of trials hundredfold:</p>
<pre><code class="language-python">@given(lists(integers(min_value=-1000,max_value=1000), min_size=1))
@settings(max_examples=50000)
</code></pre>
<p>No error manifests. That doesn't mean one <em>couldn't</em>, but it sure looks like large numbers make the chance of an error much higher. </p>
<p>The issue is: because Python's <code>statistics.median</code> returns a <code>float</code>, we've inadvertently been testing the accuracy of Python's primitive floating-point division, and floating-point division is <a href="https://docs.python.org/3/tutorial/floatingpoint.html">known to be imprecise</a> in some cases. It might even manifest differently on different hardware—this is only what happens on <em>my</em> laptop!</p>
<p>Anyway, we have two or three potential fixes: </p>
<ul>
<li>bound the range of potential input values when we test; </li>
<li>check equality within some small amount of error you're willing to tolerate (a common trick when writing tests about <code>float</code> values); or </li>
<li>change libraries to one that uses an arbitrary-precision, like <a href="https://pypi.org/project/BigNumber/">BigNumber</a>. We could adapt our test fairly easily to that setting, and we'd expect this problem to not occur. </li>
</ul>
<p>Which is best? I don't really like the idea of arbitrarily limiting the range of input values here, because picking a range would require me to understand the floating-point arithmetic specification a lot more than I do. For instance, how do I know that there exists some number <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> before which this issue can't manifest? How do I know that all processor architectures would produce the same thing? </p>
<p>Between the other two options (adding an error term and changing libraries) it depends on the engineering context we're working in. Changing libraries may have consequences for performance or system design. Testing equality <em>within some small window</em> may be the best option in this case, where we know that many inputs will involve <code>float</code> division. </p>
</details>
<h3 id="takeaways"><a class="header" href="#takeaways">Takeaways</a></h3>
<p>We'll close this section by noticing two things:</p>
<p>First, being precise about <em>what correctness means</em> is powerful. With ordinary unit tests, we're able to think about behavior only <em>point-wise</em>. Here, we need to broadly describe our goals, and tere's a cost to that, but also advantages: comprehensibility, more powerful testing, better coverage, etc. And we can still get value from a partial definition, because we can then at least apply PBT to that portion of the program's behavior. </p>
<p>Second, the very act of trying to precisely express, and test, correctness for <code>median</code> <em>taught us (or reminded us about) something subtle about how our programming language works</em>, which tightened our definition of correctness. Modeling often leads to such a virtuous cycle. </p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="intro-to-modeling-systems-part-1-tic-tac-toe"><a class="header" href="#intro-to-modeling-systems-part-1-tic-tac-toe">Intro to Modeling Systems (Part 1: Tic-Tac-Toe)</a></h1>
<h2 id="whats-a-model"><a class="header" href="#whats-a-model">What's a Model?</a></h2>
<p>A <strong>model</strong> is a <em>representation</em> of a system that faithfully includes some but not all of the system's complexity. There are many different ways to model a system, all of which have different advantages and disadvantages. Think about what a car company does before it produces a new car design. Among other things, it creates multiple models. E.g.,</p>
<ul>
<li>it models the car in some computer-aided design tool; and then</li>
<li>creates a physical model of the car, perhaps with clay, for testing in wind tunnels etc.</li>
</ul>
<p>There may be many different models of a system, all of them focused on something different. As the statisticians say, &quot;all models are wrong, but some models are useful&quot;. Learning how to model a system is a key skill for engineers, not just within &quot;formal methods&quot;. Abstraction is one of the key tools in Computer Science, and modeling lies at the heart of abstraction.</p>
<p>In this course, <strong>the models we build aren't inert</strong>; we have tools that we can use the explore and analyze them!</p>
<h3 id="dont-be-afraid-of-imperfect-representations"><a class="header" href="#dont-be-afraid-of-imperfect-representations">Don't Be Afraid of Imperfect Representations</a></h3>
<p><em>We don't need to fully model a system to be able to make useful inferences</em>. We can simplify, omit, and abstract concepts/attributes to make models that approximate the system while preserving the fundamentals that we're interested in. </p>
<p><strong>Exercise:</strong> If you've studied physics, there's a great example of this in statics and dynamics. Suppose I drop a coin from the top of the science library, and ask you what its velocity will be when it hits the ground. Using the methods you learn in beginning physics, what's something you usefully <em>disregard</em>?</p>
<details>
<summary>Think, then click!</summary>
<p>Air resistance! Friction! We can still get a reasonable approximation for many problems without needing to include that. (And advanced physics adds even more factors that aren't worth considering at this scale.) The model without friction is often enough.</p>
</details>
<h2 id="what-is-a-system-models-vs-implementations"><a class="header" href="#what-is-a-system-models-vs-implementations">What is a &quot;System&quot;? (Models vs. Implementations)</a></h2>
<p>When we say &quot;systems&quot; in this book, we mean the term broadly. A distributed system (like <a href="https://github.com/visualzhou/mongo-repl-tla">replication in MongoDB</a>) is a system, but so are user interfaces and hardware devices like CPUs and insulin pumps. Git is a system for version control. The web stack, cryptographic protocols, chemical reactions, the rules of sports and games—these are all systems too!</p>
<p>To help build intuition, let's work with a simple system: the game of <a href="https://en.wikipedia.org/wiki/Tic-tac-toe">tic-tac-toe</a> (also called noughts and crosses). There are <em>many</em> implementations of this game, including <a href="https://csci1710.github.io/2023/examples/ttt.py">this one</a> that I wrote in Python. And, of course, these implementations often have corresponding test suites, like <a href="https://csci1710.github.io/2023/examples/test_ttt.py">this (incomplete) example</a>.</p>
<p><strong>Exercise</strong>: Play a quick game of tic-tac-toe by hand. If you can, find a partner, but if not, then play by yourself.</p>
<p>Notice what just happened. You played the game. In doing so, you ran your own mental implementation of the rules. The result you got was one of many possible games, each with its own specific sequence of legal moves, leading to a particular ending state. Maybe someone won, or maybe the game was a tie. Either way, many different games could have ended with that same board. </p>
<p>Modeling is different from programming. When you're programming traditionally, you give the computer a set of instructions and it follows them. This is true whether you're programming functionally or imperatively, with or without objects, etc. Declarative modeling languages like Forge work differently. The goal of a model isn't to <em>run instructions</em>, but rather to <em>describe the rules</em> that govern systems. </p>
<p>Here's a useful comparison to help reinforce the difference (with thanks to Daniel Jackson):</p>
<ul>
<li>An empty program <strong>does nothing</strong>.</li>
<li>An empty model <strong>allows every behavior</strong>.</li>
</ul>
<h2 id="modeling-tic-tac-toe-boards"><a class="header" href="#modeling-tic-tac-toe-boards">Modeling Tic-Tac-Toe Boards</a></h2>
<p>What are the essential concepts in a game of tic-tac-toe?</p>
<div id="admonition-modeling-methodology" class="admonition admonish-tip">
<div class="admonition-title">
<p>Modeling Methodology</p>
<p><a class="admonition-anchor-link" href="chapters/ttt/ttt.html#admonition-modeling-methodology"></a></p>
</div>
<div>
<p>When we're first writing a model, we'll start with <strong>5 steps</strong>. For each step, I'll give examples from tic-tac-toe and also for binary search trees (which we'll start modeling soon) for contrast.</p>
<ul>
<li>What are the <strong>datatypes</strong> involved, and their <strong>fields</strong>? 
<ul>
<li>For tic-tac-toe: they might be the 3-by-3 board and the <code>X</code> and <code>O</code> marks that go in board locations. </li>
<li>For a binary search tree: they might be the tree nodes and their left and right children. </li>
</ul>
</li>
<li>What makes an instance of these datatypes <strong>well formed</strong>? That is, what conditions are needed for them to not be garbage? 
<ul>
<li>For tic-tac-toe, we might require that the indexes used are between <code>0</code> and <code>2</code>, since the board is 3-by-3. (We could just as easily use <code>1</code>, <code>2</code>, and <code>3</code>. I picked <code>0</code> as the starting point out of habit, because list indexes start from <code>0</code> in the programming languages I tend to use.)</li>
<li>For a binary search tree, we might require that every node has at most one left child, at most one right child, a unique parent, and so on.</li>
</ul>
</li>
<li>What's a small <strong>example</strong> of how these datatypes can be instantiated?
<ul>
<li>For tic-tac-toe, the empty board would be an example. So would the board where <code>X</code> moves first into the middle square.</li>
<li>For a binary search tree, this might be a tree with only one node, or a 3-node tree where the root's left and right children are leaves. </li>
</ul>
</li>
<li>What does the model look like when <strong>run</strong>?
<ul>
<li>For tic-tac-toe, we should see a board with some number of <code>X</code> and <code>O</code> marks.</li>
<li>For a binary search tree, we should see some set of nodes that forms a single tree via left- and right-children.</li>
</ul>
</li>
<li>What <strong>domain predicates</strong> are there? Well-formedness defines conditions that are needed for an instantiation to not be &quot;garbage&quot;. But whatever we're modeling surely has domain-specific concepts of its own, which may or may not hold. 
<ul>
<li>For tic-tac-toe, we care a great deal if the board is a winning board or not. Similarly, we might care if it looks like someone has cheated.</li>
<li>For a binary search tree, we care if the tree is balanced, or if it satisfies the BST invariant.</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="admonition-well-formedness-vs-domain-predicates" class="admonition admonish-warning">
<div class="admonition-title">
<p>Well-formedness vs. domain predicates</p>
<p><a class="admonition-anchor-link" href="chapters/ttt/ttt.html#admonition-well-formedness-vs-domain-predicates"></a></p>
</div>
<div>
<p>Why make this distinction between well-formedness and domain predicates? Because one should always hold in any instance Forge considers, but the other may or may not hold. In fact, we might want to use Forge to <em>verify</em> that a domain predicate always holds! And if we've told Forge that any instance that doesn't satisfy it is garbage, Forge won't find us such an instance.</p>
</div>
</div>
<h3 id="datatypes"><a class="header" href="#datatypes">Datatypes</a></h3>
<p>We might list:</p>
<ul>
<li>the players <code>X</code> and <code>O</code>;</li>
<li>the 3-by-3 game board, where players can put their marks;</li>
<li>the idea of whose turn it is at any given time; and</li>
<li>the idea of who has won the game at any given time.</li>
</ul>
<p>Now let's add those ideas to a model in Forge! </p>
<pre><code class="language-forge editable">#lang forge/froglet
</code></pre>
<p>The first line of any Forge model will be a <code>#lang</code> line, which says which Forge language the file uses. We'll start with the Froglet language for now. Everything you learn in this language will apply in other Forge languages, so I'll use &quot;Forge&quot; interchangeably.</p>
<p>Now we need a way to talk about the noughts and crosses themselves. So let's add a <code>sig</code> that represents them:</p>
<pre><code class="language-forge editable">#lang forge/froglet
abstract sig Player {}
one sig X, O extends Player {}
</code></pre>
<p>You can think of <code>sig</code> in Forge as declaring a kind of object. A <code>sig</code> can extend another, in which case we say that it is a <em>child</em> of its parent, and child <code>sig</code>s cannot overlap. When a sig is <code>abstract</code>, any member must also be a member of one of that <code>sig</code>'s children; in this case, any <code>Player</code> must either be <code>X</code> or <code>O</code>. Finally, a <code>one</code> sig has exactly one member—there's only a single <code>X</code> and <code>O</code> in our model.</p>
<p>We also need a way to represent the game board. We have a few options here: we could create an <code>Index</code> sig, and encode an ordering on those (something like &quot;column A, then column B, then column C&quot;). Another is to use Forge's integer support. Both solutions have their pros and cons. Let's use integers, in part to get some practice with them.</p>
<!-- this shows the play button if we say it is Rust. We have control over what to *do* 
with the highlighting and play button via theme/book.js, so mislead mdbook a bit...
-->
<!-- ```rust,editable -->
<pre><code class="language-forge editable">#lang forge/froglet
abstract sig Player {}
one sig X, O extends Player {}

sig Board {
  board: pfunc Int -&gt; Int -&gt; Player
}
</code></pre>
<p>Every <code>Board</code> object contains a <code>board</code> field describing the moves made so far. This field is a <em>partial function</em>, or dictionary, for every <code>Board</code> that maps each (<code>Int</code>, <code>Int</code>) pair to at most one <code>Player</code>. </p>
<!--
a table of (`Int`, `Int`, `Player`) tuples for each `Board`. We'll see how to work with this field shortly.
-->
<h3 id="well-formedness"><a class="header" href="#well-formedness">Well-formedness</a></h3>
<p>These definitions sketch the overall shape of a board: players, marks on the board, and so on. But not all boards that fit the definition will be valid. For example:</p>
<ul>
<li>Forge integers aren't true mathematical integers, but are bounded by a bitwidth we give whenever we run the tool. So we need to be careful here. We want a classical 3-by-3 board with indexes of (say) <code>0</code>, <code>1</code>, and <code>2</code>, not a board where (e.g.) row <code>-5</code>, column <code>-1</code> is a valid location. </li>
</ul>
<p>We'll call these <em>well-formedness</em> constraints. They aren't innately enforced by our <code>sig</code> declarations, but we'll almost always want Forge to enforce them, so that it doesn't find &quot;garbage instances&quot;. Let's write a <em>wellformedness predicate</em>:</p>
<pre><code class="language-forge editable">-- a Board is well-formed if and only if:
pred wellformed[b: Board] {
  -- row and column numbers used are between 0 and 2, inclusive  
  all row, col: Int | {
    (row &lt; 0 or row &gt; 2 or col &lt; 0 or col &gt; 2) 
      implies no b.board[row][col]      
  }
}
</code></pre>
<div id="admonition-comments-in-forge" class="admonition admonish-tip">
<div class="admonition-title">
<p>Comments in Forge</p>
<p><a class="admonition-anchor-link" href="chapters/ttt/ttt.html#admonition-comments-in-forge"></a></p>
</div>
<div>
<p>Forge treats either <code>--</code> or <code>//</code> as beginning a line-level comment, and <code>/* ... */</code> as denoting a block comment. This is different from the Python code we saw in the last section! In Forge, <code>#</code> has a different meaning.</p>
</div>
</div>
<p>This predicate is true of any <code>Board</code> if and only if the above 2 constraints are satisfied. Let's break down the syntax: </p>
<ul>
<li>Constraints can quantify over a domain. E.g.,<code>all row, col: Int | ...</code> says that for any pair of integers (up to the given bitwidth), the following condition (<code>...</code>) must hold. Forge also supports, e.g., existential quantification (<code>some</code>), but we don't need that yet. We also have access to standard boolean operators like <code>or</code>, <code>implies</code>, etc. </li>
<li><em>Formulas</em> in Forge always evaluate to a boolean; <em>expressions</em> evaluate to sets. For example,
<ul>
<li>the <em>expression</em> <code>b.board[row][col]</code> evaluates to the <code>Player</code> (if any) with a mark at location (<code>row</code>, <code>col</code>) in board <code>b</code>; but</li>
<li>the <em>formula</em> <code>no b.board[row][col]</code> is true if and only if there is no such `Player``.</li>
</ul>
</li>
<li>A <code>pred</code> (predicate) in Forge is a helper function that evaluates to a boolean. Thus, its body should always be a formula. </li>
</ul>
<div id="admonition-predicates-are-declarative" class="admonition admonish-tip">
<div class="admonition-title">
<p>Predicates are declarative</p>
<p><a class="admonition-anchor-link" href="chapters/ttt/ttt.html#admonition-predicates-are-declarative"></a></p>
</div>
<div>
<p>Notice that, rather than describing a process that produces a well-formed board, or even instructions to check well-formedness, we've just given a declarative description of what's necessary and sufficient for a board to be well-formed. If we'd left the predicate body empty, <em>any</em> board would be considered well-formed—there'd be no formulas to enforce!</p>
</div>
</div>
<h3 id="a-few-examples"><a class="header" href="#a-few-examples">A Few Examples</a></h3>
<p>Since a predicate is just a function that returns true or false, depending on its arguments and whichever instance Forge is looking at, we can write tests for it the same way we would for any other boolean-valued function. But even if we're not testing, it can be useful to write a small number of examples, so we can build intuition for what the predicate means.</p>
<p>In Forge, <code>example</code>s are automatically run whenever your model executes. They describe basic intent about a given predicate; in this case, let's write two examples in Forge:</p>
<ul>
<li>A board where <code>X</code> has moved 3 times in valid locations, and so ought to be considered well formed. </li>
<li>A board where a player has moved in an invalid location, and shouldn't be considered well formed. </li>
</ul>
<p>Notice that we're not making judgements about the rules being obeyed yet—just about whether our <code>wellformed</code> predicate is behaving the way we expect. And the <code>wellformed</code> predicate isn't aware of things like &quot;taking turns&quot; or &quot;stop after someone has won&quot;, etc. It just knows about the valid indexes being <code>0</code>, <code>1</code>, and <code>2</code>.</p>
<p>We'll write those two examples in Forge:</p>
<pre><code class="language-forge editable">-- Helper to make these examples easier to write
pred all_wellformed { all b: Board | wellformed[b]}

-- all_wellformed should be _true_ for the following instance
example firstRowX_wellformed is {all_wellformed} for {
  Board = `Board0                 -- backquote labels specific atoms
  X = `X      O = `O              -- examples must define all sigs
  Player = X + O                  -- only two kinds of player
  `Board0.board = (0, 0) -&gt; `X +  -- the partial function for the board's
                  (0, 1) -&gt; `X +  -- contents (unmentioned squares must 
                  (0, 2) -&gt; `X    -- remain empty, because we used &quot;=&quot; to say
                                  -- &quot;here's the function for `board0&quot;)
}

-- all_wellformed should be _false_ for the following instance
example off_board_not_wellformed is {not all_wellformed} for {
  Board = `Board0 
  X = `X      O = `O 
  Player = X + O
  `Board0.board = (-1, 0) -&gt; `X +
                  (0, 1) -&gt; `X + 
                  (0, 2) -&gt; `X 
}
</code></pre>
<div id="admonition-test-in-both-directions" class="admonition admonish-warning">
<div class="admonition-title">
<p>Test in both directions</p>
<p><a class="admonition-anchor-link" href="chapters/ttt/ttt.html#admonition-test-in-both-directions"></a></p>
</div>
<div>
<p>Notice that we've got a test thats a <em>positive</em> example and another test that's a <em>negative</em> example. We want to make sure to exercise both cases, or else &quot;always true&quot; or &quot;always&quot; false could pass our suite.</p>
</div>
</div>
<h3 id="running-forge"><a class="header" href="#running-forge">Running Forge</a></h3>
<p>The <code>run</code> command tells Forge to search for an <em>instance</em> satisfying the given constraints:</p>
<pre><code class="language-forge editable">run { some b: Board | wellformed[b]} 
</code></pre>
<p>(If you're curious about <em>how</em> Forge finds solutions, you can find a brief sketch in <a href="chapters/ttt/../qna/static.html">the Q&amp;A for this chapter</a>.)</p>
<p>When we click the play button in the VSCode extension, the engine solves the constraints and produces a satisfying instance,  (Because of differences across solver versions, hardware, etc., it's possible you'll see a different instance than the one shown here.) A browser window should pop up with a visualization. You can also run <code>racket &lt;filename.frg&gt;</code> in the terminal, although we recommend the VSCode extension. </p>
<!-- Alloy -->
<!-- <img style="float: right;"  src="https://i.imgur.com/jTwED1K.png"/> -->
<!-- 
<img style="float: right;" src="https://i.imgur.com/34krUGX.png"/>
 -->
<div id="admonition-running-forge-on-windows" class="admonition admonish-warning">
<div class="admonition-title">
<p>Running Forge on Windows</p>
<p><a class="admonition-anchor-link" href="chapters/ttt/ttt.html#admonition-running-forge-on-windows"></a></p>
</div>
<div>
<p>If you're running on Windows, the Windows-native <code>cmd</code> and PowerShell terminals will not properly load Forge's visualizer. Instead, we suggest using one of many other options on Windows that we've tested and know to work: the VSCode extension (available on the VSCode Marketplace), DrRacket, Git for Windows (e.g., <code>git bash</code>), Windows Subsystem for Linux, or Cygwin.</p>
</div>
</div>
<hr />
<p>There are many options for visualization. The default which loads initially is a directed-graph based one:</p>
<center><img width="70%" src="chapters/ttt/./ttt-viz.png"/></center>
<p><strong>(TODO: make this clickable to show it bigger? Want to see the whole window, but then the graph is small.)</strong></p>
<p>This isn't very useful; it looks nothing like a tic-tac-toe board! We can make more progress by using the &quot;Table&quot; visualization—which isn't ideal either:</p>
<center><img width="40%" src="chapters/ttt/./ttt-viz-table.png"/></center>
<p>Forge also allows users to make <em>custom</em> visualizations via short JavaScript programs; <a href="chapters/ttt/./ttt.js">here's</a> an example basic visualizer for this specific tic-tac-toe model that produces images like this one:</p>
<center><img width="20%" src="chapters/ttt/./ttt-custom.png"/></center>
<p>We'll talk more about visualization scripts later. For now, let's proceed. <strong>TODO: replace img with one matching the table view</strong>
<strong>TODO: add side-by-side CSS</strong></p>
<hr />
<p>This instance contains a single board, and it has 9 entries. Player <code>O</code> has moved in all of them (the <code>0</code> suffix of <code>O0</code> in the display is an artifact of how Forge's engine works; ignore it for now). It's worth noticing two things:</p>
<ul>
<li>This board doesn't look quite right: player <code>O</code> occupies all the squares. We might ask: has player <code>O</code> been cheating? But the fact is that this board <em>satisfies the constraints we have written so far</em>. Forge produces it simply because our model isn't yet restrictive enough, and for no other reason. &quot;Cheating&quot; doesn't exist yet. </li>
<li>We didn't say <em>how</em> to find that instance. We just said what we wanted, and the tool performed some kind of search to find it. So far the objects are simple, and the constraints basic, but hopefully the power of the idea is coming into focus. </li>
</ul>
<div id="admonition-why-board3-when-theres-only-one-board" class="admonition admonish-note">
<div class="admonition-title">
<p>Why <code>Board3</code> when there's only one board?</p>
<p><a class="admonition-anchor-link" href="chapters/ttt/ttt.html#admonition-why-board3-when-theres-only-one-board"></a></p>
</div>
<div>
<p>Here, we see <code>Board3</code> because the solver had a few options to pick from: we never said there should only ever be one <code>Board</code>, after all. So, under the hood, it was considering the potential existence of multiple boards. And then it happened to pick this one to exist in this instance.</p>
</div>
</div>
<h3 id="reflection-implementation-vs-model"><a class="header" href="#reflection-implementation-vs-model">Reflection: Implementation vs. Model</a></h3>
<p>So far we've just modeled boards, not full games. But we can still contrast our work here against the Python <em>implementation</em> of tic-tac-toe shared above. </p>
<p><strong>Exercise:</strong> How do the data-structure choices, and type declarations, in the implementation compare with the essence of the game as reflected in the model? What is shared, and what is different? </p>
<p>Spend a minute identifying at least one commonality and at least one difference, then move on.</p>
<h2 id="domain-predicates"><a class="header" href="#domain-predicates">Domain Predicates</a></h2>
<p>Now let's write predicates that describe important ideas in the domain. What's important in the game of tic-tac-toe? Here are a few things.</p>
<h3 id="starting-boards"><a class="header" href="#starting-boards">Starting Boards</a></h3>
<p>What would it mean to be a <em>starting state</em> in a game? The board is empty:</p>
<pre><code class="language-forge editable">pred starting[s: Board] {
  all row, col: Int | 
    no s.board[row][col]
}
</code></pre>
<h3 id="turns"><a class="header" href="#turns">Turns</a></h3>
<p>How do we tell when it's a given player's turn? It's <code>X</code>'s turn when there are the same number of each mark on the board:</p>
<pre><code class="language-forge editable">pred XTurn[s: Board] {
  #{row, col: Int | s.board[row][col] = X} =
  #{row, col: Int | s.board[row][col] = O}
}
</code></pre>
<p>Here, we're measuring the size of 2 sets. The <code>{row, col: Int | ...}</code> syntax is called a <em>set comprehension</em>. A set comprehension defines a set. We're defining the set of row-column pairs where the board contains one of the player marks. The <code>#</code> operator gives the size of these sets, which we then compare.</p>
<p><strong>Exercise:</strong> Is it enough to say that <code>OTurn</code> is the negation of <code>XTurn</code>? That is, we could write: <code>pred OTurn[s: Board] { not XTurn[s: Board]}</code>. This seems reasonable enough; why might we <em>not</em> want to write this?</p>
<details>
<summary>Think, then click!</summary>
<p>Because we defined X's turn to be when the number of X's and O's on the board are in balance. So any <em>other</em> board would be O's turn, including ones that ought to be illegal, once we start defining moves of the game. Instead, let's say something like this:</p>
<pre><code class="language-forge editable">pred OTurn[s: Board] {
  -- It's O's turn if X has moved once more often than O has
  #{row, col: Int | s.board[row][col] = X} =
  add[#{row, col: Int | s.board[row][col] = O}, 1]
}
</code></pre>
</details>
<hr />
<div id="admonition-integer-addition" class="admonition admonish-note">
<div class="admonition-title">
<p>Integer addition</p>
<p><a class="admonition-anchor-link" href="chapters/ttt/ttt.html#admonition-integer-addition"></a></p>
</div>
<div>
<p>Forge supports arithmetic operations on integers like <code>add</code>. Forge integers are signed (i.e., can be positive or negative) and are bounded by a <em>bit width</em>, which defaults to <code>4</code> bits. The number of available integers is always $2^k$, where $k$ is the bit width.</p>
<p>Forge follows the <a href="https://en.wikipedia.org/wiki/Two%27s_complement">2's complement arithmetic</a> convention, which means that the available integers are split evenly between positive and negative numbers, but counting <code>0</code> as &quot;positive&quot;. So with 4 bits, we can represent numbers between <code>-8</code> and <code>7</code> (inclusive).</p>
<p>This means that (while it doesn't matter for this model yet), arithmetic operations can overflow—just like primitive integers in languages like Java! For example, if we're working with 4-bit integers, then <code>add[7,1]</code> will be <code>-8</code>. You can experiment with this in the visualizer's <em>evaluator</em>, which we'll be using a lot after the initial modeling tour is done.</p>
</div>
</div>
<div id="admonition-use-add-for-addition-not-" class="admonition admonish-warning">
<div class="admonition-title">
<p>Use <code>add</code> for addition, not <code>+</code></p>
<p><a class="admonition-anchor-link" href="chapters/ttt/ttt.html#admonition-use-add-for-addition-not-"></a></p>
</div>
<div>
<p>Don't try to use <code>+</code> for addition in any Forge language. Use <code>add</code> instead; this is because <code>+</code> is reserved for something else (which we'll explain later).</p>
</div>
</div>
<h3 id="winning-the-game"><a class="header" href="#winning-the-game">Winning the Game</a></h3>
<p>What does it mean to <em>win</em>? A player has won on a given board if:</p>
<ul>
<li>they have placed their mark in all 3 columns of a row; </li>
<li>they have placed their mark in all 3 rows of a column; or</li>
<li>they have placed their mark in all 3 squares of a diagonal.</li>
</ul>
<p>We'll express this in a <code>winner</code> predicate that takes the current board and a player name. Let's also define a couple helper predicates along the way:</p>
<pre><code class="language-forge editable">pred winRow[s: Board, p: Player] {
  -- note we cannot use `all` here because there are more Ints  
  some row: Int | {
    s.board[row][0] = p
    s.board[row][1] = p
    s.board[row][2] = p
  }
}

pred winCol[s: Board, p: Player] {
  some column: Int | {
    s.board[0][column] = p
    s.board[1][column] = p
    s.board[2][column] = p
  }      
}

pred winner[s: Board, p: Player] {
  winRow[s, p]
  or
  winCol[s, p]
  or 
  {
    s.board[0][0] = p
    s.board[1][1] = p
    s.board[2][2] = p
  } or {
    s.board[0][2] = p
    s.board[1][1] = p
    s.board[2][0] = p
  }  
}
</code></pre>
<p>After writing these domain predicates, we're reaching a fairly complete model for a single tic-tac-toe board. Let's decide how to fix the issue we saw above (the reason why <code>OTurn</code> couldn't be the negation of <code>XTurn</code>): perhaps a player has moved too often.</p>
<p>Should we add something like <code>OTurn[s] or XTurn[s]</code> to our wellformedness predicate? <strong>No!</strong> If we then later enforced wellformedness for all boards, that would exclude &quot;cheating&quot; instances where a player has more moves on the board than are allowed. But this has some risk, depending on how we intend to use the <code>wellformed</code> predicate:</p>
<ul>
<li>If we were only ever generating <em>valid boards</em>, a cheating state might well be spurious, or at least undesirable. In that case, we might prevent such states in <code>wellformed</code> and rule it out. </li>
<li>If we were generating arbitrary (not necessarily valid) boards, being able to see a cheating state might be useful. In that case, we'd leave it out of <code>wellformed</code>.</li>
<li>If we're interested in <em>verification</em>, e.g., we are asking whether the game of Tic-Tac-Toe enables ever reaching a cheating board, we shouldn't add <code>not cheating</code> to <code>wellformed</code>; because <code>wellformed</code> also excludes garbage boards, we'd probably use it in our verification—in which case, Forge will never find us a counterexample! </li>
</ul>
<div id="admonition-modeling-vs-pbt" class="admonition admonish-tip">
<div class="admonition-title">
<p>Modeling vs. PBT</p>
<p><a class="admonition-anchor-link" href="chapters/ttt/ttt.html#admonition-modeling-vs-pbt"></a></p>
</div>
<div>
<p>Notice the similarity between this issue and what we do in property-based testing. Here, we're forced to distinguish between what a reasonable <em>board</em> is (analogous to the generator's output in PBT) and what a reasonable <em>behavior</em> is (analogous to the validity predicate in PBT). One narrows the scope of possible worlds to avoid true &quot;garbage&quot;; the other checks whether the system behaves as expected in one of those worlds.</p>
</div>
</div>
<p>We'll come back to this later, when we've had a bit more modeling experience. For now, let's separate our goal into a new predicate called <code>balanced</code>, and add it to our <code>run</code> command above so that Forge will find us an instance where some board is both <code>balanced</code> and <code>wellformed</code>:</p>
<pre><code class="language-forge editable">pred balanced[s: Board] {
  XTurn[s] or OTurn[s]
}
run { some b: Board | wellformed[b] and balanced[b]} 
</code></pre>
<p>If we click the &quot;Next&quot; button a few times, we see that not all is well: we're getting boards where <code>wellformed</code> is violated (e.g., entries at negative rows, or multiple moves in one square). Why is this happening?</p>
<p>We're getting this because of how the <code>run</code> was phrased. We said to find an instance where <em>some board</em> was well-formed and valid, not one where <em>all boards</em> were. Our <code>run</code> is satisfied by any instance where <em>at least one</em> <code>Board</code> is <code>wellformed</code>; the others won't affect the truth of the constraint. By default, Forge will find instances with up to 4 <code>Boards</code>. So we can fix the problem either by telling Forge to find instances with only 1 Board:</p>
<pre><code class="language-forge editable">run { some b: Board | wellformed[b] and balanced[b]} 
for exactly 1 Board
</code></pre>
<p>or by saying that all boards must be well-formed and balanced:</p>
<pre><code class="language-forge editable">run { all b: Board | wellformed[b] and balanced[b]} 
</code></pre>
<h2 id="practice-with-run"><a class="header" href="#practice-with-run">Practice with <code>run</code></a></h2>
<p>The <code>run</code> command can be used to give Forge more detailed instructions for its search. </p>
<h3 id="no-boards"><a class="header" href="#no-boards">No Boards</a></h3>
<p><strong>Exercise:</strong> Is it possible for an instance with <em>no</em> boards to still satisfy constraints like these?</p>
<pre><code class="language-alloy">run {    
     all b: Board | {
         -- X has won, and the board looks OK
         wellformed[b]
         winner[b, X]
         balanced[b]    
     }
 }
</code></pre>
<details>
<summary>Think, then click!</summary>
<p>Yes! There aren't any boards, so there's no obligation for anything to satisfy the constraints inside the quantifier. You can think of the <code>all</code> as something like a <code>for</code> loop in Java or the <code>all()</code> function in Python: it checks every <code>Board</code> in the instance. If there aren't any, there's nothing to check—return true.</p>
</details>
<h3 id="adding-more"><a class="header" href="#adding-more">Adding More</a></h3>
<p>This addition also requires that <code>X</code> moved in the middle of the board:</p>
<pre><code class="language-alloy">run {    
     all b: Board | {
         -- X has won, and the board looks OK
         wellformed[b]
         winner[b, X]
         balanced[b]
         -- X started in the middle
         b.board[1][1] = X
     }
 } for exactly 2 Board
</code></pre>
<p>Notice that, because we said <code>exactly 2 Board</code> here, Forge <em>must</em> find instances containing 2 tic-tac-toe boards, and both of them must satisfy the constraints: wellformedness, <code>X</code> moving in the middle, etc. You could ask for a board where <code>X</code> <em>hasn't</em> won by adding <code>not winner[b, X]</code>. </p>
<!-- You also have `implies` and `iff` (if and only if), although you can still do something like comparing two predicates without `iff` (try, e.g., asking for instances where `A and not B` holds).  -->
<p>We'll come back to tic-tac-toe soon; for now, let's cover another static example.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="intro-to-modeling-systems-part-2-bsts"><a class="header" href="#intro-to-modeling-systems-part-2-bsts">Intro to Modeling Systems (Part 2: BSTs)</a></h1>
<p>Now that we've written our first model—tic-tac-toe boards—let's switch to something a bit more serious: binary search trees. A binary search tree (BST) is a binary tree with an added property about its structure that allows it to efficiently answer many search queries related to the values it stores. Here's an example, drawn by hand:</p>
<!-- sips -s format png Bintree.pdf --out BinTree.png  -->
<center>
<img alt="a hand-drawn binary search tree" src="chapters/bst/./Bintree.png" width=40%/>
</center>
<p>Each node of the tree holds some value that the tree supports searching for. We'll call this value the search key, or just the <em>key</em> for each node. The common ancestor of every node in the tree is called the <em>root</em>. </p>
<p>This is obviously a <em>binary tree</em>, since it is a tree where every node has <em>at most</em> 2 children. What makes it a binary <em>search</em> tree is the invariant that every node <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> obeys: </p>
<ul>
<li>all left-descendants of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> have a key less than <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>'s key; and </li>
<li>all right-descendants of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> have a key greater than or equal to <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>'s key.</li>
</ul>
<div id="admonition-a-common-mistake" class="admonition admonish-warning">
<div class="admonition-title">
<p>A common mistake</p>
<p><a class="admonition-anchor-link" href="chapters/bst/bst.html#admonition-a-common-mistake"></a></p>
</div>
<div>
<p>When you're first learning about binary search trees, it's easy to phrase the invariant wrong: </p>
<ul>
<li>the left child of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> (if any) has a key less than <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>'s key; and </li>
<li>the right child of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> (if any) has a key greater than or equal to <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>'s key.
With experience, it's straightforward to see that this is too weak; search will break. But at first that isn't so obvious. It would be interesting if we could use Forge to help us understand the difference and its impact on searching the tree.</li>
</ul>
</div>
</div>
<p>Let's start modeling. As with programming, it's a good idea to start simple, and add complexity and optimization after. So we'll start with plain binary trees, and then add the invariant.</p>
<div id="admonition-the-recipe" class="admonition admonish-tip">
<div class="admonition-title">
<p>the recipe</p>
<p><a class="admonition-anchor-link" href="chapters/bst/bst.html#admonition-the-recipe"></a></p>
</div>
<div>
<p>Like with tic-tac-toe, we'll follow this rough 5-step progression:</p>
<ul>
<li>define the pertinent datatypes and fields;</li>
<li>define a well-formedness predicate;</li>
<li>write some examples;</li>
<li>run and exercise the base model; </li>
<li>write domain predicates. 
Keep in mind that this isn't a strict &quot;waterfall&quot; style progression; we may return to previous steps if we discover it's necessary.</li>
</ul>
</div>
</div>
<h2 id="datatypes-1"><a class="header" href="#datatypes-1">Datatypes</a></h2>
<p>A binary tree is made up of nodes. Each node in the tree has at most one left child and at most one right child. While nodes in the tree can hold values of most any type, for simplicity we'll stick to integers. </p>
<p>Unlike in tic-tac-toe, this definition is recursive:</p>
<pre><code class="language-forge runnable">#lang forge/froglet
sig Node {
  key: one Int,     -- every node has some key 
  left: lone Node,  -- every node has at most one left-child
  right: lone Node  -- every node has at most one right-child
}
</code></pre>
<div id="admonition-teminology-reminder" class="admonition admonish-note">
<div class="admonition-title">
<p>Teminology Reminder</p>
<p><a class="admonition-anchor-link" href="chapters/bst/bst.html#admonition-teminology-reminder"></a></p>
</div>
<div>
<p>Recall that a <code>sig</code> is a datatype, each of which may have a set of <em>fields</em>. Here, we're saying that there is a datatype called <code>Node</code>, and that every <code>Node</code> has a <code>key</code>, <code>left</code>, and <code>right</code> field.</p>
</div>
</div>
<h2 id="wellformedness-for-binary-trees"><a class="header" href="#wellformedness-for-binary-trees">Wellformedness for Binary Trees</a></h2>
<p>What makes a binary tree a binary tree? We might start by saying that: </p>
<ul>
<li>it's <em>single-tree-shaped</em>: there are no cycles and all nodes have at most one parent node; and </li>
<li>it's <em>connected</em>: all non-root nodes have a common ancestor. </li>
</ul>
<p>It's sometimes useful to write domain predicates early, and then use them to define wellformedness more clearly. For example, it might be useful to write a helper that describes what it means for a node to be a <em>root</em> node, i.e., the common ancestor of every node in the tree:</p>
<pre><code class="language-forge runnable"><span class="boring">#lang forge/froglet
</span><span class="boring">sig Node {
</span><span class="boring">  key: one Int,     -- every node has some key 
</span><span class="boring">  left: lone Node,  -- every node has at most one left-child
</span><span class="boring">  right: lone Node  -- every node has at most one right-child
</span><span class="boring">}
</span><span class="boring">
</span>pred isRoot[n: Node] {
  -- a node is a root if it has no ancestor
  no n2: Node | n = n2.left or n = n2.right
}
</code></pre>
<p>Then we'll use the <code>isRoot</code> helper in our <code>wellformed</code> predicate. But to write this predicate, there's a new challenge. We'll need to express constraints like &quot;no node can reach itself via <code>left</code> or <code>right</code> fields&quot;. So far we've only spoken of a node's <em>immediate left or right child</em>. Instead, we now need a way to talk about <em>reachability</em> over any number of <code>left</code> or <code>right</code> fields. Forge provides a helper, <code>reachable</code>, that makes this straightforward.</p>
<div id="admonition-the-reachable-built-in" class="admonition admonish-tip">
<div class="admonition-title">
<p>The <code>reachable</code> built-in</p>
<p><a class="admonition-anchor-link" href="chapters/bst/bst.html#admonition-the-reachable-built-in"></a></p>
</div>
<div>
<p>The built-in <code>reachable</code> predicate returns true if and only if its first argument is reachable from its second argument, via all of the remaining arguments. Thus, <code>reachable[n1, anc, left, right]</code> means: &quot;<code>anc</code> can reach <code>n1</code> via some sequence of <code>left</code> and <code>right</code> fields.&quot;</p>
<p>For reasons we'll explore later, <code>reachable</code> can be subtle; if you're curious now, see the <a href="chapters/bst/../qna/static.html">Static Models Q&amp;A</a> for a discussion of this.</p>
</div>
</div>
<p>Using <code>reachable</code>, we can now write:</p>
<pre><code class="language-forge editable">pred wellformed {
  -- no cycles: no node can reach itself via a succession of left and right fields
  all n: Node | not reachable[n, n, left, right] 
  
  -- all non-root nodes have a common ancestor from which both are reachable
  -- the &quot;disj&quot; keyword means that n1 and n2 must be _different_
  all disj n1, n2: Node | (not isRoot[n1] and not isRoot[n2]) implies {
    some anc: Node | reachable[n1, anc, left, right] and 
                     reachable[n2, anc, left, right] }

  -- nodes have a unique parent (if any)
  all disj n1, n2, n3: Node | 
    not ((n1.left = n3 or n1.right = n3) and (n2.left = n3 or n2.right = n3))
}
</code></pre>
<h2 id="write-an-example-or-two"><a class="header" href="#write-an-example-or-two">Write an example or two</a></h2>
<p>Let's write a few examples of well-formed and non-well-formed trees. I've listed some possibilities below.</p>
<div id="admonition-are-these-examples-enough" class="admonition admonish-note">
<div class="admonition-title">
<p>Are these examples enough?</p>
<p><a class="admonition-anchor-link" href="chapters/bst/bst.html#admonition-are-these-examples-enough"></a></p>
</div>
<div>
<p>Just like with testing a program, it's not always immediately clear when to <em>stop</em> testing a model. 
Fortunately, Forge gives us the ability to explore and exercise the model more thoroughly than just 
running a program does. So, while we're not completely out of danger, we do have new tools to protect
ourselves with.</p>
</div>
</div>
<h3 id="positive-examples"><a class="header" href="#positive-examples">Positive examples</a></h3>
<h4 id="a-binary-tree-with-no-nodes-should-be-considered-well-formed"><a class="header" href="#a-binary-tree-with-no-nodes-should-be-considered-well-formed">A binary tree with no nodes should be considered well-formed.</a></h4>
<pre><code class="language-forge editable">example p_no_nodes is wellformed for {
  no Node  -- there are no nodes in the tree; it is empty
}
</code></pre>
<p>Drawing this one wouldn't be very interesting.</p>
<h4 id="a-binary-tree-with-a-single-node-should-be-considered-well-formed"><a class="header" href="#a-binary-tree-with-a-single-node-should-be-considered-well-formed">A binary tree with a single node should be considered well-formed.</a></h4>
<pre><code class="language-forge editable">example p_one_nodes is wellformed for {
  Node = `Node0 -- there is exactly one node in the tree, named &quot;Node0&quot;.
  no left       -- there are no left-children
  no right      -- there are no right-children
}
</code></pre>
<p>If we were going to draw the single-node example, we might draw it something like this:</p>
<img alt="a tree with a single node and no edges" src="chapters/bst/./p_one_nodes.png" width=60%/>
<p>In fact, this is what Forge's default visualizer can generate. Notice that the node has:</p>
<ul>
<li>a <em>name</em> or identity, which we supplied when we named it <code>Node0</code> in the example; and </li>
<li>a value for its <code>key</code> field, which we did not supply (and so Forge filled in). 
Be careful not to confuse these! There's a rough analogy to programming: it's very possible that (especially if we have a buggy program or model) there might be different nodes with the same key value.</li>
</ul>
<p><strong>(TODO: decide: discussion of partial vs. total examples goes where?)</strong></p>
<h4 id="a-binary-tree-with-more-than-one-row-should-be-considered-well-formed"><a class="header" href="#a-binary-tree-with-more-than-one-row-should-be-considered-well-formed">A binary tree with more than one row should be considered well-formed.</a></h4>
<pre><code class="language-forge editable">example p_multi_row is wellformed for {
  Node = `Node0 +                               -- row 0
         `Node1 + `Node2 +                      -- row 1
         `Node3 + `Node4 + `Node5 + `Node6      -- row 2
  
  -- Define the child relationships (and lack thereof, for leaves)
  -- This is a bit verbose; we'll learn more concise syntax for this soon!
  `Node0.left = `Node1 
  `Node0.right = `Node2
  `Node1.left = `Node3
  `Node1.right = `Node4
  `Node2.left = `Node5
  `Node2.right = `Node6
  no `Node3.left  no `Node3.right 
  no `Node4.left  no `Node4.right 
  no `Node5.left  no `Node5.right 
  no `Node6.left  no `Node6.right 
}
</code></pre>
<center>
<img alt="a tree with more than one row" src="chapters/bst/./p_multi_row.png" width=60%/>
</center>
<p>Wait a moment; there's something strange here. What do you notice about the way we've visualized this tree? </p>
<details> 
<summary>Think, then click!</summary>
<p>That visualization is not how we'd choose to draw the tree: it has the <code>left</code> field to the right and the <code>right</code> field to the left! This is because we used Forge's default visualizer. By default, Forge has no way to understand what &quot;left&quot; and &quot;right&quot; mean. We'll come back to this problem soon. </p>
</details>
<h4 id="an-unbalanced-binary-tree-is-still-well-formed"><a class="header" href="#an-unbalanced-binary-tree-is-still-well-formed">An unbalanced binary tree is still well-formed.</a></h4>
<p>When we draw binary trees, often we draw them in a <em>balanced</em> way: nice and &quot;bushy&quot;, with roughly even distribution of nodes to the left and right. But an unbalanced tree is still a tree, and we should make sure it counts as one.</p>
<pre><code class="language-forge editable">example p_unbalanced_chain is wellformed for {
  Node = `Node0 + `Node1 + `Node2 + `Node3
  
  -- Form a long chain; it is still a binary tree.
  `Node0.left = `Node1 
  no `Node0.right 
  `Node1.left = `Node2
  no `Node1.right
  `Node2.left = `Node3
  no `Node2.right 
  
  no `Node3.left  no `Node3.right 
}
</code></pre>
<center>
<img alt="an unbalanced chain is still a tree" src="chapters/bst/./p_unbalanced_chain.png" width=50%/>
</center>
<h3 id="negative-examples"><a class="header" href="#negative-examples">Negative examples</a></h3>
<p>It's best to write some positive <em>and</em> negative examples. Why? Well, suppose you needed to test a method or function that returned a boolean, like checking whether an integer is even. Here's an example in Python:</p>
<pre><code class="language-python">def is_even(x: int) -&gt; bool: return x % 2 == 0
</code></pre>
<p>What's wrong with this test suite? </p>
<pre><code class="language-python">assert is_even(0) == True 
assert is_even(2) == True 
assert is_even(10000) == True 
assert is_even(-10000) == True 
</code></pre>
<p>The problem isn't only the <em>size</em> of the suite! By testing only values for which we expect <code>True</code> to be returned, we're neglecting half the problem. We'd never catch buggy implementations like this one:</p>
<pre><code class="language-python">def is_even(x: int) -&gt; bool: return True
</code></pre>
<p>Forge predicates are very like boolean-valued functions, so it's important to exercise them in both directions. Here are some negative examples:</p>
<h4 id="a-single-node-that-is-its-own-left-child-is-not-well-formed"><a class="header" href="#a-single-node-that-is-its-own-left-child-is-not-well-formed">A single node that is its own left-child is not well-formed.</a></h4>
<pre><code class="language-forge editable">example n_own_left is {not wellformed} for {
  Node = `Node0 
  `Node0.left = `Node0
  no `Node0.right
}
</code></pre>
<img alt="a node that is its own left child" src="chapters/bst/./n_own_left.png" width=60%/>
<h4 id="a-single-node-that-is-its-own-right-child-is-not-well-formed"><a class="header" href="#a-single-node-that-is-its-own-right-child-is-not-well-formed">A single node that is its own right-child is not well-formed.</a></h4>
<pre><code class="language-forge editable">example n_own_right is {not wellformed} for {
  Node = `Node0 
  no `Node0.left
  `Node0.right = `Node0
}
</code></pre>
<img alt="a node that is its own right child" src="chapters/bst/./n_own_right.png" width=60%/>
<h4 id="a-single-node-thats-reachable-via-a-longer-cycle-using-both-left--and-right-children-is-not-well-formed"><a class="header" href="#a-single-node-thats-reachable-via-a-longer-cycle-using-both-left--and-right-children-is-not-well-formed">A single node that's reachable via a longer cycle using both left- and right-children is not well-formed.</a></h4>
<pre><code class="language-forge editable">example n_mixed_cycle is {not wellformed} for {
  Node = `Node0 + `Node1 + `Node2
  
  `Node0.left = `Node1 
  no `Node0.right 
  no `Node1.left
  `Node1.right = `Node2
  
  `Node2.left = `Node0
  no `Node2.right 
}
</code></pre>
<img alt="a cycle using both left and right" src="chapters/bst/./n_mixed_cycle.png" width=60%/>
<h4 id="a-forest-of-multiple-disconnected-trees-is-not-well-formed"><a class="header" href="#a-forest-of-multiple-disconnected-trees-is-not-well-formed">A &quot;forest&quot; of multiple, disconnected trees is not well-formed.</a></h4>
<pre><code class="language-forge editable">example n_forest is {not wellformed} for {
  Node = `Node0 + `Node1
  no `Node0.left
  no `Node0.right 
  no `Node1.left 
  no `Node1.right 
}
</code></pre>
<img alt="a forest, not a single tree" src="chapters/bst/./n_forest.png" width=60%/>
<div id="admonition-sometimes-it-helps-to-_start_-with-an-example" class="admonition admonish-note">
<div class="admonition-title">
<p>Sometimes it helps to <em>start</em> with an example.</p>
<p><a class="admonition-anchor-link" href="chapters/bst/bst.html#admonition-sometimes-it-helps-to-_start_-with-an-example"></a></p>
</div>
<div>
<p>We wouldn't normally be able to <em>check</em> these examples until we'd finished writing the <code>wellformed</code> predicate, but it can still be useful to create a few examples first, to help guide the constraints you write. Binary trees are a quite simple domain; imagine modeling something like the Java class system. Things can get tricky fast, and it's good to have a few concrete cases in mind.</p>
</div>
</div>
<h3 id="run-the-examples"><a class="header" href="#run-the-examples">Run the examples</a></h3>
<p>Click the run button, and Forge will check that all of the examples satisfy (or dissatisfy) the <code>wellformed</code> predicate. One fails, but why? Notice two things:</p>
<ul>
<li>The failing example is a <em>negative</em> one. We expected this instance to be ruled out by <code>wellformed</code>, but it was not. This points to a potential <em>under</em>-constraint bug in <code>wellformed</code>. </li>
<li>We intended the example to fail because it contains separate, disconnected trees. This gives us a hint about the nature of the missing constraint. Except...</li>
</ul>
<p>We already added a constraint that forces connectivity. Didn't we? </p>
<pre><code class="language-forge editable">  all disj n1, n2: Node | (not isRoot[n1] and not isRoot[n2]) implies {
    some anc: Node | reachable[n1, anc, left, right] and 
                     reachable[n2, anc, left, right] }
</code></pre>
<p>So what's the problem? </p>
<details>
<summary>Think, then click!</summary>
<p>This constraint only applies for pairs of <em>non-root</em> nodes. That is, any two non-root nodes must have a common parent. So we ruled out forests of separate, bushy <em>trees</em>, but we neglected to exclude isolated roots!</p>
</details>
<hr />
<p>In modeling, it's common for there to be a few ways to fix problems like this. We could go back and edit the constraint we wrote before, or we could write a new constraint to handle roots. In <em>this</em> case, let's edit the original. We said that any two non-roots have a common ancestor. Why did we say &quot;non-root&quot;? Because if one of the nodes happened to be a root, it would have no such ancestors. </p>
<p>What if we allowed the node itself to count as the common ancestor? Then we would have two obligations (as before), but each would have another way to become true. </p>
<pre><code class="language-forge editable">  -- for _any_ pair of nodes, there is some ancestor node, such that...
  all disj n1, n2: Node | {
    some anc: Node | { 
      -- either n1 is the ancestor itself, or the ancestor reaches n1...
      ((n1 = anc) or reachable[n1, anc, left, right])
      -- ...and either n2 is the ancestor itself, or the ancestor reaches n2
      ((n2 = anc) or reachable[n2, anc, left, right]) 
    } }
</code></pre>
<p>Now all of our examples pass. While that doesn't mean the constraints are exactly right yet, it does increase our confidence in them. </p>
<h2 id="view-some-instances"><a class="header" href="#view-some-instances">View some instances</a></h2>
<p>Before we move on, let's at least look at some new instances of <code>wellformed</code>, as generated by Forge. By viewing a few of these, we can often spot issues in the initial stages of a model. </p>
<pre><code>-- View a tree or two
run {wellformed} for exactly 8 Node
</code></pre>
<!-- Note: custom visualization is _bad_ for this, because it may hide the problem due to 
     structural assumptions it makes. -->
<p>The <code>run</code> command searches for instances that satisfy the constraints it is given, and then automatically opens the visualizer to explore those instances. </p>
<div id="admonition-visualization" class="admonition admonish-tip">
<div class="admonition-title">
<p>Visualization</p>
<p><a class="admonition-anchor-link" href="chapters/bst/bst.html#admonition-visualization"></a></p>
</div>
<div>
<p>By default, the visualizer will show nearly all relationships as arcs; e.g., the <code>key</code> field of each node will be shown as an arc from the node to the (numeric) key. If you want, you can clean this up a bit by opening the <code>Theme</code> drawer, selecting the <code>key</code> field, and checking to view the field as an attribute.</p>
</div>
</div>
<p>Here's something you might see in one of the instances:</p>
<p><img src="chapters/bst/same-left-right.png" alt="A fragment of an instance visualization, showing a node whose left and right children are the same" /></p>
<p>This doesn't look right, does it? We have a node whose left and right child are the same; that's not tree-like. Again, we have an <em>under</em>-constraint bug: there's some instance(s) that are permitted by <code>wellformed</code>, but shouldn't be. In fact, we completely forgot to add a constraint like:</p>
<pre><code class="language-forge editable">  -- left+right differ (unless both are empty)
  all n: Node | some n.left =&gt; n.left != n.right 
</code></pre>
<p>With that constraint added to <code>wellformed</code>, we don't see any more wrong-looking binary trees.</p>
<h2 id="validation"><a class="header" href="#validation">Validation</a></h2>
<p>So far we've tested our model in two ways:</p>
<ul>
<li>checking that specific instances satisfy, or don't satisfy, a Forge predicate; and </li>
<li>manually viewing generated instances. 
In Forge, we have recourse to more powerful techniques. </li>
</ul>
<p>Notice that, when we were writing <code>binary_tree</code>, we never said explicitly that there must be a single unique root in the instance. It should be true, of course, that such a root exists and is unique. But that is (or should be!) a <em>consequence</em> of what we wrote. In Forge, this is easy to test:</p>
<pre><code class="language-forge editable">-- Run a test: our predicate enforces a unique root exists (if any node exists)
pred unique_root {   
  no Node or {
    one root: Node | 
      all other: Node-root | other in descendantsOf[root]}}
assert binary_tree is sufficient for unique_root for 5 Node  
</code></pre>
<p>This passes; there is no counterexample using fewer than than 6 Nodes. Our confidence increases.</p>
<div id="admonition-different-ways-of-writing-predicates" class="admonition admonish-note">
<div class="admonition-title">
<p>Different ways of writing predicates</p>
<p><a class="admonition-anchor-link" href="chapters/bst/bst.html#admonition-different-ways-of-writing-predicates"></a></p>
</div>
<div>
<p>You might be thinking that we could have just added the unique-root property as a constraint to <code>wellformed</code> directly! That's a reasonable thought, and it's true that we could have. I left it out deliberately here, for a few reasons:</p>
<ul>
<li>It's usually a good idea to not overload predicates with constraints that are really unnecessary. There's some wiggle room here in the service of making your model robust, but if we had added every possible property we could think of for a tree to have, the predicate would have become quite unwieldy, harder to understand, and (vitally) harder to debug. </li>
<li>When we start modeling, we often don't know exactly what we want. Sure, we might be able to describe it in broad terms, but 
and, of course...</li>
<li>it allowed demonstration of this general technique: checking that one predicate enforces another.</li>
</ul>
</div>
</div>
<p>Now our model is looking pretty good, although we haven't yet added the &quot;search&quot; part of &quot;binary search tree&quot;.</p>
<h2 id="more-domain-predicates-search-invariants"><a class="header" href="#more-domain-predicates-search-invariants">More Domain Predicates: Search Invariants</a></h2>
<p>Let's express our two alternative BST invariants. As a reminder, they were: </p>
<p><strong>Version 1</strong> For all nodes <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>:</p>
<ul>
<li>all left-descendants of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> have a key less than <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>'s key; and </li>
<li>all right-descendants of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> have a key greater than or equal to <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>'s key.</li>
</ul>
<p><strong>Version 2</strong> For all nodes <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>:</p>
<ul>
<li>the left child of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> (if any) has a key less than <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>'s key; and </li>
<li>the right child of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> (if any) has a key greater than or equal to <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>'s key.</li>
</ul>
<p>Notice that both are phrased in terms of single nodes, and should apply to all nodes. For convenience, we'll split these up into 2 predicates each: one to represent the per-node requirement, and another to represent the global requirement. </p>
<pre><code class="language-forge editable">pred invariant_v1[n: Node] {
  -- &quot;Every node's left-descendants...&quot; (if any)
  some n.left =&gt; {
    n.left.key &lt; n.key
    all d: Node | reachable[d, n.left, left, right] =&gt; d.key &lt; n.key
  }
  -- &quot;Every node's right-descendants...&quot; (if any)
  some n.right =&gt; {
    n.right.key &lt; n.key
    all d: Node | reachable[d, n.right, left, right] =&gt; d.key &gt; n.key
  }
}
pred binary_search_tree_v1 {
  binary_tree  -- a binary tree, with an added invariant
  all n: Node | invariant_v1[n]  
}
</code></pre>
<p>Here's the same pair of predicates for the second (<em>wrong</em>) invariant:</p>
<pre><code class="language-forge editable">pred invariant_v2[n: Node] {
  -- &quot;Every node's immediate children...&quot;
  some n.left implies n.left.key &lt; n.key
  some n.right implies n.right.key &gt; n.key
}
pred binary_search_tree_v2 {
  binary_tree  -- a binary tree, with an added invariant
  all n: Node | invariant_v2[n]
}
</code></pre>
<h3 id="semantic-differencing"><a class="header" href="#semantic-differencing">Semantic Differencing</a></h3>
<p>Forge supports a useful trick: comparing the <em>meaning</em> of two different predicates. What do we mean by &quot;meaning&quot;? Suppose that we ran <code>diff</code> on the two versions above. We'd get a report of where the <em>text</em> of the two differed. But that isn't very informative; we'd really like to know <em>which actual binary trees</em> the two disagree on. That's a better way of understanding how the meaning of the two might differ, and start to grasp the consequences. </p>
<pre><code class="language-forge editable">-- Get examples of the difference between the two. Here we name the run &quot;bstdiff&quot;.
bstdiff: run {not { binary_search_tree_v1 iff binary_search_tree_v2}} for 5 Node 
-- But how do they differ? We'd expect the first invariant to be _stronger_ than the second:
v1_is_stronger: assert binary_search_tree_v1 is sufficient for binary_search_tree_v2 for 5 Node 
</code></pre>
<p>The <code>v1_is_strong</code> test passes. The <code>run</code> command produces an instance (actually many) where the two invariants disagree. The test, however, passes, indicating that version 1 is strictly more selective than version 2: no matter how many times we clicked &quot;Next&quot;, we'd only see trees where <code>binary_search_tree_v2</code> is satisfied but <code>binary_search_tree_v1</code> isn't.</p>
<div id="admonition-differencing-for-debugging" class="admonition admonish-tip">
<div class="admonition-title">
<p>Differencing for Debugging</p>
<p><a class="admonition-anchor-link" href="chapters/bst/bst.html#admonition-differencing-for-debugging"></a></p>
</div>
<div>
<p>This simple technique really is powerful. You might use it to check whether two versions of the same constraint are equivalent when debugging or optimizing your model. <strong>We'll use this idea in a few examples later, too.</strong></p>
</div>
</div>
<p>We'll return to binary search trees soon, to model how the recursive descent search works. That will let us see how the different invariants impact the correctness of search. But first, let's get a bit more experience with Forge.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="ripple-carry-adder"><a class="header" href="#ripple-carry-adder">Ripple-Carry Adder</a></h1>
<p>Let's model a third system in Froglet. We'll focus on something even more concrete, something that is implemented in <em>hardware</em>: a circuit for adding together two numbers called a <em>ripple-carry adder</em> (RCA). Along the way, even though the adder doesn't &quot;change&quot;, we'll still learn a useful technique for modeling systems that change over time. </p>
<p>To understand an RCA, let's first think about adding together a pair of one-bit numbers. We might draw a table with four rows to represent this:</p>
<div class="table-wrapper"><table><thead><tr><th>Input Bit A</th><th>Input Bit B</th><th>Result Bit</th></tr></thead><tbody>
<tr><td>0</td><td>0</td><td>0</td></tr>
<tr><td>0</td><td>1</td><td>1</td></tr>
<tr><td>1</td><td>0</td><td>1</td></tr>
<tr><td>1</td><td>1</td><td>2</td></tr>
</tbody></table>
</div>
<p>But, wait a moment. If we're building this into a circuit, and these inputs and outputs are single bits, we can't return <code>2</code> as the result. Similarly to how we might manually add <code>12345</code> and <code>67890</code> on paper, carrying a <code>1</code> in a few places...</p>
<center><img width="50%" src="chapters/adder/./Addition.png" style="background-color:white"/></center>
<p>Notice how, on paper, we sweep from right to left. That is, we handle the least-significant digits first. </p>
<p><strong>Exercise:</strong> Why is that? (Your first answer may be: &quot;Because that's how you do it.&quot; But hold yourself to a higher standard. Was there a good reason to start on the right, and move left, rather than the other way around?)</p>
<details>
<summary>Think, then click!</summary>
<p>Carrying! If we started to the left, we'd give answers for those digits prematurely. (To see this, try doing the above arithmetic by hand again, but starting on the left and moving right. You'll need to carry, as before, but it will be <em>too late!</em>)</p>
</details>
<hr />
<p>We need to carry a bit with value <code>1</code> in the <code>2s</code> place.</p>
<div class="table-wrapper"><table><thead><tr><th>Input Bit A</th><th>Input Bit B</th><th>Result Bit</th><th>Carry Bit (double value!)</th></tr></thead><tbody>
<tr><td>0</td><td>0</td><td>0</td><td>0</td></tr>
<tr><td>0</td><td>1</td><td>1</td><td>0</td></tr>
<tr><td>1</td><td>0</td><td>1</td><td>0</td></tr>
<tr><td>1</td><td>1</td><td>0</td><td>1</td></tr>
</tbody></table>
</div>
<p>Suppose we've built a circuit like the above; this is called a <em>full adder</em> (FullAdder).</p>
<div id="admonition-building-circuits" class="admonition admonish-note">
<div class="admonition-title">
<p>Building circuits</p>
<p><a class="admonition-anchor-link" href="chapters/adder/rca.html#admonition-building-circuits"></a></p>
</div>
<div>
<p>Exactly how we build that circuit is outside the scope of this example. Generally, we build them with logic gates: tiny devices that implement boolean operators like &quot;and&quot;, &quot;not&quot;, etc.</p>
</div>
</div>
<p>Now the question is: how do we build an adder that can handle numbers of the sizes that real computers use: 8-bit, 32-bit, or even 64-bit values? The answer is that we'll chain together multiple adder circuits like the above, letting the carry bits &quot;ripple&quot; forward as an extra, 3rd input to all the adders except the first one. E.g., if we were adding together a pair of 4-bit numbers—4 and 5, say—we'd chain together 4 adders like so:</p>
<center><img width="70%" src="chapters/adder/./rca.svg" style="background-color:white"/></center>
<p>Notice that each full adder accepts <em>3</em> input bits, just like in the above table: </p>
<ul>
<li>a bit from the first number;</li>
<li>a bit from the second number; and</li>
<li>a carry bit.</li>
</ul>
<p>Each full adder has <em>2</em> output bits:</p>
<ul>
<li>the value at this bit (1s place, 2s place, etc.); and </li>
<li>the carry bit, if applicable.</li>
</ul>
<p>Our task here is to model this circuit in Forge, and confirm that it actually works correctly. </p>
<div id="admonition-circuits-arent-easy" class="admonition admonish-note">
<div class="admonition-title">
<p>Circuits aren't easy</p>
<p><a class="admonition-anchor-link" href="chapters/adder/rca.html#admonition-circuits-arent-easy"></a></p>
</div>
<div>
<p>This might look &quot;obvious&quot;, but there are things that can go wrong even at this level. </p>
<p>If you've studied physics or electrical engineering, you might also see that this model won't match reality: it takes <em>time</em> for the signals to propagate between adders, and this delay can cause serious problems if the chain of adders is too long. We'll address that with a new, more sophisticated model, later.</p>
</div>
</div>
<h2 id="datatypes-2"><a class="header" href="#datatypes-2">Datatypes</a></h2>
<p>We'll start by defining a data type—<code>Digit</code>—for the wire values, which can be either <code>T</code> or <code>F</code> (short for &quot;true&quot; and &quot;false&quot;; you can also think of these as representing &quot;1&quot; and &quot;0&quot; or &quot;high&quot; and &quot;low&quot;).</p>
<pre><code class="language-forge editable">abstract sig Digit {}
one sig T, F extends Digit {}
</code></pre>
<p>Then we'll define a <code>sig</code> for full adders, which will be chained together to form the ripple-carry adder. We'll give each full adder fields representing its input bits and output bits:</p>
<pre><code class="language-forge editable">sig FullAdder { 
  -- input value bits 
  a_in, b_in: one Digit,  
  -- input carry bit
  carry_in: one Digit,
  -- output (sum) value
  sum_out: one Digit,
  -- output carry bit 
  carry_out: one Digit
}
</code></pre>
<div id="admonition-digit-is-not-the-same-as-boolean" class="admonition admonish-warning">
<div class="admonition-title">
<p><code>Digit</code> is not the same as boolean!</p>
<p><a class="admonition-anchor-link" href="chapters/adder/rca.html#admonition-digit-is-not-the-same-as-boolean"></a></p>
</div>
<div>
<p>Beware confusing the <code>Digit</code> sig we created, and the <code>T</code> and <code>F</code> values in it, with the result of evaluating Forge constraints. Forge doesn't &quot;know&quot; anything special about <code>T</code> or <code>F</code>; <code>Digit</code> is just another datatype. <strong>If we write something like <code>(some FullAdder) = T</code>, Forge will give an error message.</strong> This is because, to Forge, <code>T</code> is just another value we defined in the model. Instead, we write just <code>(some FullAdder)</code> to say &quot;there is some full adder in the instance&quot;. </p>
<p>This will come up again as we continue to develop the model.</p>
</div>
</div>
<p>Finally, we'll define the ripple-carry adder chain:</p>
<pre><code class="language-forge editable">one sig RCA {
  -- the first full adder in the chain
  firstAdder: one FullAdder,
  -- the next full adder in the chain (if any)
  nextAdder: pfunc FullAdder -&gt; FullAdder
}
</code></pre>
<div id="admonition-reminder" class="admonition admonish-note">
<div class="admonition-title">
<p>Reminder</p>
<p><a class="admonition-anchor-link" href="chapters/adder/rca.html#admonition-reminder"></a></p>
</div>
<div>
<p>Recall that a <code>pfunc</code> field is a partial function, sort of like a dictionary: every input is mapped to at most one output.</p>
</div>
</div>
<p>Notice that there is only ever one ripple-carry adder in an instance, and that it has fields that define which full adder comes first (i.e., operates on the <code>1</code>s place), and what the succession is. We will probably need to enforce what these mean once we start defining wellformedness. </p>
<h2 id="wellformedness"><a class="header" href="#wellformedness">Wellformedness</a></h2>
<p>What do we need to encode in a <code>wellformed</code> predicate? Right now, it seems that nothing has told Forge that <code>firstAdder</code> should really <em>be</em> the first adder, nor that <code>nextAdder</code> defines a linear path through all the full adders. So we should probably start with those two facts. </p>
<pre><code class="language-forge editable">pred wellformed {
  -- The RCA's firstAdder is &quot;upstream&quot; from all other FullAdders
  all fa: FullAdder | (fa != RCA.firstAdder) implies reachable[fa, RCA.firstAdder, RCA.nextAdder]
  -- there are no cycles in the nextAdder function.
  all fa: FullAdder | not reachable[fa, fa, RCA.nextAdder]  
}
</code></pre>
<p>Notice that we've used <code>implies</code> to limit the power of the <code>all</code> quantifier: it doesn't impose the reachability condition on <em>all</em> <code>FullAdder</code>s, but rather than all of them except for <code>RCA.firstAdder</code>. This is a common pattern when you want to assert something is true, but only contingently. </p>
<div id="admonition-case-sensitivity-and-variable-names" class="admonition admonish-tip">
<div class="admonition-title">
<p>Case sensitivity and variable names</p>
<p><a class="admonition-anchor-link" href="chapters/adder/rca.html#admonition-case-sensitivity-and-variable-names"></a></p>
</div>
<div>
<p>In our model so far, <code>FullAdder</code> is the name of a datatype. When writing the constraints above, I said: &quot;for every full adder...&quot; and named this arbitrary adder <code>fa</code>. These two, <code>FullAdder</code> and <code>fa</code> are different. For a start, <code>FullAdder</code> is defined within the entire model, but <code>fa</code> is only defined within the scope of the <code>all</code> quantifier.</p>
</div>
</div>
<p>We've used the <code>reachable</code> helper before, but it's worth mentioning again: <code>A</code> is reachable from <code>B</code> via <em>one or more applications</em> of <code>f</code> if and only if <code>reachable[A, B, f]</code> is true. That &quot;one or more applications&quot; is important, and is why we needed to add the <code>(fa != RCA.firstAdder) implies</code> portion of the first constraint: <code>RCA.firstAdder</code> shouldn't be the successor of any full adder, and if it were its own successor, that would be a cycle in the line of adders. If we had left out the implication, and written just <code>all fa: FullAdder | reachable[fa, RCA.firstAdder, RCA.nextAdder]</code>, <code>RCA.firstAdder</code> would need to have a predecessor, which would contradict the second constraint.</p>
<h2 id="more-predicates"><a class="header" href="#more-predicates">More Predicates</a></h2>
<p>Before we write some examples for <code>wellformed</code>, let's also try to model how each adder should behave, given that it's wired up to other adders in this specific order. Let's write a couple of helpers first, and then combine them to describe the behavior of each adder, given its place in the sequence.</p>
<h3 id="when-is-an-adders-output-bit-set-to-true"><a class="header" href="#when-is-an-adders-output-bit-set-to-true">When is an adder's output bit set to true?</a></h3>
<p>Just like <code>pred</code>icates can be used as boolean-valued helpers, <code>fun</code>ctions can act as helpers for arbitrary return types. Let's try to write one that says what the <em>output</em> bit should be for a specific full adder, given its input bits. </p>
<pre><code class="language-forge">// Helper function: what is the output sum bit for this full adder?
fun adder_S_RCA[f: one FullAdder]: one Digit  {
  // Our job is to fill this in with an expression for the output sum bit
} 
</code></pre>
<p>Looking at the table above, the adder's output value is true if and only if an odd number of its 3 inputs is true. That gives us 4 combinations:</p>
<ul>
<li><code>A</code>, <code>B</code>, and <code>CIN</code> (all 3 are true);</li>
<li><code>A</code> only (1 is true); </li>
<li><code>B</code> only (1 is true); or</li>
<li><code>CIN</code> only (1 is true). </li>
</ul>
<p>This is where we need to remember that the sig <code>T</code> is not a Forge formula yet; to make it into one, we need to explicitly test whether each value is equal to <code>T</code>. We'll use two new Forge constructs to write the function body:</p>
<ul>
<li>The <code>let</code> construct makes it easier to write the value for each of these wires. A <code>let</code> looks similar to a quantifier, but it only introduces some local helper syntax. If I write <code>let A = (f.a_in = T) | ...</code>, I can then use <code>A</code> in place of the tedious <code>(f.a_in = T)</code>. </li>
<li>Expression if-then-else lets us produce a value based on a condition, sort of like the <code>C ? X : Y</code> operator in languages like JavaScript. If I write something like <code>(A and B and C) =&gt; T else F</code> this evaluates to <code>T</code> whenever <code>A</code>, <code>B</code>, and <code>C</code> are all true, and <code>F</code> otherwise.</li>
</ul>
<p>Now we can write:</p>
<pre><code class="language-forge">// Helper function: what is the output bit for this full adder?
fun adder_S_RCA[f: one FullAdder]: one Digit  {
  // &quot;T&quot; and &quot;F&quot; are values, we cannot use them as Forge formulas. 
  let A = (f.a_in = T), B = (f.b_in = T), CIN = (f.carry_in = T) |
   -- Expression if-then-else: if any of these conditions holds...
	 ((     A  and      B  and      CIN)  or 
    (     A  and (not B) and (not CIN)) or 
    ((not A) and      B  and (not CIN)) or 
    ((not A) and (not B) and      CIN))
      -- ...then T...
	 	  =&gt;   T
      -- ...otherwise F.
      else F
} 
</code></pre>
<div id="admonition-couldnt-we-have-just-used-a-pred-here" class="admonition admonish-tip">
<div class="admonition-title">
<p>Couldn't we have just used a <code>pred</code> here?</p>
<p><a class="admonition-anchor-link" href="chapters/adder/rca.html#admonition-couldnt-we-have-just-used-a-pred-here"></a></p>
</div>
<div>
<p>It might be a bit strange to write a helper function that returns a <code>Digit</code>, rather than a predicate directly. We could make a <code>pred</code> work, but we'd still have to eventually use <code>T</code> and <code>F</code> somewhere, since they are the values that the output bits can take on.</p>
</div>
</div>
<div id="admonition-is-the-blank-space-in-that-example-significant" class="admonition admonish-note">
<div class="admonition-title">
<p>Is the blank space in that example significant?</p>
<p><a class="admonition-anchor-link" href="chapters/adder/rca.html#admonition-is-the-blank-space-in-that-example-significant"></a></p>
</div>
<div>
<p>Nope. I added it for clarity, because it's much harder to read without the extra space to make it apparent where the <code>not</code>s are applied. Likewise, you don't need to wrap a negation in parentheses; I just think <code>(not A)</code> is clearer than <code>not A</code> in this sort of big expression.</p>
</div>
</div>
<div id="admonition-implies-and-expression-if-then-else" class="admonition admonish-tip">
<div class="admonition-title">
<p>Implies and expression if-then-else</p>
<p><a class="admonition-anchor-link" href="chapters/adder/rca.html#admonition-implies-and-expression-if-then-else"></a></p>
</div>
<div>
<p>You can also write <code>implies</code> as <code>=&gt;</code>. Indeed, the two keywords (<code>=&gt;</code> and <code>implies</code>) are interchangeable in Forge! To avoid confusion, always ask yourself whether you are trying to identify a <em>thing</em> in an instance, like a full-adder atom or an integer, or write a <em>constraint</em> which may or may not be true in an instance.</p>
</div>
</div>
<h3 id="when-is-an-adders-carry-bit-set-to-true"><a class="header" href="#when-is-an-adders-carry-bit-set-to-true">When is an adder's carry bit set to true?</a></h3>
<p>This one is quite similar. The carry bit is set to true if and only if 2 or 3 of the adder's inputs are true:</p>
<ul>
<li><code>B</code> and <code>CIN</code> (2 are true);</li>
<li><code>A</code> and <code>CIN</code> (2 are true); </li>
<li><code>C</code> and <code>CIN</code> (2 are true); or</li>
<li><code>A</code>, <code>B</code>, and <code>CIN</code> (all 3 are true). 
As before, we'll use <code>let</code> and expression if-then-else, and add (decorative) blank space to make the function more readable.</li>
</ul>
<pre><code class="language-forge">// Helper function: what is the output carry bit for this full adder?
fun adder_cout_RCA[f: one FullAdder]: one Digit {
 let A = (f.a_in = T), B = (f.b_in = T), CIN = (f.carry_in = T) |
     (((not A) and      B  and      CIN) or 
      (     A  and (not B) and      CIN) or 
      (     A  and      B  and (not CIN)) or 
      (     A  and      B  and      CIN)) 
	      =&gt;   T
        else F
} 
</code></pre>
<h3 id="adder-behavior"><a class="header" href="#adder-behavior">Adder Behavior</a></h3>
<p>Finally, what ought an adder's behavior to be? Well, we need to specify its output bits in terms of its input bits. We'll also add a constraint that says the full adders are connected in a line. More concretely, if there <em>is</em> a successor, its input carry bit is equal to the current adder's output carry bit. Here's a picture of what we want to say:</p>
<p><strong>TODO: fill picture</strong></p>
<p>And here's the Forge predicate:</p>
<pre><code class="language-forge">pred fullAdderBehavior[f: FullAdder] {
  -- Each full adder's outputs are as expected
  f.sum_out = adder_S_RCA[f]
  f.carry_out = adder_cout_RCA[f]
  -- Full adders are chained appropriately
  (some RCA.nextAdder[f]) implies (RCA.nextAdder[f]).carry_in = f.carry_out 
}
</code></pre>
<div id="admonition-wouldnt-it-be-better-to-put-the-carry-bit-connection-in-wellformed-or-somewhere-else" class="admonition admonish-note">
<div class="admonition-title">
<p>Wouldn't it be better to put the carry-bit connection in <code>wellformed</code>, or somewhere else?</p>
<p><a class="admonition-anchor-link" href="chapters/adder/rca.html#admonition-wouldnt-it-be-better-to-put-the-carry-bit-connection-in-wellformed-or-somewhere-else"></a></p>
</div>
<div>
<p>That's a good point. The values of <code>f.sum_out</code> and <code>f.carry_out</code> are part of the full adder's behavior, but the way the wires are connected in <code>RCA.nextAdder</code> is not. </p>
<p>If I were going to re-write this model, I would probably move that line into somewhere that is responsible for <em>connecting</em> the adders: perhaps a predicate for the ripple-carry adder. But I haven't done that—hoping to provoke just this question!</p>
<p>The general design principle here is to think about <em>compositionality and reuse</em>: we'd like to be able to use the same predicates to reason about full adders by themselves, or what would happen if we connected them differently. As written, the <code>fullAdderBehavior</code> predicate doesn't allow for that; we'd have to refactor it. But I'll leave that as an exercise for now.</p>
</div>
</div>
<p>Finally, we'll make a predicate that describes the behavior of the overall ripple-carry adder: </p>
<pre><code>// Top-level system specification: compose preds above
pred rca {  
  wellformed
  all f: FullAdder | fullAdderBehavior[f] 
}
</code></pre>
<div id="admonition-notice-what-weve-done" class="admonition admonish-note">
<div class="admonition-title">
<p>Notice what we've done.</p>
<p><a class="admonition-anchor-link" href="chapters/adder/rca.html#admonition-notice-what-weve-done"></a></p>
</div>
<div>
<p>Here's something to keep in mind for when we start the next chapter. By wiring together full adders into a sequence via the <code>rca</code> predicate, we are now implicitly hinting at time in our model: signal flows through each adder, in order, over time. We'll re-use this same technique in the next chapter to combine different system states into a succession of them that represents a complete run of the system.</p>
</div>
</div>
<p>Now we're ready to write some examples. We'll make a pair of examples for <code>wellformed</code> and an overall example for the full system. In practice, we'd probably want to write a couple of examples for <code>fullAdderBehavior</code> as well, but we'll leave those out for brevity. </p>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<p>Always try to write at least some positive <em>and</em> negative examples.</p>
<h3 id="positive-example"><a class="header" href="#positive-example">Positive Example</a></h3>
<pre><code class="language-forge">example twoAddersLinear is {wellformed} for {
  RCA = `RCA0 
  FullAdder = `FullAdder0 + `FullAdder1
  -- Remember the back-tick mark here! These lines say that, e.g., for the atom `RCA0, 
  -- its firstAdder field contains `FullAdder0. And so on.
  `RCA0.firstAdder = `FullAdder0
  `RCA0.nextAdder = `FullAdder0 -&gt; `FullAdder1
}
</code></pre>
<div id="admonition-notice-that-this-example-is-limited" class="admonition admonish-tip">
<div class="admonition-title">
<p>Notice that this example is limited.</p>
<p><a class="admonition-anchor-link" href="chapters/adder/rca.html#admonition-notice-that-this-example-is-limited"></a></p>
</div>
<div>
<p>Because we are testing <code>wellformed</code>, we left out fields that didn't matter to that predicate. Forge will feel free to adjust them as needed. When a field is left unspecified, the example is said to be <em>partial</em>, and it becomes a check for consistency. E.g., in this case, the example passes because the partial instance given <em>can</em> satisfy <code>wellformed</code>—not that it must satisfy <code>wellformed</code>—although in this case the difference is immaterial because <code>wellformed</code> really doesn't care about any of the other fields.</p>
</div>
</div>
<h3 id="negative-example"><a class="header" href="#negative-example">Negative Example</a></h3>
<pre><code class="language-forge">example twoAddersLoop is {not wellformed} for {
  RCA = `RCA0 
  FullAdder = `FullAdder0 + `FullAdder1
  `RCA0.firstAdder = `FullAdder0
  `RCA0.nextAdder = `FullAdder0 -&gt; `FullAdder1 + `FullAdder1 -&gt; `FullAdder0
}
</code></pre>
<h2 id="run"><a class="header" href="#run">Run</a></h2>
<p>Let's have a look at a ripple-carry adder in action. We'll pick a reasonably small number of bits: 4. </p>
<pre><code class="language-forge">run {rca} for exactly 4 FullAdder
</code></pre>
<p><strong>(FILL: screenshot)</strong></p>
<h2 id="verification"><a class="header" href="#verification">Verification</a></h2>
<p>Ok, we've looked at some of the model's output, and it seems right. But how can we be really confident that the ripple-carry adder <em>works</em>? Can we use our model to <em>verify</em> the adder? Yes, but we'll need to do a bit more modeling. </p>
<p><strong>Exercise:</strong> What does it mean for the adder to &quot;work&quot;? </p>
<details>
<summary>Think, then click!</summary>
<p>For one thing, it had better produce a series of boolean outputs that correspond to the output we'd get if we just did the addition. That is, if we add together the numbers <code>2</code> (<code>10</code>) and <code>3</code> (<code>11</code>) we should expect to get <code>5</code>—which should be <code>101</code> in binary, provided we always set the bit-width high enough to match the number of bits we're adding together. </p>
<p>Let's augment our model to check this. We'll ask Forge for an instance where the ripple-carry adder produces a different result (taken as the sum of the outputs of each full adder) than the expected (produced via Forge's <code>add</code> function). </p>
</details>
<hr />
<p>When I'm expanding a model in this way, I like to augment instances with extra fields that exist <em>just for verification</em>, and which aren't part of the system we're modeling. Here, we'll keep track of the place-values of each full adder, which we can then use to compute the &quot;true&quot; value of its input or output. E.g., the first full adder would have place-value 1, and its successors would have place-value 2, then 4, etc. </p>
<div id="admonition-helper-values" class="admonition admonish-note">
<div class="admonition-title">
<p>Helper values</p>
<p><a class="admonition-anchor-link" href="chapters/adder/rca.html#admonition-helper-values"></a></p>
</div>
<div>
<p>Sometimes you'll hear this sort of new field or value referred to as a &quot;ghost&quot;: it isn't real; it doesn't exist in the actual system.</p>
</div>
</div>
<p>We could store this field in the <code>FullAdder</code> sig, but let's keep the original unmodified, and instead add a <code>Helper</code> sig. This keeps the for-verification-only fields separate from the model of the system:</p>
<pre><code class="language-forge">one sig Helper {
  place: func FullAdder -&gt; Int
}
</code></pre>
<p>The ripple-carry adder gives us the context we need to speak of the place value each full adder ought to have. We can write this for the first adder easily:</p>
<pre><code class="language-forge">-- The &quot;places&quot; helper value should agree with the ordering that the RCA establishes.
pred assignPlaces {
  -- The least-significant bit is 2^0
  Helper.place[RCA.firstAdder] = 1
  -- ...
}
</code></pre>
<p>Now we need to, in effect, write a for-loop or a recursive function that constrains <code>places</code> for all the other adders. But Forge has no recursion or loops! Fortunately, it does have the <code>all</code> quantifier, which lets us define every other adder's <code>place</code> value in terms of its predecessor:</p>
<pre><code class="language-forge">-- The &quot;places&quot; helper value should agree with the ordering that the RCA establishes.
pred assignPlaces {
  -- The least-significant bit is 2^0
  Helper.place[RCA.firstAdder] = 1
  -- Other bits are worth 2^(i+1), where the predecessor is worth 2^i.
  all fa: FullAdder | some RCA.nextAdder[fa] =&gt; {    
    Helper.place[RCA.nextAdder[fa]] = multiply[Helper.place[fa], 2]
  }
}
</code></pre>
<p>When you have quantification and helper fields, you can often avoid needing real iteration or recursion.</p>
<p>We'll add a helper function for convenience later:</p>
<pre><code class="language-forge">fun actualValue[b: Digit, placeValue: Int]: one Int {
  (b = T) =&gt; placeValue else 0
}
</code></pre>
<h3 id="the-requirement"><a class="header" href="#the-requirement">The Requirement</a></h3>
<p>Let's try to express our requirement that the adder is correct. Again, we'll phrase this as: for every full adder, the true value of its output is the sum of the true values of its inputs (where &quot;true value&quot; means the value of the boolean, taking into account its position). We might produce something like this:</p>
<pre><code class="language-forge">pred req_adderCorrect_wrong {
  (rca and assignPlaces) implies {
    all fa: FullAdder | { 
        actualValue[fa.sum_out, Helper.place[fa]] = add[actualValue[fa.a_in, Helper.place[fa]], 
                                                  actualValue[fa.b_in, Helper.place[fa]]]
    }
  }
}
</code></pre>
<p>And then we'll use it in a test. It's vital that we have a high-enough bitwidth, so that Forge can count up to the actual expected result, without overflowing. Forge <code>int</code>s are signed, so we actually need a bigger bit-width than the number of full adders. If we have, say, 6 full adders, we might end up producing a 7-bit output (with carrying). A 7-bit value can conservatively hold up to <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">7</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">127</span></span></span></span>. To count up to that high, we need to use <em>8</em> bits in Forge, giving the solver all the numbers between <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">−</span><span class="mord">128</span></span></span></span> and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">127</span></span></span></span>, inclusive.</p>
<div id="admonition-directly-testing-satisfiability" class="admonition admonish-tip">
<div class="admonition-title">
<p>Directly testing satisfiability</p>
<p><a class="admonition-anchor-link" href="chapters/adder/rca.html#admonition-directly-testing-satisfiability"></a></p>
</div>
<div>
<p>So far, we've only seen <code>example</code>s and <code>assert</code>ions. Both of these are built using Forge's basic satisfiability checking. We can access this directly using the <code>test expect</code> feature. You can write that a run:</p>
<ul>
<li>should have instances (i.e., be satisfiable): <code>is sat</code>;</li>
<li>should not have instances (i.e., be unsatisfiable, within the bounds given): <code>is unsat</code>; or</li>
<li>should have no counterexample instances (within the bounds given): <code>is theorem</code>.</li>
</ul>
</div>
</div>
<pre><code class="language-forge">-- Ask Forge to check the satisfiability of something...
test expect {  
  -- Is it _always_ true, up to these bounds, that `req_adderCorrect` always holds?
  r_adderCorrect: {req_adderCorrect} for 6 FullAdder, 1 RCA, 8 Int is theorem
}
</code></pre>
<p>However, this requirement fails—Forge finds a counterexample. </p>
<p><strong>Exercise:</strong> What's wrong? Is the adder broken, or might our property be stated incorrectly?</p>
<details>
<summary>Think, then click!</summary>
<p>We forgot to take carrying into account! Any time a full adder carries a bit, it's dropped by the left-hand side of the above equation. </p>
<p>Notice how even if the model (or system) is correct, sometimes the property itself is wrong. Always be skeptical about your properties, just like you're skeptical about your model.</p>
</details>
<hr />
<p>Here's another attempt:</p>
<pre><code class="language-forge">pred req_adderCorrect {
  (rca and assignPlaces) implies {
    all fa: FullAdder | { 
        -- Include carrying, both for input and output. The _total_ output's true value is equal to
        -- the the sum of the total input's true value.

        -- output value bit + output carry bits; note carry value is *2 (and there may not be a &quot;next adder&quot;)
        add[actualValue[fa.sum_out, Helper.place[fa]], 
            multiply[actualValue[fa.carry_out, Helper.place[fa]], 2]] 
        = 
        -- input a bit + input b bit + input carry bit
        add[actualValue[fa.a_in, Helper.place[fa]],     
            actualValue[fa.b_in, Helper.place[fa]],    
            actualValue[fa.carry_in, Helper.place[fa]]]  
    }
  }
}
</code></pre>
<p>Now when we run the check, it passes. There's just one problem—it only passes <em>eventually</em>. The verification step took over a minute on my laptop! That's rather slow for a model this size. </p>
<h3 id="optimizing-verification"><a class="header" href="#optimizing-verification">Optimizing Verification</a></h3>
<p>When this sort of unexpected slowdown happens, it's often because we've given the solver too much freedom, causing it to explore a much larger search space than it should have to. This is especially pronounced when we expect an &quot;unsatisfiable&quot; result—then, the solver really does need to explore <em>everything</em> before concluding that no, there are no solutions. We're in that situation here, since we're hoping there are no counter-examples to correctness. </p>
<p><strong>Exercise:</strong> What did we leave the solver to figure out on its own, that we maybe could give it some help with?</p>
<details>
<summary>Think, then click!</summary>
<p>There are at least two things. </p>
<ul>
<li>First, the exact ordering of full adders isn't something we provided. We just said &quot;create up to 6 of them, and wire them together in a line&quot;. Considering just the 6-adder case (and not the 5-adder case, 4-adder case, etc.), how many ways are there to arrange the adders? <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">6</span><span class="mclose">!</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">720</span></span></span></span>. Unless the solver can detect and eliminate these symmetries, it's doing a <em>lot</em> more work than it needs to. </li>
<li>Second, we said that <code>Helper.place</code> mapped full adders to integers. But does the solver need to consider <em>all</em> integers? No! Just <code>1</code>, <code>2</code>, <code>4</code>, <code>8</code>, and so on. The vast majority of integers in the scope we provided cannot be used—and the solver will have to discover that on its own.</li>
</ul>
</details>
<hr />
<p>These both present opportunities for optimization! For now, let's just tackle the first one: we need to somehow give Forge a specific ordering on the adders, rather than letting the solver explore all possible orderings. E.g., maybe we want a series of atoms <code>FullAdder0</code>, <code>FullAdder1</code>, ..., <code>FullAdder5</code>, which ordering <code>RCA.nextAdder</code> respects. </p>
<p>We could try to express this as a constraint: </p>
<pre><code class="language-forge">pred orderingOnAdders {
  some disj fa0, fa1, fa2, fa3, fa4, fa5: FullAdder | {
    RCA.firstAdder = fa0
    RCA.nextAdder[fa0] = fa1 
    RCA.nextAdder[fa1] = fa2
    RCA.nextAdder[fa2] = fa3 
    RCA.nextAdder[fa3] = fa4 
    RCA.nextAdder[fa4] = fa5 
  }
}
</code></pre>
<p>However, this won't be very effective. </p>
<p><strong>Exercise:</strong> Why won't adding <code>orderingOnAdders</code> to our set of constraints actually help much, if at all? </p>
<details>
<summary>Think, then click!</summary>
<p>Because all of that is already implied by the other constraints we have. It's true that sometimes rephrasing a constraint like this can have a big impact on performance if the solver can figure out how to use it well, but in this case the problem is one of symmetries; the solver would <em>just keep checking all possibilities</em> for the <code>fa0</code>, <code>fa1</code>, etc. variables anyway. </p>
<p>Fortunately, there's a much better option. </p>
</details>
<hr />
<p>Recall that Forge works by searching for satisfying instances within some large possibility space, and that this space is restricted by the bounds given. The search process is run by a sophisticated solver, but the problem that the solver itself gets looks nothing like Forge. The process of solving a Forge problem thus has three separate stages: </p>
<ul>
<li>express the solution space in a form the solver understands, which is usually a large set of boolean variables; </li>
<li>convert the constraints into a form the solver understands, which needs to be in terms of the converted solution-space variables; and only then</li>
<li>invoke the solver on the converted problem.</li>
</ul>
<p>Adding constraints will affect the later steps, but we'd love to give hints to the translator even earlier in the process. We'll talk more about exactly how this works later, but for now, we'll add a <em>bounds annotation</em> to our run: that the <code>nextAdder</code> field is <em>partial-linear</em>, or <code>nextAdder is plinear</code>. Linearity means that the atoms which <code>nextAdder</code> maps should be pre-arranged in a fixed order before they get to the solver at all. Partial linearity means that the ordering may not use all of the potential atoms. </p>
<pre><code class="language-forge">test expect {  
  r_adderCorrect: {req_adderCorrect} for 6 FullAdder, 1 RCA, 8 Int for {nextAdder is plinear} is theorem
}
</code></pre>
<p>This wasn't hard to add: it's just another <code>{}</code>-delimited instruction that you can add to any <code>run</code>, <code>test</code>, etc. command. Now Forge finishes the check in under a second on my laptop. Eliminating symmetries can make a huge difference! </p>
<div id="admonition-bounds-vs-constraints" class="admonition admonish-warning">
<div class="admonition-title">
<p>Bounds vs. Constraints</p>
<p><a class="admonition-anchor-link" href="chapters/adder/rca.html#admonition-bounds-vs-constraints"></a></p>
</div>
<div>
<p>Notice that the bounds annotation is grouped after the numeric bounds, <em>not</em> with the constraints. This is because the two are separate. If we had tried to put <code>nextAdder is plinear</code> in as a constraint in our predicate, we would have gotten an error, because Forge doesn't know how to interpret it as a constraint, only how to use it to shape the solution space passed to the solver.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="anticipated-questions-static-models"><a class="header" href="#anticipated-questions-static-models">Anticipated Questions: Static Models</a></h1>
<h3 id="what-happens-when-forge-searches"><a class="header" href="#what-happens-when-forge-searches">What Happens When Forge Searches?</a></h3>
<p>Our first <code>run</code> command in Forge was from <a href="chapters/qna/../ttt/ttt.html">tic-tac-toe</a>: <code>run { some b: Board | wellformed[b]}</code>.</p>
<p>How did Forge actually run the search? Surely it isn't checking all possible boards <em>one at a time</em>; that wouldn't scale at all, and we need to scale in order to model and reason about real systems. No; Forge can efficiently search much larger problem spaces than this.</p>
<p>Let's step through <em>how</em> Forge solves a problem. First, there's a space of potential solutions that it considers. Using the default engine, this space is finite—although possibly enormous. There are <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">3</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">9</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">19683</span></span></span></span> 3-by-3 tic-tac-toe boards, which isn't too bad. But a 4-by-4 board would have <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">3</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">16</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord">430</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">467</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">213</span></span></span></span> possibilities, and real systems might have more possible states than electrons in the observable universe. So we'd better be doing something smarter than checking one instance at a time.</p>
<p>The bounds of the space to search is set by the <code>run</code> command. In this case, no bounds were given, so defaults were used: instances may contain <em>up to 4 atoms of each top-level <code>sig</code> type</em>, and the integers <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">−</span><span class="mord">8</span></span></span></span> through <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">7</span></span></span></span> (inclusive) but no more. We can adjust that bound by adding instructions, e.g., <code>run { some b: Board | wellformed[b]} for exactly 2 Board</code> will only seek instances where there are 2 <code>Board</code> atoms. </p>
<p>The bounds describe the search space. This space is populated with instances, some of which satisfy the constraints being run and some of which don't. In principle, there exist other instances too—entirely outside the space being searched! E.g., if we said to search up to 4 <code>Board</code> atoms, an instance with 100 such atoms might (or might not) satisfy our constraints, but wouldn't be considered in the search:</p>
<center><img width="70%" src="chapters/qna/./solving.svg" style="background-color:white"/></center>
<p>Once this space is defined, <strong>and only then</strong>, a sophisticated constraint-solving engine—a boolean &quot;SAT&quot; or &quot;SMT&quot; solver—takes charge. The engine uses techniques like backtracking and heuristics to try to avoid unnecessary work in solving the problem. This divides the search space into &quot;satisfying&quot; and &quot;not satisfying&quot; areas. The solver returns the satisfying instances in some order:</p>
<center><img width="70%" src="chapters/qna/./partitioned.svg" style="background-color:white"/></center>
<div id="admonition-csci-1710" class="admonition admonish-note">
<div class="admonition-title">
<p>CSCI 1710</p>
<p><a class="admonition-anchor-link" href="chapters/qna/static.html#admonition-csci-1710"></a></p>
</div>
<div>
<p>If you're in CSCI 1710, one of your assignments will be to <em>build</em> such a constraint solver, and even to see how it performs &quot;plugged in&quot; to Forge and solving real <code>run</code> commands you write.</p>
</div>
</div>
<!-- ![](https://i.imgur.com/eQ76Hv8.png) -->
<h4 id="performance-implications"><a class="header" href="#performance-implications">Performance Implications</a></h4>
<p>As you may have seen in the ripple-carry adder section, these two phases of solving work very differently, and  letting the solver infer constraints is often less efficient than giving it tighter bounds, because the latter restricts the overall space to be searched beforehand. Some optimization techniques in Forge need to be explicitly applied in the first phase, because the solver engine itself splits the two phases apart. For more on this, read <a href="chapters/qna/../qna/events.html">the upcoming Q&amp;A section for traces and events</a>.</p>
<!-- ### How does `reachable` work? 

We prototyped some confidence tests about the `reachable` predicate ([livecode file](./testing_reachable.frg)). -->
<h3 id="nulls-in-forge"><a class="header" href="#nulls-in-forge">&quot;Nulls&quot; in Forge</a></h3>
<p>In Forge, there is a special value called <code>none</code>. It's analogous (but not exactly the same!) to a <code>None</code> in languages like Python.</p>
<p>Suppose I add this predicate to our <code>run</code> command in the tic-tac-toe model:</p>
<pre><code class="language-alloy">pred myIdea {
    -- no 2 locations can share the same mark
    all rowA, colA, rowB, colB: Int | 
        (rowA != rowB or colA != colB) implies
            Board.board[rowA][colA] != 
            Board.board[rowB][colB]
}
</code></pre>
<p>I'm trying to express that every entry in the board is different. This should easily be true about, e.g., the initial board, as there are no pieces there at all. But <strong>do you think the empty board satisfies this predicate?</strong></p>
<details>
<summary>Think (or try it in Forge) then click!</summary>
<p>It's very likely this predicate would <em>not</em> be satisfied by the empty board. Why?</p>
<p><em>Because <code>none</code> equals itself</em>, and it's the value in each location of the board before <code>X</code> or <code>O</code> move there. </p>
<p>Thus, when you're writing constraints like the above, you need to watch out for <code>none</code>: the value for <em>every</em> cell in the initial board is equal to the value for <em>every</em> other cell!</p>
</details>
<div id="admonition-reachability-and-none" class="admonition admonish-tip">
<div class="admonition-title">
<p>Reachability and none</p>
<p><a class="admonition-anchor-link" href="chapters/qna/static.html#admonition-reachability-and-none"></a></p>
</div>
<div>
<p>The <code>none</code> value in Forge has at least one more subtlety: <code>none</code> is &quot;reachable&quot; from everything if you're using the built-in <code>reachable</code> helper predicate. That has an impact even if we don't use <code>none</code> explicitly. If I write something like: <code>reachable[p.spouse, Nim, parent1, parent2]</code> I'm asking whether, for some person <code>p</code>, their spouse is an ancestor of <code>Nim</code>. If <code>p</code> doesn't have a spouse, then <code>p.spouse</code> is <code>none</code>, and so this predicate would yield true for <code>p</code>.</p>
<p>This is why it's often advisible to qualify your use of <code>reachable</code>. E.g., I could write <code>some p.spouse and reachable[p.spouse, Nim, parent1, parent2]</code>.</p>
</div>
</div>
<h3 id="some-as-a-quantifier-versus-some-as-a-multiplicity"><a class="header" href="#some-as-a-quantifier-versus-some-as-a-multiplicity">Some as a Quantifier Versus Some as a Multiplicity</a></h3>
<p>The keyword <code>some</code> is used in 2 different ways in Forge:</p>
<ul>
<li>it's a <em>quantifier</em>, as in <code>some b: Board, p: Player | winner[s, p]</code>, which says that somebody has won in some board (and gives us a name for that board, and also for the winner); and</li>
<li>it's a <em>multiplicity operator</em>, as in <code>some Board.board[1][1]</code>, which says only that the middle cell of the board is populated (recall that the board indexes are <code>0</code>, <code>1</code>, and <code>2</code>).</li>
</ul>
<p>Don't be afraid to use both; they're both quite useful! But remember the difference. </p>
<h3 id="guarding-quantifiers-implies-vs-such-that"><a class="header" href="#guarding-quantifiers-implies-vs-such-that">Guarding Quantifiers; Implies vs. &quot;Such That&quot;</a></h3>
<p>You can read <code>some row : Int | ...</code> as &quot;There exists some integer <code>row</code> such that ...&quot;. The transliteration isn't quite as nice for <code>all</code>; it's better to read <code>all row : Int | ...</code> as &quot;In all integer <code>row</code>s, it holds that ...&quot;. </p>
<p>If you want to <em>further restrict</em> the values used in an <code>all</code>, you'd use <code>implies</code>. But if you want to <em>add additional requirements</em> for a <code>some</code>, you'd use <code>and</code>.  Here are 2 examples:</p>
<ul>
<li><strong>All</strong>: &quot;Everybody who has a <code>parent1</code> doesn't also have that person as their <code>parent2</code>&quot;: <code>all p: Person | some p.parent1 implies p.parent1 != p.parent2</code>.</li>
<li><strong>Some</strong>: &quot;There exists someone who has a <code>parent1</code> and a <code>spouse</code>&quot;: <code>some p: Person | some p.parent1 and some p.spouse</code>.</li>
</ul>
<p><strong>Technical aside:</strong> The type designation on the variable can be interpreted as having a character similar to these add-ons: <code>and</code> (for <code>some</code>) and <code>implies</code> (for <code>all</code>). E.g., &quot;there exists some <code>row</code> such that <code>row</code> is an integer and ...&quot;, or &quot;In all <code>row</code>s, if <code>row</code> is an integer, it holds that...&quot;.</p>
<h3 id="there-exists-some-atom-vs-some-instance"><a class="header" href="#there-exists-some-atom-vs-some-instance">There Exists <code>some</code> <em>Atom</em> vs. Some <em>Instance</em></a></h3>
<p>Forge searches for instances that satisfy the constraints you give it. Every <code>run</code> in Forge is about <em>satisfiability</em>; answering the question &quot;Does there exist an instance, such that...&quot;. </p>
<p>Crucially, <strong>you cannot write a Forge constraint that quantifies over <em>instances</em> themselves</strong>. You can ask Forge &quot;does there exist an instance such that...&quot;, which is pretty flexible on its own. E.g., if you want to check that something holds of <em>all</em> instances, you can ask Forge to find counterexamples. This exactly what <code>assert ... is necessary for ...</code> does; it searches for counterexample instances.</p>
<h3 id="tip-testing-predicate-equivalence"><a class="header" href="#tip-testing-predicate-equivalence">Tip: Testing Predicate Equivalence</a></h3>
<p>Checking whether or not two predicates are <em>equivalent</em> is the core of quite a few Forge applications---and a great debugging technique sometimes. (We saw this very briefly for binary trees, but it's worth repeating.)</p>
<p>How do you check for predicate equivalence? Well, suppose we tried to write a predicate in two different ways, like this:</p>
<pre><code class="language-alloy">pred myPred1 {
    some i1, i2: Int | i1 = i2
}
pred myPred2 {
    not all ii, i2: Int | i1 != i2
}
assert myPred1 is necessary for myPred2
assert myPred2 is necessary for myPred1
</code></pre>
<p>These <code>assert</code> statements will pass, because the two predicates <em>are</em> logically equivalent. But if we had written (forgetting the <code>not</code>):</p>
<pre><code class="language-alloy">pred myPred2 {
    all ii, i2: Int | i1 != i2
}
</code></pre>
<p>One of the assertions would fail, yielding an instance in Sterling you could use the evaluator with. If you get an instance where the two predicates aren't equivalent, you can use the Sterling evaluator to find out <strong>why</strong>. Try different subexpressions, discover which is producing an unexpected result! </p>
<h3 id="one-versus-some"><a class="header" href="#one-versus-some">One Versus Some</a></h3>
<p>Classical logic provides the <code>some</code> and <code>all</code> quantifiers, but Forge also gives you <code>no</code>, <code>one</code> and <code>lone</code>. The <code>no</code> quantifier is fairly straightforward: if I write <code>no row, col: Int | Board.board[row][col] = X</code>, it's equivalent to <code>all row, col: Int | Board.board[row][col] != X</code>. That is, <code>X</code> hasn't yet put a mark on the board. </p>
<p>The <code>one</code> quantifier is for saying &quot;there exists a UNIQUE ...&quot;. As a result, there are hidden constraints embedded into its use. <code>one row: Int | Board.board[row][0] = X</code> really means, roughly, <code>some row: Int | { Board.board[row][0] = X and all row2: Int | { row2 != row implies Board.board[row][0] != X}}</code>: there is <em>some</em> row where <code>X</code> has moved in the first column, but <em>only one such row</em>. The <code>lone</code> quantifier is similar, except that instead of saying &quot;exactly one&quot;, it says &quot;either one or none&quot;. </p>
<p>This means that interleaving <code>one</code> or <code>lone</code> with other quantifiers can be subtle. Consider what happens if I write <code>one row, col: Int | Board.board[row][col] = X</code>. This means that there is exactly one square on the board where <code>X</code> has moved. But what about <code>one row: Int | one col: Int | Board.board[row][col] = X</code>? </p>
<p><strong>Exercise:</strong> Test this out using Forge! Try running: </p>
<pre><code>run { not { 
      (one row, col: Int | Board.board[row][col] = X) iff
      (one row: Int | one col: Int | Board.board[row][col] = X)
}}
</code></pre>
<p>You'll get an instance showing you that the two aren't equivalent. What's the problem?</p>
<details>
<summary>Think, then click!</summary>
<p>The problem is that <code>one row, col: Int | ...</code> says that there exists one unique <em>pair</em> of indexes, but <code>one row: Int | one col: Int | ...</code> says that there exists one unique <em>index</em> such that there exists one unique <em>index</em>... These are not the same.</p>
</details>
<p>Because thinking through <code>one</code> and <code>lone</code> quantifiers can be subtle, we strongly suggest <em>not</em> using them except for very simple constraints. (Using them as a multiplicity, like saying <code>one Tim.office</code> is fine.) </p>
<h4 id="satisfiability-testing-and-a-pitfall"><a class="header" href="#satisfiability-testing-and-a-pitfall">Satisfiability Testing and a Pitfall</a></h4>
<p>The <code>test expect</code> syntax lets you check for satisfiability directly. This is quite powerful, and lets us illustrate a fairly common mistake. Here is a test block with 2 tests in it. Both of them may look like they are comparing <code>myPred1</code> and <code>myPred2</code> for equivalence:</p>
<pre><code class="language-alloy">test expect {
    -- correct: &quot;no counterexample exists&quot;
    -- Forge tries to find an instance where myPred1 and myPred2 disagree
    p1eqp2_A: {
        not (myPred1 iff myPred2)        
    } is unsat

    -- incorrect: &quot;it's possible to satisfy what i think always holds&quot;
    -- Forge tries to find an instance where myPred1 and myPred2 happen to agree
    p1eqp2_B: {
        myPred1 iff myPred2
    } is sat
}
</code></pre>
<p>These two tests do not express the same thing! One asks Forge to find an instance where the predicates are not equivalent. If it can find such an instance, we know the predicates are not equivalent, and can see why by viewing the intance. The other test asks Forge to find an arbitrary instance where they <em>are</em> equivalent. But that needn't be true in <em>all</em> instances, just the one that Forge finds. </p>
<h3 id="quantifiers-and-performance"><a class="header" href="#quantifiers-and-performance">Quantifiers and Performance</a></h3>
<p>Forge works by converting your model into a boolean satisfiability problem. That is, it builds a boolean circuit where inputs making the circuit true satisfy your model. But boolean circuits don't have a notion of quantifiers, so they need to be compiled out.</p>
<p>The compiler has a lot of clever tricks to make this fast, but if it can't apply those tricks, it uses a basic idea: an <code>all</code> is just a big <code>and</code>, and a <code>some</code> is just a big <code>or</code>. This very simple conversion process increases the size of the circuit exponentially in the depth of quantification. </p>
<p>Let's look at an example of why this matters. Here is a reasonable way to approach writing a predicate for a model solving the 8-queens problem, where Forge is searching for how to place 8 queens on a chessboard such that none of them can attack the other:</p>
<pre><code class="language-forge">pred notAttacking {
  -- For every pair of queens
  all disj q1, q2 : Queen | {
    -- There's somewhere to put them: (r1,c1) and (r2,c2)
    some r1, c1, r2, c2: Int | {
      // ... such that (r1,c1) and (r2,c2) aren't on a shared line of attack
    } } }
</code></pre>
<p>The problem is: there are 8 queens, and 16 integers. It turns out this is a pathological case for the compiler, and it runs for a really long time. In fact, it runs for a long time even if we reduce the scope to 4 queens! The default <code>verbosity</code> option shows the blowup here, in `time-ranslation, which gives the number of milliseconds used to convert the model to a boolean circuit:</p>
<pre><code>:stats ((size-variables 410425) (size-clauses 617523) (size-primary 1028) (time-translation 18770) (time-solving 184) (time-building 40)) :metadata ())
#vars: (size-variables 410425); #primary: (size-primary 1028); #clauses: (size-clauses 617523)        
Transl (ms): (time-translation 18770); Solving (ms): (time-solving 184)
</code></pre>
<p>Ouch! To avoid this blowup, we might try a different approach that uses fewer quantifiers. In fact, *we can write the constraint without referring to specific queens at all, just 4 integers representing the positions. </p>
<div id="admonition-how" class="admonition admonish-tip">
<div class="admonition-title">
<p>How?</p>
<p><a class="admonition-anchor-link" href="chapters/qna/static.html#admonition-how"></a></p>
</div>
<div>
<p>Does the identity of the queens matter at all, beyond their location?</p>
</div>
</div>
<p>If you encounter bad performance from Forge, check for this sort of unnecessary nested quantifier use. It can often be fixed by reducing quantifier nesting, or by narrowing the scope of what's being quantified over.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h2 id="from-boards-to-games"><a class="header" href="#from-boards-to-games">From Boards to Games</a></h2>
<p>Now that we've gotten some experience modeling in Forge, let's start thinking about <em>change</em>.</p>
<p>What do you think a <em>game</em> of tic-tac-toe looks like? Crucially, a game involves <em>moves</em>. </p>
<p><strong>Exercise:</strong> How could we model the moves between board states? (Hint: start thinking in terms of a graph—nodes and edges!)</p>
<details>
<summary>Think, then click!</summary>
<p>It's often convenient to use the following idiom. </p>
<p>Think of the game as a big graph, where the nodes are the <em>states</em> (possible board configurations) and the edges are <em>transitions</em> between states (in this case, legal moves of the game). Here's a rough sketch:</p>
<p><img src="https://i.imgur.com/YmsbRp8.png" alt="" /></p>
</details>
<br/>
<p>A game of tic-tac-toe is a sequence of steps in a state graph, starting from the empty board. Let's model it.</p>
<p>First, what does a move look like? A player puts their mark at a specific location. In Forge, we'll represent this using a <em>transition predicate</em>: a predicate that says when it's legal for one state to evolve into another. We'll often call these the <em>pre-state</em> and <em>post-state</em> of the transition:</p>
<pre><code class="language-forge">pred move[pre: Board, row: Int, col: Int, p: Player, post: Board] {
  // ...
}
</code></pre>
<p>What constraints should we add? It's useful to divide a transition predicate into:</p>
<ul>
<li>a <em>guard</em>, which allows the move only if the pre-state is suitable; and </li>
<li>an <em>action</em>, which defines what is in the post-state based on the pre-state and the move parameters.</li>
</ul>
<p>For the guard, in order for the move to be valid, it must hold that in the pre-state:</p>
<ul>
<li>nobody has already moved at the target location; and</li>
<li>it's the moving player's turn.</li>
</ul>
<p>For the action:</p>
<ul>
<li>the new board is the same as the old, except for the addition of the player's mark at the target location.</li>
</ul>
<p>Now we can fill in the predicate. Let's try something like this:</p>
<pre><code class="language-alloy">pred move[pre: Board, row: Int, col: Int, p: Player, post: Board] {
  -- guard:
  no pre.board[row][col]   -- nobody's moved there yet
  p = X implies XTurn[pre] -- appropriate turn
  p = O implies OTurn[pre]  
  
  -- action:
  post.board[row][col] = p
  all row2: Int, col2: Int | (row!=row2 and col!=col2) implies {        
     post.board[row2][col2] = pre.board[row2][col2]     
  }  
}
</code></pre>
<p>There are many ways to write this predicate. However, we're going to stick with this general form because it calls out an important point. Suppose we had only written <code>post.board[row][col] = p</code> for the action, without the <code>all</code> on the next following lines. Those added lines, which we'll call a <em>frame condition</em>, say that all other squares remain unchanged; without them, the contents of any other square might change in any way. Leaving them out would cause an <em>underconstraint</em> bug: the predicate would be too weak to accurately describe moves in tic-tac-toe. But that's not the only source of problems...</p>
<p><strong>Exercise</strong>: Could there be a bug in this predicate? (Run Forge and find out!)</p>
<details>
<summary>Think, then click</summary>
<p>The <code>all row2...</code> formula says that for any board location where <em>both the row and column differ</em> from the move's, the board remains the same. But is that what we really wanted? Suppose <code>X</code> moves at location <code>1</code>, <code>1</code>. Then of the 9 locations, which is actually protected?</p>
<div class="table-wrapper"><table><thead><tr><th>Row</th><th>Column</th><th>Protected?</th></tr></thead><tbody>
<tr><td>0</td><td>0</td><td>yes</td></tr>
<tr><td>0</td><td>1</td><td>no (column 1 = column 1)</td></tr>
<tr><td>0</td><td>2</td><td>yes</td></tr>
<tr><td>1</td><td>0</td><td>no (row 1 = row 1)</td></tr>
<tr><td>1</td><td>1</td><td>no (as intended)</td></tr>
<tr><td>1</td><td>2</td><td>no (row 1 = row 1)</td></tr>
<tr><td>2</td><td>0</td><td>yes</td></tr>
<tr><td>2</td><td>1</td><td>no (column 1 = column 1)</td></tr>
<tr><td>2</td><td>2</td><td>yes</td></tr>
</tbody></table>
</div>
<p>Our frame condition was <em>too weak</em>! We need to have it take effect whenever <em>either</em> the row or column is different. Something like this will work:</p>
<pre><code class="language-alloy">  all row2: Int, col2: Int | 
    ((row2 != row) or (col2 != col)) implies {    
       post.board[row2][col2] = pre.board[row2][col2]     
  }  

</code></pre>
</details>
<p><strong>Exercise</strong>: Make the suggested fix to the predicate above. Comment out the 3 frame-condition lines and run the model. Do you see moves where the other 8 squares change arbitrarily? You should, because Forge is free to make such changes.</p>
<h3 id="property-preservation"><a class="header" href="#property-preservation">Property Preservation</a></h3>
<p>Once someone wins a game, does their win still persist, even if more moves are made? I'd like to think so: moves never get undone, and in our model winning just means the existence of 3-in-a-row for some player. We probably even believe this property without checking it. However, it won't always be so straightforward to show that properties are preserved by the system. We'll check this one in Forge as an example of how you might prove something similar in a more complex system.</p>
<div id="admonition-looking-ahead" class="admonition admonish-note">
<div class="admonition-title">
<p>Looking ahead</p>
<p><a class="admonition-anchor-link" href="chapters/ttt/ttt_games.html#admonition-looking-ahead"></a></p>
</div>
<div>
<p>This is our first step into the world of verification. Asking whether or not a program, algorithm, or other system always satisfies some assertion is a core problem in engineering, and has a centuries-long history.</p>
</div>
</div>
<p>We'll tell Forge to find us pairs of states, connected by a move: the <em>pre-state</em> before the move, and the <em>post-state</em> after it. That's <em>any</em> potential transition in tic-tac-toe—at least, following the rules as we defined them. To apply this technique, all we need to do is add two more constraints that reflect a winner existing in the pre-state, but that there's no winner in the post-state.</p>
<pre><code class="language-alloy">pred winningPreservedCounterexample {
  -- There is some pair of states
  some pre, post: Board | {
    -- such that the first transitions to the second
    some row, col: Int, p: Player | 
      move[pre, post, row, col, p]
    -- the first state has a winner
    some p: Player | winner[pre, p]
    -- the second state has no winner
    all o: Player | not winner[post, p]
  }
}
run {
  all s: Board | wellformed[s]
  winningPreservedCounterexample
}
</code></pre>
<p>The <code>run</code> is unsatisfiable. Forge can't find any counterexamples. We'll see this reported as &quot;UNSAT&quot; (short for &quot;unsatisfiable&quot;) in the visualizer. </p>
<div id="admonition-next-button" class="admonition admonish-tip">
<div class="admonition-title">
<p>Next button</p>
<p><a class="admonition-anchor-link" href="chapters/ttt/ttt_games.html#admonition-next-button"></a></p>
</div>
<div>
<p>Remember that the visualizer also has a &quot;Next&quot; button; you can browse many different solution instances. Of course, if you press it enough times, Forge (eventually) runs out of solutions to show.</p>
</div>
</div>
<h2 id="generating-complete-games"><a class="header" href="#generating-complete-games">Generating Complete Games</a></h2>
<p>Recall that our worldview for this model is that systems <em>transition</em> between <em>states</em>, and thus we can think of a system as a directed graph. If the transitions have arguments, we'll sometimes label the edges of the graph with those arguments. This view is sometimes called a <em>discrete event</em> model, because one event happens at a time. Here, the events are moves of the game. In a bigger model, there might be many different types of events.</p>
<p>Today, we'll ask Forge to find us <em>full traces of the system</em>, starting from an initial state. We'll also add a <code>Game</code> sig to incorporate some metadata.</p>
<pre><code class="language-alloy">-- Generate *one* game of tic-tac-toe
one sig Game {
  -- What state does the game start in?
  initialState: one Board,
  -- How does the game evolve from state to state?
  nextState: pfunc Board -&gt; Board
}

pred traces {
    -- The trace starts with an initial state
    starting[Game.initialState]
    no sprev: Board | Game.nextState[sprev] = Game.initialState
    -- Every transition is a valid move
    all s: Board | some Game.nextState[s] implies {
      some row, col: Int, p: Player |
        move[s, row, col, p, Game.nextState[s]]
    }
}
</code></pre>
<p>By itself, this wouldn't be quite enough; we might see a bunch of disjoint traces. We could add more constraints manually, but there's a better option: tell Forge, at <code>run</code>time, that <code>nextState</code> represents a linear ordering on states. This is similar to what we did back in the <a href="chapters/ttt/../adder/rca.html">ripple-carry adder</a>:</p>
<pre><code class="language-alloy">run { traces } for {nextState is linear}
</code></pre>
<p>It's worth recalling what's happening here. The phrase <code>nextState is linear</code> isn't a <em>constraint</em>; it's a separate annotation given to Forge alongside a <code>run</code> or a test. Never put such an annotation in a constraint block; Forge won't understand it. These annotations narrow Forge's <em>bounds</em> (the space of possible worlds to check) before the solver begins its work.</p>
<p>In general, Forge syntax allows such annotations <em>after</em> numeric bounds. E.g., if we wanted to see full games, rather than unfinished game prefixes (the default bound on any sig, including <code>Board</code>, is up to 4) we could have asked:</p>
<pre><code class="language-alloy">run {
  traces
} for exactly 10 Board for {nextState is linear}
</code></pre>
<p>You might notice that because of this, some traces are excluded. That's because <code>nextState is linear</code> forces exact bounds on <code>Board</code>. This is in contrast to <code>plinear</code>, which we used for the ripple-carry adder, and which didn't force exact bounds. Use whichever of the two is more appropriate to your needs.</p>
<h2 id="the-evaluator"><a class="header" href="#the-evaluator">The Evaluator</a></h2>
<p>Moreover, since we're now viewing a single fixed instance, we can <em>evaluate</em> Forge expressions in it. This is great for debugging, but also for just understanding Forge a little bit better. Open the evaluator here at the bottom of the right-side tray, under theming. Then enter an expression or constraint here:</p>
<p><img src="https://i.imgur.com/tnT8cgo.png" alt="" /></p>
<p>Type in something like <code>some s: Board | winner[s, X]</code>. Forge should give you either <code>#t</code> (for true) or <code>#f</code> (for false) depending on whether the game includes <code>X</code> winning in some state.</p>
<h3 id="optimization"><a class="header" href="#optimization">Optimization</a></h3>
<p>You might notice that this model takes a while to run. Something happened after we started reasoning about full games. Why might that be? Let's re-examine our bounds and see if there's anything we can adjust. In particular, here's what the evaluator says we've got for integers:</p>
<p><img src="https://i.imgur.com/UJJUqdB.png" alt="" /></p>
<p>Wow---wait, do we really <strong>need</strong> to be able to count up to <code>7</code> for this model? Even more, do we really need to count all the way down to <code>-8</code>? Probably not. If we change our integer bounds to <code>3 Int</code> we'll still be able to use <code>0</code>, <code>1</code>, and <code>2</code>, and the search space is much smaller.</p>
<h2 id="back-to-tic-tac-toe-ending-games"><a class="header" href="#back-to-tic-tac-toe-ending-games">Back To Tic-Tac-Toe: Ending Games</a></h2>
<p>Recall that we just ran this command:</p>
<pre><code class="language-alloy">run {
  wellformed
  traces
} for exactly 10 Board for {nextState is linear}
</code></pre>
<div id="admonition-nothing-without-a-command" class="admonition admonish-note">
<div class="admonition-title">
<p>Nothing without a command</p>
<p><a class="admonition-anchor-link" href="chapters/ttt/ttt_games.html#admonition-nothing-without-a-command"></a></p>
</div>
<div>
<p>Without a <code>run</code>, an <code>example</code>, or a similar <em>command</em>, running a Forge model will do nothing.</p>
</div>
</div>
<p>From this <code>run</code> command, Forge will find <em>traces</em> of the system (here, games of Tic-Tac-Toe) represented as a linear sequence of exactly 10 <code>State</code> atoms.</p>
<p>Do you have any worries about the way this is set up?</p>
<details>
<summary>Think, then click!</summary>
Are all Tic-Tac-Toe games 10 states long? 
<p>Well, <em>maybe</em>; it depends on how we define a game. If we want a game to stop as soon as nobody can win, our <code>exactly 10 State</code> bound is going to prevent us from finding games that are won before the final cell of the board is filled.</p>
</details>
<p>Let's add the following guard constraint to the <code>move</code> transition predicate, which forces games to end as soon as somebody wins.</p>
<pre><code class="language-alloy">all p: Player | not winner[pre, p]
</code></pre>
<p>Now we've got problems, because once we add this constraint, Forge will omit games that end before all square of the board are filled.</p>
<p>This behavior, which may initially seem strange, exists for two reasons:</p>
<ul>
<li>History: Forge's ancestor language, Alloy, has something very similar to <code>is linear</code>, with the same semantics.</li>
<li>Performance: since the <code>is linear</code> annotation is almost always used for trace-generation, and trace-generation solving time grows (in the worst case) exponentially in the length of the trace, we will almost always want to reduce unnecessary uncertainty. Forcing the trace length to always be the same reduces the load on the solver, and makes trace-generation somewhat more efficient.</li>
</ul>
<p>But now we need to work around this limitation. Any ideas? Hint: do we need to have <em>only one</em> kind of transition in our system?</p>
<details>
<summary>Think, then click!</summary>
<p>No. A common way to allow trace length to vary is by adding a &quot;do nothing&quot; transition. (In the literature, this is called a <em>stutter transition</em>.) </p>
<p>The trick is in how to add it without also allowing a &quot;game&quot; to consist of nobody doing anything. To do that requires some more careful modeling.</p>
</details>
</br>
<p>Let's add an additional transition that does nothing. We can't &quot;do nothing&quot; in the predicate body, though—an empty predicate body would just mean <em>anything</em> could happen. What we mean to say is that the state of the board remains the same, even if the before and after <code>Board</code> objects differ.</p>
<pre><code class="language-alloy">pred doNothing[pre: Board, post: Board] {
    all row2: Int, col2: Int | 
        post.board[row2][col2] = pre.board[row2][col2]
}
</code></pre>
<div id="admonition-variable-names" class="admonition admonish-warning">
<div class="admonition-title">
<p>Variable names</p>
<p><a class="admonition-anchor-link" href="chapters/ttt/ttt_games.html#admonition-variable-names"></a></p>
</div>
<div>
<p>Remember that <code>row2</code> and <code>col2</code> are just variable names that could stand for any <code>Int</code>; they aren't necessarily the row or column index value <code>2</code>.</p>
</div>
</div>
<p>We also need to edit the <code>traces</code> predicate to allow <code>doNothing</code> to take place:</p>
<pre><code class="language-alloy">pred traces {
    -- The trace starts with an initial state
    starting[Game.initialState]
    no sprev: Board | Game.nextState[sprev] = Game.initialState
    -- Every transition is a valid move
    all s: Board | some Game.nextState[s] implies {
      some row, col: Int, p: Player | {
        move[s, row, col, p, Game.nextState[s]] 
      }
      or
      doNothing[s, Game.nextState[s]]      
    } 
}
</code></pre>
<p>As it stands, this fix solves the <em>overconstraint</em> problem of never seeing an early win, but introduces a new <em>underconstraint</em> problem: we don't want <code>doNothing</code> transitions to happen just anywhere!</p>
<p>Here's how I like to fix it:</p>
<pre><code class="language-alloy">pred gameOver[s: Board] {
  some p: Player | winner[s, p]
}
</code></pre>
<p>Why a new predicate? Because I want to use different predicates to represent different concepts, and enable re-use.</p>
<p>When should a <code>doNothing</code> transition be possible? <em>Only when the game is over!</em></p>
<pre><code class="language-alloy">pred doNothing[pre: State, post: State] {
    gameOver[pre] -- guard of the transition
    pre.board = post.board -- effect of the transition
}
</code></pre>
<p>If we wanted to, we could add a <code>not gameOver[pre]</code> guard constraint to the <code>move</code> predicate, enforcing that nobody can move at all after someone has won.</p>
<h2 id="do-the-rules-allow-cheating"><a class="header" href="#do-the-rules-allow-cheating">Do The Rules Allow Cheating?</a></h2>
<p>Let's ask Forge whether a <code>cheating</code> state is possible under the rules. </p>
<pre><code class="language-alloy">pred cheating[b: Board] {
  -- It's neither X's nor O's turn; the balance is way off! 
  not XTurn[b] 
  not OTurn[b]
}
run {
  wellformed
  traces
  some bad: Board | cheating[bad]
} for exactly 10 State for {next is linear}
</code></pre>
<p>This should work—assuming we don't drop the <code>is linear</code> annotation. Without it, nothing says that every state must be in the trace, and so Forge could produce an instance with an &quot;unused&quot; cheating state that's not reachable from the start.</p>
<h2 id="checking-conjectures"><a class="header" href="#checking-conjectures">Checking Conjectures</a></h2>
<p>When I was very small, I thought that moving in the middle of the board would guarantee a win at Tic-Tac-Toe. Now I know that isn't true. Could I have used Forge to check my conjecture?</p>
<details>
<summary>Think, then Click!</summary>
Here's how I did it:    
<pre><code class="language-alloy">run {
  wellformed
  traces
  -- &quot;let&quot; lets us locally define an expression, which can
  -- be good for clarity in the model!
  -- here we say that X first moved in the middle
  let second = Game.nextState[Game.initialState] |
    second.board[1][1] = X
  -- ...but X didn't win
  all s: State | not winner[s, X]
} for exactly 10 State for {nextState is linear}
</code></pre>
</details>
<p>We should get a counterexample if we run that predicate.</p>
<p>We could also write this using an assertion (which would fail) rather than a <code>run</code>:</p>
<pre><code>pred xWins {
  all s: State | not winner[s, X]
}
assert moveInMiddle is sufficient for xWins 
  for exactly 10 State for {nextState is linear}
</code></pre>
<hr />
<p>You might wonder how <code>assert</code> can be used for predicates that take arguments. For example, suppose we had defined <code>wellformed</code> to take a board, rather than quantifying over <code>all</code> boards in its body. The <code>assert</code> syntax can take (one layer of) quantification. Would <code>move</code> preserve <code>wellformed</code>-ness?</p>
<p><strong>TODO: mismatch; prior sections do have a 1-ary wellformed?</strong></p>
<p>Here's how we'd write that. Notice we don't even need to use the <code>Game</code> here (and thus don't need to give the <code>is linear</code> annotation)! We're just asking Forge about 2 boards at a time:</p>
<pre><code>pred someMoveFromWF[pre, post: Board] { 
  wellformed[pre]
  some r, c: Int, p: Player | move[pre, r, c, p, post]
}
assert all pre,post: Board | move[pre,post] is sufficient for wellformed[post] 
</code></pre>
<h3 id="reminder-the-evaluator"><a class="header" href="#reminder-the-evaluator">Reminder: The Evaluator</a></h3>
<p>If you're viewing an instance, you can always select the evaluator tray and enter Forge syntax to see what it evaluates to in the instance shown. You can enter both formulas and expressions. We also have the ability to refer to atoms in the world directly. E.g., we could try:</p>
<pre><code class="language-alloy">all s: Board | not winner[s, X]
</code></pre>
<p>but also (assuming <code>Board0</code> is an atom in the instance we're currently viewing):</p>
<pre><code class="language-alloy">winner[Board0, X]
</code></pre>
<h3 id="going-further"><a class="header" href="#going-further">Going Further</a></h3>
<p>This illustrates a new class of queries we can ask Forge. Given parties following certain <em>strategies</em>, is it possible to find a trace where one strategy fails to succeed vs. another? </p>
<p><strong>Challenge exercise:</strong> Write a <code>run</code> that searches for a game where both parties always <em>block</em> immediate wins by their opponent. Is it ever possible for one party to win, if both will act to prevent a 3-in-a-row on the next turn?</p>
<h2 id="modeling-tip-dealing-with-unsatisfiability"><a class="header" href="#modeling-tip-dealing-with-unsatisfiability">Modeling Tip: Dealing with Unsatisfiability</a></h2>
<p>Overconstraint bugs, where some instances may be unintentionally ruled out by our model, can be a nightmare to detect and fix. Maybe you wrote an <code>assert</code> and it seemed to never stop. Maybe you wrote a <code>run</code> command and Forge just produced an <code>UNSAT</code> result—after a long wait.</p>
<p>Getting back an unsat result <em>can</em> take a long time. Why? Think of the search process. If there is a satisfying instance, the solver can find it early. If there isn't, the solver needs to explore the entire space of possibilities. There are smart algorithms for this, and the solver is not <em>really</em> enumerating the entire space of instances, but the general idea holds. </p>
<p>So if you run Forge and it doesn't seem to ever terminate, it's not necessarily a Forge problem. Overconstraint bugs can produce this behavior, too.</p>
<p>So, how do you debug a problem like this? The first thing I like to do is reduce the bounds (if possible) and, if I still get unsat, I'll use that smaller, faster run to debug. But at that point, we're kind of stuck. <code>UNSAT</code> isn't very helpful. </p>
<p>Today I want to show you a very useful technique for discovering the problem. There are more advanced approaches we'll get to later in the course, but for now this one should serve you well. </p>
<p><strong>TODO: insert unsat core, now that we have good highlighting!</strong></p>
<p>The idea is: encode an instance you'd expect to see as a set of constraints, run <em>those</em> constraints only, and then use the evaluator to explore why it fails your other constraints. Let's do an example!</p>
<p><strong>TODO: this is taken from a homework, not one of the above... should rewrite</strong></p>
<pre><code class="language-alloy">#lang froglet 

sig State {
  top: lone Element
}
sig Element {
  next: lone Element             
}

pred buggy {
  all s: State | all e: Element {
    s.top = e or reachable[e, s.top, next]
  }
  some st1, st2: State | st1.top != st2.top     
  all e: Element | not reachable[e, e, next]
}
test expect {
  exampleDebug: {buggy} is sat
}
</code></pre>
<p>This test fails. But why?</p>
<pre><code class="language-alloy">run {
  some st1, st2: State |
  some ele1, ele2: Element | {
    st1.top = ele1
    st2.top = ele2
    ele1.next = ele2   
    no ele2.next    
  }
} for exactly 2 State, exactly 2 Element
</code></pre>
<p>Given this instance, the question is: <strong>why didn't Forge accept it?</strong> There must be some constraint, or constraints, that it violates. Let's find out which one. We'll paste them into the evaluator...</p>
<ul>
<li><code>some st1, st2: State | st1.top != st2.top</code>? This evaluates to <code>#t</code> (true). No problem there.</li>
<li><code>  all s: State | all e: Element { s.top = e or reachable[e, s.top, next] }</code>? This evaluates to <code>#f</code> (false). So this is a problem.</li>
</ul>
<p>Now we proceed by breaking down the constraint. The outer shell is an <code>all</code>, so let's plug in a concrete value:</p>
<ul>
<li><code>all e: Element { State0.top = e or reachable[e, State0.top, next] }</code>? This evaluates to <code>#f</code>. So the constraint fails for <code>State0</code>. </li>
</ul>
<p><strong>Important</strong>: Don't try to name specific states in your model. They <em>don't exist</em> at that point. </p>
<p>Which element does the constraint fail on? Again, we'll substitute concrete values and experiment:</p>
<ul>
<li><code>State0.top = Element0 or reachable[Element0, State0.top, next]</code>? This evaluates to <code>#t</code>. What about <code>State0.top = Element1 or reachable[Element1, State0.top, next]</code>?</li>
</ul>
<p>Following this process very often leads to discovering an over-constraint bug, or a misconception the author had about the goals of the model or the meaning of the constraints. </p>
<p><strong>Question: What's the problem here?</strong></p>
<details>
<summary>Think, then click!</summary>
<p>Since the <code>next</code> field never changes with time, the <code>all</code> constraint doesn't allow states to vary the <code>top</code> of the stack. Instead, we need a weaker constraint to enforce that the stack is shaped like a state.</p>
</details>
<h2 id="aside-reminder-about-examples"><a class="header" href="#aside-reminder-about-examples">Aside: Reminder About Examples</a></h2>
<p><strong>TODO: should this part go to the Q and A for traces?</strong></p>
<p>Where an <code>assert</code> or <code>run</code> is about checking satisfiability or unsatisfiability of some set of constraints, an <code>example</code> is about whether a <em>specific</em> instance satisfies a given predicate. This style of test can be extremely useful for checking that (e.g.) small helper predicates do what you expect.</p>
<p>Why use <code>example</code> at all? A couple of reasons:</p>
<ul>
<li>It is often much more convenient (once you get past the odd syntax) than adding <code>one sig</code>s or <code>some</code> quantification for every object in the instance, provided you're trying to describe an <em>instance</em> rather than a property that defines a set of them---which becomes a better option as models become more complex.</li>
<li>Because of how it's compiled, an <code>example</code> can sometimes run faster than a constraint-based equivalent. </li>
</ul>
<p>You may be wondering whether there's a way to leverage that same speedup in a <code>run</code> command. Yes, there is! But for now, let's get used to the syntax just for writing examples. Here are some, well, examples:</p>
<pre><code class="language-alloy">pred someXTurn {some s: State | XTurn[s]}
example emptyBoardXturn is {someXTurn} for {
  State = `State0
  no `State0.board
}
</code></pre>
<p>Here, we've said that there is one state in the instance, and its <code>board</code> field has no entries. We could have also just written <code>no board</code>, and it would have worked the same.</p>
<pre><code class="language-alloy">-- You need to define all the sigs that you'll use values from
pred someOTurn {some b: Board | OTurn[b]}
example xMiddleOturn is {someOTurn} for {
  Board = `Board0
  Player = `X0 + `O0
  X = `X0
  O = `O0
  `Board0.board =  (1, 1) -&gt; `X0
}
</code></pre>
<p>What about assertions, though? You can think of assertions as <em>generalizing</em> examples. I could have written something like this:</p>
<pre><code class="language-alloy">pred someXTurn {some b: Board | xturn[b]}
pred emptySingleBoard {
  one b: Board | true
  all b: Board, r,c: Int | no b.board[r][c]
}
assert emptySingleBoard is sufficient for someXTurn  
</code></pre>
<p>That's pretty coarse-grained, though. So let's write it in a better way:</p>
<pre><code class="language-alloy">pred emptyBoard[b: Board] { all r, c: Int | no b.board[r][c] }
assert all b: Board | emptyBoard[b] is sufficient for xturn[b]
</code></pre>
<p>Notice how, by adding variables to the assertion, we're able to write less-verbose assertions and re-use our predicates better. </p>
<div id="admonition-but-if-examples-are-faster-why-use-assertions" class="admonition admonish-tip">
<div class="admonition-title">
<p>But if examples are faster, why use assertions?</p>
<p><a class="admonition-anchor-link" href="chapters/ttt/ttt_games.html#admonition-but-if-examples-are-faster-why-use-assertions"></a></p>
</div>
<div>
<p>First, examples aren't <em>always</em> faster. There are also some models we'll write later where <code>example</code> isn't supported. And, of course, as the model becomes more complex, the example becomes longer and longer as you try to define the value of all fields.</p>
<p>But there's a more important reason: assertions can express <em>properties</em>. Because they can state arbitrary constraints, there's an analogy to property-based testing: where <code>example</code>s are like traditional unit tests, <code>assert</code>ions are like the checker predicates you wrote in Hypothesis. </p>
<p>So there's a role for both of them.</p>
</div>
</div>
<h2 id="traces-good-and-bad"><a class="header" href="#traces-good-and-bad">Traces: Good and Bad</a></h2>
<p>We've finished our model of tic-tac-toe. We could generate a full game of up to 10 board states, and reason about what was possible in any game. </p>
<p>This works great for tic-tac-toe, and also in many other real verification settings. But there's a huge problem ahead. Think about verifying properties about a more complex system—one that didn't always stop after at most 9 steps. If we want to confirm that some bad condition can never be reached, <em>how long a trace do we need to check?</em></p>
<details>
<summary>Think, then click!</summary>
<p>What's the longest (simple—i.e., no cycles) path in the transition system? That's the trace length we'd need. </p>
</details>
<p>That's potentially a lot of states in a trace. Hundreds, thousands, billions, ... So is this entire approach doomed from the start? </p>
<p>No, for at least two reasons:</p>
<ul>
<li>Often there <em>are</em> &quot;shallow&quot; bugs that can be encountered in only a few steps. In something like a protocol or algorithm, scaling to traces of length 10 or 20 can still find real bugs and increase confidence in correctness. </li>
<li>There's more than one way to verify. Generating <em>full traces</em> wasn't the only technique we used to check properties of tic-tac-toe; let's look deeper at something we saw awhile back.</li>
</ul>
<h2 id="proving-preservation-inductively"><a class="header" href="#proving-preservation-inductively">Proving Preservation Inductively</a></h2>
<p><strong>TODO: should this be a separate section?</strong></p>
<p>Let's turn to a <em>programming</em> problem. Suppose that we've just been asked to write the <code>add</code> method for a linked list class in Java. The code involves a <code>start</code> reference to the first node in the list, and every node has a <code>next</code> reference (which may be null). </p>
<p>Here's what we hope is a <em>property of linked lists</em>: <strong>the last node of a non-empty list always has <code>null</code> as its value for <code>next</code></strong>. </p>
<p>How can we prove that our <code>add</code> method preserves this property, <em>without</em> generating traces of ever-increasing length? There's no limit to how long the list might get, and so the length of the longest path in the transition system is infinite: 0 nodes, 1 node, 2 nodes, 3 nodes,...</p>
<p>This might not be immediately obvious. After all, it's not as simple as asking Forge to run <code>all s: State | last.next = none</code>. </p>
<p><strong>Exercise:</strong> Why not?</p>
<details>
<summary>Think, then click!</summary>
<p>Because that would just be asking Forge to find us instances full of good states. Really, we want a sort of higher-level <code>all</code>, something that says: &quot;for all <strong>runs of the system</strong>, it's impossible for the run to contain a bad linked-list state.</p>
</details>
<p>This illustrates a <strong>central challenge in software and hardware verification</strong>. Given a discrete-event model of a system, how can we check whether all reachable states satisfy some property? You might have heard properties like this called <em>invariants</em> of the system.</p>
<p>One way to solve the problem <em>without</em> the limitation of bounded-length traces goes something like this:</p>
<ul>
<li>Step 1: Ask whether any starting states are bad states. If not, then at least we know that executions with no moves obey our invariant. (It's not much, but it's a start. It's also easy for Forge to check.)</li>
<li>Step 2: Ask whether it's possible, in any good state, to transition to a bad state. </li>
</ul>
<p>Consider what it means if both checks pass. We'd know that runs of length <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> cannot involve a bad state. And since we know that good states can't transition to bad states, runs of length <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> can't involve bad states either. And for the same reason, runs of length <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span> can't involve bad states, nor games of length <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span>, and so on.</p>
<h3 id="how-do-we-write-this-in-forge"><a class="header" href="#how-do-we-write-this-in-forge">How do we write this in Forge?</a></h3>
<p>This technique isn't only applicable in Forge. It's used in many other solver-based tools, including those used in industry. And modeling linked lists in Forge is very doable, but more complicated than I'd like to do at this point. So we'll demonstrate the idea on the tic-tac-toe model. </p>
<p><strong>Step 1: are there any bad states that are also starting states?</strong></p>
<pre><code class="language-alloy">assert all b: Board | initial[b] is sufficient for balanced[b]
  for 1 Board, 3 Int
</code></pre>
<p>Notice that we didn't <em>need</em> to use the <code>next is linear</code> annotation, because we're not asking for traces at all. We've also limited our scope to exactly 1 Board. We also don't need 4 integer bits; 3 suffices. This should be quite efficient. It should also pass, because the empty board isn't unbalanced. </p>
<p><strong>Step 2: are there any transitions from a good state to a bad state?</strong></p>
<p>Again, we don't need a full trace for this to work. We only need 2 boards: the pre-state and post-state of the transition:</p>
<pre><code class="language-alloy">pred moveFromBalanced[pre: Board, row, col: Int, p: Player, post: board] {
  balanced[pre]
  move[pre, row, col, p, post]
}
assert all pre, post: Board, row, col: Int, p: Player | 
  moveFromBalanced[pre, row, col, p, post] is sufficient for balanced[post]
    for 2 Board, 3 Int
</code></pre>
<p>If both of these pass, we've just shown that bad states are impossible to reach via valid moves of the system.</p>
<div id="admonition-aside-performance" class="admonition admonish-note">
<div class="admonition-title">
<p>Aside: Performance</p>
<p><a class="admonition-anchor-link" href="chapters/ttt/ttt_games.html#admonition-aside-performance"></a></p>
</div>
<div>
<p>That second step is still pretty slow on my laptop: around 10 or 11 seconds to yield <code>UNSAT</code>. Can we give the solver any help? Hint: <strong>is the set of possible values for <code>pre</code> bigger than it really needs to be?</strong></p>
<details>
<summary>Think, then click!</summary>
<p>If we assume the <code>pre</code> board is well-formed, we'll exclude transitions involving invalid boards. There are a lot of these, even at <code>3 Int</code>, since row and column indexes will range from <code>-4</code> to <code>3</code> (inclusive). We could do this either by asserting <code>wellformed[pre]</code> or by refining the bounds we give Forge.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="counterexamples-to-induction"><a class="header" href="#counterexamples-to-induction">Counterexamples To Induction</a></h1>
<p>This section contains a running exercise where we model binary search on an array. You'll need <a href="chapters/inductive/./binarysearch_template.frg">this exercise template</a> to begin. For your reference, the completed version with comments from Q&amp;A, is <a href="chapters/inductive/./binarysearch_inclass.frg">here</a>.</p>
<p><strong>TODO: insert reminder of what binary search is</strong></p>
<h2 id="conceptual-setup"><a class="header" href="#conceptual-setup">Conceptual Setup</a></h2>
<p>When we're talking about whether or not a reachable state violates a desirable property <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> (recall we sometimes say that if this holds, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> is an <em>invariant</em> of the system), it's useful to think geometrically. Here's a picture of the space of <em>all states</em>, with the cluster of &quot;good&quot; states separated from the &quot;bad&quot;:</p>
<p><img src="https://i.imgur.com/n3F16P4.png" alt="" /></p>
<p>If this space is large, we probably can't use trace-finding to get a real <em>proof</em>: we'd have to either:</p>
<ul>
<li>reduce the trace length (in which case, maybe there's a bad state <em>just barely</em> out of reach of that length but we'd never know); or </li>
<li>possibly be waiting for the solver until the sun expands and engulfs the earth.</li>
</ul>
<p>Complete-trace checking is still useful, especially for finding shallow bugs. The technique is used in industry, and inspires other, more sophisticated algorithmic techniques. But we need more than one tool in our bag of tricks, so let's keep developing the idea of only looking at 1 or 2 states at a time. </p>
<div id="admonition-original-paper" class="admonition admonish-note">
<div class="admonition-title">
<p>Original paper</p>
<p><a class="admonition-anchor-link" href="chapters/inductive/bsearch.html#admonition-original-paper"></a></p>
</div>
<div>
<p>If you're interested, you can read the original paper on using solvers to find traces of bounded length by <a href="https://www.cs.cmu.edu/~emc/papers/Books%20and%20Edited%20Volumes/Bounded%20Model%20Checking.pdf">Biere, et al.</a>.</p>
</div>
</div>
<p>To do that, we'll go back over what we did in the last section, but in more detail.</p>
<h3 id="step-1-initiation-or-base-case"><a class="header" href="#step-1-initiation-or-base-case">Step 1: Initiation or Base Case</a></h3>
<p>Let's break the problem down. What if we just consider reachability for traces of length <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>---that is, traces of only one state, an <code>initial</code> state?</p>
<p>This we can check in Forge just by asking for a state <code>s</code> satisfying <code>{initial[s] and wellformed[s] and not P[s]}.</code> There's no exponential blowup with trace length since the transition predicates are never even involved! If we see something like this:</p>
<p><img src="https://i.imgur.com/Aia9V0q.png" alt="" /></p>
<p>We know that at least the starting states are good. If instead there was a region of the starting states that overlapped the bad states, then we immediately know that the property isn't invariant.</p>
<h3 id="step-15-restrictions-spur-creativity"><a class="header" href="#step-15-restrictions-spur-creativity">Step 1.5: Restrictions Spur Creativity</a></h3>
<p>We can also check whether there are bad states within <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> transition. We're using the transition predicate (or predicates) now, but only <em>once</em>. Forge can also do this; we ask for a pair of states <code>s0</code>, <code>s1</code> satisfying <code>{initial[s0] and someTransition[s0, s1] and not P[s1]}</code> (where <code>someTransition</code> is my shorthand for allowing any transition predicate to work). </p>
<p>If Forge doesn't find any way for the second state to violate <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>, it means we have a picture like this:</p>
<p><img src="https://i.imgur.com/NdA7RwF.png" alt="" /></p>
<p>Note that in general, there might be overlap (as shown) between the set of possible initial states and the set of possible second states. For example, imagine if we allowed a <code>doNothing</code> transition at any time—then the starting state could be reached in any number of steps.</p>
<p>We could continue to extend this idea to 2 transitions (3 states), 3 transitions (4 states), and so on. If we keep following this process, we'll arrive back at the fully trace-based approach. And anyway, to address the exponential-blowup problem of traces, we said that we would only ever look at 1 or 2 states. But how can we ever get something useful, that is, a result that isn't limited to trace length 1?</p>
<p>We can (often) use these small, efficient queries to show that <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> holds at <em>any</em> finite length from a starting state. But how? By giving something up. In fact, we'll give up something apparently vital: we'll <em>stop caring whether the pre-state of the bad transition is reachable or not.</em></p>
<h3 id="step-2-consecution-or-inductive-case"><a class="header" href="#step-2-consecution-or-inductive-case">Step 2: Consecution or Inductive Case</a></h3>
<p>We'll ask Forge whether <code>{P[s0] and someTransition[s0, s1] and not P[s1]}</code> is satisfiable for <em>any</em> pair of states. Just so long as the pre-state satisfies <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> and the post-state doesn't. We're asking Forge if it can find a transition that looks like this:</p>
<p><img src="https://i.imgur.com/CWSjSrr.png" alt="" /></p>
<p>If the answer is <em>no</em>, then it is simply impossible (up to the bounds we gave Forge) for any transition predicate to stop property <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> from holding: if it holds in the pre-state, it <em>must</em> hold in the post-state. </p>
<p>But if that's true, and we know that all initial states satisfy <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>, then all states reachable in <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> transition satisfy <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> (by what we just checked). And if <em>that's</em> true, then all states reachable in <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span> transitions satisfy <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> also (since all potential pre-states must satisfy <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>). And so on: <em>any</em> state that's reachable in a finite number of transitions must satisfy <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>. </p>
<p>If you've seen &quot;proof by induction&quot; before in another class, we've just applied the same idea here. Except, rather than using it to show that the sum of the numbers from <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> to <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> is <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.355em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> (or some other toy algebraic example) we've just used it to prove that <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> is invariant in a system.</p>
<p>In Tic-Tac-Toe, we let property <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> be &quot;cheating states can't be reached with legal moves&quot;. In an operating system, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> might be &quot;two processes can never modify a block of memory simultaneously&quot;. In hardware, it might be &quot;only one device has access to write to the bus at any point&quot;. In a model of binary search, it might be &quot;if the target is in the array, it's located between the <code>low</code> and <code>high</code> indexes&quot;.</p>
<div id="admonition-a-cs-perspective" class="admonition admonish-note">
<div class="admonition-title">
<p>A CS Perspective</p>
<p><a class="admonition-anchor-link" href="chapters/inductive/bsearch.html#admonition-a-cs-perspective"></a></p>
</div>
<div>
<p>I think that showing a system preserves an invariant might be a far more relatable and immediately useful example of the induction principle than summation. That's not to dismiss mathematical induction! I quite like it (and it's useful for establishing some useful results related to Forge). But multiple perspectives enrich life.</p>
</div>
</div>
<p><strong>Exercise: Try it!</strong> Open up the binary search model starter. You should see a pair of tests labeled <code>initStep</code> and <code>inductiveStep</code> under a comment that says &quot;Exercise 1&quot;. Fill these in using the logic above, and run them. Do they both pass? Does one fail?</p>
<h3 id="what-if-forge-finds-a-counterexample"><a class="header" href="#what-if-forge-finds-a-counterexample">What if Forge finds a counterexample?</a></h3>
<p>What if Forge <em>does</em> find a transition that fails to preserve our property <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>? Does it mean that <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> is not an invariant of the system?</p>
<details>
<summary>Think, then click!</summary>
<p>No! It just means that <strong>the pre-state that Forge finds might not <em>itself</em> be reachable!</strong>  In that case, we'll say that while <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> might be an invariant, it's not <em>inductively invariant</em>.</p>
<p>So, this 2-states-at-a-time technique can be a great way to quickly show that <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> is invariant. But if it fails, we need to do more work!</p>
</details>
<p>We see this happen when we try to run the above checks for our binary-search model! The <code>inductiveStep</code> test fails, and we get a counterexample. </p>
<h3 id="fix-1-maybe-the-property-is-wrong"><a class="header" href="#fix-1-maybe-the-property-is-wrong">Fix 1: Maybe the Property is Wrong!</a></h3>
<p>Sometimes there are conditions about the world that we need in order for the system to work at all. For example, we already require the array to be sorted, or binary search breaks. Are there other requirements? </p>
<p>It turns out that there are. Here's one: <a href="https://research.google/blog/extra-extra-read-all-about-it-nearly-all-binary-searches-and-mergesorts-are-broken/">the classic way to write binary search is actually broken in most systems</a>. If I write <code>mid = (low + high) / 2</code>, and I'm working with machine integers (which have a maximum value), what happens if the array is large relative to the maximum integer in the system?</p>
<details>
<summary>Think, then click!</summary>
<p>On a 32-bit system, the maximum <code>int</code> value is <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord">4</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">294</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">967</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">295</span></span></span></span>, and any value over that &quot;wraps around&quot;. So if the array is just a couple billion elements long (easily reachable even in the early 2000's at Google scale), the value of <code>(high+low)</code> can overflow. For example: </p>
<pre><code>low = 2,500,000,000
high = 3,000,000,000
low + high = 5,500,000,000 - 4,294,967,295 = 1,205,032,705
</code></pre>
<p>But this index isn't between <code>low</code> and <code>high</code>, and so the algorithm breaks. In Forge, we can adjust the number of bits available, and see the problem much sooner. </p>
</details>
<p>We're not trying to <em>fix</em> this problem in the algorithm. This is a real bug. Our modeling found it (admittedly, 20 years after the linked blog post). So let's remember the issue, and proceed. If the array is small enough, is the algorithm correct? We'll add a <em>global assumption</em> that the array is not so large. We'll add that in the <code>safeArraySize</code> predicate, which we'll then use in the 2 checks. </p>
<p>How can we express what we want: that the array is not too large?</p>
<details>
<summary>Think, then click!</summary>
<p>The core challenge here is that we'll never have enough integers to actually count <code>#Int</code>. However, we <em>can</em> ask for the maximum integer---<code>max[Int]</code>. So we could say that <code>arr.lastIndex</code> is less than <code>divide[max[Int], 2]</code>. This might be a little conservative, but it guarantees that the array is never larger than half of the maximum integer, and so it works for our purposes here.</p>
</details>
</br>
<p><strong>Exercise</strong>: Try expressing this in the <code>safeArraySize</code> predicate, and adding it to the test that failed. Add a comment explaining why this is a requirement.</p>
<h3 id="fix-2-enriching-the-invariant"><a class="header" href="#fix-2-enriching-the-invariant">Fix 2: Enriching the Invariant</a></h3>
<p>Sometimes the property we're hoping to verify <em>is</em> invariant in the system, but it's <em>not</em> preserved by the system transitions when we look at them in isolation. This would mean that the pre-state in any counterexample isn't actually reachable. In the full-trace approach, we didn't have this problem, since the trace was rooted in an initial state. <strong>This is the tradeoff of the inductive approach!</strong> We gain a big performance boost, but sometimes we have to do more work to make progress.</p>
<p>Concretely, we'll need to <em>verify something stronger</em>. At the very least, if <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span> is the pre-state of the counterexample we were given, we need to change our property to be (where <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> is the old property) &quot;<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> and the state isn't <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span>&quot;. In practice, we try to add something more general that expresses the root cause of why <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span> shouldn't be reachable.</p>
<p>The technique is sometimes called &quot;enriching the invariant&quot;. </p>
<p><strong>Exercise</strong>: Do you believe the counterexample you're getting is reachable? If not, what is it about the state that looks suspicious?</p>
<p><strong>Exercise</strong>: Now add new constraints to the <code>bsearchInvariant</code> predicate that exclude this narrow criterion. <em>Be careful not to exclude too much!</em> An over-constrained property can be easy to verify, but may not actually give many guarantees.</p>
<h2 id="but-can-we-trust-the-model"><a class="header" href="#but-can-we-trust-the-model">But Can We Trust The Model?</a></h2>
<p>Look again at the two checks we wrote. If <code>initial</code> were unsatisfiable, surely the Step 1 check would also be unsatisfiable (since it just adds <em>more</em> constraints). Similarly, unsatisfiable transition predicates would limit the power of Step 2 to find ways that the system could transition out of safety. If either of these bugs existed, Forge would find no initial bad states, and/or no bad transitions. It would look like the property was invariant, but really the check out pass because our model was overconstrained. </p>
<p>More concretely, Step 1 checks that <code>all s: State | initial[s] implies good[s]</code>. But if no <code>s</code> can possibly satisfy <code>initial</code>, then the overall constraint evaluates to true—no counterexamples are possible! This problem is called <em>vacuity</em> or <em>vacuous truth</em>, and it's a threat to modeling success. </p>
<div id="admonition-put-another-way" class="admonition admonish-note">
<div class="admonition-title">
<p>Put another way...</p>
<p><a class="admonition-anchor-link" href="chapters/inductive/bsearch.html#admonition-put-another-way"></a></p>
</div>
<div>
<p>Suppose I told you: &quot;All my billionaire friends love Logic for Systems&quot;. I have, as far as I know anyway, no billionaire friends. So is the sentence true or false? You might (quite reasonably) say that it shouldn't be either true or false, but some sort of third value that indicates inapplicability. There are logics that work that way, but they tend to either be complicated, or to complicate building tools using them. So Forge uses classical logic, where <code>A implies B</code> is equivalent to <code>(not A) or B</code>. </p>
<p>The result is: Forge would say that the sentence is true. After all, there's no billionaire friend of mine who <em>doesn't</em> love Logic for Systems...
~~</p>
<p><strong>Watch out! Pay attention!</strong>
This is a problem you might first hear about in a logic or philosophy textbook. So there's a risk you'll think vacuity is silly, or possibly a topic for debate among people who like drawing their As upside down and their Es backwards, and love writing formulas with lots of Greek letters in. <strong>Don't be fooled!</strong> Vacuity is a major problem even in industrial settings, because verification tools are literal-minded. </p>
<p><strong>TODO: insert industry links from EdStem ref'd in 2024</strong></p>
<p>At the very least, we'd better test that the left-hand-side of the implication can be satisfied. This isn't a guarantee of trustworthiness, but it's a start. And it's easy to check with Forge that some state can be <code>initial</code> or some transition can be executed:</p>
<pre><code class="language-forge">test expect {
  {some s: State | initial[s]} is sat
  {some pre, post: State | transition[pre, post]} is sat
}
</code></pre>
<p>Make sure you're always testing vacuity. Errors like this are more common than you might think.</p>
</div>
</div><div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="bsts-recursive-descent"><a class="header" href="#bsts-recursive-descent">BSTs: Recursive Descent</a></h1>
<p>When we last modeled <a href="chapters/bst/../bst/bst.html">binary search trees</a>, we defined what it meant to be a binary tree, and had two different candidates for the BST invariant. Now we'll return to BSTs and model the classic recursive <em>BST search</em> algorithm. Just like games of tic-tac-toe, a BST search can be represented as a sequence of states that evolve as the algorithm advances. </p>
<p>As a reminder, we had defined binary-tree nodes like this:</p>
<pre><code class="language-forge">sig Node {
  key: one Int,     -- every node has some key 
  left: lone Node,  -- every node has at most one left-child
  right: lone Node  -- every node has at most one right-child
}
</code></pre>
<p>Just like in the last example, we'll start by adding a sig for the state of the system. The &quot;system&quot; here is the recursive search, so it should have fields that are used in that context. Really, the only thing that changes during the recursive descent is the node currently being visited:</p>
<pre><code class="language-forge">-- Since a BST descent doesn't need to backtrack, the state can be fairly simple.
sig SearchState {
    current: lone Node -- the node currently being visited
}
</code></pre>
<p>Then we'll define a <code>one</code> sig for the overall search. As with tic-tac-toe, Forge will find instances that represent a single search, embodied by the <code>Search</code> atom and its fields:</p>
<pre><code class="language-forge">one sig Search {
    target: one Int, -- the target of the search (never changes)
    -- The first state and successor-state function for this trace
    initialState: one SearchState,
    nextState: pfunc SearchState -&gt; SearchState
}
</code></pre>
<p>What does an initial state of the search look like? We'd better be at the root of the tree! </p>
<pre><code class="language-forge">pred init[s: SearchState] {    
    isRoot[s.current]
}
</code></pre>
<p>Now for the more complicated part. How does a step of the recursive descent work? At any given node:</p>
<ul>
<li>First, it checks whether <code>current.key = target</code>. If yes, it's done.</li>
<li>It checks whether <code>current.key &lt; target</code>. If yes, it moves to the left child if it exists, and returns failure otherwise.</li>
<li>It checks whether <code>current.key &gt; target</code>. If yes, it moves to the right child if it exists, and returns failure otherwise.</li>
</ul>
<p>That's not so bad, but it feels like there are two different kinds of transition that our system might take. Let's give each of them their own predicates, just to avoid them getting tangled with each other: </p>
<ul>
<li><code>descendLeft</code> will apply if the target is to the left.</li>
<li><code>descendRight</code> will apply if the target is to the right.
If neither can apply, the algorithm is done: either the target has been found, or the search has &quot;hit bottom&quot; without finding the target.</li>
</ul>
<p>Let's start writing them, beginning with <code>descendLeft</code>. We'll follow the discipline of separating the <em>guard</em> and <em>action</em> of each transition <code>pred</code>:</p>
<pre><code class="language-forge">pred descendLeft[pre, post: SearchState] {
  -- GUARD 
  Search.target &lt; pre.current.key
  some pre.current.left
  -- ACTION
  post.current = pre.current.left
}
</code></pre>
<p>Because only the current node is a component of the search state, we only need to define the new current node in the action.</p>
<p><strong>Exercise:</strong> Write <code>descendRight</code> yourself. The structure should be very similar to <code>descendLeft</code>. </p>
<details>
<summary>Think, then click!</summary>
<p>You might write something like this:</p>
<pre><code class="language-forge">pred descendRight[pre, post: SearchState] {
  -- GUARD 
  Search.target &gt; pre.current.key
  some pre.current.right
  -- ACTION
  post.current = pre.current.right
}
</code></pre>
</details>
<hr />
<p>Let's do some basic validation:</p>
<pre><code class="language-forge">test expect {
    -- let's check that these two transitions are mutually-exclusive
    r_l_together: {some s: SearchState | {descendLeft[s] and descendRight[s]}} for 7 Node is unsat
    -- let's check that transitions are all possible to execute
    r_sat: {some s: SearchState | descendRight[s]} for 7 Node is sat
    l_sat: {some s: SearchState | descendLeft[s]} for 7 Node is sat
    -- initial state is satisfiable
    init_sat: {some s: SearchState | init[s]} for 7 Node is sat
}
</code></pre>
<hr />
<p>Now we'll combine these predicates into one that defines the entire recursive descent. The shape of this predicate is somewhat boilerplate; soon we'll see how to get rid of it entirely. For now, we'll just copy from the tic-tac-toe example and make small, local changes. Namely:</p>
<ul>
<li>we called the trace sig <code>Search</code>, not <code>Game</code>;</li>
<li>we called the state sig <code>SearchState</code>, not <code>Board</code>; and </li>
<li>we have two different transition predicates to include.</li>
</ul>
<pre><code class="language-forge">pred traces {
    -- the graph is well-formed to begin with
    binary_tree
    -- The trace starts with an initial state
    init[Search.initialState]
    no sprev: SearchState | Search.nextState[sprev] = Search.initialState
    -- Every transition is a valid move
    all s: SearchState | some Search.nextState[s] implies {
        descendLeft [s, Search.nextState[s]] or 
        descendRight[s, Search.nextState[s]]
    }
}
</code></pre>
<p>Let's run it!</p>
<pre><code class="language-forge">run {traces} for exactly 7 Node, 5 SearchState for {nextState is plinear}
</code></pre>
<p>The output may initially be overwhelming: by default, it will show <em>all</em> the atoms in the world and their relationships, including each <code>SearchState</code>. You could stay in the default visualizer and mitigate the problem a <em>little</em> by clicking on &quot;Theme&quot; and then &quot;Add Projection&quot; for <code>SearchState</code>. The problem is that this hides the <code>current</code> node indicator for the current state, since the current state becomes implicit. </p>
<p>Instead, let's use a custom visualization. There are multiple options included with this book:</p>
<ul>
<li><a href="chapters/bst/./bst.js"><code>bst.js</code></a>, which visualizes the tree itself, without any regard to the descent. This is useful for debugging the basic tree model and the invariants themselves.</li>
<li><a href="chapters/bst/./bst_descent.js"><code>bst_descent.js</code></a>, which visualizes the <em>descent</em> in one picture. </li>
<li>(Don't run this yet!) <code>bst_temporal.js</code>, which visualizes a Temporal Forge version of the model, which we'll get to soon.</li>
</ul>
<p>If we run <code>bst_descent.js</code> for this instance, it will draw the tree and highlight the path taken in the recursive descent. A node with the target key will have a thick border. A node that's visited in the descent will have a red border. So a correct descent should never show a node with a thick border that isn't red. </p>
<p><strong>TODO fill: how to run? Did we describe this already?</strong></p>
<p>This is easier to read, but also a little worrying: we see two nodes visited, and they aren't directly connected! </p>
<p><strong>Exercise:</strong> What's going on? (Hint: examine the table view. How many search states are there? Are they all in the trace?)</p>
<details>
<summary>Think, then click!</summary>
<p>The problem is that we allowed <code>SearchState</code> atoms to exist without being used in the trace. The visualizer script is highlighting a node that <em>any</em> <code>SearchState</code> uses. So we have two options: </p>
<ul>
<li>change the visualizer script to only look at states reachable from the first one; or</li>
<li>add a constraint that forces all <code>SearchState</code> atoms to be used. </li>
</ul>
<p>We'll go for the second fix, adding this line to the <code>traces</code> predicate:</p>
<pre><code class="language-forge">-- All SearchStates are used
all s: SearchState | { 
  s = Search.initialState or 
  reachable[s, Search.initialState, Search.nextState]
}
</code></pre>
</details>
<p>Ok, that's better, but we still aren't seeing a <em>complete</em> descent. To fix that, we'll say that, eventually, the descent either reaches bottom or a node with the target value:</p>
<pre><code class="language-alloy">run {
  binary_tree 
  traces
  some s: SearchState | s.current.key = Search.target or (no s.current.left and no s.current.right)
} for exactly 7 Node, 5 SearchState for {nextState is plinear}
</code></pre>
<p>That's more like it. But what about the invariants? We only said <code>binary_tree</code> had to hold, which means that the tree being searched isn't necessarily a binary <em>search</em> tree yet.</p>
<h3 id="trying-different-invariants"><a class="header" href="#trying-different-invariants">Trying Different Invariants</a></h3>
<p>In our <a href="chapters/bst/./bst.html">original BST model</a>, we'd sketched two different invariants:</p>
<p><strong>Version 1</strong> (<code>invariant_v1</code>): For all nodes <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>:</p>
<ul>
<li>all left-descendants of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> have a key less than <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>'s key; and </li>
<li>all right-descendants of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> have a key greater than or equal to <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>'s key.</li>
</ul>
<p><strong>Version 2</strong> (<code>invariant_v2</code>): For all nodes <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>:</p>
<ul>
<li>the left child of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> (if any) has a key less than <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>'s key; and </li>
<li>the right child of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> (if any) has a key greater than or equal to <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>'s key.</li>
</ul>
<p>We were able to look at trees that met one invariant but not another, but now we can do something much more powerful: we can ask Forge to show us how the differing invariants affect the recursive descent on the tree! If an invariant is &quot;wrong&quot;, surely it will cause the descent to fail in some way. Since we've already modeled the descent, this should be easy. Let's try it for <code>invariant_v2</code>:</p>
<pre><code class="language-forge">run {
  binary_tree     -- it must be a binary tree
  all n: Node | invariant_v2[n]    -- additionally, the tree satisfies invariant version 1
  some n: Node | n.key = Search.target -- the target is present
  traces          -- do a search descent
  -- Finally, the trace finishes the search
  some s: SearchState | s.current.key = Search.target or no (s.current.left + s.current.right)
} for exactly 7 Node, 5 SearchState for {nextState is plinear}
</code></pre>
<p>This will show us instances of a descent for a tree following <code>invariant_v2</code>. To see descents for trees following the other invariant, just change <code>invariant_v2</code> to <code>invariant_v1</code>. If you look at a few instances for <code>invariant_v2</code>, you should notice that one of the invariants can make the descent fail: the tree contains the target, but it's never found. You'll see something like this: </p>
<img alt="a binary tree following invariant 2, where the recursive descent fails to find the target" src="chapters/bst/./bst_invar2_buggy.png" width=60%/>
<h3 id="verifying-bsts"><a class="header" href="#verifying-bsts">Verifying BSTs</a></h3>
<p>Notice what just happened. We built up our structural model to contain a collection of related features, such as:</p>
<ul>
<li>binary trees with numeric node values; </li>
<li>multiple possible invariants for these trees to follow; and </li>
<li>a recursive-descent algorithm on those binary trees.</li>
</ul>
<p>Before, we could only ask Forge to show us that the invariants were different, which wasn't very useful—at least not immediately. Then, in this section, we added a discrete event model of BST search atop the original, which gave us something more powerful: representations of how the different invariants might <em>impact</em> the search algorithm. We can even verify that <code>invariant_v1</code> is correct (for reasonably-sized example trees). </p>
<p><strong>Exercise:</strong> Do this now! Write either a <code>run</code> or <code>test expect</code> confirming that if <code>invariant_v1</code> holds for all nodes, then the recursive descent will be successful at finding a present target value. </p>
<details>
<summary>Think, then click!</summary>
<p>I'll write my version as a <code>run</code>, so we can better match the one above. </p>
<pre><code class="language-forge">run {
  binary_tree    
  all n: Node | invariant_v1[n]   
  some n: Node | n.key = Search.target -- the target is present
  traces     
  -- The trace finishes the search without finding the target
  some s: SearchState | no (s.current.left + s.current.right)
  no s: SearchState   | s.current.key = Search.target
} for exactly 7 Node, 5 SearchState for {nextState is plinear}
</code></pre>
</details>
<p><strong>Bonus Exercise:</strong> Do the numeric bounds in the commands above seem OK to you? Is there any situation you might be worried about, beyond example trees that are bigger than 7 nodes?</p>
<details>
<summary>Think, then click!</summary>
<p>Trees aren't always balanced. It's possible that there could be <code>7</code> nodes arranged like a linear list, with the target value at the bottom-most node. In this case, <code>5</code> states wouldn't be enough; Forge wouldn't ever even look for such a situation, because we said that the descent ended when it reached the bottom of the tree, and we lack the states to get there.</p>
<p>This is a great example of how carefully considering bounds and exploring the structural model before doing more complex verification is vital. To really be complete for 7-node trees, we would need up to 7 <code>SearchState</code> atoms as well.</p>
</details>
<h3 id="looking-ahead"><a class="header" href="#looking-ahead">Looking Ahead</a></h3>
<p>Of course, this is still a very simple model. Binary Search Trees are much less complicated than many other data structures, and even complex data structures are only part of a larger system. </p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="validating-models"><a class="header" href="#validating-models">Validating Models</a></h1>
<ul>
<li>Now that we have the full discrete-event story, we can talk more carefully about model validation.</li>
<li>Adapt from work with Pamela and credit her. </li>
</ul>
<h2 id="interlude-on-testing-and-properties"><a class="header" href="#interlude-on-testing-and-properties">Interlude on Testing and Properties</a></h2>
<p>As we start modeling more complex systems, models become more complex. The more complex the model is, the more important it is to test the model carefully. Just like in software testing, however, you can never be 100% sure that you have tested everything. Instead, you proceed using your experience and following some methodology. </p>
<p>Let's get some practice with this. Before we start modifying our locking algorithm model, we should think carefully---both about testing, but also about how the model reflects the real world. </p>
<h3 id="principle-1-whats-the-domain-whats-the-system"><a class="header" href="#principle-1-whats-the-domain-whats-the-system">Principle 1: What's the Domain? What's the System?</a></h3>
<p>When we're writing a model, it's useful to know when we're talking about the <em>system</em>, and when we're talking about the <em>domain</em> that the system is operating on. </p>
<ul>
<li>The domain has a set of behaviors it can perform on its own. In this example, the threads represent the domain: programs running concurrently. </li>
<li>The system affects that set of behaviors in a specific way. In this example, the locking algorithm is the system. Usually the system functions by putting limits and structure on otherwise unfettered behavior. (E.g., without a locking algorithm in place, in reality threads would still run and violate mutual exclusion.)</li>
<li>Because we usually have goals about how, exactly, the system constrains the domain, we state <em>requirements</em> about how the domain behaves in the system's presence. Think of these as the top-level goals that we might be modeling in order to prove (or disprove) about the system or otherwise explore.</li>
<li>Because the domain cannot &quot;see&quot; inside the system, we'll try to avoid stating requirements in terms of internal system variables. However, models are imperfect! We will also have some <em>validation tests</em> that are separate from the requirements. These may or may not involve internal system state.</li>
</ul>
<p>We'll develop these ideas more over the next few weeks. For now, keep in mind that when you add something to a model, it's good to have a sense of where it comes from. Does it represent an internal system state, which should probably not be involved in a requirement, but perhaps should be checked in model validation?</p>
<div id="admonition-have-we-been-disciplined-about-this-so-far" class="admonition admonish-note">
<div class="admonition-title">
<p>Have we been disciplined about this so far?</p>
<p><a class="admonition-anchor-link" href="chapters/validation/validating_events.html#admonition-have-we-been-disciplined-about-this-so-far"></a></p>
</div>
<div>
<p>No we have not! And we may be about to encounter some problems because of that.</p>
</div>
</div>
<h3 id="principle-2-what-can-be-observed"><a class="header" href="#principle-2-what-can-be-observed">Principle 2: What Can Be Observed?</a></h3>
<p>Ask what behaviors might be important in the domain, but not necessarily always observed. These are sometimes referred to as <em>optional predicates</em>, because they may or may not hold. In real life, here are some optional predicates:</p>
<ul>
<li>we have class today;</li>
<li>it's raining today; </li>
<li>homework is due today; etc. </li>
</ul>
<p><strong>Exercise:</strong> What are some optional predicates about the domain in our locking algorithm model? </p>
<details>
<summary>Think, then click!</summary>
<p>We might see, but won't necessarily always see:</p>
<ul>
<li>combinations of different transitions; </li>
<li>threads that are both simultaneously interested;</li>
<li>threads that are uninterested; </li>
<li>etc.</li>
</ul>
<p>As the model includes more domain complexity, the set of optional predicates grows. </p>
</details>
<p>Let's write some actual tests to confirm that these behaviors can happen (or not), and check whether that matches our modeling intuition. </p>
<div id="admonition-for-next-time" class="admonition admonish-note">
<div class="admonition-title">
<p>For Next Time</p>
<p><a class="admonition-anchor-link" href="chapters/validation/validating_events.html#admonition-for-next-time"></a></p>
</div>
<div>
<p>We'll consider questions of atomicity (how granular should transitions be?), and model a different variation of this lock.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="qa-event-systems"><a class="header" href="#qa-event-systems">Q&amp;A: Event Systems</a></h1>
<p><strong>TODO: consider advanced question: correspondence??? is there one between the array version and the tree version?</strong></p>
<h2 id="more-on-optimization-inst-syntax"><a class="header" href="#more-on-optimization-inst-syntax">More on Optimization: <code>inst</code> Syntax</a></h2>
<p>The syntax that you use in <code>example</code>s and to say <code>is linear</code> for a field (like you saw in the <a href="chapters/qna/../adder/rca.html">ripple-carry adder</a>) is more expressive than you've seen so far. Recall that Forge has <a href="chapters/qna/./static.html">two phases</a>: deliniating the allowed search space, and solving the constraints within that search space. This new syntax lets you define a <em>partial instance</em>, which affects the first phase to limit the possible instances the solver will consider.</p>
<p>You can even define a reusable partial instance using the <code>inst</code> command, and use it in the same place you'd use <code>{next is linear}</code> in a <code>run</code>, <code>assert</code>, etc. For example, we could pre-define the set of full adders in the <a href="chapters/qna/../adder/rca.html">ripple-carry adder</a> model, giving each an atom name:</p>
<pre><code class="language-alloy">inst fiveBits {
  FA = `FA0 + `FA1 + `FA2 + `FA3 + `FA4 + `FA5
} 
run {rca} for exactly 1 RCA for {fiveBits}
</code></pre>
<p>Because this defines the set of <code>FA</code> atoms that must exist, it does something quite similar to just saying <code>for exactly 5 FA</code>. If we then add entries for the <code>RCA</code>'s fields, we manually accomplish what <code>nextAdder is linear</code> would as well, while simultaneously making sure the first full adder in that ordering is what we see in <code>RCA.firstAdder</code>:</p>
<pre><code class="language-alloy">inst fiveBits {
  RCA = `RCA0 
  FA = `FA0 + `FA1 + `FA2 + `FA3 + `FA4 + `FA5
  -- Remember the back-tick mark here before atom names! 
  `RCA0.firstAdder = `FA0
  `RCA0.nextAdder = `FA0 -&gt; `FA1 + `FA1 -&gt; `FA2 + `FA2 -&gt; `FA3 + 
                    `FA3 -&gt; `FA4 + `FA4 -&gt; `FA5
} 
run {rca} for exactly 1 RCA for {fiveBits}
</code></pre>
<p>So far this is just a long-handed way of doing what we've already done. But partial instances are far more flexible. Remember the optimization we had to do in <a href="chapters/qna/../ttt/ttt_games.html">tic-tac-toe games</a>, where we reduced the bitwidth from <code>4</code> to <code>3</code>? Partial instances give us a much finer degree of control. Where <code>for 3 Int</code> still allows any integer between <code>-4</code> and <code>3</code> to be used, we can use a partial instance to <em>force</em> well-formedness, before the solver ever sees a constraint: </p>
<pre><code class="language-forge">inst ttt_indexes {
  Board = `Board0
  X = `X   O = `O
  Player = X + O
  board in Board -&gt; (0 + 1 + 2) -&gt; (0 + 1 + 2) -&gt; Player
}
</code></pre>
<p>This says that any entry in any board's <code>board</code> field can only use the values <code>0</code> through <code>2</code>, inclusive. It has an impact very similar to the <code>wellformed</code> pred we wrote, but can be much more efficient. (You'll learn more about why in the next chapter.)</p>
<p><strong>Exercise</strong>: Compare the statistical info for the original tic-tac-toe game run with and without this added partial instance information. Do you notice any changes? What do you think might be going on, here? </p>
<details>
<summary>Think, then click!</summary>
<p>The statistical information is reporting runtime, but also something else: the number of &quot;clauses&quot; and &quot;variables&quot;. It turns out these express how big the boolean constraint problem is before the solver gets it. Partial instances can reduce these, and thus make the problem easier for the solver. </p>
</details>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="modeling-boolean-logic-syntax-semantics-and-sets"><a class="header" href="#modeling-boolean-logic-syntax-semantics-and-sets">Modeling Boolean Logic (Syntax, Semantics, and Sets)</a></h1>
<p>In this chapter, we'll start writing a new model from scratch to meet 3 broad goals:</p>
<ul>
<li>expanding Forge's expressive power to support <em>sets</em> and <em>relations</em>;</li>
<li>modeling more recursive concepts in a language without recursion; and </li>
<li>modeling a <em>syntax</em> for a language, along with its <em>semantics</em>.</li>
</ul>
<p>You can find the completed models <a href="chapters/relations/./booleanLogic.frg">here</a>.</p>
<!-- ## In-class exercise

We'll warm up with an in-class exercise. I'd like everyone to take 5 minutes responding to this [request for feedback about Toadus Ponens](https://docs.google.com/forms/d/e/1FAIpQLSfv7p6PH1ZkXQuSc-29NmFRwDS5JQiDX-6cHdHehvabpfBE7g/viewform). Feedback here is actionable; e.g., we might be able to make Forge give an overall test report rather than stopping after the first test failure---something that came out of the feedback so far.   -->
<h2 id="modeling-boolean-formulas"><a class="header" href="#modeling-boolean-formulas">Modeling Boolean Formulas</a></h2>
<p>If you've spent time writing programs, then you've already spent a lot of time working with boolean formulas. E.g., if you're building a binary search tree in Java, you might write something like this to check the left-descent case:</p>
<pre><code class="language-java=">if(this.getLeftChild() != null &amp;&amp;
   this.getLeftChild().value &lt; goal) { 
    ... 
}
</code></pre>
<p>The conditional inside the <code>if</code> is a boolean formula with two <em>boolean variables</em> (also sometimes called <em>atomic propositions</em>) corresponding to <code>leftChild == null</code> and <code>leftChild.value &lt; goal</code>. A <code>!</code> (<code>not</code>) negates the equality check, and a single <code>&amp;&amp;</code> (and) combines the conditions. The syntax of the conditional forms a tree, with atoms for the two boolean variables, the <code>not</code> and the <code>and</code>:</p>
<center><img width="40%" src="chapters/relations/./Ifcond.png"/></center>
<!-- ```alloy
example leftBranchFormula is {} for {
  And = `And0
  Var = `VarNeqNull + `VarLTLeft
  Formula = And + Var
}
``` -->
<h2 id="modeling-boolean-formulas-1"><a class="header" href="#modeling-boolean-formulas-1">Modeling Boolean Formulas</a></h2>
<p>Let's define some types for formulas. Like we've done before when defining a hierarchy of types, we'll make an <code>abstract sig</code> to represent the collection of <em>all</em> kinds of formulas, and have child <code>sig</code>s that represent specific kinds:</p>
<pre><code class="language-alloy">-- Syntax: formulas
abstract sig Formula {}
sig Var extends Formula {} 
sig Not extends Formula {child: one Formula} 
sig Or extends Formula {o_left, o_right: one Formula}
sig And extends Formula {a_left, a_right: one Formula}
-- If we really wanted to, we could add `Implies`, `IFF`, etc. in the same way.
</code></pre>
<div id="admonition-field-names" class="admonition admonish-note">
<div class="admonition-title">
<p>Field names</p>
<p><a class="admonition-anchor-link" href="chapters/relations/modeling-booleans-1.html#admonition-field-names"></a></p>
</div>
<div>
<p>Forge doesn't allow re-use of field names between sigs. If you try, you'll get an error that says the name is already used. So we need to name the left and right children of the <code>And</code> and <code>Or</code> types differently. Hence the <code>o_</code> and <code>a_</code> prefixes.</p>
</div>
</div>
<h3 id="wellformedness-1"><a class="header" href="#wellformedness-1">Wellformedness</a></h3>
<p>As always, we need a notion of wellformedness. What would make a formula tree &quot;garbage&quot;? Well, if the syntax tree contained a cycle, the tree wouldn't be a tree, and the formula wouldn't be a formula! We'll write a <code>wellformed</code> predicate where an assertion like this will pass:</p>
<pre><code class="language-alloy">pred trivialLeftCycle { 
    some a: And | a.a_left = a
}
pred notWellformed { not wellformed }
assert trivialLeftCycle is sufficient for notWellformed
</code></pre>
<p><strong>(TODO: I don't like the need to create a secondary helper <code>notWellformed</code>. Discuss with SP.)</strong></p>
<p>Like in binary trees, there are multiple fields that a cycle could use. Then, we only needed to worry about <code>left</code> and <code>right</code>; here there are many more. Let's build a helper predicate that evaluates whether a formula is a smaller part of another:</p>
<pre><code class="language-alloy">-- IMPORTANT: remember to update this if adding new formula types!
pred subFormulaOf[sub: Formula, f: Formula] {
  reachable[sub, f, child, a_left, o_left, a_right, o_right]
}
</code></pre>
<p>At first, this might seem like a strange use of a helper. There's just one line, and all it does is call the <code>reachable</code> built-in predicate. However, we probably need to check for subformulas in multiple places in our model. And, we might anticipate a need to add more formula types (maybe we get around to adding <code>Implies</code>). Then we need to remember to add the fields of the new <code>sig</code> everywhere that <code>reachable</code> is used. And if we leave one out, we probably won't get an error. So making this helper is just good engineering practice; this way, we minimize the number of places that need the change. </p>
<pre><code class="language-alloy">pred wellformed {
  -- no cycles
  all f: Formula | not subFormulaOf[f, f]
}
</code></pre>
<div id="admonition-remember-what-wellformed-is-for" class="admonition admonish-warning">
<div class="admonition-title">
<p>Remember what <code>wellformed</code> is for</p>
<p><a class="admonition-anchor-link" href="chapters/relations/modeling-booleans-1.html#admonition-remember-what-wellformed-is-for"></a></p>
</div>
<div>
<p>Recall that we use wellformed to exclude &quot;garbage&quot; instances only, analogously to filtering an input generator in property-based testing. The stuff we might want to verify (or build a system to enforce) goes elsewhere—or else Forge will exclude any potental counterexamples.</p>
</div>
</div>
<p>We'll want to add <code>wellformed</code> to the first example we wrote, but it should still pass. Let's run the model and look at some formulas! We could just <code>run {wellformed}</code>, but that might be prone to giving uninteresting examples. Let's try identifying the root node in our <code>run</code> constraint, which would let us ask for something more complex:</p>
<pre><code class="language-alloy">run {
  wellformed
  some top: Formula | {
    all other: Formula | top != other =&gt; {
      subFormulaOf[other, top]
    }
  }
} for exactly 8 Formula
</code></pre>
<p>Try running this. You should see some example formula trees; we've modeled the <em>syntax</em> of boolean logic. </p>
<p><strong>Exercise:</strong> Write at least one more positive and one more negative test for <code>wellformed</code> in this model. </p>
<p><strong>Exercise:</strong> Why didn't we add a constraint to prevent nodes from having multiple parents? That is, why didn't we prevent an instance like this? (And, in light of that, is it really fair to call these &quot;trees&quot;?)</p>
<center><img width="40%" src="chapters/relations/./Dagformula.png"/></center>
<p><strong>TODO: add image</strong></p>
<details>
<summary>Think, then click!</summary>
<p>If we wanted to exlude &quot;sharing&quot; of child formulas, we'd need to allow multiple nodes to have the same meaning. E.g., if we had a variable <code>x</code>, we'd need to allow multiple <code>Var</code> atoms to represent <code>x</code>, which would greatly complicated the model and increase the size of its instances. Instead, we let one <code>Var</code> atom be re-used in multiple contexts. </p>
<p>So, while the instances aren't (strictly speaking) trees, they <em>represent</em> trees in an efficient way. </p>
</details>
<h2 id="the-meaning-of-boolean-circuits"><a class="header" href="#the-meaning-of-boolean-circuits">The <em>Meaning</em> Of Boolean Circuits</a></h2>
<p>What's the <em>meaning</em> of a formula? So far they're just bits of syntax in isolation; we haven't defined a way to understand them or interpret them. This distinction between syntax and its meaning is <em>really important</em>, and touches every aspect of computer science. Indeed, it deeply affects anywhere we use a language. </p>
<p>To see why, let's go back to that Java BST example, with the boolean conditional:</p>
<pre><code class="language-java=">if(this.getLeftChild() != null &amp;&amp; this.getLeftChild().value &lt; goal) { 
    ... 
}
</code></pre>
<p><strong>Exercise:</strong> Suppose that the <code>getLeftChild()</code> method increments a counter whenever it is called. Suppose the counter is <code>0</code> before this <code>if</code> statement runs. What will it be afterward?</p>
<details>
<summary>Think, then click!</summary>
<p>It depends! </p>
<ul>
<li>If the left-child is non-null, the counter will hold <code>2</code> afterward, because <code>getLeftChild()</code> will be called twice. </li>
<li>If the left-child is null, and we're working in a language like Java, which &quot;short circuits&quot; conditionals, the counter would be <code>1</code> since the second branch of the <code>&amp;&amp;</code> wouldn't execute.</li>
</ul>
<p>In another language, one that <em>didn't</em> have short-circuiting conditionals, the counter might be <code>2</code> in both cases. And in yet <em>another</em> language, where <code>getLeftChild()</code> might be cached and only called once, both counters might be <code>1</code>!</p>
</details>
<br/>
<h3 id="whats-the-point"><a class="header" href="#whats-the-point">What's the point?</a></h3>
<p>If we don't know the <em>meaning</em> of that <code>if</code> statement and the <code>and</code> within it, we don't actually know what will happen! Syntax can mislead us, especially if we have pre-existing intuitions. And if we want to reason about what a piece of syntax <em>does</em>, we need to understand what the syntax <em>means</em>. </p>
<p>Right now we're modeling boolean formulas. So let's understand the meaning of formulas; sometimes this is called their <em>semantics</em>. </p>
<p><strong>Exercise:</strong> What can I <em>do</em> with a formula? What kind of operations is it meant to enable? </p>
<details>
<summary>Think, then click!</summary>
<p>If I have a formula, I can plug in various values into its variables and read off the result: does the overall formula evaluate to true or false when given those values? This is what we want to encode in our model.</p>
<p>Let's think of a boolean formula like a function from <em>sets of variable values</em> to a <em>result boolean</em>. </p>
</details>
<br/>
<p>We'll need a way to represent &quot;sets of variable values&quot;. Sometimes these are called a &quot;valuation&quot;, so let's make a new <code>sig</code> for that. </p>
<pre><code class="language-alloy">sig Valuation {
  -- [HELP: what do we put here? Read on...]
}
</code></pre>
<p>We have to decide what fields a <code>Valuation</code> should have. Once we do that, we might start out by writing a <em>recursive</em> predicate or function, kind of like this pseudocode:</p>
<pre><code class="language-alloy">pred semantics[f: Formula, val: Valuation] {
  f instanceof Var =&gt; val sets the f var true
  f instanceof And =&gt; semantics[f.a_left, val] and semantics[f.a_right, val]
  ...
}
</code></pre>
<p><strong>This <em>won't work!</em></strong> Forge is not a recursive language; you won't be able to write a predicate that calls itself like this. So we've got to do something different. Let's move the recursion into the model itself, by adding a mock-boolean sig: </p>
<pre><code class="language-alloy">one sig Yes {}
</code></pre>
<p>and then adding a new field to our <code>Formula</code> sig (which we will, shortly, constrain to encode the semantics of formulas):</p>
<pre><code class="language-alloy">   satisfiedBy: pfunc Valuation -&gt; Yes
</code></pre>
<p>This <em>works</em> but it's a bit verbose and quite tangled. It'd be more clear to just say that every formula has a <em>set</em> of valuations that satisfy it. But so far we haven't been able to do that.</p>
<h4 id="language-change"><a class="header" href="#language-change">Language change!</a></h4>
<p>First, let's change our language to <code>#lang forge</code>. This gives us a language with more expressive power, but also some subtleties we'll need to address.</p>
<div id="admonition-relational-forge" class="admonition admonish-tip">
<div class="admonition-title">
<p>Relational Forge</p>
<p><a class="admonition-anchor-link" href="chapters/relations/modeling-booleans-1.html#admonition-relational-forge"></a></p>
</div>
<div>
<p>This language is called <strong>Relational Forge</strong>, for reasons that will become apparent. For now, when you see <code>#lang forge</code> rather than <code>#lang froglet</code>, expect us to say &quot;relational&quot;, and understand there's more expressivity there than Froglet gives you.</p>
</div>
</div>
<p>Now, we can write that every formula is satisfied by some <em>set</em> of valuations:</p>
<pre><code class="language-alloy">abstract sig Formula {
  -- Work around the lack of recursion by reifying satisfiability into a field.
  -- f.satisfiedBy contains an instance IFF that instance makes f true.
  -- [NEW] Relational Forge lets us create fields that contain _sets_ of values.
  satisfiedBy: set Valuation
}
</code></pre>
<p>We can now infer what field(s) <code>Valuation</code> should have. A <code>Valuation</code> isn't a formula, so it won't have a <code>satisfiedBy</code> field, but it does need to contain something. </p>
<p><strong>Exercise:</strong> What does a <code>Valuation</code> contain, and how does that translate to its field(s) in Forge?</p>
<details>
<summary>Think, then click!</summary>
<pre><code class="language-alloy">sig Valuation {
  trueVars: set Var
}
</code></pre>
</details>
<hr />
<p>Now we can encode the meaning of each formula as a predicate like this:</p>
<pre><code class="language-alloy">-- IMPORTANT: remember to update this if adding new fmla types!
-- Beware using this fake-recursion trick in general cases (e.g., graphs with cycles)
-- It's safe to use here because the data are tree shaped. 
pred semantics
{
  -- [NEW] set difference
  all f: Not | f.satisfiedBy = Valuation - f.child.satisfiedBy
  -- [NEW] set comprehension, membership
  all f: Var | f.satisfiedBy = {i: Valuation | f in i.trueVars}
  -- ...
}
</code></pre>
<p><strong>Exercise:</strong> We still need to say what <code>f.satisfiedBy</code> is for <code>Or</code> and <code>And</code> formulas. What should it be? (You might not yet know how to express it in Forge, but what should satisfy them, conceptually? Hint: think in terms of what satisfies their left and right subformulas.)</p>
<details>
<summary>Think, then click!</summary>
<p>We'd like <code>Or</code> to be satisfied when either of its children is satisfied. In contrast, <code>And</code> requires both of its children to be satisfied. We'll use <em>union</em> (<code>+</code>) and <em>intersection</em> (<code>&amp;</code>) for this.</p>
<pre><code class="language-forge">pred semantics
{
  -- [NEW] set difference
  all f: Not | f.satisfiedBy = Valuation - f.child.satisfiedBy
  -- [NEW] set comprehension, membership
  all f: Var | f.satisfiedBy = {i: Valuation | f in i.trueVars}
  -- [NEW] set union
  all f: Or  | f.satisfiedBy = f.o_left.satisfiedBy + f.o_right.satisfiedBy
  -- [NEW] set intersection
  all f: And | f.satisfiedBy = f.a_left.satisfiedBy &amp; f.a_right.satisfiedBy
}
</code></pre>
<p>In hindsight: yes, this is why you can't use <code>+</code> for integer addition in Froglet; we reserve the <code>+</code> operator to mean set union.</p>
</details>
<h3 id="is-that-all"><a class="header" href="#is-that-all">Is That All?</a></h3>
<p>No. In fact, there are some <em>Forge</em> semantics questions you might have. That's not a joke: are you sure that you know the <em>meaning</em> of <code>=</code> in Forge now? Suppose I started explaining Forge's set-operator semantics like so:</p>
<ul>
<li>Set union (<code>+</code>) in Forge produces a set that contains exactly those elements that are in one or both of the two arguments. </li>
<li>Set intersection (<code>&amp;</code>) in Forge produces a set that contains exactly those elements that are in both of the two arguments.</li>
<li>Set difference (<code>-</code>) in Forge produces a set that contains exactly those elements of the first argument that are not present in the second argument.</li>
<li>Set comprehension (<code>{...}</code>) produces a set containing exactly those elements from the domain that match the condition in the comprehension.</li>
</ul>
<p>That may sound OK at a high level, but you shouldn't let me get away with <em>just</em> saying that. </p>
<p><strong>Exercise:</strong> Why not?</p>
<details>
<summary>Think, then click!</summary>
<p>What does &quot;produces a set&quot; mean? And what happens if I use <code>+</code> (or other set operators) to combine a set and another kind of value? Am I even allowed to do that? If so, what values can I combine with sets? </p>
<p>This isn't a new question! It comes up in programming contexts, too. </p>
<ul>
<li>What happens when you add together a <code>float</code> and an <code>int</code> in Python? The result is automatically converted to a <code>float</code>. </li>
<li>What happens if you do the same in (say) OCaml? You'll get a type error unless you explicitly say to convert the <code>int</code> to a <code>float</code>. </li>
</ul>
<p>So, by analogy, which of these options does Forge use?</p>
</details>
<br/>
<p>In conversation, we're often dismissive of semantics. You'll hear people say, in an argument, &quot;That's just semantics!&quot; (to mean that the other person is being unnecessarily pedantic and quibbling about technicalities, rather than engaging). But when we're talking about how languages work, precise definitions <em>matter a lot</em>! </p>
<p><strong>In Relational Forge, <em>all</em> values are sets.</strong> A singleton value is just a set with one element, and <code>none</code> is the empty set. So <code>=</code> is <em>always</em> set equality in Relational Forge. From now on, we'll embrace that everything in Relational Forge is a set, but introduce the ideas that grow from that fact gradually, resolving potential confusions as we go.</p>
<div id="admonition-why-start-with-froglet" class="admonition admonish-note">
<div class="admonition-title">
<p>Why start with Froglet?</p>
<p><a class="admonition-anchor-link" href="chapters/relations/modeling-booleans-1.html#admonition-why-start-with-froglet"></a></p>
</div>
<div>
<p>The fact that all values in Relational Forge are sets means that <code>+</code>, <code>&amp;</code>, etc. and even <code>=</code> are always well-defined. However, our natural intuitions about how sets are different from objects can cause problems with learning Forge like this to start, and the learner's background is a major factor. Not everyone has had a discrete math class (or remembers their discrete math class). So, we start in a language where the power of sets is drastically reduced so that we can focus early on essential concepts like constraints and quantification.</p>
<p>On the other hand, sets are incredibly useful. Hence this chapter.</p>
</div>
</div>
<h4 id="returning-to-well-formedness"><a class="header" href="#returning-to-well-formedness">Returning to well-formedness</a></h4>
<p>Now we have a new kind of ill-formed formula: one where the <code>semantics</code> haven't been properly applied. So we enhance our <code>wellformed</code> predicate:</p>
<pre><code class="language-alloy">pred wellformed {
  -- no cycles
  all f: Formula | not subFormulaOf[f, f]
  -- the semantics of the logic apply
  semantics
}
</code></pre>
<h2 id="some-validation"><a class="header" href="#some-validation">Some Validation</a></h2>
<p>Here are some examples of things you might check in the model. Notice that some are:</p>
<ul>
<li>validation of the <em>model</em> (e.g., that it's possible to have instances that disagree on which formulas they satisfy); and others are </li>
<li>results about boolean logic that we might prove in a math course, like <a href="https://en.wikipedia.org/wiki/De_Morgan%27s_laws">De Morgan's Laws</a>.</li>
</ul>
<h3 id="consistency-checks"><a class="header" href="#consistency-checks">Consistency Checks</a></h3>
<pre><code class="language-alloy">-- First, some tests for CONSISTENCY. We'll use test-expect/is-sat for these. 
test expect {
  nuancePossible: {
    wellformed
    -- [NEW] set difference in quantifier domain
    --   Exercise: why do we need the &quot;- Var&quot;?
    some f: Formula - Var | {
      some i: Valuation | i not in f.satisfiedBy
      some i: Valuation | i in f.satisfiedBy
    }    
  } for 5 Formula, 2 Valuation is sat  
  ---------------------------------
  doubleNegationPossible: {
    wellformed 
    some f: Not | {
      -- [NEW] set membership (but is it &quot;subset of&quot; or &quot;member of&quot;?)
      f.child in Not      
    }
  } for 3 Formula, 1 Valuation is sat  
} 
</code></pre>
<h3 id="properties-of-boolean-logic"><a class="header" href="#properties-of-boolean-logic">Properties of Boolean Logic</a></h3>
<pre><code class="language-alloy">-- What are some properties we'd like to check? 
-- We already know a double-negation is possible, so let's write a predicate for it
-- and use it in an assertion. Since it's satisfiable (above) we need not worry 
-- about vacuous truth for this assertion.
pred isDoubleNegationWF[f: Formula] { 
    f in Not  -- this is a Not
    f.child in Not -- that is a double negation
    wellformed
} 
pred equivalent[f1, f2: Formula] {
    -- Note that this predicate is always with respect to scopes/bounds. That is, &quot;equivalent&quot; 
    -- here isn't real logical equivalence, but rather whether there is a Valuation in a given 
    -- instance on which the two formulas disagree.
    f1.satisfiedBy = f2.satisfiedBy
}

assert all n: Not | isDoubleNegationWF[n] is sufficient for equivalent[n, n.child.child] 
  for 5 Formula, 4 Valuation is unsat    

-- de Morgan's law says that 
-- !(x and y) is equivalent to (!x or !y) and vice versa. Let's check it. 

-- First, we'll set up a general scenario with constraints. 
pred negatedAnd_orOfNotsWF[f1, f2: Formula] {
    wellformed
    
    -- f1 is !(x and y)
    f1 in Not 
    f1.child in And      
    -- f2 is (!x or !y)
    f2 in Or
    f2.o_left in Not
    f2.o_right in Not
    f2.o_left.child = f1.child.a_left
    f2.o_right.child = f1.child.a_right      
}

assert all f1, f2: Formula | 
  negatedAnd_orOfNotsWF[f1, f2] is sufficient for equivalent[f1, f2]
  for 8 Formula, 4 Valuation is unsat      

-- If we're going to trust that assertion passing, we need to confirm 
-- that the left-hand-side is satisfiable! 
test expect {
    negatedAnd_orOfNotsWF_sat: {
        some f1, f2: Formula | negatedAnd_orOfNotsWF[f1, f2]
    } for 8 Formula, 4 Valuation is sat
}
</code></pre>
<h2 id="looking-forward"><a class="header" href="#looking-forward">Looking Forward</a></h2>
<p>It turns out that sets are remarkably useful for describing relationships between objects in the world. We'll explore that further in the next sections.</p>
<!-- ```  
  ---------------------------------    
  andAssociativePossible: {
    -- ((X and Y) and Z) 
    --      ^ A1MID  ^ A1TOP
    -- (X and (Y and Z)
    --      ^ A2TOP  ^ A2MID
    wellformed
    some A1TOP, A2TOP, A1MID, A2MID : And {
      A1TOP.a_left = A1MID
      A2TOP.a_right = A2MID
      A1TOP.a_right = A2MID.a_right
      A1MID.a_left = A2TOP.a_left
      A1MID.a_right = A2MID.a_left
    }
  } for 8 Formula, 4 Valuation is sat 
  andAssociativeCheck: {
    -- ((X and Y) and Z) 
    --      ^ A1MID  ^ A1TOP
    -- (X and (Y and Z)
    --      ^ A2TOP  ^ A2MID
    wellformed
    some A1TOP, A2TOP, A1MID, A2MID : And {
      A1TOP.a_left = A1MID
      A2TOP.a_right = A2MID
      A1TOP.a_right = A2MID.a_right
      A1MID.a_left = A2TOP.a_left
      A1MID.a_right = A2MID.a_left
      A1TOP.satisfiedBy != A2TOP.satisfiedBy
    }
  } for 8 Formula, 4 Valuation is unsat 
} 
```
-->
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="relations-and-reachability"><a class="header" href="#relations-and-reachability">Relations and Reachability</a></h1>
<!-- ~~~admonish note title="Brown CSCI 1710"

* Hopefully everyone has been making good progress with Curiosity Modeling! I'm seeing a lot of awesome questions on Ed and at hours. 
* Some of you are curious about how far you need to go to earn a check on the project. This is hard to give a precise answer to, because everyone's models will be different. However, I can say that we're looking for:
    * evidence that you explored your topic of choice;
    * evidence that you validated your model;
    * something you _got_ from the model (generating or solving puzzles, checking a property, or even just understanding a domain better).
* **There's a lab this week** that focuses on _sets_ and other _relational_ concepts. You'll be exploring automated memory management in Forge. This lab leads directly into the next homework, and is meant to give you useful insight into how these systems work.

~~~ -->
<p>Consider this <a href="chapters/relations/reach.frg">small Relational Forge model</a>:</p>
<pre><code class="language-alloy">#lang forge
sig Person {
    friends: set Person,
    followers: set Person
}
one sig Nim, Tim extends Person {}

pred wellformed {
    -- friends is symmetric (followers might not be)
    all disj p1, p2: Person | p1 in p2.friends implies p2 in p1.friends 
    -- you cannot follow or friend yourself
    all p: Person | p not in p.friends and p not in p.followers
}
run {wellformed} for exactly 8 Person
</code></pre>
<p>Let's run it, get a reasonably large instance, and try to figure out how to express some goals in the evaluator. </p>
<p><strong>EXERCISE</strong>: You'll be following along with each of these questions. Use the evaluator heavily---it's great for figuring out what different expressions evaluate to.</p>
<h4 id="expression-nims-followers"><a class="header" href="#expression-nims-followers">Expression: Nim's followers</a></h4>
<details>
<summary>Think, then click!</summary>
<p>This is just <code>Nim.followers</code>.</p>
</details>
<h4 id="formula-nim-is-reachable-from-tim-via-followers"><a class="header" href="#formula-nim-is-reachable-from-tim-via-followers">Formula: Nim is reachable from Tim via &quot;followers&quot;</a></h4>
<details>
<summary>Think, then click!</summary>
<p>We can use the <code>reachable</code> built-in: <code>reachable[Nim, Tim, followers]</code>.</p>
</details>
<h4 id="expression-nims-followers-followers"><a class="header" href="#expression-nims-followers-followers">Expression: Nim's followers' followers</a></h4>
<details>
<summary>Think, then click!</summary>
<p>Another application of the field! <code>Nim.followers.followers</code>.</p>
<p>But wait, what does this really mean? Since <code>Nim.followers</code> is a set, rather than a <code>Person</code>, should I be able to apply <code>.followers</code> to it? If we try this in the evaluator, it works, but we're no longer just doing a &quot;field access&quot;; something more must be going on. </p>
</details>
<h4 id="formula-nim-is-reachable-from-tim-via-the-inverse-of-followers-what-we-might-call-following"><a class="header" href="#formula-nim-is-reachable-from-tim-via-the-inverse-of-followers-what-we-might-call-following">Formula: Nim is reachable from Tim via the inverse of &quot;followers&quot; (what we might call &quot;following&quot;)?</a></h4>
<details>
<summary>Think, then click!</summary>
<p>Hmm. This seems harder. We don't have a field called <code>following</code>, and the <code>reachable</code> built-in takes fields! </p>
<p>...it does take fields, right? Or might it take something more flexible? Can we use <em>set operations</em> to adjust the potential edges that <code>reachable</code> looks at?</p>
</details>
<p>To figure that out, let's try something else.</p>
<h4 id="formula-nim-is-reachable-from-tim-via-followers-but-not-including-tims-friends"><a class="header" href="#formula-nim-is-reachable-from-tim-via-followers-but-not-including-tims-friends">Formula: Nim is reachable from Tim via followers, but not including Tim's friends?</a></h4>
<details>
<summary>Think, then click!</summary>
<p>We might try <code>reachable[Nim, Tim, (followers-Tim.friends)]</code> but this will produce an error. Why? Well, one reason we might give is:</p>
<blockquote>
<p>...because <code>followers</code> is a field but <code>Tim.friends</code> is a set.</p>
</blockquote>
<p>But is that the real answer? The error complains about &quot;arity&quot;: 2 vs 1. Let's type those two expressions into the evaluator and see what we get. For <code>followers</code>, we get a set of <em>pairs</em> of people. But <code>Tim.friends</code> is a set of <em>singletons</em>. </p>
</details>
<!-- ~~~admonish warning title="Evaluator Output" 
The evaluator prints expression values as parenthesized lists of lists. But don't be fooled! It's really printing a _set_ of _lists_. The order in which the inner lists print shouldn't matter.
~~~ -->
<div id="admonition-arity-relations-and-tuples" class="admonition admonish-tip">
<div class="admonition-title">
<p>Arity, Relations, and Tuples</p>
<p><a class="admonition-anchor-link" href="chapters/relations/reachability.html#admonition-arity-relations-and-tuples"></a></p>
</div>
<div>
<p><em>Arity</em> is another word for how wide the elements of a set are. Here, we'd say that <code>followers</code> has arity 2 since elements of <code>followers</code> are pairs of atoms. Similarly, <code>Tim.friends</code> has arity 1 since its elements are singletons. So Forge is pointing out that taking the set difference of these two makes no sense; their elements are shaped differently.</p>
<p>When we're talking about sets in this way, we sometimes call them <em>relations</em>. E.g., the <code>followers</code> field is a <em>binary relation</em> because it has arity 2. We'll call elements of relations <em>tuples</em>. E.g., if <code>Nim</code> follows <code>Tim</code>, the tuple <code>(Tim, Nim)</code> would be present in <code>followers</code>.</p>
</div>
</div>
<p>In Relational Forge, <code>reachable</code> doesn't take &quot;fields&quot;; it takes relations. Specifically, binary relations, which define the steps it can use to connect the two objects. That's the fact we'll use to solve the 2 problems above. </p>
<h4 id="attempt-2-formula-nim-is-reachable-from-tim-via-the-inverse-of-followers-what-we-might-call-following"><a class="header" href="#attempt-2-formula-nim-is-reachable-from-tim-via-the-inverse-of-followers-what-we-might-call-following">(Attempt 2) Formula: Nim is reachable from Tim via the inverse of &quot;followers&quot; (what we might call &quot;following&quot;)?</a></h4>
<p>Now that we know <code>followers</code> is a binary relation, we can imagine flipping it to get its inverse. How can we do that? Well, there are multiple ways! We could write a set-comprehension:</p>
<pre><code>{p1, p2: Person | p1 in p2.followers}
</code></pre>
<p>The order matters here! If <code>p1</code> is in <code>p2.followers</code>, then there is an entry in the relation that looks like <code>(p2, p1)</code>. We could make this more explicit by writing:</p>
<pre><code>{p1, p2: Person | p2-&gt;p1 in followers}
</code></pre>
<p>Now that we know <code>followers</code> is a set, this makes sense! The <em>product</em> (<code>-&gt;</code>) operator combines <code>p2</code> and <code>p1</code> into a binary tuple, which may (or may not) be in <code>followers</code>.</p>
<p>Forge provides an operator that does this directly for binary relations: transpose (<code>~</code>). So we could write instead:</p>
<pre><code>~followers
</code></pre>
<p>Which should you use? It's up to you! Regardless, we could now answer this question with:</p>
<pre><code class="language-alloy">reachable[Nim, Tim, ~followers]
</code></pre>
<h4 id="attempt-2-formula-nim-is-reachable-from-tim-via-followers-but-not-including-tims-friends"><a class="header" href="#attempt-2-formula-nim-is-reachable-from-tim-via-followers-but-not-including-tims-friends">(Attempt 2) Formula: Nim is reachable from Tim via followers, but not including Tim's friends?</a></h4>
<p>Everything is a set, so let's build the subset of <code>followers</code> that doesn't involve anyone in <code>Tim.friends</code>. We can't write <code>followers-(Tim.friends)</code>, since that's an arity mismatch. Somehow, we need to remove entries in <code>followers</code> involving one of Tim's friends <em>and anybody else</em>. </p>
<p>One way is to use the product operator to build the binary relation we want <code>reachable</code> to use. E.g.:</p>
<pre><code>reachable[Nim, Tim, followers-(Tim.friends-&gt;Person)]
</code></pre>
<div id="admonition-default" class="admonition admonish-tip">
<div>
<p>You may notice that we've now used <code>-&gt;</code> in what seems like 2 different ways. We used it to combine specific people, <code>p1</code> and <code>p2</code> above into a single tuple. But now we're using it to combine two <em>sets</em> into a <em>set</em> of tuples. This flexibility is a side effect of sets being the fundamental concept in Relational Forge:</p>
<ul>
<li>the product of <code>((Tim))</code> and <code>((Nim))</code> is <code>((Tim, Nim))</code>; </li>
<li>the product of <code>((Person1), (Person2))</code> and <code>((Person3), (Person4))</code> is <code>((Person1, Person3), (Person1, Person4), (Person2, Person3), (Person2, Person4))</code>. </li>
</ul>
<p>Formally, <code>-&gt;</code> is the cross-product operation on sets. </p>
<p>You'll see this apparently double-meaning when using <code>in</code> and <code>=</code>, too: singletons are single-element sets, where the element is a one-column tuple.</p>
</div>
</div>
<h2 id="what-is-dot-really"><a class="header" href="#what-is-dot-really">What is Dot, Really?</a></h2>
<p>In Relational Forge, the dot operator is called <em>relational join</em>. The expression <code>A.B</code> combines two arbitrary relations <code>A</code> and <code>B</code> by seeking out rows with common values in their rightmost (in <code>A</code>) and leftmost (in <code>B</code>) columns. Concretely, if <code>A</code> is an <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>-ary relation, and <code>B</code> is <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span>-ary, then <code>A.B</code> equals the <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span>-ary relation:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">∃</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">A</span><span class="mord text"><span class="mord"> and </span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">}</span></span></span></span></span></p>
<p>That's a lot, so let's work through some examples. Suppose that we have the following relation for the <code>friend</code> field of <code>Person</code>:</p>
<div class="table-wrapper"><table><thead><tr><th>column 1</th><th>column 2</th></tr></thead><tbody>
<tr><td><code>Tim</code></td><td><code>Person0</code></td></tr>
<tr><td><code>Tim</code></td><td><code>Person1</code></td></tr>
<tr><td><code>Person0</code></td><td><code>Person1</code></td></tr>
<tr><td><code>Person0</code></td><td><code>Tim</code></td></tr>
<tr><td><code>Person1</code></td><td><code>Person0</code></td></tr>
<tr><td><code>Person1</code></td><td><code>Person2</code></td></tr>
<tr><td><code>Person1</code></td><td><code>Tim</code></td></tr>
<tr><td><code>Person2</code></td><td><code>Person1</code></td></tr>
<tr><td><code>Person2</code></td><td><code>Nim</code></td></tr>
<tr><td><code>Nim</code></td><td><code>Person2</code></td></tr>
</tbody></table>
</div>
<p>We know that join can often work like field access. So we'd expect <code>Tim.friend</code> to produce a set containing <code>Person0</code> and <code>Person1</code>. Why? Because we see <code>Tim</code> in the <em>left</em> column of 2 rows, and the <em>right</em> columns of those rows contain <code>Person0</code> and <code>Person1</code>. </p>
<p>But what about each of the following?</p>
<div id="admonition-try-the-evaluator" class="admonition admonish-tip">
<div class="admonition-title">
<p>Try the evaluator!</p>
<p><a class="admonition-anchor-link" href="chapters/relations/reachability.html#admonition-try-the-evaluator"></a></p>
</div>
<div>
<p>To build intuition for <code>.</code>, try expressions like this in the evaluator after reading the following examples.</p>
</div>
</div>
<h4 id="friendtim"><a class="header" href="#friendtim"><code>friend.Tim</code></a></h4>
<p>Here we run the same process that gave us a value for <code>Tim.friend</code>, but in reverse. Which rows do we see <code>Tim</code> in the <em>right</em> column? </p>
<center><img width="40%" src="chapters/relations/./Join2.png" style="background-color:white"/></center>
<p>Because <code>friend</code> is symmetric, it's the same: <code>friend.Tim</code> is the same as <code>Tim.friend</code>, a set containing <code>Person0</code> and <code>Person1</code>. </p>
<hr />
<h4 id="friendfriend"><a class="header" href="#friendfriend"><code>friend.friend</code></a></h4>
<p>Before trying to compute the value, first answer: </p>
<p><strong>Exercise:</strong> What is the arity of <code>friend.friend</code>?</p>
<details>
<summary>Think, then click!</summary>
<p>Well, <code>friend</code> has arity <code>2</code>, and a join subtracts one column from each side. So we expect <code>friend.friend</code> to have arity <code>1+1=2</code>. </p>
</details>
<p>Now, what's the value? Start by looking for matches. Here are some of them (the ones on <code>Person0</code>): </p>
<center><img width="40%" src="chapters/relations/./Join3.png" style="background-color:white"/></center>
<p>Continuing, we'll find matches on <code>Person1</code>, <code>Tim</code>, and others. Because some people have a lot of friends, the graph is getting difficult to read, but notice what's happening: we're identifying <em>matching pairs of rows</em> in each relation.</p>
<center><img width="40%" src="chapters/relations/./Join4.png" style="background-color:white"/></center>
<p>Finally, we generate a new row in the result for every pair of matching rows, deleting the inner columns we matched on: <code>Tim-&gt;Person1</code> is in the result because <code>Tim-&gt;Person0</code> is in <code>friends</code> (the left-hand side of the join) and <code>Person0-&gt;Person1</code> is in <code>friends</code> (the right-hand side of the join). We'll get one row for every match (but we won't keep duplicates):</p>
<div class="table-wrapper"><table><thead><tr><th>column 1</th><th>column 2</th></tr></thead><tbody>
<tr><td><code>Tim</code></td><td><code>Person1</code></td></tr>
<tr><td><code>Tim</code></td><td><code>Person2</code></td></tr>
<tr><td><code>Tim</code></td><td><code>Tim</code></td></tr>
<tr><td><code>Person0</code></td><td><code>Person0</code></td></tr>
<tr><td><code>Person0</code></td><td><code>Person1</code></td></tr>
<tr><td><code>Person0</code></td><td><code>Person2</code></td></tr>
<tr><td><code>Person0</code></td><td><code>Tim</code></td></tr>
<tr><td><code>Person1</code></td><td><code>Person0</code></td></tr>
<tr><td><code>Person1</code></td><td><code>Person1</code></td></tr>
<tr><td><code>Person1</code></td><td><code>Tim</code></td></tr>
<tr><td><code>Person1</code></td><td><code>Nim</code></td></tr>
<tr><td><code>Person2</code></td><td><code>Person0</code></td></tr>
<tr><td><code>Person2</code></td><td><code>Person2</code></td></tr>
<tr><td><code>Person2</code></td><td><code>Tim</code></td></tr>
<tr><td><code>Nim</code></td><td><code>Nim</code></td></tr>
<tr><td><code>Nim</code></td><td><code>Person2</code></td></tr>
</tbody></table>
</div>
<p><strong>This is the set of <em>friend-of-friend</em> relationships.</strong> If we computed <code>friend.friend.friend</code>, we'd get the <em>friend-of-friend-of-friend</em> relationships, and so on.</p>
<p><strong>TODO: double-check this</strong></p>
<hr />
<p><strong>Exercise:</strong> What about <code>Tim.Tim</code>?</p>
<details>
<summary>Think, then click!</summary>
<p>This will give an error because the result has arity <code>0</code>. </p>
</details>
<h2 id="how-reachability-works"><a class="header" href="#how-reachability-works">How Reachability Works</a></h2>
<p>If we wanted to encode reachability without using the built-in <code>reachable</code> predicate, we could start by writing a helper predicate:</p>
<pre><code class="language-alloy">pred reachable2[to: Person, from: Person, via: Person -&gt; Person]: set Person {
    to in 
    from.via +
    from.via.via +
    from.via.via.via 
    -- ...and so on...
}
</code></pre>
<p>But we always have to stop writing somewhere. We could write the union out to 20 steps, and still we wouldn't catch some very long (length 21 or higher) paths. So we need some way to talk about <em>unbounded reachability</em>, or at least reachability up to a path length that's influenced by the problem bounds.</p>
<p>Forge's <code>reachable</code> built-in does this, but it's just a facade over a new relational operator: transitive closure (<code>^R</code>).</p>
<p>The <em>transitive closure</em> <code>^R</code> of a binary relation <code>R</code> is the <em>smallest</em> binary relation such that:</p>
<ul>
<li>if <code>x-&gt;y</code> is in <code>R</code>, then <code>x-&gt;y</code> is in <code>^R</code>; and</li>
<li>if <code>x-&gt;z</code> is in <code>R</code> and <code>z-&gt;y</code> is in <code>^R</code> then <code>x-&gt;y</code> is in <code>R</code>.</li>
</ul>
<p>That is, <code>^R</code> encodes exactly what we were trying to achieve above. The <code>reachable[to, from, f1, ...]</code> built-in is just syntactic sugar for:</p>
<pre><code class="language-alloy">    to in from.^(f1 + ...)
</code></pre>
<p>You might remember that <code>reachable</code> always evaluates to true if we give <code>none</code> as its first argument. This is because of the translation above: if <code>to</code> is the empty set, then it is a subset of anything. </p>
<!-- ~~~admonish tip title="Design Discussion"
You might wonder why we don't translate `reachable[to, from, f1, ...]` to something like `to in from.^(f1 + ...) and some to`. This would, after all, fix the problem of `none` being reachable from everything! The answer is that this fix might cause other confusion, and either way the ...
...
~~~ -->
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="more-sets-and-induction-mutual-exclusion"><a class="header" href="#more-sets-and-induction-mutual-exclusion">More Sets and Induction (Mutual Exclusion)</a></h1>
<p>If you have two independent threads of execution running concurrently, many subtle bugs can manifest. For instance, if both threads can write to the same region of memory, they might overlap their writes. A great example of this is simply incrementing a counter. In most computer systems, an operation like:</p>
<pre><code class="language-java">  counter = counter + 1;
</code></pre>
<p>is not atomic by itself. Thus, the following sequence of operations would be problematic:</p>
<ul>
<li>Thread 1: read the current value of <code>counter</code></li>
<li>Thread 2: read the current value of <code>counter</code></li>
<li>Thread 1: add <code>1</code> to that value</li>
<li>Thread 1: write the new value to <code>counter</code></li>
<li>Thread 2: add <code>1</code> to that value</li>
<li>Thread 2: write the new value to <code>counter</code>
because then the counter's value is only <code>1</code> higher than its original value.</li>
</ul>
<p>We often call the property that such traces can't exist <em>mutual exclusion</em>, and the piece of code that shouldn't ever be run by 2 threads at once the <em>critical section</em>.  Today we'll model a very simple approach to mutual-exclusion—which turns out <em>not</em> to work, but is a first step on the way to something that does.</p>
<p>The idea comes from how we as humans negotiate access to a shared resource like the spoken-communication channel in a meeting. If we want to talk, we raise our hand. </p>
<h3 id="a-simplified-mutual-exclusion-algorithm"><a class="header" href="#a-simplified-mutual-exclusion-algorithm">A Simplified Mutual-Exclusion Algorithm</a></h3>
<p>Consider the pseudocode below, and imagine it running on two separate threads of execution. I've marked <em>program locations</em> in square brackets---note how they correspond to the spaces in between lines of code executing.</p>
<p><strong>TODO: incorporate Pamela's comments on this; return to validation</strong></p>
<pre><code class="language-java">while(true) { 
    // [state: uninterested]
    this.flag = true;
    // [state: waiting]
    while(other.flag == true);    
    // [state: in-cs]    
    run_critical_section_code(); // does whatever; we don't care about details
    this.flag = false;    
}
</code></pre>
<p>Both processes will always continuously try to access the critical section. When they become interested, they set a public <code>flag</code> bit to true. Then, they don't enter until their counterpart's flag is false. When they're done executing the critical section, they lower their flag and restart. </p>
<p>Notice we aren't modeling the critical section itself. The exact nature of that code doesn't matter for our purposes; we just want to see whether both process can be at the <code>in-cs</code> location at once. If so, mutual exclusion fails!</p>
<h3 id="modeling"><a class="header" href="#modeling">Modeling</a></h3>
<p>Let's start with a simple model. We'll critique this model as the semester progresses, but this will be useful enough to get us started. </p>
<pre><code class="language-alloy">abstract sig Location {}
one sig Uninterested, Waiting, InCS extends Location {}

abstract sig Process {}
one sig ProcessA, ProcessB extends Process {}

sig State {
    loc: func Process -&gt; Location,
    flags: set Process
}
</code></pre>
<p>An initial state is one where all processes are uninterested, and no process has raised its flag:</p>
<pre><code class="language-alloy">pred init[s: State] {
    all p: Process | s.loc[p] = Uninterested
    no s.flags 
}
</code></pre>
<p>We then have three different transition predicates, each corresponding to one of the lines of code above, and a transition predicate <code>delta</code> that represents <em>any</em> currently-possible transition:</p>
<pre><code class="language-alloy">
pred raise[pre: State, p: Process, post: State] {
    pre.loc[p] = Uninterested
    post.loc[p] = Waiting
    post.flags = pre.flags + p
    all p2: Process - p | post.loc[p2] = pre.loc[p2]
}

pred enter[pre: State, p: Process, post: State] {
    pre.loc[p] = Waiting 
    pre.flags in p -- no other processes have their flag raised
    post.loc[p] = InCS    
    post.flags = pre.flags
    all p2: Process - p | post.loc[p2] = pre.loc[p2]
}

pred leave[pre: State, p: Process, post: State] {
    pre.loc[p] = InCS    
    post.loc[p] = Uninterested    
    post.flags = pre.flags - p
    all p2: Process - p | post.loc[p2] = pre.loc[p2]
}

-- the keyword &quot;transition&quot; is reserved
pred delta[pre: State, post: State] {
    some p: Process | 
        raise[pre, p, post] or
        enter[pre, p, post] or 
        leave[pre, p, post]
}
</code></pre>
<p>We won't create a <code>Trace</code> sig or <code>traces</code> predicate at all, because we're going to apply induction rather than trace generation. </p>
<h3 id="model-validation"><a class="header" href="#model-validation">Model Validation</a></h3>
<p>We should do some quick validation at this point. The most basic would be checking that each of our transitions is satisfiable:</p>
<pre><code class="language-alloy">test expect {
    canEnter: {        
        some p: Process, pre, post: State | enter[pre, p, post]        
    } is sat
    canRaise: {        
        some p: Process, pre, post: State | raise[pre, p, post]        
    } is sat    
    canLeave: {        
        some p: Process, pre, post: State | leave[pre, p, post]        
    } is sat    
}
</code></pre>
<p>In a real modeling situation, we would <em>absolutely</em> add more checks. Even here, we might regret not testing more...</p>
<h3 id="does-mutual-exclusion-hold"><a class="header" href="#does-mutual-exclusion-hold">Does Mutual Exclusion Hold?</a></h3>
<p>Before we run Forge, ask yourself whether the algorithm above guarantees mutual exclusion. (It certainly has another kind of error, but we'll get to that later. Focus on this one property for now.)</p>
<p>It seems reasonable that the property holds. But if we try to use the inductive approach to prove that:</p>
<pre><code class="language-alloy">pred good[s: State] {
    #{p: Process | s.loc[p] = InCS} &lt;= 1
}

pred startGoodTransition[s1, s2: State] {    
    good[s1]
    delta[s1,s2]
}
assert all s: State | init[s] is sufficient for good[s] for exactly 1 State
assert all pre, post: State | startGoodTransition[pre, post] is sufficient for good[post] for exactly 2 State
</code></pre>
<p>The inductive case <em>fails</em>. Let's see what the counterexample is:</p>
<pre><code class="language-alloy">    run {
      not {
        all pre, post: State | 
          delta[pre, post] and good[pre] implies good[post]
        }
    } for exactly 2 State
</code></pre>
<p>Yields, in the table view:</p>
<p><img src="https://i.imgur.com/tJsdyDV.png" alt="" /></p>
<p>Notice that neither process has raised its flag in either state. This seems suspicious, and might remind you of the binary-search model, where the <code>good</code> predicate wasn't strong enough to be inductive, but the counterexample Forge found wasn't actually reachable. This is another such situation.</p>
<h3 id="refresher-enriching-the-invariant"><a class="header" href="#refresher-enriching-the-invariant">Refresher: Enriching The Invariant</a></h3>
<p>This counterexample shows that the property we wrote <em>isn't inductive</em>. But it might still an invariant of the system—it's just that Forge has found an unreachable prestate. To prevent that, we'll add more conditions to the <code>good</code> predicate (recall: we call this <em>enriching the invariant</em>; it's a great demo of something apparently paradoxical: <em>proving something stronger can be easier</em>). Let's <em>also</em> say that, in order for a process to be in the critical section, its flag needs to be true:</p>
<pre><code class="language-alloy">pred good2[s: State] {
    -- enrichment: if in CS, flag must be raised
    all p: Process | s.loc[p] = InCS implies p in s.flags  
    -- original: mutual exclusion      
    #{p: Process | s.loc[p] = InCS} &lt;= 1        
}
</code></pre>
<p>We re-run this, and the inductive case still fails! Look closely at the counterexample. The problem now is that the flag <em>also</em> has to be raised if a process is <code>Waiting</code>.</p>
<pre><code class="language-alloy">pred good3[s: State] {
    -- enrichment: if in CS or Waiting, flag must be raised
    all p: Process | (s.loc[p] = InCS or s.loc[p] = Waiting) implies p in s.flags    
    -- original: mutual exclusion
    #{p: Process | s.loc[p] = InCS} &lt;= 1        
}
</code></pre>
<div id="admonition-what-are-changing" class="admonition admonish-tip">
<div class="admonition-title">
<p>What are changing?</p>
<p><a class="admonition-anchor-link" href="chapters/relations/sets-induction-mutex.html#admonition-what-are-changing"></a></p>
</div>
<div>
<p>Notice again that we're only strengthening the thing we're trying to prove---<em>not</em> altering the model itself in any way.</p>
</div>
</div>
<p>At this point, the inductive check passes. <strong>We've just shown that this algorithm satisfies mutual exclusion.</strong> It might not give us some other properties we want, but this one is guaranteed.</p>
<h3 id="validating-the-check"><a class="header" href="#validating-the-check">Validating the Check</a></h3>
<p>We should probably make sure the two proof steps (the base case and the inductive step) aren't passing vacuously:</p>
<pre><code class="language-alloy">test expect {
    baseCaseVacuity: {
        some s: State | init[s] and good1[s]
    } for exactly 1 State is sat
    
    inductiveCaseVacuity: {
        some pre, post: State | 
                delta[pre, post] and good3[pre]
    } for exactly 2 State is sat

}
</code></pre>
<p>Fortunately, these both pass. So far, so good. But does this algorithm do everything we want? </p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="going-beyond-assertions"><a class="header" href="#going-beyond-assertions">Going Beyond Assertions</a></h1>
<p>In the <a href="chapters/relations/./sets-induction-mutex.html">last section</a>, we were modeling this simplified (and perhaps buggy) mutual-exclusion protocol: </p>
<pre><code>while(true) { 
     // [location: uninterested]
    this.flag = true;  // visible to other threads!
    //  [location: waiting]
    while(other.flag == true);    
    //  [location: in-cs] // &quot;critical section&quot;   
    this.flag = false;    
}
</code></pre>
<div id="admonition-thread-vs-process" class="admonition admonish-note">
<div class="admonition-title">
<p>Thread vs. Process</p>
<p><a class="admonition-anchor-link" href="chapters/relations/sets-beyond-assertions.html#admonition-thread-vs-process"></a></p>
</div>
<div>
<p>I'm going to use the terms &quot;process&quot; and &quot;thread&quot; interchangably for this model. The difference is vital when programming, but it's not important for our purposes today.</p>
</div>
</div>
<p><strong>Exercise:</strong> If there are 3 possible locations for each process, and 2 possible flag values for each process, how many possible states are there overall in the system (without considering reachability)?</p>
<details>
<summary>Think, then click!</summary>
<p>Every process has <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">6</span></span></span></span> possible states. If 2 processes are executing this loop, there are <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">6</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">6</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">6</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">36</span></span></span></span> possible states overall in the system. (Of course, we hope that not all of them are reachable!)</p>
</details>
<p>Our mutual exclusion property, which says that at most one process can be running the critical section at a time, is a statement that 4 specific states are unreachable: the ones where both processes are in the critical-section location (with any possible combination of boolean flags).</p>
<p>That property wasn't &quot;inductive&quot;: Forge could find transitions with a good prestate that end in one of those 4 bad states. So we enriched the invariant to <em>also</em> say that any thread in the waiting or critical-section locations must also have a raised flag. This prevented Forge from using many prestates it could use before: <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.05764em;">CS</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">Wai</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span>, for example. </p>
<p>Now we're going to do two things:</p>
<ul>
<li>build intuition for how the above actually worked; and</li>
<li>talk about how we could approch verifying other, richer, kinds of property.</li>
</ul>
<h2 id="drawing-the-picture"><a class="header" href="#drawing-the-picture">Drawing The Picture</a></h2>
<p>I really don't want to draw 36 states along with all their corresponding transition arcs. But maybe I don't need to. Let's agree that there are, in principle, 36 states, but just draw the part of the system that's <em>reachable</em>. We'll start with the initial state: <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span> and abbrieviate location tags to make writing them convenient for us: <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal">n</span></span></span></span> for &quot;uninterested&quot;, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">CS</span></span></span></span> for &quot;critical section&quot;, and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span> for &quot;waiting&quot;.</p>
<p><strong>TODO: redraw with &quot;un&quot; rather than &quot;dis&quot;</strong></p>
<p><img src="https://i.imgur.com/02KboGA.png" alt="" /></p>
<p>Fill in the rest of the reachable states and transitions; don't add unreachable states at all. You should find the picture is significantly smaller than it would be if we had drawn <em>all</em> states.</p>
<p><img src="https://i.imgur.com/PQraiC7.png" alt="" /></p>
<p>Keep going! In diagrams like this, where there are only 2 processes, I like to split the state and draw the transition arcs for each process moving separately in different directions. (We're assuming, for now, that only one process moves at a time, even though they are executing concurrently.)</p>
<p><img src="https://i.imgur.com/EPMcgrl.png" alt="" /></p>
<p>I've marked the inability of a process to make progress with an &quot;<strong>X</strong>&quot;; it's a transition that can't be taken.</p>
<p>By drawing the entire graph of reachable states, we can see that the &quot;bad&quot; states are not reachable. <strong>This protocol satisfies mutual exclusion</strong> (as Forge showed us in the last section).</p>
<h2 id="other-properties"><a class="header" href="#other-properties">Other Properties</a></h2>
<p>Just mutual exclusion isn't good enough! After all, a protocol that never gave access to the critical section would guarantee mutual exclusion. We need at least one other property, one that might turn out to be more complex. We'll get there in 2 steps.</p>
<h3 id="property-deadlock-freedom"><a class="header" href="#property-deadlock-freedom">Property: Deadlock Freedom</a></h3>
<p>If, at some point, <em>nobody</em> can make progress, then surely the protocol isn't working. Both processes would be waiting forever, unable to ever actually get work done. </p>
<p>A state where <em>no</em> process can transition is called a <em>deadlock state</em>. Verifying that a system is free of deadlocks is a common verification goal.</p>
<p><strong>Exercise:</strong> Does the system above satisfy deadlock-freedom? (You can check using the diagram we produced.)</p>
<details>
<p>No. The state <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span> is reachable, but has no exit transitions: neither thread can make progress in that state. Once the system is there, it's stuck there. And we can see that just by doing a visual search of the sub-system for the reachable states.</p>
</details>
<p>This kind of verification problem---checking properties of a transition system---is called <em>model checking</em>. Interestingly, there are other kinds of verification tools that use this graph-search approach, rather than the logic- and solver-based approach that Forge uses; you'll hear these tools referred to as <em>explicit-state model checkers</em> and <em>symbolic model checkers</em> respectively.</p>
<p><strong>Exercise:</strong> How could we check for deadlocks using just the graph we drew and our eyes?</p>
<details>
<summary>Think, then click!</summary>
In the same way we looked for a failure of mutual exclusion. We seek a reachable state with _no_ transitions out. And in this case, we find such a state.
</details>
<p><strong>Exercise:</strong> How could we check for deadlock in Forge?</p>
<p>We could either try the inductive approach, or use the finite-trace method. In the former, we would express that a &quot;good&quot; state is one where some transition is enabled---that is, one where the guard portion of some transition evaluates to true.</p>
<p><strong>Exercise:</strong> Working from the graph you drew, how could we fix the problem?</p>
<p>We could add a transition from the deadlock state. Maybe we could allow the first thread to always take priority over the second:</p>
<p><img src="https://i.imgur.com/gyt75Bk.png" alt="" /></p>
<p>This might manifest in the code as an extra way to escape the <code>while</code> loop. Of course, if we prioritize the first thread, the second thread is going to be very unhappy with this fix! But, regardless, adding this transition technically fixes the deadlock problem, and this property will now pass as well.</p>
<h3 id="property-non-starvation"><a class="header" href="#property-non-starvation">Property: Non-Starvation</a></h3>
<p>Even if there are no deadlocks, it's still possible for one thread to be waiting forever. We'd prefer a system where it's impossible for one thread to be kept waiting while the other thread continues to completely hog the critical section. This property is called <em>non-starvation</em>; more formally, it says that every thread must <em>always</em> (at any point) <em>eventually</em> (at some point) get access to the resource.</p>
<p><strong>Exercise:</strong> How could we check non-starvation in this graph?</p>
<details>
<summary>Think, then click!</summary>
<p>Not by looking for a single &quot;bad state&quot;. That won't suffice.</p>
</details>
<h3 id="safety-versus-liveness-intuition"><a class="header" href="#safety-versus-liveness-intuition">Safety Versus Liveness: Intuition</a></h3>
<p>Notice the differences between these properties. In particular, consider what a <em>full counterexample trace</em> for each must look like, if we were inclined to produce one. </p>
<ul>
<li>For mutual-exclusion and (in this formulation) deadlock-freedom, a counterexample trace could be finite. After some number of transitions, we'd reach a state where a deadlock or failure of mutual-exclusion has occurred. At that point, it's impossible for the system to recover; we've found an issue and the trace has served its purpose.</li>
<li>For a failure of non-starvation, on the other hand, no finite trace can suffice. It's always possible that just ahead, the system will suddenly recover and prevent a thread from being starved. So here, we need some notion of an <em>infinite counterexample trace</em> such that some thread never, ever, gets access.</li>
</ul>
<p>The difference here is a fundamental distinction in verification. We call properties that have finite counterexamples <em>safety properties</em>, and properties with only infinite counterexamples <em>liveness properties</em>. </p>
<div id="admonition-definitions" class="admonition admonish-note">
<div class="admonition-title">
<p>Definitions</p>
<p><a class="admonition-anchor-link" href="chapters/relations/sets-beyond-assertions.html#admonition-definitions"></a></p>
</div>
<div>
<p>People often describe safety properties as &quot;something bad never happens&quot; and liveness properties as &quot;something good must happen&quot;. I don't like this wording, because it assumes an understanding of &quot;goodness&quot; and &quot;badness&quot;. Instead, think about what a counterexample needs to look like. Then, one kind of property really is fundamentally different from the other, without requiring a notion of &quot;good&quot; or &quot;bad&quot;.</p>
</div>
</div>
<p>You'll usually find that a liveness property is more computationally complex to check. This doesn't mean that verifying liveness properties is always slower. It's just that we, and Forge, usually have to bring some additional tricks to bear. <strong>In the context of a <em>finite</em> state system, searching for an infinite counterexample amounts to looking for a reachable <em>cycle</em> in the graph, rather than just a single bad state.</strong></p>
<hr />
<p>We'll take a short break in the next section to say more about how Forge works. Then we'll return to the problem of defining infinite counterexample traces.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="bounds-and-booleans-how-forge-works"><a class="header" href="#bounds-and-booleans-how-forge-works">Bounds and Booleans: How Forge Works</a></h1>
<blockquote>
<p>&quot;The world is everything that is the case. The world is the totality of facts, not of things. The world is determined by the facts, and by these being all the facts.&quot;</p>
<p>Ludwig Wittgenstein (Tractatus Logico-philosophicus)</p>
</blockquote>
<h2 id="how-does-forge-work"><a class="header" href="#how-does-forge-work">How Does Forge Work?</a></h2>
<p>We've hinted about this a bit in the <a href="chapters/solvers/../qna/static.html">past</a>, but now we'll go a bit deeper into how Forge works.</p>
<p>Recall that every <code>run</code> (or <code>test</code>, or <code>example</code>) command defines a <em>search problem</em>: find some instance that satisfies the given constraints and is within the given bounds. When you click &quot;Run&quot;, Forge compiles this search problem into a <em>boolean satisfiability problem</em>, which it then gives to an external boolean solver package.</p>
<p>There are complications, though. The search problem Forge needs to solve is in terms of <em>atomic objects</em>: objects of particular types, which can go into sets and relations and so on. In contrast, a boolean problem is in terms of just boolean variables: <em>atomic truths</em> that can be combined with <code>and</code>, <code>or</code>, etc. Somehow, we need to bridge that gap from object to boolean.</p>
<h2 id="what-boolean-solvers-understand"><a class="header" href="#what-boolean-solvers-understand">What Boolean Solvers Understand</a></h2>
<p>As an example of where Forge needs to end up, here's an example of a real problem to pass to a boolean solver. It's in a standard format called DIMACS, and it describes a way to find a solution to the <a href="https://en.wikipedia.org/wiki/Eight_queens_puzzle">4-queens puzzle</a>. There are many other ways to express this problem, but we'll focus on this one. What do you think it's saying, exactly?</p>
<details>
<summary>Click to expand the DIMACS problem definition</summary>
<pre><code>c DIMACS for 4 queens
c 
p cnf 16 84
1 2 3 4 0
-1 -2 0
-1 -3 0
-1 -4 0
-2 -3 0
-2 -4 0
-3 -4 0
5 6 7 8 0
-5 -6 0
-5 -7 0
-5 -8 0
-6 -7 0
-6 -8 0
-7 -8 0
9 10 11 12 0
-9 -10 0
-9 -11 0
-9 -12 0
-10 -11 0
-10 -12 0
-11 -12 0
13 14 15 16 0
-13 -14 0
-13 -15 0
-13 -16 0
-14 -15 0
-14 -16 0
-15 -16 0
1 5 9 13 0
-1 -5 0
-1 -9 0
-1 -13 0
-5 -9 0
-5 -13 0
-9 -13 0
2 6 10 14 0
-2 -6 0
-2 -10 0
-2 -14 0
-6 -10 0
-6 -14 0
-10 -14 0
3 7 11 15 0
-3 -7 0
-3 -11 0
-3 -15 0
-7 -11 0
-7 -15 0
-11 -15 0
4 8 12 16 0
-4 -8 0
-4 -12 0
-4 -16 0
-8 -12 0
-8 -16 0
-12 -16 0
-1 -6 0
-1 -11 0
-1 -16 0
-2 -7 0
-2 -12 0
-2 -5 0
-3 -8 0
-3 -6 0
-3 -9 0
-4 -7 0
-4 -10 0
-4 -13 0
-5 -10 0
-5 -15 0
-6 -11 0
-6 -16 0
-6 -9 0
-7 -12 0
-7 -10 0
-7 -13 0
-8 -11 0
-8 -14 0
-9 -14 0
-10 -15 0
-10 -13 0
-11 -16 0
-11 -14 0
-12 -15 0
</code></pre>
<details>
<hr />
<p>Even without parsing it with a computer, the format tells us a lot about what a purely boolean solver understands. Here are a few facts about DIMACS:</p>
<ul>
<li>Boolean variables in DIMACS are represented by integers greater than zero. </li>
<li>If <code>p</code> is a variable, then <code>not p</code> is represented as the integer <code>-p</code>. </li>
<li>Lines starting with a <code>c</code> are comments.</li>
<li>The line <code>p cnf 16 84</code> says there are 16 variables and 84 <em>clauses</em>. A clause is a set of variables (or negated variables) all combined with <code>or</code>. E.g., <code>4 8 12 -16 0</code> means <code>4 or 8 or 12 or (not 16)</code>. (The <code>0</code> is a line-terminator.)</li>
<li>To satisfy the input, every clause must be satisfied.</li>
</ul>
<p>A set of constraints expressed as a set of clauses, each of which must hold true, is said to be in <em>Conjunctive Normal Form</em> (CNF). Boolean solvers often expect input in CNF, for algorithmic reasons we'll soon see.</p>
<p>Now that you know how to read the input format, you might be able to see how the boolean constraints work to solve the 4-queens problem. Any ideas?</p>
<details>
<summary>Think, then click!</summary>
<p>There's one variable for every square on the <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span></span></span></span> squares. <code>1 2 3 4</code> says that there must be a queen somewhere on the first row. <code>-1 -2</code> says that if there is a queen at <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span></span></span></span> there cannot also be a queen at <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">2</span></span></span></span>. And so on.</p>
</details>
<h2 id="the-world-is-that-which-is-the-case"><a class="header" href="#the-world-is-that-which-is-the-case">&quot;The world is that which is the case&quot;</a></h2>
<p>Consider this Forge model and corresponding <code>run</code> command:</p>
<pre><code class="language-alloy">abstract sig Person {
  followers: set Person
}
one sig Alice, Bob, Charlie extends Person {}
run {some followers} for exactly 3 Person 
</code></pre>
<p>How many potential instances are there? Note that there can only ever be exactly 3 people, since <code>Person</code> is <code>abstract</code>.</p>
<details>
<summary>Think, then click!</summary>
<p>There are always exactly 3 people, and the only relation that can vary is <code>followers</code>, which has 2 columns. That means <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">3</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">9</span></span></span></span> potential pairs of people, and the field contains a set of those. The set either contains or does not contain each pair. So there are <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">9</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">512</span></span></span></span> potential instances.</p>
</details>
<hr />
<p>Notice how we reached that number. There are 9 potential pairs of people. 9 potential follower relationships. 9 essential things that may, or may not, be the case in the world. Nothing else.</p>
<p>If you run Forge on this model, you'll see statistics like these:</p>
<pre><code>#vars: (size-variables 10); #primary: (size-primary 9); #clauses: (size-clauses 2)
Transl (ms): (time-translation 122); Solving (ms): (time-solving 1)
</code></pre>
<p>The timing may vary, but the other stats will be the same. The thing to focus on is: 9 <code>primary variables</code>. Primary variables correspond to these atomic truths, which in this case is just who follows who in our fixed 3-person world: the number of rows that are potentially in the <code>followers</code> relation.</p>
<p>Let's try increasing the size of the world:</p>
<pre><code class="language-alloy">run {some followers} for 4 Person
</code></pre>
<p>Now we have a 4th person---or rather, we <em>might</em> have a 4th person. When we run, Forge shows:</p>
<pre><code>#vars: (size-variables 27); #primary: (size-primary 17); #clauses: (size-clauses 18)
</code></pre>
<p>We've gone from 9 to 17 primary variables. Why? </p>
<details>
<summary>Think, then click!</summary>
<p>There is another <em>potential</em> <code>Person</code> in the world; the world may be either size 3 or 4. Whether or not this fourth person exists is 1 new Boolean variable. And since there are <em>4</em> potential people in the world, there are now <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">4</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">16</span></span></span></span> potential follower relationships. </p>
<p>This equals 17 variables.</p>
</details>
</br>
<p>This is how Forge translates statements about atoms into statements about booleans. </p>
<h2 id="intermediate-representation-lower-bounds-upper-bounds"><a class="header" href="#intermediate-representation-lower-bounds-upper-bounds">Intermediate Representation: Lower Bounds, Upper Bounds</a></h2>
<p>Not every potential boolean needs to actually be considered, however. You might <a href="chapters/solvers/../qna/events.html">remember</a> that annotations like <code>{next is linear}</code> or partial instances defined by <code>example</code> or <code>inst</code> further limit the set of variables before the boolean solver encounters them. To understand this better, let's increase the verbosity setting in Forge. This will let us look at what Forge produces as an intermediate problem description before converting to boolean logic.</p>
<pre><code class="language-alloy">option verbose 5
</code></pre>
<p>Let's focus on a few lines. First, you should see this somewhere:</p>
<pre><code>(univ 20)
</code></pre>
<p>This tells the compiler that there are 20 potential objects in the world. (Why 20? Because the default bitwidth is 4: that's 16 integers, plus 4 potential people.) These objects get assigned integer identifiers by the compiler. </p>
<div id="admonition-3-different-meanings" class="admonition admonish-warning">
<div class="admonition-title">
<p>3 different meanings</p>
<p><a class="admonition-anchor-link" href="chapters/solvers/bounds_booleans_how_forge_works.html#admonition-3-different-meanings"></a></p>
</div>
<div>
<p>This is an unfortunate overlap in the backend solver engine's language: all <em>atoms</em>, including atoms of type <code>Int</code>, get assigned integers by the engine. Moreover, the boolean solver itself uses integer indexes for boolean variables. <strong>These are not the same thing!</strong></p>
</div>
</div>
<p>Next, the compiler gets provided a <em>lower</em> and <em>upper</em> bound for every relation in the model.</p>
<ul>
<li>The <em>lower</em> bound is a set of tuples that must always be in the relation.</li>
<li>The <em>upper</em> bound is a set of tuples that may be in the relation.</li>
</ul>
<p>For example, here are the bounds on <code>Int</code>:</p>
<pre><code>(r:Int [{(0) (1) (2) (3) (4) (5) (6) (7) (8) (9) (10) (11) (12) (13) (14) (15)} :: {(0) (1) (2) (3) (4) (5) (6) (7) (8) (9) (10) (11) (12) (13) (14) (15)}])
</code></pre>
<p>The lower bound comes first, then a <code>::</code>, then the upper bound. These singleton tuples containing <code>0</code> through <code>15</code> are actually the representatives of integers <code>-8</code> through <code>7</code>. This is an artifact of how the solver process works.</p>
<p>Here's the bound on <code>Person</code> and its three sub-<code>sig</code>s:</p>
<pre><code>(r:Person [{(16) (17) (18)} :: {(16) (17) (18) (19)}])
(r:Alice [{(16)} :: {(16)}])
(r:Bob [{(17)} :: {(17)}])
(r:Charlie [{(18)} :: {(18)}])
</code></pre>
<p>The lower bound on <code>Person</code> contains 3 object identifiers, because there must always be 3 distinct objects (representing our three <code>one</code> sigs). There's an object in the upper, but not the lower, bound, because that fourth person may or may not exist. <code>Alice</code>, <code>Bob</code>, and <code>Charlie</code> are exactly set to be those 3 different always-present objects.</p>
<p>Finally, let's look at a field's bounds:</p>
<pre><code>(r:followers [(-&gt; none none) :: {(16 16) (16 17) (16 18) (16 19) (17 16) (17 17) (17 18) (17 19) (18 16) (18 17) (18 18) (18 19) (19 16) (19 17) (19 18) (19 19)}])
</code></pre>
<p>The <code>followers</code> relation may be empty, and it may contain any of the 16 ordered pairs of potential <code>Person</code> objects.</p>
<p><em>Any tuple in the upper bound of a relation, that isn't also in the lower bound, gets assigned a boolean variable.</em></p>
<ul>
<li>If a tuple isn't in the upper bound, it can never exist in an instance---it would always be assigned false---and so we needn't assign a variable.</li>
<li>If a tuple is in the lower bound, it must always exist in an instance---it would always be assigned true---and so we can again omit a variable.</li>
</ul>
<h2 id="from-forge-constraints-to-boolean-constraints"><a class="header" href="#from-forge-constraints-to-boolean-constraints">From Forge Constraints to Boolean Constraints</a></h2>
<p>Once we know the set of Boolean variables we'll use, we can translate Forge constraints to purely Boolean ones via substitution. Here's an example of how a basic compiler, without optimizations, might work.  Suppose we have the constraint:</p>
<pre><code class="language-alloy">all p: Person | Alice in p.followers
</code></pre>
<p>There are no <code>all</code> quantifiers in Boolean logic. How can we get rid of it?</p>
<details>
<summary>Think, then click!</summary>
<p>An <code>all</code> is just a big <code>and</code> over the upper bound on <code>Person</code>. So we substitute (note here we're using <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">erso</span><span class="mord mathnormal">n</span><span class="mord">3</span></span></span></span> as if it were defined in our model, because it's a <em>potential</em> part of every instance):</p>
<pre><code class="language-alloy">Alice in Alice.followers
Alice in Bob.followers
Alice in Charlie.followers
(Person3 in Person) implies Alice in Person3.followers
</code></pre>
</details>
</br>
<p>There are similar rules for other operators: a <code>some</code> becomes a big <code>or</code>, a relational join becomes a <code>some</code>-quantified statement about the existence of a value to join on, which then becomes a big <code>or</code>, etc.</p>
<h2 id="example-optimization-skolemization"><a class="header" href="#example-optimization-skolemization">Example optimization: Skolemization</a></h2>
<p>Forge performs a process called <em>Skolemization</em>, named after the logician <a href="https://en.wikipedia.org/wiki/Thoralf_Skolem">Thoralf Skolem</a>, to convert specific <code>some</code> quantifiers into supplemental relations. </p>
<p>The idea is: to satisfy a <code>some</code> quantifier, some atom exists that can be plugged into the quantifier's variable <code>x</code> to make the child formula true. Skolemization reifies that object witness into the model as a new relational constant <code>$x</code>. This:</p>
<ul>
<li>makes debugging easier sometimes, since you can immediately <em>see</em> what might satisfy the quantifier constraint; and</li>
<li>sometimes aids in efficiency, especially in a &quot;target poor&quot; environment like an unsatisfiable problem. </li>
</ul>
<p>By convention, these variables are prefixed with a <code>$</code>. So if you see a relation labeled <code>$x</code>, it's a Skolem relation that points to a value for a <code>some</code> quantified variable <code>x</code>. The relation will grow wider for every <code>all</code> quantifier that wraps the <code>some</code> quantifier being Skolemized. To see why that happens, suppose that we have a constraint: <code>all p: Person | all b: Bank | hasAccount[p,b] implies some i: Int | bankBalance[p,b,i]</code>. This constraint says that if a person has a bank account at a certain bank, there's a balance entered for that account. That balance isn't constant! It's potentially different for every <code>Person</code>-<code>Bank</code> pairing. Thus, <code>$i</code> would have arity 3: 2 for the &quot;input&quot; and 1 for the &quot;output&quot;. </p>
<div id="admonition-skolem-depth" class="admonition admonish-tip">
<div class="admonition-title">
<p>Skolem Depth</p>
<p><a class="admonition-anchor-link" href="chapters/solvers/bounds_booleans_how_forge_works.html#admonition-skolem-depth"></a></p>
</div>
<div>
<p>You can change how deeply <code>some</code> quantifiers will get Skolemized by using the <code>skolem_depth</code> <a href="chapters/solvers/../../docs/running-models/options.html">option</a> in Forge.</p>
</div>
</div>
<!-- (Forge adds the numeric suffix to help disambiguate variables with the same name.)
`$x_some32783` -->
<h2 id="symmetry-breaking"><a class="header" href="#symmetry-breaking">Symmetry Breaking</a></h2>
<p>Let's return to the original Followers model:</p>
<pre><code class="language-alloy">abstract sig Person {
  followers: set Person
}
one sig Alice, Bob, Charlie extends Person {}
run {some followers} for exactly 3 Person 
</code></pre>
<p>We decided it probably had <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">512</span></span></span></span> instances. But does it <em>really</em>? Let's hit <code>Next</code> a few times, and count! Actually, that sounds like a lot of work. Let's simplify things a bit more, instead:</p>
<pre><code class="language-alloy">abstract sig Person {
  follower: one Person -- changed: replace `set` with `one` 
}
one sig Alice, Bob, Charlie extends Person {}
run {} for exactly 3 Person  -- changed: don't run any predicates
</code></pre>
<p>Now everybody has exactly one follower. There are still 9 potential tuples, but we're no longer storing <em>sets</em> of them for each <code>Person</code>. Put another way, every instance corresponds to an ordered triplet of <code>Person</code> objects (Alice's follower, Bob's follower, and Charlie's follower). There will be <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">3</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">27</span></span></span></span> instances. And indeed, if we click &quot;Next&quot; 26 times, this is what we see. (Whew.) </p>
<p>Now suppose we didn't name the 3 people, but just had 3 anonymous <code>Person</code> objects:</p>
<pre><code class="language-alloy">sig Person {
  follower: one Person
}
run {} for exactly 3 Person  -- changed: no named people
</code></pre>
<p>The math is still the same: <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">27</span></span></span></span> instances. But now we only get <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">9</span></span></span></span> before hitting the unsat indicator of &quot;no more instances&quot; in the visualizer.</p>
<p>What's going on?</p>
<p>Forge tries to avoid showing you the same instance multiple times. And, if objects are un-named and the constraints can never distinguish them, instances will be considered &quot;the same&quot; if you can arrive at one by renaming elements of the other. E.g., </p>
<pre><code>Person1 follows Person2
Person2 follows Person3
Person3 follows Person1
</code></pre>
<p>would be considered equivalent to:</p>
<pre><code>Person2 follows Person1
Person3 follows Person2
Person1 follows Person3
</code></pre>
<p>since the individual <code>Person</code> atoms are <em>anonymous</em> to the constraints, which cannot refer to atoms by name. We call these instances <em>isomorphic</em> to each other, and say that there is a <em>symmetry</em> between them.  Formally, Forge finds every instance &quot;up to isomorphism&quot;. This is useful for:</p>
<ul>
<li>increasing the quality of information you get from paging through instances; and</li>
<li>(sometimes) improving the runtime on problems, especally if solutions are very rare.</li>
</ul>
<p>This process isn't always perfect: some equivalent instances can sneak in. Removing <em>all</em> equivalent instances turns out to sometimes be even more expensive than solving the problem. So Forge provides a best-effort, low cost attempt based on a <em>budget</em> for adding additional constraints to the problem, specifically to eliminate symmetries.</p>
<p>You can adjust the budget for symmetry breaking via an option:</p>
<ul>
<li><code>option sb 0</code> turns off symmetry breaking; and</li>
<li><code>option sb 20</code> is the default.</li>
</ul>
<p>If we turn off symmetry-breaking, we'll get the expected number of instances in the above run: <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">27</span></span></span></span>.</p>
<div id="admonition-symmetry-breaking--filtering" class="admonition admonish-note">
<div class="admonition-title">
<p>Symmetry Breaking != Filtering</p>
<p><a class="admonition-anchor-link" href="chapters/solvers/bounds_booleans_how_forge_works.html#admonition-symmetry-breaking--filtering"></a></p>
</div>
<div>
<p>Forge doesn't just filter instances after they're generated; it <em>adds</em> extra constraints that try to rule out symmetric instances. These constraints are guaranteed to be satisfied by at least one element of every equivalence class of instances. There's a lot of research work on this area, e.g., <a href="https://kaiyuanw.github.io/papers/paper22-tacas20.pdf">this paper</a> from 2020.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="relational-forge-qa"><a class="header" href="#relational-forge-qa">Relational Forge Q&amp;A</a></h1>
<h2 id="the-truth-about-dot"><a class="header" href="#the-truth-about-dot">The Truth About Dot</a></h2>
<p>This part of the notes is meant to reinforce what we'd previously done with relational join in Forge. We'll cover some of this in class, but the rest is here for your reference.</p>
<p>Let's go back to the directed-graph model we used before:</p>
<pre><code class="language-alloy">#lang forge
sig Person {
    friends: set Person,
    followers: set Person
}
one sig Nim, Tim extends Person {}
pred wellformed {
    -- friendship is symmetric
    all disj p1, p2: Person | p1 in p2.friends implies p2 in p1.friends
    -- cannot follow or friend yourself
    all p: Person | p not in p.friends and p not in p.followers
}
run {wellformed} for exactly 5 Person

pred reachableIn1To7Hops[to: Person, from: Person, fld: Person-&gt;Person] {
    to in from.fld or
    to in from.fld.fld or
    to in from.fld.fld.fld or 
    to in from.fld.fld.fld.fld or
    to in from.fld.fld.fld.fld.fld or
    to in from.fld.fld.fld.fld.fld.fld or
    to in from.fld.fld.fld.fld.fld.fld.fld 
    --  ... and so on, for any finite number of hops
    --  this is what you use the transitive-closure operator (^) 
    --  or the reachable built-in predicate for.
}
</code></pre>
<p>We said that chaining field access with <code>.</code> allows us to compute reachability in a certain number of hops. That's how <code>reachableIn1To7Hops</code> works. </p>
<p>However, there's more to <code>.</code> than this.</p>
<h3 id="beyond-field-access"><a class="header" href="#beyond-field-access">Beyond Field Access</a></h3>
<p>Let's run this model, and open up the evaluator. I'll show the first instance Forge found using the table view:</p>
<p><img src="https://i.imgur.com/CXrslMn.png" alt="" /></p>
<p>We saw that <code>Tim.friends</code> produces the set of <code>Tim</code>'s friends, and that <code>Tim.friends.friends</code> produces the set of <code>Tim</code>'s friends' friends. But let's try something else. Enter this into the evaluator:</p>
<pre><code>friends.friends
</code></pre>
<p>This looks like a nonsense expression: there's no object to reference the <code>friends</code> field of. But it means something in Forge:</p>
<p><img src="https://i.imgur.com/2m2esUg.png" alt="" /></p>
<p>What do you notice about this result? Recall that this is just a parenthetical way to show a set of tuples: it's got <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">erso</span><span class="mord mathnormal">n</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">erso</span><span class="mord mathnormal">n</span><span class="mord">0</span><span class="mclose">)</span></span></span></span> in it, and so on.</p>
<details>
<summary>Think, then click!</summary>
<p>This seems to be the binary relation (set of 2-element tuples) that describes the friend-of-friend relationship. Because we said that friendship is symmetric, everyone who has friends is a friend-of-a-friend of themselves. And so on.</p>
</details>
</br>
<p>The <code>.</code> operator in Forge isn't exactly field access. It behaves that way in Froglet, but now that we have sets in the language, it's more powerful. It lets us combine relations in a path-like way.</p>
<h3 id="relational-join"><a class="header" href="#relational-join">Relational Join</a></h3>
<p>Here's the precise definition of the <em>relational join</em> operator (<code>.</code>):</p>
<p>If <code>R</code> and <code>S</code> are relations (with <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> columns, respectively), then <code>R.S</code> is defined to be the set of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mclose">)</span></span></span></span>-column tuples: <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord"> and </span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">}</span></span></span></span></p>
<p>That is, whenever the inner columns of the two relations line up on some value, their join contains some tuple(s) that have the inner columns eliminated. </p>
<p>In a path-finding context, this is why <code>Tim.friends.friends.friends.friends</code> has one column, and all the intermediate steps have been removed: <code>Tim</code> has one column, and <code>friends</code> has 2 columns. <code>Tim.friends</code> is the <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mclose">)</span></span></span></span>-column relation of <code>Tim</code>'s friends. And so on: every time we join on another <code>friends</code>, 2 columns are removed.</p>
<p>Let's try this out in the evaluator:</p>
<p><img src="https://i.imgur.com/oeZWrIT.png" alt="" /></p>
<p><img src="https://i.imgur.com/B3Hyk8h.png" alt="" /></p>
<p>Does this mean that we can write something like <code>followers.Tim</code>? Yes; it denotes the set of everyone who has <code>Tim</code> as a follower:</p>
<p><img src="https://i.imgur.com/yVaYWoz.png" alt="" /></p>
<p>Note that this is very different from <code>Tim.followers</code>, which is the set of everyone who follows <code>Tim</code>:</p>
<p><img src="https://i.imgur.com/MKu2M29.png" alt="" /></p>
<h3 id="testing-our-definition"><a class="header" href="#testing-our-definition">Testing Our Definition</a></h3>
<p>We can use Forge to validate the above definition, for relations with fixed arity. So if we want to check the definition for pairs of <em>binary</em> relations, up to a bound of <code>10</code>, we'd run:</p>
<pre><code class="language-alloy">test expect {
    joinDefinitionForBinary: {
        friends.followers = 
        {p1, p2: Person | some x: Person | p1-&gt;x in friends and 
                                           x-&gt;p2 in followers}
    } for 10 Person is theorem
}
</code></pre>
<p>Notice that we don't include <code>wellformed</code> here: if we did, we wouldn't be checking the definition for <em>all</em> possible graphs.</p>
<h3 id="whats-join-good-for"><a class="header" href="#whats-join-good-for">What's Join Good For?</a></h3>
<p>Here's an example. Suppose you're modeling something like Dijkstra's algorithm. You'd need a weighted directed graph, which might be something like this:</p>
<pre><code class="language-alloy">sig Node {
    edges: Node -&gt; Int
}
</code></pre>
<p>But then <code>edges</code> has three columns, and you won't be able to use either <code>reachable</code> or <code>^</code> on it directly. Instead, you can eliminate the rightmost column with join: <code>edges.Int</code>, and then use that expression as if it were a <code>set</code> field.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="liveness-and-lassos"><a class="header" href="#liveness-and-lassos">Liveness and Lassos</a></h1>
<p>Let's return to thinking about our <a href="chapters/temporal/../relations/sets-induction-mutex.html">mutual-exclusion</a> <a href="chapters/temporal/../relations/sets-beyond-assertions.html">model</a>. We had noticed that &quot;every thread, whenever it becomes interested in the critical section, will eventually get access&quot; is a different kind of property—one that requires an <em>infinite</em> counterexample to disprove about the system. We called this sort of property a <em>liveness property</em>.</p>
<p>In a finite-state system, checking a liveness property amounts to looking for a bad cycle: some trace, starting from an initial state, that loops back on itself. Since these traces don't always loop back to the first state, we'll often call these <em>lasso traces</em>, named after a loop of rope. Here's an example. Consider the (reachable states only) transition system we drew last time:</p>
<p><img src="https://i.imgur.com/EPMcgrl.png" alt="" /></p>
<p><strong>Exercise:</strong> Can you find a lasso trace that violates our liveness property?</p>
<details>
<summary>Think, then click!</summary>
Here's one of them: 
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span>; then</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>; then</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>; then back to</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span>.</li>
</ul>
<p>This lasso trace <em>does</em> just happen to loop back to its first state. It shows the second process executing forever, and the first process remains uninterested forever. </p>
<p>Is this good or bad? It depends on how we write the property, and what we mean when we write it. If we want to say that no process can <em>WAIT</em> forever, then maybe this is OK. (Or is it?)</p>
</details>
<h2 id="checking-liveness-in-forge-attempt-1"><a class="header" href="#checking-liveness-in-forge-attempt-1">Checking Liveness In Forge (Attempt 1)</a></h2>
<p>How could we encode this sort of check in Forge? We wouldn't be able to use the inductive method—at least not in the same way—because we're looking for a bad cycle, not a bad state. So let's use the full finite-trace approach we used to generate games of Tic-Tac-Toe, but expand it to search for a bad <em>cycle</em>.</p>
<h3 id="setting-up"><a class="header" href="#setting-up">Setting Up</a></h3>
<p>We'll add the same finite-trace infrastructure as before. This time we're able to use full Forge, so we can use the transpose (<code>~</code>) operator to say that the initial state has no predecessors.</p>
<pre><code class="language-alloy">one sig Trace {
    initialState: one State,
    nextState: pfunc State -&gt; State
}

pred trace {
    no Trace.initialState.~(Trace.nextState)
    init[Trace.initialState]
    all s: State | some Trace.nextState[s] implies {
        delta[s, Trace.nextState[s]]
}
pred lasso {
    trace
    all s: State | some Trace.nextState[s]
}
</code></pre>
<p>Let's test our <code>lasso</code> predicate to make sure it's satisfiable. And, because we're careful, let's make sure it's <em>not</em> satisfiable if we don't give the trace enough states to loop back on itself:</p>
<pre><code class="language-alloy">test expect {
  lassoVacuity: { lasso } is sat
  lassoVacuityNotEnough: { lasso } for 2 State is unsat
}
</code></pre>
<h3 id="beware"><a class="header" href="#beware">Beware...</a></h3>
<p>There is actually a hidden overconstraint bug in our <code>lasso</code> predicate. It's not so extreme as to make the predicate unsatisfiable---so the test above passes! </p>
<p><strong>Exercise:</strong> What's the problem?</p>
<details>
<summary>Think, then click!</summary>
<p>We said that the initial state has no predecessor. This will prevent the lasso from looping back to the start—it must always have some states before the cycle begins. If the bug we're looking for always manifests as a loop back to the starting state, we would be <strong>lulled into a false sense of success</strong> by Forge, because it would fail to find the counterexample.</p>
<p>In fact, this would be a problem in the current model, since the counterexample we'd like to find does loop back to the original state.</p>
</details>
</br>
<p><strong>Watch out for this kind of bug!</strong></p>
<p>This is why thinking through vacuity testing is important. It's also a reason why, maybe, we'd like to avoid having to write all this temporal boilerplate (and potentially introduce bugs when we make a mistake).</p>
<h3 id="identifying-a-bad-cycle"><a class="header" href="#identifying-a-bad-cycle">Identifying A Bad Cycle</a></h3>
<p>If we know that the trace is a lasso, we can write a predicate that identifies some process being starved. This isn't easy, though. To see why, look at this initial attempt, which says that our property fails if <code>ProcessA</code> never enters the critical section:</p>
<pre><code class="language-alloy">pred badLasso {
  lasso
  all s: State | s.loc[ProcessA] != InCS
}
test expect {
  checkNoStarvation: { badLasso } is unsat
}

</code></pre>
<p>This is <em>unsatisfiable</em>; the test passes. Could anything potentially be going wrong in our model, though?</p>
<p>We might first wonder, as we usually should, whether the test allocates enough states to reasonably find a counterexample. We've got 8 reachable states, so maybe we'd need 8 (or 9?) states in the test. That's true! There's something else wrong here, and it's more subtle. We'll need to address both of these problems to make progress. </p>
<p><strong>Exercise:</strong> What else is wrong?</p>
<details>
<summary>Think, then click!</summary>
<p>The <code>badLasso</code> predicate wouldn't hold true if the system allowed <code>ProcessA</code> to enter the critical section <em>once</em> (and only once). We want <code>ProcessA</code> to be able to get access (eventually) whenever it needs that access. That is, we need to say that the <em>loop</em> of the lasso contains no states where <code>ProcessA</code> is in the critical section, no matter what happens before the cycle starts.</p>
</details>
</br>
<p>That sounds like a lot of work: we'd need to identify the sub-sequence of states representing the cycle and properly apply the constraint to only those states. More importantly, it sounds really easy to get this wrong if we write it ourselves, at this low level of abstraction, because the specifics might change as the model evolves. </p>
<p>There's a better way. Forge has another language level—Temporal forge—that provides all of this automatically. </p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="temporal-forge"><a class="header" href="#temporal-forge">Temporal Forge</a></h1>
<p>Temporal Forge works by adding additional operators to the language. You can still do everything you could before (with one exception that we'll get to) in Relational Forge, but you get new operators—new operators like <code>always</code> and <code>eventually</code>—that make describing properties and specifying systems easier. Moreover, these operators are standard in industrial model-checking tools.</p>
<!-- Livecode is [here](./mutex_temporal.frg). -->
<!-- ## Temporal Operators: Survey

I wonder if we could add notions of "always" and "eventually" and so on to Forge. That would help us avoid some of the errors that occur when we try to represent lasso traces manually.

~~~admonish note title="CSCI 1710"
Your class exercise today is to try out [this survey](https://docs.google.com/forms/d/e/1FAIpQLSf4nNtzjVhEv3daqZeySbsApoX9L2cwVts23qIzOlX6Ug8nug/viewform?usp=sf_link).  

We're asking whether a _specific trace_ satisfies a constraint that uses the new operators.
~~~ -->
<p>Temporal Forge takes away the need for you to explicitly model traces, and gives some convenient syntax for describing what can change over time. But there is something to watch out for: Temporal Forge <strong>forces the engine to only ever find lasso traces</strong>. It's very convenient if that's what you want, but <em>don't use it if you don't want a lasso trace</em>!</p>
<h2 id="example-integer-counter"><a class="header" href="#example-integer-counter">Example: Integer Counter</a></h2>
<p>Here's a quick example that motivates how Temporal Forge works, and some pitfalls that can occur when you use it. Suppose that we're modeling a system with a single integer counter:</p>
<pre><code class="language-forge">#lang forge/temporal

-- enable traces of up to length 10
option max_tracelength 10

one sig Counter {
  -- The value of the &quot;counter&quot; field may vary over time.
  var counter: one Int
}

run {
  -- Temporal-mode formulas are interpreted from an implicit current time. By default, 
  -- we're talking about the start of the trace. So, the counter starts at 0.
  Counter.counter = 0
  -- `always` means &quot;now and at every time in the future&quot;. The prime (') operator 
  -- says &quot;value in the next state&quot;. So this means that the counter is incremented 
  -- with every transition:
  always Counter.counter' = add[Counter.counter, 1]
} for 3 Int
</code></pre>
<p>First, notice that we didn't need to define the structure of a trace. We got that for free by using Temporal Forge, which only ever finds traces.</p>
<p>Second, this is <em>satisfiable</em>, as we might expect. But what happens if you change the bound on <code>Int</code> to <code>for 4 Int</code>? </p>
<p><strong>Exercise:</strong> Try it. What happens? Why do you think it did happen?</p>
<details>
<summary>Think, then click!</summary>
<p>It's unsatisfiable with the new bound. This is strange: usually when we increase the scope on a <code>sig</code>, without using the <code>exactly</code> keyword, we only ever make something <em>satisfiable</em> (because we're increasing the possible sizes of instance that Forge checks). </p>
<p>The problem is that, because <strong>only lasso traces are found</strong>, Forge can only satisfy this model by exploiting integer overflow. At <code>3 Int</code>, which supports values between <code>-4</code> and <code>3</code>, the counter progresses like this: <code>0</code>, <code>1</code>, <code>2</code>, <code>3</code>, (overflow to) <code>-4</code>, <code>-3</code>, <code>-2</code>, <code>-1</code>, <code>0</code> and so on. We have 10 states to work with, which is enough to wrap around back to <code>0</code>. </p>
<p>In contrast, at <code>4 Int</code>, the values range from <code>-8</code> to <code>7</code>. Overflow will happen as normal, but only when moving from <code>7</code> to <code>-8</code>. The 10 states we have won't be enough to actually loop back around to <code>0</code>—and there <em>must</em> be a loop somewhere in a lasso trace. So Temporal Forge says that the model is unsatisfiable at trace length 10, <code>for 4 Int</code>. </p>
</details>
<h2 id="converting-to-temporal-forge"><a class="header" href="#converting-to-temporal-forge">Converting to Temporal Forge</a></h2>
<p>Let's convert the mutual-exclusion model into Temporal Forge. We'll add the necessary options first:</p>
<pre><code class="language-alloy">#lang forge/temporal

option max_tracelength 10
</code></pre>
<div id="admonition-option-names" class="admonition admonish-warning">
<div class="admonition-title">
<p>Option Names</p>
<p><a class="admonition-anchor-link" href="chapters/temporal/temporal_operators.html#admonition-option-names"></a></p>
</div>
<div>
<p>Be sure to include the underscore! Misspellings like <code>maxtracelength</code> aren't a valid option name.</p>
</div>
</div>
<p>Now we'll update the data definitions. Because both the <code>flags</code> and <code>loc</code> fields change over time, we'll make both of them <code>var</code>:</p>
<p><strong>TODO: double-check; is <code>World</code> new? If so, explain.</strong></p>
<pre><code class="language-alloy">one sig World {
  var loc: func Thread -&gt; Location,
  var flags: set Thread
</code></pre>
<p>At any moment in time, every thread is in exactly one location. And, at any moment in time, each thread has either raised or lowered its flag. </p>
<p>Now for the predicates. In Temporal Forge, we don't have the ability to talk about specific pre- and post-states: the language handles the structure of traces for us. This means we have to change the types of our predicates. For <code>init</code>, we have:</p>
<pre><code class="language-alloy">-- No argument! Temporal mode is implicitly aware of time
pred init {
    all p: Process | World.loc[p] = Uninterested
    no World.flags 
}
</code></pre>
<p>The loss of a <code>State</code> <code>sig</code> is perhaps disorienting. How does Forge evaluate <code>init</code> without knowing which state we're looking at? <strong>In Temporal Forge, every constraint is evaluated not just in an instance, but in that instance at some <em>moment in time</em></strong>. You don't need to explicitly mention the moment. So the formula <code>no World.flags</code> is true exactly when, at the current time, there's no flags raised. Using <code>init</code> is like saying &quot;are we in an initial state <em>right now</em>?&quot;</p>
<p>Similarly, we'll need to change our transition predicates:</p>
<pre><code class="language-alloy">-- Only one argument; same reason as above
pred raise[p: Process] {
    // pre.loc[p] = Uninterested
    // post.loc[p] = Waiting
    // post.flags = pre.flags + p
    // all p2: Process - p | post.loc[p2] = pre.loc[p2]

    // GUARD
    World.loc[p] = Uninterested
    // ACTION
    World.loc'[p] = Waiting
    World.flags' = World.flags + p
    all p2: Process - p | World.loc'[p2] = World.loc[p2]
}
</code></pre>
<p>I've left the old version commented out so you can contrast the two. Again, the predicate is true subject to an implicit moment in time. <strong>The priming (') operator means &quot;this expression in the next state&quot;</strong>; so if <code>raise</code> holds at some point in time, it means there is a specific relationship between the current and next moments.</p>
<p>We'll convert the other predicates similarly, and then run the model:</p>
<pre><code class="language-alloy">run {
    -- start in an initial state
    init
    -- in every state of the lasso, the next state is defined by the transition predicate
    always {some t: Thread | raise[t] or enter[t] or leave[t]}
}
</code></pre>
<p>This is the general shape of things! There are still some potential problems remaining, but we'll get to them shortly. First, we need to talk about how to view a Temporal Forge instance.</p>
<h2 id="running-a-temporal-model"><a class="header" href="#running-a-temporal-model">Running A Temporal Model</a></h2>
<p>When we run, we get something that looks like this:</p>
<p><img src="https://i.imgur.com/LsN0gfB.png" alt="" /></p>
<h3 id="new-buttons"><a class="header" href="#new-buttons">New Buttons!</a></h3>
<p>In temporal mode, Sterling has 2 &quot;next&quot; buttons, rather than just one. </p>
<ul>
<li>The &quot;Next Trace&quot; button will hold all non-<code>var</code> relations constant, but ask for a new trace that varies the <code>var</code> relations. </li>
<li>The &quot;Next Config&quot; button forces the non-<code>var</code> relations to differ. 
Having different buttons for these two ideas is useful, since otherwise Forge is free to change the value of any relation, even if it's not what you want changed. </li>
</ul>
<h3 id="trace-minimap"><a class="header" href="#trace-minimap">Trace Minimap</a></h3>
<p>In Temporal Forge, Sterling shows a &quot;mini-map&quot; of the trace in the &quot;Time&quot; tab. You can see the number of states in the trace, as well as where the lasso loops back. </p>
<p><strong>It will always be a lasso, because Temporal Forge never finds anything but lassos.</strong></p>
<p>You can use the navigation arrows, or click on specific states to move the visualization to that state: </p>
<p><img src="https://i.imgur.com/KnLqfJm.png" alt="" /></p>
<p>Theming works as normal, as do custom visualizers (although read the documentation if you're writing your own visualizer; there are some small changes like using <code>instances</code> instead of <code>instance</code> to access data). </p>
<h3 id="so-whats-missing"><a class="header" href="#so-whats-missing">So what's missing?</a></h3>
<p><em>Do not</em> try to use <code>example</code> in temporal mode. The <code>example</code> and <code>inst</code> constructs define bounds for <em>all states at once</em> in Temporal forge. While <code>inst</code> can still be very useful for optimization, <code>example</code> will prevent anything it binds from ever changing in the trace, which isn't very useful for test cases. Instead, use constraints.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="linear-temporal-logic"><a class="header" href="#linear-temporal-logic">Linear Temporal Logic</a></h1>
<p>Formally, the temporal operators Forge provides come from a language called Linear Temporal Logic (or LTL). It's <em>temporal</em> because it has time-aware operators like <code>always</code> and <code>eventually</code>, and it's <em>linear</em> because it's interpreted over (infinite) linear traces. </p>
<div id="admonition-industrial-practice" class="admonition admonish-note">
<div class="admonition-title">
<p>Industrial Practice</p>
<p><a class="admonition-anchor-link" href="chapters/temporal/temporal_operators_2.html#admonition-industrial-practice"></a></p>
</div>
<div>
<p>LTL is commonly used in industry. And even where it isn't used directly, many other temporal specification languages are either related to LTL (e.g., branching-time logics like CTL) or inspired by it (e.g., Lamport's <a href="https://lamport.azurewebsites.net/tla/tla.html"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7713em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">L</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7713em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">+</span></span></span></span></span></span></span></span></span></span></span></span></a> and other more recent languages). There are a <em>lot</em> of industrial model-checking tools out there, using a lot of different languages, but learning LTL will help you build intuition for nearly all of them.</p>
<p>And, on the research side of things, there's a lot of temporal logic use as well. For example, <a href="https://nakulgopalan.github.io/docs/sequence-sequence-language.pdf">this paper</a> on using temporal logics in AI to specify robot behaviors.</p>
</div>
</div>
<h2 id="how-to-read-a-temporal-formula"><a class="header" href="#how-to-read-a-temporal-formula">How To Read A Temporal Formula</a></h2>
<p>Recall that:</p>
<ul>
<li>time is <em>implicit</em> in temporal mode, and </li>
<li>temporal mode only ever finds lasso traces. </li>
</ul>
<p>When you write a constraint in temporal mode, it's true with respect to an instance (which is always a lasso trace) <em>and a time index</em> into that trace. Thus the <code>init</code> predicate may be true, or not true, depending on which state you're looking at.</p>
<p>Evaluation always <em>starts</em> at the first state. This corresponds to the top-level <code>run</code> command or <code>test</code>. I didn't say &quot;the initial state&quot;, because if we've got a predicate that encodes &quot;initial state&quot;, it  won't be enforced unless we've told Forge to do so. This is why, usually, you'll start by putting: <code>init</code> (or whatever your initial-state predicate is named) in your top-level <code>run</code>. </p>
<p>As soon as temporal operators become involved, however, the &quot;evaluate in the first state&quot; rule starts to change because the current time index may change.</p>
<h2 id="moving-forward-in-time"><a class="header" href="#moving-forward-in-time">Moving Forward In Time</a></h2>
<p>You can refer to the <em>next</em> state (relative to the current one, whatever it is) by using the <code>next_state</code> operator. If I wanted to say that the <em>second</em> and <em>third</em> states would also need to be initial states, I'd write more in the top-level <code>run</code> block:</p>
<pre><code>init
next_state init
next_state next_state init
</code></pre>
<p>It's rare you'd do something like this in practice, but it's a good first demonstration of the operator.</p>
<p>```admonish note title=&quot;Why <code>next_state</code>?&quot;
The keyword is, admittedly, a little verbose. But it was the best of the various candidates at hand:</p>
<ul>
<li>In many settings, this LTL operator is usually called <code>X</code>, which is not very descriptive. (When I read <code>X</code>, I think &quot;variable&quot;!)</li>
<li>In Forge's parent language, Alloy 6, the operator is called <code>after</code>, but this can lead to some misconceptions since <code>A after B</code> might be misinterpreted as a binary operator, and Forge and Alloy both have implicit <code>and</code> via newlines, so <code>A after B</code> would actually mean <code>A and (after B)</code>. </li>
<li>I've heard <code>afterward</code> suggested, but that risks confusion with <code>always</code> or <code>eventually</code>.</li>
</ul>
<pre><code>
## Quantifying Over Time

What does it mean for something to `always` be true, or to `eventually` hold? These terms quantify over time: if something is `always` true, it's true at all time indexes (starting now). If something is `eventually` true, it's true at _some_ time index (possibly now). 

So if we wanted to say that every state in the trace transitions to its successor in accordance with our `move` predicate, we'd say: `always move`. In the last section, because we had multiple predicates, and each took an argument, we wrote:

```forge
always {some t: Thread | raise[t] or enter[t] or leave[t]}
</code></pre>
<h3 id="nesting-operators"><a class="header" href="#nesting-operators">Nesting Operators</a></h3>
<p>Just like you can nest <code>all</code> and <code>some</code>, you can nest <code>always</code> and <code>eventually</code>. We'll need to do this to express properties like non-starvation. In fact, let's think about how to express non-starvation now! </p>
<p>We had informally written non-starvation in our mutex model as something like &quot;once a process becomes interested, it eventually gets access&quot;. How would you write this using temporal operators, assuming that <code>interested</code> and <code>access</code> were predicates describing the process becoming interested and getting access respectively?</p>
<p><strong>Exercise:</strong> Try this!</p>
<details>
<summary>Think, then click for a possible solution.</summary>
<p>We might start with: <code>interested =&gt; eventually access</code>. That would be a reasonable start: if the process is interested, it eventually gets access. The problem is that the interest is measured <em>now</em>---that is, at whatever time index Forge is currently looking. </p>
</details>
<hr />
<p>Clearly we need to add some sort of temporal operator that prevents the above issue. Here's a possible candidate: <code>(eventually interested) =&gt; (eventually access)</code>. </p>
<p><strong>Exercise:</strong> What's wrong with this one?</p>
<details>
<summary>Think, then click!</summary>
<p>The problem here is that there's no connection between the time at which the left-hand side holds, and the time at which the right-hand side holds. To force that relationship (access <em>after</em> interest) we need to nest the two temporal quantifiers.</p>
</details>
<hr />
<p>How about <code>eventually (interested =&gt; (eventually access))</code>? </p>
<details>
<summary>Think, then click!</summary>
<p>This constraint isn't strong enough. Imagine a trace where the process never gets access, but is interested only (say) half the time. Then any of those disinterested states will satisfy the subformula <code>interested =&gt; (eventually access)</code>. </p>
<p>Why? Think about how an implication is satisfied. It can be satisfied if the right-hand side is true, but also if the left-hand side is false—in the case where no obligation needs to be incurred! So the implication above evaluates to <em>true</em> in any state where the process isn't interested. And using <code>eventually</code> means <em>any</em> single such state works...</p>
</details>
<hr />
<p>It seems like we need a different temporal operator! What if we combine <code>always</code> and <code>eventually</code>? </p>
<p><strong>Exercise:</strong> Give it a try.</p>
<details>
<summary>Think, then click!</summary>
<p>We'll say: <code>always {interested =&gt; eventually access}</code>. Now, no matter what time it is, if the process is interested, it has to eventually get access. </p>
<p>This sort of <code>always</code>-<code>eventually</code> pattern is good for (contingent) &quot;infinitely often&quot; properties, which is exactly what non-starvation is.</p>
</details>
<h2 id="lets-try-it-out"><a class="header" href="#lets-try-it-out">Let's Try It Out!</a></h2>
<p>I'm going to ask you to play the role of Forge. I've listed some temporal constraints below, and would like you to come up with some instances (lasso traces) that satisfy them. Don't use Forge unless you've already tried, and are stumped. </p>
<p>For all examples, you may come up with your own shape of the world. That is, you might pick a University (where a state is a semester, with courses offered and taken) or your experience waiting for an elevator in the CIT, or anything else from your life! I'll use <code>A</code>, <code>B</code> and <code>C</code> to denote arbitrary facts that might be true, or not true---your job is to plug in specifics, and then find a satisfying trace!</p>
<p>I'll use a lot of parentheses, to avoid confusion about operator precedence...</p>
<p><strong>Exercise:</strong> <code>eventually (always (A or B))</code></p>
<details>
<summary>Think, then click!</summary>
<p>Suppose <code>A</code> stands for weekday, and <code>B</code> for weekend. Then the normal progression of time satisfies the constraint: after some point (perhaps right now) it will always be either a weekday or a weekend.</p>
<p>I am probably abstracting out some important details here, like the heat-death of the universe. But that's not really the point. The point is that alternation between <code>A</code> and <code>B</code> is allowed---it's always <em>either</em> one or the other, or possibly even both.</p>
</details>
<hr />
<p><strong>Exercise:</strong> <code>always (eventually (X and (next_state Y)))</code></p>
<details>
<summary>Think, then click!</summary>
<p>Suppose <code>A</code> stands for &quot;Saturday&quot;, and <code>B</code> for &quot;Sunday&quot;. Then it's always true that, at <em>any point</em> in time, there is a Saturday-Sunday pair of days in the future. </p>
</details>
<hr />
<p><strong>Exercise:</strong> <code>always ((eventually X) or (always Y)))</code></p>
<details>
<summary>Think, then click!</summary>
<p>Suppose <code>A</code> stands for &quot;final exam or demo&quot;, and <code>B</code> for &quot;graduated&quot;. Then, at <em>any point</em> in time, either there's a final in your future <em>or</em> you've graduated (and stay graduated forever). </p>
<p>Note that this doesn't mean you can't take a final exam after graduating if you want to. Both sides of the <code>or</code> can be true. It just means that, at any point, if you haven't graduated permanently, you must eventually take an exam.</p>
</details>
<hr />
<h2 id="non-starvation-in-our-lock-model"><a class="header" href="#non-starvation-in-our-lock-model">Non-Starvation in our Lock Model</a></h2>
<p>A deadlock state is one where <em>no</em> outgoing transitions are possible. How can we write a test in Temporal Forge that tries to find a reachable deadlock state? There are two challenges:</p>
<ul>
<li>How do we phrase the constraint, in terms of the transition predicates we have to work with? </li>
<li>How do we even allow Forge to find a deadlock, given that temporal mode <em>only</em> ever finds lasso traces? (A deadlock in a lasso trace is impossible, since a deadlock prevents progress!)</li>
</ul>
<p>Let's solve the second challenge first, since it's more foundational.</p>
<h3 id="finding-deadlocks-via-lassos"><a class="header" href="#finding-deadlocks-via-lassos">Finding Deadlocks Via Lassos</a></h3>
<p>We could prevent this issue by allowing a <code>doNothing</code> transition from every state. Then from Forge's perspective there's no &quot;deadlock&quot;, and a lasso trace can be found. We can add such a transition easily enough: </p>
<pre><code class="language-alloy">pred doNothing {
    flags' = flags
    loc' = loc
}
run {
    init
    always { 
        (some p: Process | {raise[p] or enter[p] or leave[p]})
        or doNothing 
    }
}
</code></pre>
<p>But we have to do so carefully, or the fix will cause new problems. If we allow a <code>doNothing</code> transition to happen <em>anywhere</em>, then Forge can find traces when nothing ever happens. In that case, our liveness property is definitely going to fail, even if we were modeling a smarter algorithm. So we need to reduce the power of <code>doNothing</code> somehow. </p>
<p>Put another way: we started with an <em>overconstraint</em> bug: if only lassos can be found, then we can't find a trace exhibiting deadlock. Adding a powerful <code>doNothing</code> fixes the overconstraint but adds a new <em>underconstraint</em>, because we'll get a lot of garbage traces where the system can just pause arbitrarily (while the trace continues).</p>
<p>We saw this phenomenon earlier when we were modeling <a href="chapters/temporal/../ttt/ttt_games.html">tic-tac-toe games</a>, and wanted to work around the fact that the <code>is linear</code> annotation forces exact bounds. We can use the same ideas in the fix here.</p>
<h2 id="finding-deadlock"><a class="header" href="#finding-deadlock">Finding Deadlock</a></h2>
<p>Let's look at one of our transitions:</p>
<pre><code class="language-alloy">pred raise[p: Process] {
    // GUARD
    World.loc[p] = Disinterested
    // ACTION
    World.loc'[p] = Waiting
    World.flags' = World.flags + p
    all p2: Process - p | World.loc'[p2] = World.loc[p2]
}
</code></pre>
<p>Notice it's split into a &quot;guard&quot; and an &quot;action&quot;. If all the constraints in the guard are true, the transition <em>can</em> occur. Formally, we say that if all the guard constraints hold, then the transition is <em>enabled</em>. When should <code>doNothing</code> be enabled? When no other transition is. What if we made an &quot;enabled&quot; predicate for each of our other transitions? Then we could write: </p>
<pre><code class="language-alloy">pred doNothing {
    -- GUARD (nothing else can happen)
    not (some p: Process | enabledRaise[p]) 
    not (some p: Process | enabledEnter[p]) 
    not (some p: Process | enabledLeave[p]) 
    -- ACTION (no effect)
    flags' = flags
    loc' = loc
}
</code></pre>
<p>We won't create a separate <code>enabledDoNothing</code> predicate. But we will add <code>doNothing</code> to the set of possible moves:</p>
<pre><code class="language-alloy">always { 
    (some p: Process | {raise[p] or enter[p] or leave[p]})
    or doNothing 
}
</code></pre>
<p>And we'd also better create those 3 <code>enabled</code> predicates, too. (<strong>TODO: link code</strong>) But then, finally, we can write a check looking for deadlocks:</p>
<pre><code class="language-alloy">test expect {
    noDeadlocks_counterexample: {
        -- setup conditions
        init
        always { 
            (some p: Process | {raise[p] or enter[p] or leave[p]})
            or doNothing 
        }
        -- violation of the property
        not always {
            some p: Process |
                enabledRaise[p] or
                enabledEnter[p] or
                enabledLeave[p] 
        }
    } is sat
}
</code></pre>
<p>which fails. Why? The counterexample (at least, the one I got) is 3 states long. And in the final state, both processes are <code>Waiting</code>. Success! Or, at least, success in <strong>finding the deadlock</strong>. But how should we fix the algorithm? And how can we avoid confusion like this in the future?</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="obligations-and-the-past"><a class="header" href="#obligations-and-the-past">Obligations and The Past</a></h1>
<!-- ~~~admonish hint title="Temporal Forge Reminders"
* Remember the definition of "configuration": the value of all relations that aren't marked `var`. Thus, if you click the Sterling button that asks for a _new configuration_, the solver will always find a new trace that varies on one or more of those relations. This is useful when you want to see different temporal behavior, but not vary the constants.
* _Do not_ try to use `example` in temporal mode. For reasons we'll get to soon (when we talk about how Forge works) `example` and `inst` constrain _all states_ in temporal mode, and so an example will prevent anything it binds from ever changing in the trace.
~~~

The in-class exercise is [here](https://docs.google.com/forms/d/e/1FAIpQLSemtfAG44sxqkRSS4imTcGC1LVwcHgJWOrgrHp3wXyLbuMAZw/viewform?usp=sf_link). The livecode is the same model we've been working on: the [locking algorithm](./mutex_temporal.frg), and the (new) [traffic lights example](./traffic.frg). -->
<!-- You can talk about the value of an expression _in the next state_ by appending `'` to the expression. So writing `flags'` means the value of the flags relation in the state after the current one. -->
<p><strong>TODO: soften abrupt transition</strong></p>
<p><strong>TODO: link to docs for this and other temporal operators</strong></p>
<p>Suppose we've written a model where <code>stopped</code> and <code>green_light</code> are predicates that express our car is stopped, and the light is green. Now, maybe we want to write a constraint like, at the current moment in time, it's true that:</p>
<ul>
<li>the light must eventually turn green; and </li>
<li>the <code>stopped</code> predicate must hold true until the light turns green. </li>
</ul>
<p>We can write the first easily enough: <code>eventually green</code>. But what about the second? We might initially think about writing something like: <code>always {not green implies stopped}</code>. But this doesn't quite express what we want. </p>
<p><strong>Exercise:</strong> Why not?</p>
<details>
<summary>Think, then click!</summary>
<p>The formula <code>always {not green implies stopped}</code> says that at any single moment in time, if the light isn't green, our car is stopped. This isn't the same as &quot;the <code>stopped</code> predicate holds until the light turns green&quot;. For one thing, the latter applies <em>until</em> <code>green</code> happens, and after that there is no obligation remaining on <code>stopped</code> for the rest of the trace. </p>
</details>
<hr />
<p>In LTL, the <code>until</code> operator can be used to express a stronger sort of <code>eventually</code>. If I write <code>stopped until green_light</code>, it encodes the meaning above. This operator is a great way to phrase obligations that might hold only until some releasing condition occurs.</p>
<!-- ~~~admonish tip title="Strong vs. Weak Until"
Some logics include a "weak" `until` operator that doesn't actually enforce that the right-hand side ever holds, and so the left-hand side can just be true forever. But, for consistency with industrial languages, Forge's `until` is "strong", so it requires the right-hand side hold eventually.
~~~ -->
<div id="admonition-the-car-doesnt-have-to-move" class="admonition admonish-warning">
<div class="admonition-title">
<p>The car doesn't have to move!</p>
<p><a class="admonition-anchor-link" href="chapters/temporal/obligations_past.html#admonition-the-car-doesnt-have-to-move"></a></p>
</div>
<div>
<p>The <code>until</code> operator doesn't prevent its <em>left</em> side from being true after its right side is. E.g., <code>stopped until green_light</code> doesn't mean that the car has to move immediately (or indeed, ever) once the light is green. It just means that the light eventually turns green, and the car can't move until then.</p>
</div>
</div>
<h2 id="the-past-rarely-used-but-sometimes-useful"><a class="header" href="#the-past-rarely-used-but-sometimes-useful">The Past (Rarely Used, but Sometimes Useful)</a></h2>
<p>Forge also includes temporal operators corresponding to the <em>past</em>. This isn't standard in some LTL tools, but we include it for convenience. It turns out that past-time operators don't increase the expressive power of the language, but they do make it much easier and sometimes <em>much</em> more concise to write some constraints. Here are some examples:</p>
<h3 id="prev_state-init"><a class="header" href="#prev_state-init"><code>prev_state init</code></a></h3>
<p>This means that the <em>previous</em> state satisfied the initial-state predicate. <strong>But beware</strong>: traces are infinite in the forward direction, but <em>not</em> infinite in the backward direction. For any subformula <code>myPredicate</code>, <code>prev_state myPredicate</code> is <em>false</em> if the current state is the first state of the trace.</p>
<h3 id="past-time-always-and-eventually-historically-and-once"><a class="header" href="#past-time-always-and-eventually-historically-and-once">Past-Time <code>always</code> and <code>eventually</code>: <code>historically</code> and <code>once</code></a></h3>
<p>We can use <code>historically</code> to mean that something held in all past states. I can write &quot;I've never been skydiving&quot; as <code>historically {not skydiving[Tim]}</code>. But if I go skydiving tomorrow, that formula won't be true tomorrow.</p>
<p>Likewise, <code>once</code> means that there was a time in the past where something held. If I've been skydiving at all in my life, I could write <code>once {skydiving[Tim]}</code>. </p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="peterson-lock-and-fairness"><a class="header" href="#peterson-lock-and-fairness">Peterson Lock and Fairness</a></h1>
<p>Let's finally <em>fix</em> <a href="chapters/temporal/../relations/sets-induction-mutex.html">the broken locking algorithm</a> <a href="chapters/temporal/../relations/sets-beyond-assertions.html">we modeled before</a>. We <a href="chapters/temporal/./liveness_and_lassos.html">decided</a> that it would be a bother to encode lasso traces manually in Relational Forge, but it seems like Temporal Forge might give us exactly what we need.</p>
<p>The final version of the model will be in <a href="chapters/temporal/./peterson.frg">peterson.frg</a>.</p>
<h2 id="fixing-deadlock"><a class="header" href="#fixing-deadlock">Fixing Deadlock</a></h2>
<p>Our little algorithm is 90% of the way to a <em>working</em> mutex called the <a href="https://en.wikipedia.org/wiki/Peterson%27s_algorithm">Peterson lock</a>.  The Peterson lock just adds one extra bit of state, and one transition to set that bit. In short, if our current algorithm is analogous to raising hands for access, the other bit added is like a &quot;no, you first&quot; when two people are trying to get through the door at the same time; that's exactly the sort of situation our both-flags-raised deadlock represented.</p>
<p><strong>TODO: add transition diagram here, and probably for lock1</strong></p>
<p>To represent which process (if any) has most recently said &quot;no, you go first&quot;, we'll add a <code>polite: lone Process</code> field to each <code>Process</code>. The algorithm now needs to take a step to set this value. It goes something like this (in pseudocode) after the process becomes interested:</p>
<pre><code>// location: uninterested 
this.flag = true
// location: halfway   (NEW)
polite = me         
// location: waiting 
while(other.flag == true || polite == me) {} // hold until their flag is lowered _or_ the other is being polite
// location: in CS 
run_critical_section_code(); // don't care details
this.flag = false
</code></pre>
<p>Because we're modeling individual operations executing, we'll need to add a new location to the state, which I'll call <code>Halfway</code>. We'll also need a new transition (and to change existing transitions in some places). The new transition might look something like this:</p>
<pre><code class="language-alloy">pred enabledNoYou[p: Process] {
    World.loc[p] = Halfway
}
pred noYou[p: Process] {
    -- GUARD
    enabledNoYou[p]
    -- ACTION
    World.loc'[p] = Waiting
    World.flags' = World.flags
    World.polite' = p
    all p2: Process - p | World.loc'[p2] = World.loc[p2]
}
</code></pre>
<p>We'll need a small edit in <code>raise</code>, to set </p>
<pre><code>World.loc'[p] = Halfway
</code></pre>
<p>instead of </p>
<pre><code>World.loc'[p] = Waiting
</code></pre>
<p>and a modification to the <code>enter</code> transition so that it's enabled if <em>either</em> nobody else has their flag raised <em>or</em> the current process isn't the one being polite anymore:</p>
<pre><code class="language-alloy">pred enabledEnter[p: Process] {
    World.loc[p] = Waiting 
    -- no other processes have their flag raised *OR* this process isn't the polite one
    (World.flags in p or World.polite != p)
}
</code></pre>
<p>Then we add the new transition to the overall transition predicate, to <code>doNothing</code>, to the deadlock check test—anywhere we previously enumerated possible transitions.</p>
<p>We also need to expand the frame conditions of all other transitions to keep <code>polite</code> constant if we aren't explicitly modifying it.</p>
<div id="admonition-watch-out" class="admonition admonish-warning">
<div class="admonition-title">
<p>Watch out!</p>
<p><a class="admonition-anchor-link" href="chapters/temporal/fixing_lock_temporal.html#admonition-watch-out"></a></p>
</div>
<div>
<p>Beware of forgetting (or accidentally including) primes. This can lead to unsatisfiable results, since the constraints won't do what you expect between states. E.g., an accidental double-prime will mean &quot;in the state <em>after</em> next&quot;.</p>
</div>
</div>
<h3 id="lets-check-non-starvation"><a class="header" href="#lets-check-non-starvation">Let's Check Non-Starvation</a></h3>
<pre><code class="language-alloy">noStarvation: {
    lasso implies {
        all p: Process | {
            always {
                -- Beware saying &quot;p in World.flags&quot;. Why? Read on...
                p in World.flags =&gt;
                eventually World.loc[p] = InCS
            }
        }
    }
} is theorem
</code></pre>
<p>This passes. Yay!</p>
<div id="admonition-should-we-be-suspicious" class="admonition admonish-tip">
<div class="admonition-title">
<p>Should we be suspicious?</p>
<p><a class="admonition-anchor-link" href="chapters/temporal/fixing_lock_temporal.html#admonition-should-we-be-suspicious"></a></p>
</div>
<div>
<p>That was really easy. Everything seems to be working perfectly. Maybe we can stop early and go get ice cream. </p>
<p>But we should probably do some validation to make sure we haven't missed something. Here's a question: <em>is our domain model realistic enough to trust these results?</em></p>
</div>
</div>
<h2 id="abstraction-choices-we-made"><a class="header" href="#abstraction-choices-we-made">Abstraction Choices We Made</a></h2>
<p>We made a choice to model processes as always eventually <em>interested</em> in accessing the critical section. There's no option to remain uninterested, or even to terminate (as many processes do in real life). Suppose we allowed processes to become uninterested and go to sleep. How could this affect the correctness of our algorithm, or threaten our ability to verify the non-starvation property with the current model? </p>
<details>
<summary>Think, then click!</summary>
<p>The property might break because a process's flag is still raised as it is <em>leaving</em> the critical section, even if it never actually wants access again. So the implication is too strong. It is more correct to say <code>World.loc[p] = Waiting =&gt; ...</code> than <code>p in World.flags</code>, which is why we use it in the above. </p>
<p>But even the correct property will fail in this case: there's nothing that says one process can't completely dominate the overall system, locking its counterpart out. Suppose that <code>ProcessA</code> is <code>Waiting</code> and then <code>ProcessB</code> stops being interested. <em>If we modeled disinterest as a while loop</em>, perhaps using <code>doNothing</code> or a custom <code>stillDisinterested</code> transition, then <code>ProcessA</code> could follow that loop forever, leaving <code>ProcessB</code> enabled, but frozen, because our model only lets one process transition at a time.</p>
</details>
<p>Let's deal with that second problem now.</p>
<!-- In your next homework, you'll be _critiquing_ a set of properties and algorithms for managing an elevator. Channel your annoyance at the CIT elevators, here! Of course, none of our models encompass the complexity of the CIT elevators... -->
<h2 id="fairness"><a class="header" href="#fairness">Fairness</a></h2>
<p>In the real world, it's not just the process itself that says whether or not it runs forever; it's also up to the operating system's scheduler, the system's hardware, etc. Thus, non-starvation is contingent on some <strong>preconditions</strong> that the domain must provide. 
Without the scheduler being at least <em>somewhat</em> fair, even the best algorithm can guarantee very little. </p>
<p>Let's add the precondition, which we'll call &quot;fairness&quot;. Again, keep in mind that, in this context, fairness is <em>not a property our locking system must guarantee</em>. Rather, it's something our locking system needs from its environment. This is a common thing to see in verification and, for that matter, in all of computer science. To underscore this point, you might review the <a href="chapters/temporal/../bst/bst.html">binary search tree</a> invariant. Is the BST invariant a properties for the search to guarantee, or a precondition for its correctness? Of course, the status of a given property can shift depending on our perspective: if we're modeling the algorithm to <em>add</em> to the binary search tree, preserving the invariant is now very important.</p>
<div id="admonition-other-precondition-examples" class="admonition admonish-note">
<div class="admonition-title">
<p>Other precondition examples</p>
<p><a class="admonition-anchor-link" href="chapters/temporal/fixing_lock_temporal.html#admonition-other-precondition-examples"></a></p>
</div>
<div>
<p>Is Dijkstra's algorithm always correct, on any weighted directed graph? Is RSA encryption absolutely secure, no matter how powerful or how lucky the adversary is?</p>
</div>
</div>
<h3 id="expressing-fairness"><a class="header" href="#expressing-fairness">Expressing Fairness</a></h3>
<p>There are many ways to phrasing fairness, and since we're making it an assumption about the world outside our algorithm, we'd really like to pick something that suffices for our needs, but <em>isn't any stronger than that.</em> Once we add the <code>weakFairness</code> predicate below as an assumption, the properties pass. </p>
<pre><code class="language-alloy">pred weakFairness {
    all p: Process | {
        (eventually always 
                (enabledRaise[p] or
                enabledEnter[p] or
                enabledLeave[p] or
                enabledNoYou[p])) 
        =&gt; 
        (always eventually (enter[p] or raise[p] or leave[p] or noYou[p]))        
    }
}
</code></pre>
<p>This may initially look a little strange. It still looks rather strange to me, years after learning it. It just happens that there are multiple ways to express fairness. Hillel Wayne has a <a href="https://www.hillelwayne.com/post/fairness/">great blog post</a> on the differences between them. (Unfortunately it's in a different modeling language, but the ideas come across well.) Regardless, &quot;weak&quot; fairness is sufficient for our needs! It says that if a process remains ready to move forward forever (possibly via a different transition per state), it must be allowed to proceed infinitely often.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="modeling-raft"><a class="header" href="#modeling-raft">Modeling Raft</a></h1>
<p>This case study is going to be personal. That is, I'll be modeling a protocol from scratch in the honest desire to understand it better. I'll be making false starts or modeling mistakes, and leaving all of that in as part of the story. I'll talk through recovering from my own mistakes, and in the end hopefully both understand this protocol better myself <em>and</em> show you how you might approach modeling a larger system in Forge. </p>
<div id="admonition-instance-images" class="admonition admonish-note">
<div class="admonition-title">
<p>Instance images</p>
<p><a class="admonition-anchor-link" href="chapters/raft/raft.html#admonition-instance-images"></a></p>
</div>
<div>
<p>I won't always include screenshots of the instances I see when I'm debugging. However, when I don't I'll try to explain what I see in them.</p>
</div>
</div>
<p>In this section, we'll be modeling <a href="https://raft.github.io">Raft</a> in <strong>Temporal Forge</strong>. This isn't a distributed-systems textbook, so if you're curious about more details than I cover here, you should check out the Raft Github, some of the <a href="https://raft.github.io/#implementations">implementations</a> (including <a href="https://github.com/etcd-io/raft">the one powering etcd</a>), or the original 2014 <a href="https://raft.github.io/raft.pdf">Raft paper</a> by Ongaro and Ousterhout.</p>
<h3 id="structure"><a class="header" href="#structure">Structure</a></h3>
<p>You can follow along with livecode in these files:</p>
<ul>
<li>A first, abstract model of leader election: <a href="chapters/raft/./raft_1.frg"><code>raft_1.frg</code></a>;</li>
<li>A basic model of messages: <a href="chapters/raft/./messages.frg"><code>messages.frg</code></a>;</li>
<li>Definitions of four RPC messages (two requests, two responses): <a href="chapters/raft/./rpc.frg"><code>rpc.frg</code></a>;</li>
<li>A second, message-passing version of our leader election model: <a href="chapters/raft/./raft_2.frg"><code>raft_2.frg</code></a>.</li>
</ul>
<p><strong>TODO: add more as more files are created.</strong></p>
<h2 id="what-is-raft"><a class="header" href="#what-is-raft">What is Raft?</a></h2>
<p>Suppose you're storing multiple copies of the same data on different servers around the world. You'd really like to make sure that the data stored on each replica server is <em>actually the same</em> data, i.e., that your replicas aren't gradually slipping out of agreement with one another. This is called <em>distributed consensus</em>. Raft is a protocol for achieving distributed consensus without anything like a shared clock or a trusted third party. </p>
<p>Raft claims to be an &quot;understandable&quot; consensus protocol, or at least more understandable than the original, brilliant but famously difficult to understand <a href="https://en.wikipedia.org/wiki/Paxos_(computer_science)">Paxos protocol</a>. Since I don't understand Paxos either, I'm hoping that Raft lives up to that intention. </p>
<div id="admonition-full-disclosure" class="admonition admonish-note">
<div class="admonition-title">
<p>Full Disclosure</p>
<p><a class="admonition-anchor-link" href="chapters/raft/raft.html#admonition-full-disclosure"></a></p>
</div>
<div>
<p>I <em>have</em> seen a couple of lectures on Raft, one of which was delivered by the excellent <a href="https://www.dougwoos.com">Doug Woos</a>. Unfortunately, as with all such things, I've since forgotten almost everything I thought I'd learned. But I do have some pre-existing intuition, in my subconscious if nowhere else. </p>
<p>Also, there does exist a formal model of Raft already, written in the TLA+ modeling language. I am deliberately <em>NOT</em> going to go looking at that model unless I really need to. Why not? Well, because Forge and TLA+ have somewhat different abstractions. But more importantly, I don't want bias how I think about Raft, especially early on. Reading others' formal models is useful, and if I were implementing Raft, I'd be referring to their model regularly. But I want to write my own, and understand the protocol better because of it.</p>
</div>
</div>
<h2 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h2>
<p>In a smaller system, we'd start by figuring out datatypes and writing examples. Here, though, there are many moving parts, and we can expect to iterate a few times on each, starting with a fairly abstract version. So we'll begin at a higher level, one that is more about sketching what's important than running Forge to get &quot;results&quot;. </p>
<p>What pieces does Raft have, or at least which pieces does it have that we expect we'll want to model? </p>
<ul>
<li>Raft has a <strong>leader election process</strong>, wherein nodes that stop hearing from the current leader might be voted new leader by their peers. It's likely we'll need to model this election process, or at least some abstraction of leader replacement. (The time in which a specific node is the continuous leader is called a <em>term</em>.)</li>
<li>Raft is based on a sequence of <strong>log entries</strong>, each of which describes a transaction which changes the underlying state. (This is where the name comes from: a raft is a sequence of logs.) We might not need to model the state itself, but we'll surely need to model log entries in order to detect whether they are being faithfully committed in the right order. </li>
<li>Raft runs on a network, and networks are imperfect. So some model of <strong>message passing</strong> seems reasonable. There are a few standard messages that Raft uses: update requests, vote requests, &quot;heartbeat&quot; messages from the leader, and so on. </li>
</ul>
<p>Now we should ask ourselves what we hope to get out of the model, because that will inform how we approach the above. Yes, I said my goal was the &quot;understand Raft&quot; but that's a little vague, isn't it? So let's ask a different question. What would it mean for Raft to &quot;work&quot;? Figure 3 of <a href="https://raft.github.io/raft.pdf">the Raft paper</a> enumerates these, and I'll quote each verbatim here with my comments below each: </p>
<ul>
<li><strong>Election Safety</strong>: at most one leader can be elected in a given term. 
<ul>
<li>This seems simple enough to check. We'll just have a notion of roles for every node, and make sure that the leader role is always either empty or singleton.</li>
</ul>
</li>
<li><strong>Leader Append-Only</strong>: a leader never overwrites or deletes entries in its log; it only appends new entries. 
<ul>
<li>This seems subtle to guarantee, since (it seems to me at first anyway!) network faults could cause a new leader to have bugs in its log that need resolving. But perhaps the election protocol is meant to prevent that. Anyway, this sounds like a place we can apply invariant-checking techniques we already know.</li>
</ul>
</li>
<li><strong>Log Matching</strong>: if two logs contain an entry with the same index and term, then the logs are identical in all entries up through the given index. 
<ul>
<li>Ok, this seems to be saying that if two nodes think the same transaction appears in the same place under the same &quot;reign&quot;, they can't disagree on anything beforehand. At first glance this seems like another inductive property, or at least a safety property we can check with Forge. But if we want to phrase the property identically to the paper, we'll want to model logs as indexed sequences (like arrays), not chains (like linked lists).</li>
</ul>
</li>
<li><strong>Leader Completeness</strong>: if a log entry is committed in a given term, then that entry will be present in the logs of the leaders for all higher-numbered terms.
<ul>
<li>So there's some guarantee that the commitments of prior administrations will be respected by later leaders. Makes sense. Sounds like this is something else that the election protocol needs to guarantee; I'm getting a feeling that modeling leader election will be <em>essential</em>. Maybe we'll start there. </li>
</ul>
</li>
<li><strong>State Machine Safety</strong>: if a server has applied a log entry at a given index to its state machine, no other server will ever apply a different log entry for the same index. 
<ul>
<li>Like the previous property, this also sounds like it's about the distinction between the log and <em>committing</em> entries in the log. We'll need some way to distinguish the two ideas eventually, although I'm not sure if we'll need to model the state machine fully. Let's wait to make that decision, and explore the protocol elsewhere first. </li>
</ul>
</li>
</ul>
<div id="admonition-are-these-the-right-properties-we-wont-care-right-now" class="admonition admonish-warning">
<div class="admonition-title">
<p>Are these the right properties? We won't care right now.</p>
<p><a class="admonition-anchor-link" href="chapters/raft/raft.html#admonition-are-these-the-right-properties-we-wont-care-right-now"></a></p>
</div>
<div>
<p>In a different setting, I'd ask you to consider whether these properties are the right ones. Although it's still a good idea to spend a minute considering that, I won't belabor the point here. Our goal is to understand the protocol, not critique it—at least not yet! So these are the properties we'll run with.</p>
</div>
</div>
<h2 id="leader-election-abstractly"><a class="header" href="#leader-election-abstractly">Leader Election, Abstractly</a></h2>
<p>Notice how thinking a little bit about the pieces of the system and the properties led to some idea of what's most important. The leader election seems vital to almost everything, and it's part of the protocol (as opposed to message passing, which may be vital but isn't about the protocol itself, but the network it runs on). So let's begin there. </p>
<h3 id="number-of-servers"><a class="header" href="#number-of-servers">Number of Servers</a></h3>
<p>In Raft, every node knows how many total servers there are in the cluster. This is part of the configuration before startup, so we will assume that every server has, and agrees on, the correct cluster size. We won't create a field for this anywhere, we'll just feel free to use <code>#Server</code>—and make sure we don't allow the set of servers to vary! </p>
<h3 id="roles"><a class="header" href="#roles">Roles</a></h3>
<p>A server can have one of three different roles. These are called &quot;states&quot; in the paper, but I find that a confusing term given just how many kinds of state there are here:</p>
<pre><code class="language-forge">#lang forge/temporal 

abstract sig Role {}
one sig Follower, Candidate, Leader extends Role {}
</code></pre>
<p>Every <code>Server</code> has exactly one role at any time. All servers begin as <code>Follower</code>s at startup. We'll express these facts as a <code>sig</code> definition and an initial-state <code>pred</code>, and add to both as we continue.</p>
<pre><code class="language-forge">sig Server {
    var role: one Role
}
/** The initial startup state for the cluster */
pred init {
    all s: Server | { 
        s.role = Follower
    } 
}
</code></pre>
<h3 id="leader-election"><a class="header" href="#leader-election">Leader Election</a></h3>
<p>If a <code>Follower</code> hasn't heard from the leader recently (either via a state-update message or a heartbeat message), it will become a <code>Candidate</code>. In an actual implementation, &quot;recently&quot; would be concretely defined by a timeout value, but we'll try to avoid that here. The paper says: </p>
<blockquote>
<p>To begin an election, a follower increments its current term and transitions to candidate state. It then votes for itself and issues RequestVote RPCs in parallel to each of the other servers in the cluster. A candidate continues in this state until one of three things happens: (a) it wins the election, (b) another server establishes itself as leader, or (c) a period of time goes by with no winner. </p>
</blockquote>
<p>And from Section 5.4.1,</p>
<blockquote>
<p>the voter denies its vote if its own log is more up-to-date than that of the candidate.</p>
</blockquote>
<p>So we'll need to keep track of a server's current vote and enable it to send requests for votes. We'll also need to recognize the end of the election in these three different ways—we might start with just a single transition that incorporates all three, and expand it only if we need to. We'll omit modeling logs for the moment, but leave in a note so we don't forget. </p>
<div id="admonition-be-guided-by-the-writeup" class="admonition admonish-tip">
<div class="admonition-title">
<p>Be guided by the writeup!</p>
<p><a class="admonition-anchor-link" href="chapters/raft/raft.html#admonition-be-guided-by-the-writeup"></a></p>
</div>
<div>
<p>I'll be guided by Figure 2 in the Raft paper, which gives field names and initial values for variables. E.g., it says that every server has a <code>votedFor</code> variable which starts out <code>null</code>.</p>
</div>
</div>
<pre><code class="language-forge">sig Server {
    var role: one Role,
    var votedFor: lone Server, -- NEW
    var currentTerm: one Int -- NEW
}
/** The initial startup state for the cluster */
pred init {
    all s: Server | { 
        s.role = Follower
        no s.votedFor -- NEW
        s.currentTerm = 0 -- NEW
    } 
}
</code></pre>
<p>Now let's create some abstract transitions.</p>
<h4 id="starting-an-election"><a class="header" href="#starting-an-election">Starting an Election</a></h4>
<p>A <code>Follower</code> runs for leader if it hasn't heard from <code>Leader</code> node in some time. We haven't yet modeled message passing, and we really hope not to have to model time. But we can at least require the server be a <code>Follower</code> when it begins. </p>
<pre><code class="language-forge">/** Server `s` runs for election. */
pred startElection[s: Server] {
    s.role = Follower -- GUARD 
    s.role' = Candidate -- ACTION: in candidate role now
    s.votedFor' = s -- ACTION: votes for itself 
    s.currentTerm' = add[s.currentTerm, 1] -- ACTION: increments term
    -- ACTION: issues RequestVote calls
    -- ... we can't model this yet: no message passing
    
    -- FRAME: role, currentTerm, votedFor for all other servers
    all other: Server - s | {
        other.votedFor' = other.votedFor
        other.currentTerm' = other.currentTerm
        other.role' = other.role
    }
}```

Ok, so should we immediately rush off to model message passing? I don't think so, we'd like to focus on the essence of leader election. So, instead, we'll have a transition that represents another server receiving that voting request, but guard it differently:

```forge
/** A server can vote for another server on request, 
    &quot;on a first-come-first-served basis&quot;. */
pred makeVote[voter: Server, c: Server] {
    no voter.votedFor -- GUARD: has not yet voted
    c.role = Candidate -- GUARD: election is running 
    noLessUpToDateThan[c, voter] -- GUARD: candidate is no less updated

    voter.votedFor' = c -- ACTION: vote for c
    -- FRAME role, currentTerm for voter
    -- FRAME: role, currentTerm, votedFor for all others
    all s: Server | {
        s.role' = s.role
        s.currentTerm' = s.currentTerm
        (s != voter) =&gt; (s.votedFor' = s.votedFor)
    }
}

/** Does the first server have a log that is no less up-to-date than
    the second server? 
*/
pred noLessUpToDateThan[moreOrSame: Server, baseline: Server] { 
    -- true (for now)
    -- TODO: once we model logs, the paper describes this relation as:
    --   the log with the later term is more up-to-date.
    --   if the logs end with the same term, then the longer log is more up-to-date.
}
</code></pre>
<div id="admonition-leaders-shouldnt-be-able-to-vote" class="admonition admonish-warning">
<div class="admonition-title">
<p>Leaders shouldn't be able to vote.</p>
<p><a class="admonition-anchor-link" href="chapters/raft/raft.html#admonition-leaders-shouldnt-be-able-to-vote"></a></p>
</div>
<div>
<p>Oops. I forgot a guard constraint that seems important: I'll just add: <code>voter in Follower + Candidate</code> in order to allow the vote to occur only if the voter is not a <code>Leader</code> already.</p>
</div>
</div>
<h4 id="ending-an-election"><a class="header" href="#ending-an-election">Ending an Election</a></h4>
<blockquote>
<p>A candidate wins an election if it receives votes from a majority of the servers in the full cluster for the same term. </p>
</blockquote>
<blockquote>
<p>Once a candidate wins an election, it becomes leader. It then sends heartbeat messages to all of the other servers to establish its authority and prevent new elections.</p>
</blockquote>
<pre><code class="language-forge">/** Server `s` is supported by a majority of the cluster.*/
pred majorityVotes[s: Server] {
    #{voter: Server | voter.votedFor = s} &gt; divide[#Server, 2]
}
/** Server `s` wins the election. */
pred winElection[s: Server] {
    -- GUARD: won the majority
    majorityVotes[s]
    -- ACTION: become leader, send heartbeat messages
    s.role' = Leader 
    s.currentTerm' = s.currentTerm
    no s.votedFor' 

    -- TODO: heartbeats
    -- For now, we'll just advance their terms and cancel votes
    -- directly as a FRAME, rather than using the network
    all f: Server - s | {
        f.role' = Follower
        no f.votedFor'
        f.currentTerm' = add[f.currentTerm, 1] 
    }
}
</code></pre>
<blockquote>
<p>if many followers become candidates at the same time, votes could be split so that no candidate obtains a majority. When this happens, each candidate will time out and start a new election by incrementing its term and initiating another round of RequestVote RPCs.</p>
</blockquote>
<div id="admonition-random-timeouts" class="admonition admonish-warning">
<div class="admonition-title">
<p>Random timeouts</p>
<p><a class="admonition-anchor-link" href="chapters/raft/raft.html#admonition-random-timeouts"></a></p>
</div>
<div>
<p>Raft uses random timeouts to reduce the chances of a failed election. If elections fail over and over again, the cluster is stalled. We won't model this, but may have to add some assumptions later on.</p>
</div>
</div>
<pre><code class="language-forge">/** Nobody has won the election after some time. */
pred haltElection {
    -- GUARD: there is some Candidate -- i.e., there is an election running
    some s: Server | s.role = Candidate
    -- GUARD: no server with the Candidate role has received a majority vote.
    --   (There is no requirement that everyone has voted; indeed, that wouldn't 
    --    work since the network might be broken, etc.)
    no s: Server | s.role = Candidate and majorityVotes[s]
    
    -- ACTION: each Candidate (not each server, necessarily) will increment their term
    --    and clear their vote.
    all c: Server | { 
        c.role = Candidate =&gt; c.currentTerm' = add[c.currentTerm, 1]
                         else c.currentTerm' = c.currentTerm
        no c.votedFor'
    }
    -- ACTION: initiating another round of RequestVote
    -- ... we can't model this yet: no message passing

    -- FRAME: nobody's role changes
    all c: Server | c.role' = c.role
}
</code></pre>
<p>Whew! That's a lot of constraints without ever running the model. We should do that next. </p>
<h4 id="running-the-model"><a class="header" href="#running-the-model">Running the Model</a></h4>
<p>First, let's check in. What have we even accomplished? </p>
<ul>
<li>We've forced ourselves to enumerate the sentences from the paper &quot;in our own words&quot; (and better, in less ambiguous language); </li>
<li>We've probably prompted ourselves to ask questions that we wouldn't just from reading the paper. For example, when I went through the predicates above, I had originally read the paper as saying &quot;each server will time out and start a new election&quot;, not &quot;each <em>candidate</em>&quot;. Writing it down made me notice my misunderstanding. </li>
<li>We've made a start at our formal model, and we can even run it. That we haven't modeled the &quot;whole protocol&quot; is not a concern at this point. We make incremental progress, which is the only way to make progress on a large model. </li>
</ul>
<p>Because this is only one part of the overall model we want to build, we'll allow unguarded no-op transitions in our trace predicate. This will make it easier to spot some classes of bugs, and (soon) help compose different modules as we write them.</p>
<pre><code class="language-forge">/** Guardless no-op */
pred election_doNothing {
    -- ACTION: no change
    role' = role
    votedFor' = votedFor
    currentTerm' = currentTerm
}

/** Allow arbitrary no-op (&quot;stutter&quot;) transitions, a la TLA+. We'll either 
    assert fairness, or use some other means to avoid useless traces. */ 
pred electionSystemTrace {
    init 
    always { 
        (some s: Server | startElection[s])
        or
        (some s, c: Server | makeVote[s, c])
        or 
        (some s: Server | winElection[s])
        or
        (haltElection)
        or 
        (election_doNothing)
    }
}

run { 
    electionSystemTrace 
    eventually {some s: Server | winElection[s]}
    #Server &gt; 1
}
</code></pre>
<p>Let's see what we get. The minimap shows a lasso trace of 4 states:</p>
<center>
<img alt="4 states in sequence, with a self-loop on the final state" src="chapters/raft/./img/model1/minimap.png" width=40%/>
</center>
<p>Here's what we see in the default visualization:</p>
<table>
<tr>
  <td>State0</td>
  <td>The initial state: both servers are followers with current term 0.</td>
  <td><img alt="Both followers, term 0" src="chapters/raft/./img/model1/state0.png" width=60%/></td>
</tr>
<tr>
  <td>State1</td>
  <td>One server initiates an election, voting for themselves and advancing their term.</td>
  <td><img alt="One candidate with term 1, one follower with term 0" src="chapters/raft/./img/model1/state1.png" width=60%/></td>
</tr>
<tr>
  <td>State2</td>
  <td>The other server votes for the candidate.</td>
  <td><img alt="The follower votes for the candidate" src="chapters/raft/./img/model1/state2.png" width=60%/></td>
</tr>
<tr>
  <td>State3</td>
  <td>The candidate wins the election, and is now cluster leader. Both servers now agree on the term.</td>
  <td><img alt="The candidate wins the election" src="chapters/raft/./img/model1/state3.png" width=60%/></td>
</tr>
</table>
<p>This looks more or less like what we'd expect. Let's finish this stage of the model by doing a little validation. We'll try to validate in a way that will still be useful after we add more features to the model. </p>
<h4 id="validation-1"><a class="header" href="#validation-1">Validation</a></h4>
<p>What's important here? Well, there's the set of standard transition-system properties we'd like to check. E.g., </p>
<ul>
<li>All of these transitions (except the no-op) should be mututally exclusive. </li>
<li>It should be possible to execute all the transitions.
But we also have some domain-specific properties:</li>
<li>No server should ever transition directly from <code>Leader</code> to <code>Candidate</code>. </li>
<li>It should be possible to witness two elections in a row.</li>
<li>It should be possible for two different servers to win elections in the same trace. </li>
<li>It should be invariant that there is only ever at most one <code>Leader</code>. </li>
</ul>
<p>We could go on, but let's stop with these, since we're still working at a fairly high level. </p>
<h5 id="problem-prefix-unsatisfiable"><a class="header" href="#problem-prefix-unsatisfiable">Problem: Prefix Unsatisfiable</a></h5>
<p>I wrote a test like this: </p>
<pre><code class="language-forge">sat_start_make_win: {
    (some s: Server | startElection[s])
    next_state (some s1, s2: Server | makeVote[s1, s2])
    next_state next_state (some s: Server | winElection[s])
  } is sat 
</code></pre>
<p>This is a useful pattern because it only requires a <em>prefix</em>. So if it's unsatisfiable (and it is, oops!) we can comment out the transitions in reverse order to easily discover where the problem lies. At the moment, I need to comment out <em>both</em> the <code>makeVote</code> and <code>winElection</code> transitions to make this satisfiable, which means there's probably some sort of issue with <code>makeVote</code>. </p>
<div id="admonition-initial-state" class="admonition admonish-note">
<div class="admonition-title">
<p>Initial-state</p>
<p><a class="admonition-anchor-link" href="chapters/raft/raft.html#admonition-initial-state"></a></p>
</div>
<div>
<p>I've left out the <code>init</code> predicate from the above test, although once we fix the issue we should add it back in. This way we've learned about the problem without <code>init</code> being involved at all.</p>
</div>
</div>
<p>In these situations, I like to try unsat cores. If the core is small, we might learn something quickly. </p>
<pre><code class="language-forge">option solver MiniSatProver
option logtranslation 1
option coregranularity 1
option core_minimization rce
</code></pre>
<p>The core I get only highlights one line, which would seem to indicate that the <code>makeVote</code> transition just can't fire from the second state:</p>
<pre><code class="language-forge">next_state (some s1, s2: Server | makeVote[s1, s2])
</code></pre>
<p>Let's see if it can <em>ever</em> fire:</p>
<pre><code class="language-forge">eventually (some s1, s2: Server | makeVote[s1, s2])
</code></pre>
<p>Indeed, this is unsatisfiable by itself. So what's wrong with <code>makeVote</code>? Notice that there's no constraint at all on what happened <em>before</em> the transition in this <code>run</code>; whatever is wrong has a very strong effect. Let's first check whether the guard of <code>makeVote</code> can be satisfied:</p>
<pre><code class="language-forge">    some voter, c: Server | {
      no voter.votedFor -- GUARD: has not yet voted
      voter in Follower -- GUARD: avoid Leaders voting
      c.role = Candidate -- GUARD: election is running 
      noLessUpToDateThan[c, voter] -- GUARD: candidate is no less updated
    }
</code></pre>
<p>Still unsatisfiable! What in the world is wrong? I increase the core granularity and translation log settings from <code>1</code> to <code>2</code>; this is expensive, and sometimes leads to confusing output, but can give a finer-grained core. Now Forge blames two things:</p>
<ul>
<li>the fact that <code>voter</code> is a <code>Server</code>; and </li>
<li><code>voter in Follower + Candidate</code>.</li>
</ul>
<p>At this point, it's clear what the problem is. I made a terrible typo in my model. <code>Follower</code> and <code>Candidate</code> are<code>Role</code>s, and so <code>voter</code> can never be in them; I should have written <code>voter.role in Follower + Candidate</code> instead. </p>
<div id="admonition-error" class="admonition admonish-warning">
<div class="admonition-title">
<p>Error?</p>
<p><a class="admonition-anchor-link" href="chapters/raft/raft.html#admonition-error"></a></p>
</div>
<div>
<p>I worked on this model during the summer of 2024, during which I was also cleaning up Forge's error-handling code. So I was both annoyed and pleased to encounter this problem—this should have given me an error, telling me that <code>voter</code> and <code>Follower+Candidate</code> were necessarily disjoint!</p>
<p>Even if this specific issue doesn't happen to you, I'm leaving the debugging process in. Hopefully it's useful.</p>
</div>
</div>
<p>I'll remove the unsat-core options now, since they reduce performance.</p>
<h5 id="another-problem-only-one-election"><a class="header" href="#another-problem-only-one-election">Another Problem: Only One Election</a></h5>
<p>Our test for &quot;It should be possible to witness two elections in a row.&quot; has failed. In retrospect, this isn't surprising: there is no transition that models a <code>Leader</code> <em>stopping</em> its leadership. I neglected to add a transition for this sentence in the paper: </p>
<blockquote>
<p>If a candidate or leader discovers that its term is out of date, it immediately reverts to follower state. </p>
</blockquote>
<p>We'll add that now as a <code>stepDown</code> transition, and add it to the overall trace predicate: </p>
<pre><code class="language-forge">/** If a candidate or leader discovers that its term is out of date, it immediately reverts to follower state. 
    If the leader’s term (included in its RPC) is at least as large as the candidate’s current term, then the 
    candidate recognizes the leader as legitimate and returns to follower state. 
*/
pred stepDown[s: Server] {
    -- Two guard cases
    {
        -- GUARD: is leader, someone has a higher term (abstracted out message)
        s.role in Leader
        and
        (some s2: Server-s | s2.currentTerm &gt; s.currentTerm)
    } or {
        -- GUARD: is candidate, someone claims to be leader and has term no smaller
        s.role in Candidate 
        and 
        (some s2: Server-s | s2.role = Leader and s2.currentTerm &gt;= s.currentTerm)
    }

    -- ACTION: step down
    s.role' = Follower
    
    -- FRAME: all others equal; s same currentTerm and votedfor.
    all x: Server | {
        x.currentTerm' = x.currentTerm
        x.votedFor' = x.votedFor 
        (x != s) =&gt; x.role' = x.role
    }
}
</code></pre>
<p>Unfortunately, there are two problems still:</p>
<ul>
<li>Adding this transition isn't enough. It can't actually fire, because we have no way for a higher term number to be seen. Even though we abstracted out the network and just let the servers see each others' terms directly, there is not yet anything that might cause one server's term to exceed another's. This tells me that maybe it's almost time to actually model the network, or add some other component we're currently missing. </li>
<li>What I said above wasn't actually clear, was it? We still have the <code>startElection</code> transition, which (at the moment) allows any <code>Follower</code> to become a candidate, and then servers can vote for them. If they win, they'd become <code>Leader</code>. So why can't we see this? </li>
</ul>
<p>Let's resolve the second issue first. We'll use a telescoping prefix run to debug this. At first, we'll just add one more transition to our existing test. Can we even <em>start</em> a second election?</p>
<pre><code class="language-forge">  -- Start -&gt; Vote -&gt; Win -&gt; Start
  run {
    (some s: Server | startElection[s])
    next_state (some s1, s2: Server | makeVote[s1, s2])
    next_state next_state (some s: Server | winElection[s])
    next_state next_state next_state (some s: Server | startElection[s])
  } 
</code></pre>
<p>Yes! Ok, good. Let's add the next step: we should be able to see someone vote for that server. So we can reference the second <code>Candidate</code>, we'll combine the two transitions like this:</p>
<pre><code class="language-forge">    next_state next_state next_state { some s: Server | {
        startElection[s]
        next_state (some s2: Server | makeVote[s2, s])
    }}
</code></pre>
<p>This is now unsatisfiable. So the problem may be in that second vote being made. Let's back up to what we had before and run it, then check what the final state can look like, after the second election begins. If we're <em>looking at</em> a trace prefix, we should add <code>init</code> to the beginning of the <code>run</code>, to make sure we don't get confused (unhelpfully!) by a garbage start state. </p>
<p>The first instance I see contains 2 <code>Server</code>s. We see that the original <code>Leader</code> still has that role, and the new contender has the <code>Candidate</code> role (as we would expect). But now nobody can vote at all, because the only non-<code>Leader</code> has already voted (for themselves). What about a <em>larger</em> instance? </p>
<ul>
<li>Adding <code>for exactly 4 Server</code> to the <code>run</code> leads to unsat. (Oh, no! We should consider why in a minute.)</li>
<li>Adding <code>for exactly 3 Server</code> to the <code>run</code> is satisfiable. (Whew.) Now there <em>is</em> a <code>Follower</code>, and we can see that their term has been cleared in the last state. So <em>why can't they vote</em>? Time to re-enable unsat cores. This time the core is bigger. I'll put what it blames inside a spoiler tag; read if you're curious. </li>
</ul>
<details>
<summary>Unsat core result</summary>
<ul>
<li><code>init</code></li>
<li>When <code>s</code> wins an election, <code>s.role' = Leader</code></li>
<li>Three lines in <code>makeVote</code>: 
<ul>
<li><code>no voter.votedFor</code>; </li>
<li><code>voter.votedFor' = c</code>; and </li>
<li><code>all s: Server | (s.role' = s.role and s.currentTerm' = s.currentTerm)</code> (Notice that this actually omits one of the constraints inside the <code>all</code>; this is one of the benefits of increasing the core granularity. However, there's a consequence: these kinds of &quot;partial&quot; quantified formulas don't always highlight well in VSCode. As a backup, you can always look at the console output to see a readout of the formulas in the core.)</li>
</ul>
</li>
<li>Three lines in <code>startElection</code>: 
<ul>
<li><code>s.role = Follower</code>;</li>
<li><code>s.role' = Candidate</code>; and </li>
<li>A piece of the <code>all</code>-quantified frame condition again, this time: <code>(all other : Server - s | other.votedFor' = other.votedFor &amp;&amp; other.currentTerm' = other.currentTerm)</code>.</li>
</ul>
</li>
<li>The uniqueness of roles, shown as a highlight on the field declaration: <code>var role: one Role</code>. </li>
</ul>
<p>Whew, that's more than we'd ideally have to look through! And it's incredibly confusing, because it still looks as if we ought to be able to take the <code>makeVote</code> transition with the 3rd <code>Server</code>. </p>
</details>
<p>The problem is simple, and the core doesn't really help us find it. <strong>We're still using the default trace length maximum: 5 states.</strong> Count how many I'm asking for: </p>
<ul>
<li>initial state; </li>
<li>election 1 has just started; </li>
<li>someone has voted; </li>
<li>someone has won the election; </li>
<li>election 2 has just started; and </li>
<li>someone has voted. 
This is too many states! We'll fix the problem by saying <code>option max_tracelength 10</code>. </li>
</ul>
<p>This fixes one problem, but I'm still curious why <code>for 4 Server</code> was unsatisfiable. It still is, even at the longer maximum trace length. So I start collapsing the trace: no 2nd vote, no 2nd election, ... In the end, this is where it becomes satisfiable: </p>
<pre><code class="language-forge">init
(some s: Server | startElection[s])
next_state (some s1, s2: Server | makeVote[s1, s2])
</code></pre>
<p>So in a 4-server cluster, nobody can actually win an election? That's silly. But actually it was me being silly. In order to win the election, a server needs a majority vote. If there are 4 servers, there need to be 3 votes for the new winner. But I only had one <code>makeVote</code> transition! If I make that fix to my <code>run</code>, all is well:</p>
<pre><code class="language-forge">run {
    init
    (some s: Server | startElection[s])
    next_state (some s1, s2: Server | makeVote[s1, s2])
    next_state next_state (some s1, s2: Server | makeVote[s1, s2])
    next_state next_state next_state (some s: Server | winElection[s])
  } for exactly 4 Server
</code></pre>
<p>Importantly, after all the above fixes, <em>the tests all pass</em>. I think we're now ready to do more modeling. Because network failures are so important for understanding Raft, I think we ought to model that. We just need to choose between a couple different perspectives. E.g., we could pick one of these:</p>
<ul>
<li>Network <em>messages</em>. We'd have a &quot;bag&quot; of messages in flight, which could be received. But they could also be dropped, replayed, etc. </li>
<li>Network <em>connectivity</em>. This would be a more abstract model, and perhaps more efficient. We wouldn't be able to represent specific RPC messages, but we'd be able to tell when one server could hear another. </li>
</ul>
<p>I'm going to go with the first option, because if I want to understand Raft, I probably need to understand the messages that servers send one another. </p>
<h2 id="messages-on-the-network"><a class="header" href="#messages-on-the-network">Messages on the Network</a></h2>
<p>I'll start with this very simple model: </p>
<pre><code class="language-forge">#lang forge/temporal 

/*
  A simple model of message passing. To the extent possible, this model should be 
  domain-inspecific; it can be imported and its predicates called from the transitions
  of other models. 

  NOT MODELED: message replay, message alteration in transit
*/

abstract sig Message {}
one sig Network {
    var messages: set Message 
}

/** When the system starts, there are no messages &quot;in flight&quot;. */
pred message_init { 
    no Network.messages
}

/** Add a message to the set of messages &quot;in flight&quot;. */ 
pred send[m: Message] {
    m not in Network.messages
    Network.messages' = Network.messages + m
}

/** A message can also be received if it's &quot;in flight&quot;. */
pred receive[m: Message] {
    m in Network.messages
    Network.messages' = Network.messages - m
}

/** A message might be dropped. On the surface, this is the same as `receive`. */
pred drop[m: Message] {
    m in Network.messages
    Network.messages' = Network.messages - m
}
</code></pre>
<p>We'll use the <code>drop</code> predicate to represent a large number of potential communication issues, all of which would prevent a server from seeing another's messages. </p>
<p>Let's remember to add <code>message_init</code> to the <code>init</code> predicate of our leader-election model.</p>
<h3 id="the-raft-rpc-messages"><a class="header" href="#the-raft-rpc-messages">The Raft RPC Messages</a></h3>
<p>But what should those messages look like? We'll define them in yet another module. This one is a bit long, but it's mostly comments taken almost verbatim from figure 2 of the Raft paper. </p>
<pre><code class="language-forge">#lang forge/temporal 

/*
    Modeling (a subset of) Raft's RPC messages.
*/

open &quot;messages.frg&quot;

abstract sig Role {}
one sig Follower, Candidate, Leader extends Role {}

sig Server {
    var role: one Role,
    var votedFor: lone Server, 
    var currentTerm: one Int 
}

/** Now we need a notion of intended sender and receiver. */
sig RaftMessage extends Message {
    from, to: one Server
}

/** Nothing here yet. */
sig Entry {}

/**
  From figure 2:
  Arguments: 
    term  (candidate’s term)
    candidateID (candidate requesting vote)
    lastLogIndex (index of candidate’s last log entry)
    lastLogTerm (index of candidate’s last log term)
  Results:
    term: currentTerm, for candidate to update itself
    voteGranted: true means candidate received vote

Receiver implementation:
  1. Reply false if term &lt; currentTerm (§5.1)
  2. If votedFor is null or candidateId, and candidate’s log is at
     least as up-to-date as receiver’s log, grant vote (§5.2, §5.4)
*/
sig RequestVote extends RaftMessage {
    requestTerm: one Int, 
    candidateID: one Server, 
    lastLogIndex: one Int,
    lastLogTerm: one Int
}
sig RequestVoteReply extends RaftMessage {
    replyTerm: one Int, 
    voteGranted: lone Server -- represent true boolean as non-empty
}

/**
  From figure 2:

  Arguments:
    term (leader’s term)
    leaderId (so follower can redirect clients)
    prevLogIndex (index of log entry immediately preceding new ones)
    prevLogTerm (term of prevLogIndex entry)
    entries[] (log entries to store (empty for heartbeat; may send more than one for efficiency))
    leaderCommit (leader’s commitIndex)
Results:
    term (currentTerm, for leader to update itself)
    success (true if follower contained entry matching prevLogIndex and prevLogTerm)

Receiver implementation:
  1. Reply false if term &lt; currentTerm (§5.1)
  2. Reply false if log doesn’t contain an entry at prevLogIndex
     whose term matches prevLogTerm (§5.3)
  3. If an existing entry conflicts with a new one (same index
     but different terms), delete the existing entry and all that
     follow it (§5.3)
  4. Append any new entries not already in the log
  5. If leaderCommit &gt; commitIndex, set commitIndex = min(leaderCommit, index of last new entry)
*/
sig AppendEntries extends RaftMessage {
    appendEntriesTerm: one Int, 
    leaderID: one Server, 
    prevLogIndex: one Int, 
    prevLogTerm: one Int, 
    entries: set Entry,
    leaderCommit: one Int
}
sig AppendEntriesReply extends RaftMessage {
    appendEntriesReplyTerm: one Int, 
    success: lone Server -- represent true boolean as non-empty
}

</code></pre>
<div id="admonition-notice-we-moved-server-and-role-we-added-entry" class="admonition admonish-warning">
<div class="admonition-title">
<p>Notice we moved <code>Server</code> and <code>Role</code>; we added <code>Entry</code></p>
<p><a class="admonition-anchor-link" href="chapters/raft/raft.html#admonition-notice-we-moved-server-and-role-we-added-entry"></a></p>
</div>
<div>
<p>Because I wanted the RPC model to refer to <code>Server</code>, I moved those basic definitions into the RPC model. The expanded leader-election model will import the RPC model. </p>
<p>I also added <code>Entry</code>, because it's needed for one of the messages. But it's just an empty <code>sig</code> for the moment, because we aren't modeling that yet.</p>
</div>
</div>
<h3 id="sending-and-receiving-messages"><a class="header" href="#sending-and-receiving-messages">Sending and Receiving Messages</a></h3>
<p>Ok, great. But now we need to actually use these messages in the leader-election model. Let's take stock. We have:</p>
<ul>
<li><code>RequestVote</code>: sent by a server when becoming a candidate; </li>
<li><code>RequestVoteReply</code>: sent by a server when asked for a vote;</li>
<li><code>AppendEntries</code>: sent by the leader to request a follower update, or as a &quot;heartbeat&quot; message; and</li>
<li><code>AppendEntriesReply</code>: sent by a follower in reply to an update request. 
The next step is to ask how these fit into our existing model of leader election. Here's one option, and where we'll start:</li>
<li><code>RequestVote</code> is sent to all other servers as part of the <code>startElection</code> transition.</li>
<li><code>RequestVoteReply</code> is sent as part of the <code>makeVote</code> action, but (as written) only if the vote is agreed to. We don't have a transition in place to represent this message being sent when the vote is rejected—we'll add one, but only if we need to. </li>
<li><code>AppendEntries</code> and <code>AppendEntriesReply</code> don't currently have transition representing them yet, either. They're either about actual data updates (which we haven't modeled) or preventing other servers from running for election. </li>
</ul>
<p>I think we should start with the two voting-related messages and then decide whether we need the data-update messages. </p>
<h3 id="adding-requestvote"><a class="header" href="#adding-requestvote">Adding <code>RequestVote</code></a></h3>
<p>We need to expand on <code>startElection</code> to have the candidate send <code>RequestVote</code> messages to all other servers. In principle, this should be easy if we set up the other files correctly. We even left ourselves a convenient note in the Forge file: <code>ACTION: issues RequestVote calls</code>. Since Forge doesn't have a notion of manufacturing a brand new <code>Message</code> atom, we'll use <code>some</code> to say that an unused <code>Message</code> just happens to exist, then constrain its fields. Finally, we'll invoke <code>send</code> on it to make sure it's added to the &quot;in flight&quot; set.</p>
<pre><code class="language-forge">/** Server `s` runs for election. */
pred startElection[s: Server] {
    s.role = Follower -- GUARD 
    s.role' = Candidate -- ACTION: in candidate role now
    s.votedFor' = s -- ACTION: votes for itself 
    s.currentTerm' = add[s.currentTerm, 1] -- ACTION: increments term
    
    -- ACTION: issues RequestVote calls (NEW)
    all other: Server - s | {
        some rv: RequestVote | {
            rv not in Network.messages -- not currently being used
            rv.from = s
            rv.to = other
            rv.requestVoteTerm = s.currentTerm
            rv.candidateID = s
            rv.lastLogIndex = -1 -- TODO: NOT MODELING YET
            rv.lastLogTerm = -1 -- TODO: NOT MODELING YET
            send[rv]
        }
    }
    
    -- FRAME: role, currentTerm, votedFor for all other servers
    all other: Server - s | {
        other.votedFor' = other.votedFor
        other.currentTerm' = other.currentTerm
        other.role' = other.role
    }
}
</code></pre>
<div id="admonition-im-a-little-worried-about-messages" class="admonition admonish-warning">
<div class="admonition-title">
<p>I'm a little worried about messages.</p>
<p><a class="admonition-anchor-link" href="chapters/raft/raft.html#admonition-im-a-little-worried-about-messages"></a></p>
</div>
<div>
<p>How many of these will we need? If every time a server becomes a candidate we use just less than <code>#Server</code> messages, I could see needing to give a very high scope, which would cause performance issues. If we hit that point, we will refactor the model—although I like the message-hierarchy style we've currently got. </p>
<p><em>If we <em>do</em> run into scope limitations, we might consider making message fields <code>var</code>, but enforcing they remain constant while the message is in transit. That would allow message atoms to be re-used.</em></p>
</div>
</div>
<p>We need to import both the messages and RPC modules to make this run. And all the tests still pass (although notice that we aren't testing the new predicates <em>at all</em> yet). We can even run the model and get instances which now show the state of the network. Of course, we don't yet <em>receive</em> anything. </p>
<div id="admonition-the-donothing-predicate" class="admonition admonish-note">
<div class="admonition-title">
<p>The <code>doNothing</code> predicate</p>
<p><a class="admonition-anchor-link" href="chapters/raft/raft.html#admonition-the-donothing-predicate"></a></p>
</div>
<div>
<p>Notice that the barely-constrained no-op predicate is doing more work for us. Without it, our model would have just become unsatisfiable, since we'd have no way to build the lasso-trace loopback: so far, we can only <em>add</em> messages, but never <em>remove</em> them. The <code>doNothing</code> option really does help when you're adding to a model.</p>
</div>
</div>
<h3 id="receiving-and-replying-to-requestvote"><a class="header" href="#receiving-and-replying-to-requestvote">Receiving and Replying to <code>RequestVote</code></a></h3>
<p>A <code>RequestVote</code> message ought to prompt votes, which in turn ought to produce a reply. It's tempting to not model replies, but I'd like to allow the &quot;network&quot; to break in such a way that the <code>Follower</code> believes they've voted but the <code>Candidate</code> is unaware of that fact. So we'll model both of them. </p>
<p>Receiving <code>RequestVote</code> should be as easy as sending. We'll modify the <code>makeVote</code> transition, remembering to ensure that the request term isn't smaller than the voter's current term. I also notice that the RPC specification says: &quot;If votedFor is null or candidateId, and candidate’s log is at least as up-to-date as receiver’s log, grant vote&quot;, which means I should change the first guard line to be more permissive than it was previously. Finally, we'll remove the old guard constraint that covered for the lack of messages; we now have messages, and no longer needed it. </p>
<pre><code class="language-forge">pred makeVote[voter: Server, c: Server] {
    -- GUARD: has not yet voted *OR* has voted for this candidate (CHANGED)
    (no voter.votedFor or voter.votedFor = c) 
    voter.role in Follower + Candidate -- GUARD: avoid Leaders voting
    -- Removed, now that we see an explicit message
    --c.role = Candidate -- GUARD: election is running (REMOVED)
    noLessUpToDateThan[c, voter] -- GUARD: candidate is no less updated

    -- ACTION/GUARD: must receive a RequestVote message (NEW)
    some rv: RequestVote | { 
        receive[rv] -- enforces message &quot;in flight&quot;
        rv.to = voter
        rv.from = c
        voter.currentTerm &lt;= rv.requestVoteTerm
    }

    voter.votedFor' = c -- ACTION: vote for c
    -- FRAME role, currentTerm for voter
    -- FRAME: role, currentTerm, votedFor for all others
    all s: Server | {
        s.role' = s.role
        s.currentTerm' = s.currentTerm
        (s != voter) =&gt; (s.votedFor' = s.votedFor)
    }
}
</code></pre>
<p>All tests still pass after this change, and we can <code>run</code> to see traces. Great! Now, what about replies? We can add a <code>send</code> for some new <code>RequestVoteReply</code>, but if we do that we should add some way for that message to be <code>receive</code>d. We'll add the message first as another new block in <code>makeVote</code>, although we need access to the request message, so I'll add this <em>within</em> the <code>rv</code> quantifier:</p>
<pre><code class="language-forge">    -- ACTION/GUARD: must send a RequestVoteReply message (NEW)
    some rvp: RequestVoteReply | { 
        send[rvp] -- enforces message not in flight
        rvp.to = c
        rvp.from = voter
        rvp.voteGranted = c -- stand-in for boolean true
        rvp.replyRequestVoteTerm = rv.requestVoteTerm
    }
</code></pre>
<p>But this makes some <code>is sat</code> tests fail. One reason might be that there are not enough <code>Message</code> atoms: we need one for <em>each</em> <code>RequestVote</code> message sent, and one for <em>each</em> <code>RequestVoteReply</code>. But the default of <code>4</code> should suffice if there are only 2 <code>Server</code> atoms: one request, one reply. So we expect something else. The &quot;telescoping prefix&quot; method shows that the problem is with <code>makeVote</code> (not surprising), and the corresponding core is:</p>
<ul>
<li>the line from <code>send</code> that adds the message to the &quot;in flight&quot; set; </li>
<li>the line from <code>receive</code> that removes the message from the &quot;in flight&quot; set; </li>
<li>the fact that <code>rv</code> is a <code>RequestVote</code> and must be in the &quot;in flight&quot; set when received. </li>
</ul>
<p>What's the problem? Both <code>send</code> and <code>receive</code> have an implicit frame condition. When I write <code>Network.messages' = Network.messages - m</code>, it means that no other changes to <code>Network.messages</code> are possible on this &quot;tick&quot;. So using <code>send</code> and <code>receive</code> in the same transition will, as written, be contradictory. Likewise, because requesting a vote happens for many servers at once, this bug would also cause problems if there were more than one <code>Follower</code>. </p>
<p>To fix this, I'll add a <code>sendAndReceive</code> pred to the messages module. It will take <em>sets</em> of messages, so that we can send and/or receive multiple messages at a time.</p>
<pre><code class="language-forge">/** We might need to send/receive multiple messages. Note that the way this is written, if there is any message
    in both the to_send and to_receive sets, it will remain &quot;in flight&quot;.  */
pred sendAndReceive[to_send: set Message, to_receive: set Message] {
    no to_send &amp; Network.messages
    to_receive in Network.messages
    Network.messages' = (Network.messages - to_receive) + to_send
}
</code></pre>
<p>Now we can edit the <code>startElection</code> and <code>makeVote</code> predicates to use this instead of just <code>send</code> and <code>receive</code>. The first is a bit challenging, because we need to build the <em>set</em> of messages and pass it all at once. But we also need to make sure the right message atoms actually exist. So we'll split this into two parts: existence and identity. </p>
<pre><code class="language-forge">-- ACTION: issues RequestVote calls (MODIFIED)
    // The set of unused messages exists
    all other: Server - s | { some rv: RequestVote | { rvFor[s, other, rv] } }
    // They are all actually sent, with nothing received
    sendAndReceive[{rv: RequestVote | some other: Server | rvFor[s, other, rv]}, 
                   none &amp; Message]
                   -- ^ Interestingly we need to do the intersection here, so the checker understands this empty set 
                   -- can't have type `Int`. 
</code></pre>
<p>What about <code>makeVote</code>? That's easier, because we have a <em>single</em> message to receive and a different, <em>single</em> message to send. We end up changing the message block we had before just a bit: </p>
<pre><code class="language-forge">    -- ACTION/GUARD: must receive a RequestVote message (NEW)
    -- ACTION/GUARD: must send a RequestVoteReply message (NEW)
    some rv: RequestVote, rvp: RequestVoteReply  | { 
        rv.to = voter
        rv.from = c
        voter.currentTerm &lt;= rv.requestVoteTerm     
        
        rvp.to = c
        rvp.from = voter
        rvp.voteGranted = c -- stand-in for boolean true
        rvp.replyRequestVoteTerm = rv.requestVoteTerm

        sendAndReceive[rvp, rv] -- enforces message &quot;unused&quot;/&quot;used&quot; respectively
    }
</code></pre>
<div id="admonition-framing-and-composition" class="admonition admonish-warning">
<div class="admonition-title">
<p>Framing and composition</p>
<p><a class="admonition-anchor-link" href="chapters/raft/raft.html#admonition-framing-and-composition"></a></p>
</div>
<div>
<p>As written, any transition that doesn't use one of the message predicates, or speak of <code>Network.messages</code> directly itself, will allow the message bag to change arbitrarily. E.g., our <code>winElection</code> transition doesn't yet refer to the network, and so that slice of the system's state is unconstrained on this transition. </p>
<p>For now, we'll go and add the following to every transition except the two we've already changed:</p>
<pre><code class="language-forge">    -- Frame the network state explicitly
    sendAndReceive[none &amp; Message, none &amp; Message]
</code></pre>
</div>
</div>
<h3 id="receiving-replies"><a class="header" href="#receiving-replies">Receiving Replies</a></h3>
<p>In order to actually receive these replies, we need a new transition. Or do we? We might choose to have the <code>RequestVoteReply</code> messages get received all at once, as part of stepping down or winning the election. This isn't exactly in accordance with reality, but we're using the message buffer as a stand-in for the record of how many votes each server receives over the course of the election. This consumes less of our <code>max_tracelength</code> than receiving them all one at a time and explicitly storing votes in a <code>Server</code> field. Let's give that idea try to start with. We'll just have <code>receiveMajorityVotes</code> examine and change the currently &quot;in flight&quot; messages.</p>
<pre><code class="language-forge">/** Server `s` is supported by a majority of the cluster. E.g., 
  |cluster| = 5 ---&gt; need 5/2 + 1 = 3 votes. */
pred receiveMajorityVotes[s: Server] {
    -- This formulation identifies the set of replies destined for this server, 
    -- and evaluates to true if they get removed from the message bag and there are 
    -- a sufficient number of them granting a vote.
    let voteReplies = {m: Network.messages &amp; RequestVoteReply | m.to = s} | {
        receive[voteReplies]
        #{m: voteReplies | some m.voteGranted} &gt; divide[#Server, 2]
    }
}
</code></pre>
<p>As always, we'll check that we can generate a pertinent prefix. Here's what I ran:</p>
<pre><code class="language-forge">run {
    init
    (some s: Server | startElection[s])
    next_state (some s1, s2: Server | makeVote[s1, s2])
    next_state next_state (some s1, s2: Server | makeVote[s1, s2])
    next_state next_state next_state (some s: Server | winElection[s])
} for exactly 3 Server, 10 Message
</code></pre>
<p>Unsatisfiable <em>again</em>! But this isn't unusual; often when we make a change there's some factor we forgot to account for. We'll follow the same recipe as before, removing constraints from the end of the prefix until we reach satisfiability. We don't have to do much, because only the last transition seems to cause a problem—unsurprising, since the conditions for winning are what we just changed. </p>
<p>The unsat core has only 3 formulas in it. Rather than just looking at code location, let's examine what the command-line output says. I'll add newlines to make it a bit more readable:</p>
<pre><code>Unsat core available (3 formulas):
Core(part 1/3): [/Users/tbn/repos/cs1710/newbook/book/src/chapters/raft/messages.frg:32:4 (span 40)] 
(Network.messages' = Network.messages - {m : Network.messages &amp; RequestVoteReply | m.to = s})
Core(part 2/3): [/Users/tbn/repos/cs1710/newbook/book/src/chapters/raft/raft_2.frg:124:8 (span 59)] 
(#{m : {m : Network.messages &amp; RequestVoteReply | m.to = s} | some m.voteGranted} &gt; divide[#Server, 2])
Core(part 3/3): [/Users/tbn/repos/cs1710/newbook/book/src/chapters/raft/messages.frg:47:4 (span 61)] 
(Network.messages' = Network.messages - none  &amp; Message + none  &amp; Message)
</code></pre>
<p>The command-line core output prints core formulas <em>after substitution</em>. So, for example, <code>(Network.messages' = Network.messages - none  &amp; Message + none  &amp; Message)</code> is the result of applying <code>sendAndReceive</code> (defined in <code>messages.frg</code>) to the arguments <code>none &amp; Message</code> and <code>none  &amp; Message</code>. But that's not surprising: the <code>winElection</code> predicate actually contains the frame condition <code>sendAndReceive[none &amp; Message, none &amp; Message]</code>. </p>
<p>No, what's far more suspicious is the apparent tangle between the frame condition and the first formula, which calls <code>receive</code>. This is how we've currently defined <code>receive</code>: </p>
<pre><code class="language-forge">pred receive[m: Message] {
    m in Network.messages
    Network.messages' = Network.messages - m
}
</code></pre>
<p>And there's the problem: that pesky <code>=</code>. If we call <code>receive</code> and <code>sendAndReceive</code> in the same transition, they will conflict with each other! So we need to be a bit more clever in how we write <code>winElection</code>. But it's annoying, because the call to <code>receive</code> is inside a helper predicate: <code>receiveMajorityVotes</code>. I don't want to inline the helper-predicate body, because that would clutter the transition predicate. </p>
<p>But, wait. Do we <em>really</em> need to re-frame the network state in this predicate? Probably not, since the only modification comes from <code>receiveMajorityVotes</code>. And that <em>already</em> frames the state of the network. So we'll remove this line entirely:</p>
<pre><code class="language-forge">sendAndReceive[none &amp; Message, none &amp; Message]
</code></pre>
<p>We don't need it at all! And now we're back to satisfiable, and we can view a run of the protocol. And <em>most</em> of our validation suite passes too, which is comforting. There's just one thing that fails: </p>
<ul>
<li>It should be possible for two different servers to win elections in the same trace. </li>
</ul>
<p>My first thought is that maybe we haven't given Forge enough states to witness this. But then I remembered that we were just making <em>winning</em> possible again. Is it ever possible for a leader to stop being a leader in our current model? We have a passing test that looks for such a pattern, or so I thought. Here it is as a predicate:</p>
<pre><code class="language-forge">pred two_elections_in_a_row {
  electionSystemTrace
  eventually {
    some s: Server | startElection[s] 
    next_state eventually (some s2: Server | startElection[s2])
  }
}
</code></pre>
<p>But this doesn't mean what it says. It's not <em>two different elections</em>. It's <em>two <code>startElection</code> actions</em>. This could be satisfied by two candidates running for leader in the same election cycle. So let's write a better test. As an experiment, let's write it in terms of server roles rather than transitions:</p>
<pre><code class="language-forge">pred two_elections_in_a_row {
  electionSystemTrace
  eventually {
    -- At time t, someone is a candidate
    some s: Server | s.role = Candidate
    eventually {
      -- At time t2, nobody is a candidate
      no s: Server | s.role = Candidate
      eventually {
        -- At time t3, someone (same or different) is a candidate again
        some s: Server | s.role = Candidate
      }
    }
  }
}
</code></pre>
<p>Let's try something simpler. Can a leader ever <em>stop</em> being a leader? </p>
<pre><code class="language-forge">leader_stops_leading: {
    electionSystemTrace 
    eventually {
      some s: Server | s.role = Leader 
      eventually { 
        no s: Server | s.role = Leader
      }
    }
  } is sat
</code></pre>
<p>Unsatisfiable. No. Wait—we know our <code>stepDown</code> transition can be satisfied, but maybe it's buggy. This generates a trace:</p>
<pre><code class="language-forge">(some s: Server | startElection[s])
next_state (some s1, s2: Server | makeVote[s1, s2])
next_state next_state (some s: Server | winElection[s])
next_state next_state next_state (some s: Server | startElection[s])
next_state next_state next_state next_state (some s: Server | stepDown[s])
</code></pre>
<p>This looks like what we expected. So where's the discrepancy between this and <code>leader_stops_leading</code>? </p>
<pre><code>&gt; electionSystemTrace
false
</code></pre>
<p>Uh oh. I forgot to assert that the trace starts in an initial state. Adding that makes the above unsatisfiable. But it also becomes unsatisfiable even without the <code>stepDown</code> transition. I go back to my basic tests, and realize I had forgotten to add <code>init</code> in several of them! After fixing this, one fails:</p>
<pre><code class="language-forge">-- Start -&gt; Vote -&gt; Win
  sat_start_make_win: {
    init
    (some s: Server | startElection[s])
    next_state (some s1, s2: Server | makeVote[s1, s2])
    next_state next_state (some s: Server | winElection[s])
  } for 6 Message is sat 
</code></pre>
<div id="admonition-yes-this-happens" class="admonition admonish-warning">
<div class="admonition-title">
<p>Yes, this happens!</p>
<p><a class="admonition-anchor-link" href="chapters/raft/raft.html#admonition-yes-this-happens"></a></p>
</div>
<div>
<p>Sometimes you'll be working on a model, and then realize you neglected something that might force changes throughout. You may have seen this happen when working on a program; it's the same here. I'm deliberately leaving this in rather than cleaning it up so you can see how I deal with the issue.</p>
</div>
</div>
<p>If I remove the win requirement, it passes. So something still isn't right with <code>winElection</code>; possibly with message passing. The unsat core makes me also think there might be a problem with numbers of messages, because it points to this line:</p>
<pre><code>Core(part 5/6): [/Users/tbn/repos/cs1710/newbook/book/src/chapters/raft/raft_2.frg:117:8 (span 59)] (#{m : {m : Network.messages &amp; RequestVoteReply | m.to = s} | some m.voteGranted} &gt; divide[#Server, 2])
</code></pre>
<p>The problem is that, before we added messages, we measured a majority vote by looking directly at everyone's <code>votedFor</code> field. The candidate votes for themself, <em>but doesn't send a vote reply</em>. So we need to look for <em>one less</em> reply message than we expect votes for the candidate:</p>
<pre><code class="language-forge">let voteReplies = {m: Network.messages &amp; RequestVoteReply | m.to = s} | {
    receive[voteReplies]
    #{m: voteReplies | some m.voteGranted} &gt; add[-1, divide[#Server, 2]]
}
</code></pre>
<p>Now we see an instance again. And, after we make one small change, all our tests pass once again (even after adding <code>init</code> where it was needed). (The small change is to require the winner of an election to actually be a <code>Candidate</code>; one of our tests was failing because a server could win without starting an election in a cluster of size <code>1</code>.) </p>
<h3 id="getting-our-bearings"><a class="header" href="#getting-our-bearings">Getting Our Bearings</a></h3>
<p>Where have we ended up? We have a model of leader election in Raft which has some notion of a network and the messages on it. We can see execution traces for single elections, or sequential elections. We'll add a quick test to make sure that it's possible for two servers to be candidates at the same time:</p>
<pre><code class="language-forge">  two_simultaneous_candidates: {
    electionSystemTrace
    some disj s1, s2: Server | eventually {
        s1.role = Candidate
        s2.role = Candidate
    }
  } is sat
</code></pre>
<p>This passes. We'll look at a couple more instances, but I think we're ready to add network <em>failure</em> to our model. After we do that, we'll be able to really see whether or not Raft <em>works</em> under &quot;real&quot; conditions—where messages may be lost, for example. </p>
<h2 id="modeling-network-failure"><a class="header" href="#modeling-network-failure">Modeling Network Failure</a></h2>
<div id="admonition-model-3" class="admonition admonish-note">
<div class="admonition-title">
<p>Model 3</p>
<p><a class="admonition-anchor-link" href="chapters/raft/raft.html#admonition-model-3"></a></p>
</div>
<div>
<p>At this point, I copied the entire model into a new file, so that it would be clear where we were <em>after</em> the above section. For myself, I could use a Git commit to find the model state, but I want to share these separately.</p>
</div>
</div>
<p>It would be nice to make the degree of network failure adjustable, so we can check how Raft does under certain conditions. So we'll break out the various kinds of network failure into their own predicates and then see if we can add them cleanly to our model as a new transition type. We'll want to model at least:</p>
<ul>
<li>messages being <em>dropped</em> by the network, rather than delivered; and </li>
<li>messages being <em>duplicated</em> by the network. </li>
</ul>
<p>We already wrote something for the message-drop case:</p>
<pre><code class="language-forge">/** A message might be dropped. On the surface, this is the same as `receive`. This is a single-change predicate: if used, it will
    preclude other message activity within a transition. */
pred drop[m: Message] {
    m in Network.messages
    Network.messages' = Network.messages - m
}
</code></pre>
<p>Let's write something similar for duplication. It starts out quite well, but then we encounter a problem:</p>
<pre><code class="language-forge">/** A message might be duplicated. This asserts that another Message atom exists (in flight), having 
    the same content as the other. */
pred duplicate[m1: Message] {
    m1 in Network.messages
    some m2: Network.messages - m1  | { 
        // *** THEY MUST BE THE SAME KIND OF MESSAGE, AND HAVE SAME FIELD VALUES ***
        Network.messages' = Network.messages + m2
    }
}
</code></pre>
<p>The problem is that here, in <code>messages.frg</code>, we have no information about the kinds of <code>Message</code> that will be defined. So we can't say that <code>m</code> is of the same type as <code>m2</code>, or that they have equal field values. To make this work, we'd either need Forge to support something vaguely like dynamic dispatch (perhaps via built-in helpers like <code>sameSig[x,y]</code> and <code>eqFields[x,y]</code>) or to move this predicate up into a file that has knowledge of message types: <code>rpc.frg</code>. Because I'm working with Forge today, not working <em>on</em> Forge, we'll go with the latter option.</p>
<pre><code class="language-forge">/** A message might be duplicated. This asserts that another Message atom exists (in flight), having 
    the same content as the other. */
pred duplicate_rv[m1: RequestVote] {
    m1 in Network.messages
    m1 in RequestVote
    some m2: Network.messages - m1 | { 
        // *** THEY MUST BE THE SAME KIND OF MESSAGE, AND HAVE SAME FIELD VALUES ***
        m2 in RequestVote
        m2.requestVoteTerm = m1.requestVoteTerm
        m2.candidateID = m1.candidateID
        m2.lastLogIndex = m1.lastLogIndex
        m2.lastLogTerm = m1.lastLogTerm
        
        Network.messages' = Network.messages + m2
    }
}
</code></pre>
<p>This isn't ideal. There's probably a better way to handle this <em>without</em> a lot of code duplication. But for now we'll press on. </p>
<div id="admonition-alloy" class="admonition admonish-warning">
<div class="admonition-title">
<p>Alloy</p>
<p><a class="admonition-anchor-link" href="chapters/raft/raft.html#admonition-alloy"></a></p>
</div>
<div>
<p>Note to self: Do I remember that Alloy has some undocumented reflection features? TODO: look into this.</p>
</div>
</div>
<p>Let's add the potential for the network to take an action to our main model, in <code>rpc.frg</code>:</p>
<pre><code class="language-forge">/** Helper to keep a server's state constant. Useful in composition. */
pred frame_server[s: Server] {
  s.role' = s.role
  s.votedFor' = s.votedFor
  s.currentTerm' = s.currentTerm
}

/** Transition predicate: the network performs some error behavior. */
pred network_error { 
  // One of the various flavors of error occurs
  (some m: Network.messages | drop[m])
  or 
  (some rv: RequestVote | duplicate_rv[rv])

  // Server state remains the same 
  all s: Server | frame_server[s]
}
</code></pre>
<p>We'll add <code>network_error</code> as one of the possibilities in our main transition predicate, too. We're getting quite a long list of possibilities:</p>
<pre><code class="language-forge">pred electionSystemTrace {
    init
    always { 
        (some s: Server | startElection[s])
        or
        (some s, c: Server | makeVote[s, c])
        or 
        (some s: Server | winElection[s])
        or 
        (some s: Server | stepDown[s])
        or
        (haltElection)
        or 
        (election_doNothing)
        or 
        (network_error)
    }
}
</code></pre>
<p>Having added this capability to the model, we should add tests to make sure the behavior can occur as we intended. To make this easier, I ended up refactoring some of the above. Most importantly, I changed from a per-type duplication predicate to a single <code>duplicate</code> predicate that refers to a helper <code>message_extensional_equality</code> that is true if and only if its two arguments are the same type and have the same field values. </p>
<div id="admonition-i-dont-like-this-solution" class="admonition admonish-warning">
<div class="admonition-title">
<p>I don't like this solution!</p>
<p><a class="admonition-anchor-link" href="chapters/raft/raft.html#admonition-i-dont-like-this-solution"></a></p>
</div>
<div>
<p>If I ever add a new message type, or even alter the fields of an existing type, I need to go back and edit <code>message_extensional_equality</code>.</p>
</div>
</div>
<pre><code class="language-forge">test expect {
  // Failure during an election
  sat_drop_during: {electionSystemTrace and eventually {
    (some c: Server | c.role = Candidate) and network_error}} is sat
  // Failure outside an election
  sat_drop_outside: {electionSystemTrace and eventually {
    (no c: Server | c.role = Candidate) and network_error}} is sat
  // Failure can involve dropping a message
  sat_failure_drop: {electionSystemTrace and eventually {
    network_error and Network.messages' in Network.messages}} is sat
  // Failure can involve duplicating a message
  sat_failure_dupe: {electionSystemTrace and eventually {
    network_error and Network.messages in Network.messages'}} is sat

  // A failure cannot occur if the network is empty (no messages to duplicate or drop)
  unsat_failure_empty: {electionSystemTrace and eventually { 
    network_error and no Network.messages
  }} is unsat

  // If there is one message in flight, a duplication followed by a drop will be idempotent
  prop_1_dupe_drop_idempotent: {
    electionSystemTrace 
    eventually {
      one Network.messages

      network_error // duplicate
      Network.messages in Network.messages'

      next_state network_error // drop
      Network.messages'' in Network.messages'

      // Seek counterexample to idempotence. Note that dropping may not drop the same _atom_, but 
      // we need to define idempotence extensionally, i.e., by the field values of the remaining message. 
      not {
        one Network.messages''
        message_extensional_equality[Network.messages, Network.messages'']
      }
    }

  } is unsat
}
</code></pre>
<p>That last test passes, but it takes about a minute to run on my laptop, which is interesting. The model is getting complex enough that yielding UNSAT is, at times, real work for the solver. And the work <em>is</em> happening in the solver, not in translation to boolean logic:</p>
<pre><code>#vars: (size-variables 344839); #primary: (size-primary 12820); #clauses: (size-clauses 979303)
Transl (ms): (time-translation 923); Solving (ms): (time-solving 60520) Core min (ms): (time-core 0)
</code></pre>
<p>We could probably reduce this by changing the trace length to something below 10, which is where we currently have it set. </p>
<h3 id="what-about-changing-message-field-values"><a class="header" href="#what-about-changing-message-field-values">What about changing message field values?</a></h3>
<p>In practice, a network can do more than duplicate or drop a packet. The network has the power to arbitrarily change the bits in a message. It might even manufacture a message on its own! For simplicity, we'll leave this out. But as a result, some of our results will be weaker than they otherwise might be: showing that Raft maintains consistency in a model that doesn't admit packet modification won't tell us anything about real-world situations where that modification happens.</p>
<p>Likewise, we won't be considering membership changes or log compaction. We'll follow figure 2 pretty closely, and see if we get into trouble. </p>
<h2 id="requesting-updates"><a class="header" href="#requesting-updates">Requesting Updates</a></h2>
<p>The final major piece to build is the <code>AppendEntries</code> RPC messages, and how updates are done in response. We can add the RPC messages easily enough, using the paper's figure 2 as a guide:</p>
<pre><code class="language-forge">appendEntriesTerm: one Int, 
    leaderID: one Server, 
    prevLogIndex: one Int, 
    prevLogTerm: one Int, 
    entries: set Entry,
    leaderCommit: one Int
}
sig AppendEntriesReply extends RaftMessage {
    appendEntriesReplyTerm: one Int, 
    success: lone Server -- represent true boolean as non-empty
}
</code></pre>
<p>Then we need to add constraints to our <code>message_extensional_equality</code> predicate that check fields of these two message types. E.g., </p>
<pre><code class="language-forge">m1 in AppendEntriesReply =&gt; {
    m2 in AppendEntriesReply
    m1.appendEntriesReplyTerm = m2.appendEntriesReplyTerm
    m1.success = m2.success
}
</code></pre>
<p>But we still need to add appropriate transitions for these messages, and those transitions need to encode the behavior of the system when such a message is received. Figure 2 of the paper sketches what a node does when it receives an <code>AppendEntries</code> message:</p>
<ul>
<li>Reply false if term &lt; currentTerm (§5.1)</li>
<li>Reply false if log doesn’t contain an entry at prevLogIndex whose term matches prevLogTerm (§5.3)</li>
<li>If an existing entry conflicts with a new one (same index but different terms), delete the existing entry and all that follow it (§5.3)</li>
<li>Append any new entries not already in the log</li>
<li>If leaderCommit &gt; commitIndex, set commitIndex = min(leaderCommit, index of last new entry)</li>
</ul>
<p>I feel like we can encode these into a predicate. We'll just need to watch out to make sure our constraints match the ordering of these steps, and make sure that a reply is always sent. To keep the transition from getting tangled when we start talking about the reply, I'll actually make two transition predicates: one for false replies, and one for true replies. </p>
<pre><code class="language-forge">pred canReceiveAppendGood[msg: AppendEntries] {
    -- [TODO: term &gt;= currentTerm]
    -- [TODO: there is a local log entry at (prevLogTerm, prevLogIndex)]
}

pred receiveAppendBad {
    -- GUARD 
    -- [TODO: actually can and do receive the message &lt;msg&gt;. similar to receiving votes.]
    not canReceiveAppendGood[msg]
    -- ACTION
    -- make no change to local log 
    -- [TODO: add a false reply to the network]
}
pred receiveAppendGood {
    -- GUARD
    -- [TODO: actually can and do receive the message &lt;msg&gt;. similar to receiving votes.]
    canReceiveAppendGood[msg]
    -- ACTION
    -- make a change to the local log
    -- [TODO: if there's something at this index with a different term, delete it and all following]
    -- [TODO: append new entries not already present]
    -- [TODO: If leaderCommit &gt; commitIndex, set commitIndex = min(leaderCommit, index of last new entry)]
    -- [TODO: add a true reply to the network]
}
</code></pre>
<p>Those last few &quot;TODO&quot;s in <code>receiveAppendGood</code> seem like they'll interfere with each other, since Forge isn't imperative. In particular, we'll need to delete (if needed) and append (if needed) entries in the same transition. So those two will likely get combined into a single constraint. </p>
<p>And we need to handle replies: </p>
<pre><code class="language-forge">pred receiveAppendReply {
    -- GUARD
    -- [TODO: actually can and do receive the reply &lt;msg&gt;. similar to receiving votes.]
    -- If this is a &quot;true&quot; reply, do nothing. If it's a &quot;false&quot; reply, we need to resend
    -- with changes: &quot;After a rejection, the leader decrements nextIndex and retries the 
    -- AppendEntries RPC. Eventually nextIndex will reach a point where the leader and 
    -- follower logs match.&quot;
    -- [TODO: if false reply, decrement and send a new message]
}
</code></pre>
<div id="admonition-number-of-messages" class="admonition admonish-note">
<div class="admonition-title">
<p>Number of messages</p>
<p><a class="admonition-anchor-link" href="chapters/raft/raft.html#admonition-number-of-messages"></a></p>
</div>
<div>
<p>I'm again starting to get a little worried about the bound on <code>Message</code> we'll give Forge. We need 2 messages every time the follower rejects an update request. We'll also need 2 state transitions, which means traces are likely to get pretty long for situations where the logs are very out of sync.</p>
</div>
</div>
<p>We also need to add the log to our servers, which until now have only been concerned with voting and leadership related state. </p>
<pre><code class="language-forge">/** &quot;each entry contains command for state machine, 
     and term when entry was received by leader&quot; 
     
  We'll abstract out state-machine commands for the moment. */
sig Entry {
  termReceived: one Int
}
</code></pre>
<p>and one more field for <code>Server</code>, along with the necessary additions to helpers like <code>frame_server</code>. All servers will begin with an empty log:</p>
<pre><code class="language-forge">sig Server {
    var role: one Role,
    var votedFor: lone Server, 
    var currentTerm: one Int,
    var log: pfunc Int -&gt; Entry
}
</code></pre>
<p>Finally, we need a transition that represents a client request to execute a state-machine command. These requests will be managed only by the current leader (if any). Since we're interested in the replicated log, we won't model the exact command(s) requested, but rather the addition of a new <code>Entry</code> that must be replicated. We'll keep commands out of it, unless we end up needing them. </p>
<pre><code class="language-forge">pred processClientRequest {
    -- GUARD: this can happen at any time, provided there is a Leader
    some s: Server | s.role = Leader 
    -- ACTION: the leader updates its log and sends AppendEntries RPC requests to all Followers.
    -- TODO
}
</code></pre>
<h2 id="understanding-raft"><a class="header" href="#understanding-raft">Understanding Raft:</a></h2>
<p>TODO</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="further-reading"><a class="header" href="#further-reading">Further Reading</a></h1>
<p><strong>IN PROGRESS</strong></p>
<h2 id="textbooks"><a class="header" href="#textbooks">Textbooks</a></h2>
<p>Forge would never have existed without its intellectual parent, <a href="alloytools.org">Alloy</a>. <strong>TODO: Alloy book, but also Jackson's new book?</strong></p>
<p>Should probably link to Morgan's book, Wayne's book. It's not just us who are thinking about formalism for those who don't adore theory.</p>
<h2 id="papers"><a class="header" href="#papers">Papers</a></h2>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="2023-satisfiability-solving"><a class="header" href="#2023-satisfiability-solving">2023: Satisfiability Solving</a></h1>
<p>Welcome back! We'll spend this week on algorithms and data structures for solving boolean constraint problems. (Sometimes we'll call this &quot;SAT&quot;---short for &quot;satisfiability&quot;.)</p>
<h2 id="logistics-homework"><a class="header" href="#logistics-homework">Logistics: Homework</a></h2>
<p>Friday's homework will involve writing your own solver! </p>
<h2 id="solving-sat"><a class="header" href="#solving-sat">Solving SAT</a></h2>
<p>Suppose I asked you to solve a boolean constraint problem. Maybe it comes from Forge, and maybe it doesn't. Here's an example, in &quot;Java syntax&quot;:</p>
<pre><code>x1 and (x1 implies x2)
</code></pre>
<p>Is there a satisfying instance for this constraint? </p>
<ul>
<li>If yes, what is it, and how did you obtain it?</li>
<li>If no, how did you reach that conclusion?</li>
</ul>
<p>Here's another:</p>
<pre><code>(x1 or !x2) and (x1 or x2) and (x2 or !x1) and (!x2 or !x1)
</code></pre>
<p>Same question. Is there a satisfying instance for this constraint? </p>
<ul>
<li>If yes, what is it, and how did you obtain it?</li>
<li>If no, how did you reach that conclusion?</li>
</ul>
<h2 id="truth-tables"><a class="header" href="#truth-tables">Truth Tables</a></h2>
<p>We could build the table of all possibilities, and use it to search like so:</p>
<div class="table-wrapper"><table><thead><tr><th><code>x1</code></th><th><code>x2</code></th><th><code>(x1 implies x2)</code></th><th><code>x1 and (x1 implies x2)</code></th></tr></thead><tbody>
<tr><td>T</td><td>T</td><td>T</td><td><strong>T</strong></td></tr>
<tr><td>T</td><td>F</td><td>F</td><td>F</td></tr>
<tr><td>F</td><td>T</td><td>T</td><td>F</td></tr>
<tr><td>F</td><td>F</td><td>T</td><td>F</td></tr>
</tbody></table>
</div>
<p>We've found a solution! But we needed to build the entire set of possibilities to do so.</p>
<h2 id="can-we-do-better"><a class="header" href="#can-we-do-better">Can We Do Better?</a></h2>
<p>If you take 1010, you'll learn that we don't actually know (at time of writing) whether it's possible to solve boolean satisfiability for arbitrary inputs without taking time exponential in the size of the input. This is one of the biggest unsolved questions, and certainly one of the most famous, in computer science.</p>
<p>But we shouldn't let that discourage us. Plenty of problems are <em>worst</em> case exponential (or even more difficult) and we solve them all the time.</p>
<h2 id="lets-try-anyway"><a class="header" href="#lets-try-anyway">Let's Try Anyway</a></h2>
<p>Maybe we can do better <em>sometimes</em>. Let's just start, and see where we get to. </p>
<div id="admonition-pseudocode" class="admonition admonish-warning">
<div class="admonition-title">
<p>Pseudocode</p>
<p><a class="admonition-anchor-link" href="chapters/solvers/dpll.html#admonition-pseudocode"></a></p>
</div>
<div>
<p>The &quot;code&quot; in today's notes is <em>pseudocode</em>---it shouldn't be viewed as complete---rather, the goal is to motivate the core ideas coming up. You'll get a more complete stencil as part of your homework, including types.</p>
</div>
</div>
<h3 id="a-first-try"><a class="header" href="#a-first-try">A First Try</a></h3>
<p>Here's a solution that recursively tries all combinations---sort of like building the truth table:</p>
<pre><code class="language-python">def solve(formula: BooleanFormula) -&gt; bool:
    remaining = variables_in(formula) # get list of variables used in the formula
    if remaining.isEmpty(): 
        return simplify(formula)      # no variables left; simplify to true or false
    else:
        branch = remaining[0]                                     # guess based on first variable v
        true_result = solve(substitute(formula, branch, True))    # try v = true
        false_result = solve(substitute(formula, branch, False))  # try v = false
        return true_result || false_result                        # true if and only if _some_ guess worked
</code></pre>
<p>The function relies on two helpers:</p>
<ul>
<li><code>simplify</code>, which evaluates a formula with no variables. E.g., it turns <code>True and False</code> to just <code>True</code>.</li>
<li><code>substitute</code>, which replaces a variable with a concrete boolean value. E.g., calling <code>substitute(x1 and x2, x1, True)</code> would produce <code>True and x2</code>.</li>
</ul>
<p>Note, though, that this program doesn't actually build the <em>entire</em> table at any one time. It explores the entire set of possible instances, and so takes time worst-case exponential in the number of variables. But it doesn't need that much <em>space</em>, which is already an improvement.</p>
<p>However, its <em>best</em> case time is also exponential, which is a bit disappointing. </p>
<h3 id="maybe-luck-is-with-us"><a class="header" href="#maybe-luck-is-with-us">Maybe Luck Is With Us</a></h3>
<p>The issue with the last solution is that it <em>always</em> explores, even if it doesn't need to. Instead, how about we only check one value at a time---if we find a <code>True</code> result for one specific substitution, we're done!</p>
<pre><code class="language-python">def solve(formula: BooleanFormula) -&gt; bool:
    remaining = variables_in(formula)
    if remaining.isEmpty(): 
        return simplify(formula)
    else:
        branch = remaining[0]
        true_result = solve(substitute(formula, branch, True))
        if true_result:    # same as last version
            return True    # but allow early termination
        else: 
            false_result = solve(substitute(formula, branch, False))
            return false_result    
</code></pre>
<p>Now, suddenly, the best-case and the worst-case aren't the same. The solver could be <em>lucky</em>: consider a formula like <code>x1 and x2 and x3 and x4 and x5</code>. The above algorithm only needs 5 recursive calls to return <code>True</code>; the previous one would need <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span>.</p>
<p>Of course, luck won't always be with us. Right? What's an example formula that would still need an exponential number of calls with the above code?</p>
<details>
<summary>Think, then click!</summary>
<p>How about: <code>!x1 and !x2 and !x3 and ...</code>? The first guess of <code>True</code> is always wrong for a formula like this.</p>
</details>
<h3 id="imposing-structure"><a class="header" href="#imposing-structure">Imposing Structure</a></h3>
<p>Let's look back at our first example: <code>x1 and (x1 implies x2)</code>. You may have taken advantage of some <em>structure</em> to figure out a satisfying instance for this formula. Namely, if we know that <code>x1</code> holds, then we can propagate that knowledge into <code>x1 implies x2</code> to <em>deduce</em> that <code>x2</code> must hold---without needing to guess and try a value. There's nothing like this deduction in either of our programs so far.</p>
<p>The trouble is: if we're given an arbitrary formula, it's hard to pick out that (say) <code>x1</code> is <em>definitely</em> true. But if we impose a little bit of structure on the input, it becomes easy in many cases. Let's do that now.</p>
<h2 id="conjunctive-normal-form"><a class="header" href="#conjunctive-normal-form">Conjunctive Normal Form</a></h2>
<p>First, three definitions:</p>
<p>A <em>literal</em> is a variable or its negation. E.g., <code>x1</code> and <code>!x1</code> are both literals, but <code>!!x1</code> and <code>x1 or x2</code> are not.</p>
<p>A <em>clause</em> is a set of literals combined with &quot;or&quot;; you may sometimes hear this called a <em>disjunction</em> of literals. </p>
<p>A formula is said to be in <em>conjunctive normal form</em> (CNF) if it comprises a set of clauses that is combined with &quot;and&quot;. We call it this because &quot;conjunction&quot; is just another name for &quot;and&quot;; a &quot;normal form&quot; is just a way of saying that a formula's shape follows a certain (often useful) structure.</p>
<p>If the input to our solver is in CNF, as the example formula <code>x1 and (x1 implies x2)</code> is (or rather, it would be if we'd wrote it equivalently as <code>x1 and (!x1 or x2)</code>), we can spot these opportunities to propagate knowledge quite quickly, just by searching for clauses of only one element. </p>
<p>A <em>unit clause</em> is a 1-element clause: a variable or its negation.</p>
<p>The <em>empty clause</em> is a 0-element clause, and is equivalent to <code>False</code>. Why is the empty clause equivalent to <code>False</code>?</p>
<details>
<summary>Think, then click!</summary>
<p>A clause is a big &quot;or&quot;, and an &quot;or&quot; gives a set of ways the formula could evaluate to <code>True</code>. But an empty clause gives <em>no</em> such options!</p>
</details>
</br>
<p><strong>From now on, we'll assume that we always have input in CNF.</strong> There's a trick to accomplish this, so let's keep focused on the solving, not on the conversion for now. </p>
<h3 id="using-cnf-unit-propagation"><a class="header" href="#using-cnf-unit-propagation">Using CNF: Unit Propagation</a></h3>
<p>If our input was <code>x1 and (!x1 or x2)</code>, and we'd stored it as a set, that would be <code>{x1, (!x1 or x2)}</code>. We can check for unit clauses in time linear in the number of clauses. And if there is one, we can see whether there are opportunities to propagate that knowledge. This idea is called <em>unit propagation</em>.</p>
<p>But how does that actually <em>work</em>?</p>
<details>
<summary>Think, then click!</summary>
<p>Suppose we've identified a unit clause, in this case <code>x1</code>. Then, for every other clause <code>C</code> in the set, we can check:</p>
<ul>
<li>Does the clause <code>C</code> contain the same literal as the unit clause?
<ul>
<li>If so, then <code>C</code> is <em>subsumed</em> by the unit clause: <code>C</code> must be satisfied given <code>x1</code> holds! Delete the entire clause <code>C</code>.</li>
</ul>
</li>
<li>Does the clause contain the opposite literal as in the unit clause?
<ul>
<li>If so, then the clause <code>C</code> cannot possibly be made true by that opposite literal. Delete that literal from <code>C</code>.</li>
</ul>
</li>
</ul>
</details>
</br>
<p><strong>Exercise</strong>: Here's a CNF formula. Solve it using unit propagation. </p>
<p><code>x1 and (x1 or x2 or x3) and (!x3 or x2 or !x4) and (!x2 or !x1) and x3</code></p>
<details>
<summary>Think, then click!</summary>
<p>First, we notice 2 unit clauses: <code>x1</code> and <code>x3</code>. Then:</p>
<ul>
<li>Propagate <code>x1</code>, which lets us remove a clause entirely, and simplify another: <code>x1 and (!x3 or x2 or !x4) and !x2 and x3</code>. But now we have a new unit clause, as a result of simplifying! </li>
<li>Propagating <code>x3</code> gives us: <code>x1 and (x2 or !x4) and !x2 and x3</code>. </li>
<li>Propagating <code>!x2</code> gives us <code>x1 and !x4 and !x2 and x3</code>. </li>
</ul>
<p>This is starting to look suspiciously like a boolean instance. <em>The unit clauses are assignments to boolean variables, and part of this process deduces new ones.</em></p>
</details>
</br>
<p><strong>Exercise</strong>: Here's a CNF formula. Solve it using unit propagation. </p>
<p><code>x1 and (x1 or x2 or x3) and (!x3 or x2 or !x4)</code></p>
<p>Notice this formula is a strict subset of the earlier one. Because the earlier one is satisfiable, so is this one! But does unit propagation alone suffice to discover the satisfiability?</p>
<details>
<summary>Think, then click!</summary>
<p>No. Unit propagating <code>x1</code> will produce <code>x1 and (!x3 or x2 or !x4)</code>, but we need some other way---besides <em>just</em> unit propagation---of breaking down the larger clause that remains.</p>
</details>
</br>
<p>Fortunately, if we mix unit propagation with our prior &quot;guessing&quot; algorithm, we make significant progress.</p>
<h3 id="adding-unit-propagation"><a class="header" href="#adding-unit-propagation">Adding Unit Propagation</a></h3>
<pre><code class="language-python">def solve(formula: Set[Clause]) -&gt; bool:
    
    # are there any unit clauses? if so, propagate them
    # keep doing so until there are no more changes
    # Beware: mutation can be a source of bugs here...
    old_formula, formula = propagate_unit_clauses(formula)
    while formula &lt;&gt; old_formula:
        old_formula, formula = propagate_unit_clauses(formula)
    
    # Did we produce the empty clause? (We might represent the e.c. as {} or [] etc.)
    if EmptyClause in formula:
        return False
    # Do we otherwise have only unit clauses remaining? (What could go wrong in this check?) 
    elif formula == units_in(formula):    
        return True
    else:
        branch = remaining[0]
        # no longer substitute; instead, _add_ a unit clause to represent the &quot;True&quot; guess
        true_result = solve(formula + {branch})
        if true_result: 
            return True
        else: 
            # no longer substitute; instead, _add_ a unit clause to represent the &quot;False&quot; guess
            false_result = solve(formula + {!branch})
            return false_result    
</code></pre>
<p>Again, the amount of information we get from unit propagation is subject to luck (or, rather, the dependencies between variables and clauses in the formula we're given). </p>
<div id="admonition-think-why-did-we-stop-substituting" class="admonition admonish-note">
<div class="admonition-title">
<p>Think: Why did we stop substituting?</p>
<p><a class="admonition-anchor-link" href="chapters/solvers/dpll.html#admonition-think-why-did-we-stop-substituting"></a></p>
</div>
<div>
<p>In prior versions, we substituted <code>True</code> or <code>False</code> into the formula. Now, we're adding a unit clause to represent the guess instead. Why did we make this change? One reason is that it's easier to explicitly represent the flow of this algorithm via the addition of unit clauses, since half of it is about unit propagation. More reasons may appear as we continue.</p>
</div>
</div>
<p>This idea---a recursive, backtracking search paired with unit propagation---is the foundation of one of the most famous boolean solver algorithms: <strong>DPLL</strong> (named after the authors: Davis, Putnam, Logemann, and Loveland). DPLL still forms the core of how most modern SAT-solvers work (although there are more ideas and optimizations not yet incorporated, such as learning from failure and deciding which variable to branch on).</p>
<h3 id="returning-more-than-a-boolean"><a class="header" href="#returning-more-than-a-boolean">Returning more than a boolean</a></h3>
<p>Returning just a boolean seems bad for the caller. After all, if Forge were using this solver, it would want the instance itself, not just that the instance exists. But there's another problem with returning a boolean: something related to testing. What is it?</p>
<details>
<summary>Think, then click!</summary>
<p>If we wanted to do property-based testing on the solver, returning <code>True</code> would force the testing predicate to <em>solve the problem again</em>. But if we returned an instance, the predicate would be much easier: just evaluate the formula in the instance, and see if it indeed satisfies the formula.</p>
</details>
</br>
<p>But how should we go about returning an instance, rather than <code>True</code>? To find out, let's actually look at the tree of recursive calls, and see what information we have, or could recover. Let's solve:</p>
<p><code>(!x1 or !x2) and (!x1 or !x3) and (x2 or x3)</code></p>
<p><img src="https://i.imgur.com/odianeQ.jpg" alt="" /></p>
<p>In that bottom left call, how do we conclude &quot;conflict?&quot; In the other bottom call, how do we conclude &quot;success&quot;?</p>
<details>
<summary>Think, then click!</summary>
<p>Because there's one more unit-propagation step in each case that I haven't drawn! Unit propagating <code>x3</code> when <code>!x3</code> is present will produce the empty clause: <code>False</code>. And similarly in the other case: unit propagating <code>x2</code> will eliminate the entire <code>x2 or x3</code> clause.</p>
</details>
</br>
<p>Notice that every time we make a recursive call, there's an implicit set of <em>assumptions</em> involved. That is, there's always a <em>partial instance</em> of previously-selected guesses in effect at any point. We can make this explicit by adding a parameter to the function, and returning the guesses that produce a success:</p>
<pre><code class="language-python"># Note new input and output types
def solve(formula: Set[Clause], assumptions: Set[Literal]) -&gt; Set[Literal]:    
    old_formula, formula = propagate_unit_clauses(formula)
    while formula &lt;&gt; old_formula:
        old_formula, formula = propagate_unit_clauses(formula)
        
    remaining = variables_in(formula)
    if remaining.isEmpty():
        if simplify(formula): 
            return assumptions
        else: 
            return False        
    else:
        branch = remaining[0]
        true_result = solve(formula + {branch}, assumptions + {branch : true})
        if true_result &lt;&gt; False: 
            return assumptions
        else: 
            false_result = solve(formula + {!branch}, assumptions + {branch : False})
            return false_result    
</code></pre>
<div id="admonition-hold-on" class="admonition admonish-warning">
<div class="admonition-title">
<p>Hold on...</p>
<p><a class="admonition-anchor-link" href="chapters/solvers/dpll.html#admonition-hold-on"></a></p>
</div>
<div>
<p>Does this actually work? Let's think about testing. We can use PBT to test our solver! What do we need?</p>
<ul>
<li>A <em>generator</em> for clause sets;</li>
<li>A <em>predicate</em> that tests whether an instance satisfies a clause set.</li>
</ul>
<p>If we try this out, we may find a potential issue. Here's an example we might be concerned about (but notice how many contingencies are involved in generating it!):</p>
<pre><code>(x1 or x2)
(!x1 or x3) 
</code></pre>
<p>If our solver uses lexical order to decide what to branch on first, it's going to pick <code>x1</code> before the others. And if it tries <code>True</code> first, we'll end up unit-propagating to:</p>
<pre><code>x1 
x3 
</code></pre>
<p>because the first original clause is subsumed by <code>x1</code>, and the second can be unit-propagated into. Yet, if we only return the assumptions, rather than <em>all</em> derived unit clauses, we'll return <code>{x1: True}</code>, not <code>{x1: True, x3: True}</code>. Beware!</p>
</div>
</div>
<h3 id="total-or-partial-instances"><a class="header" href="#total-or-partial-instances">Total or Partial Instances?</a></h3>
<p>So far, our algorithm will avoid making assumptions if it doesn't need to. This is good from a performance perspective but bad if the caller expects a <em>total</em> instance that maps every variable to a boolean. But unit propagation can <em>delete</em> clauses, resulting in variables just disappearing from the problem. E.g., solving <code>x1 and (x1 or x5)</code>.</p>
<p>If our goal is to produce a <em>total</em> solver (and it usually is---Forge, for example, needs values for every possible tuple in every relation, even if they aren't constrained at all), we'll need to post-process the result and pick arbitrary values for variables that have no value in the assumption set. Traditionally, we'll make this easier on ourselves by passing a 3rd argument to the solver: the number of variables.</p>
<h2 id="heuristics-which-variables-which-values"><a class="header" href="#heuristics-which-variables-which-values">Heuristics: Which Variables? Which Values?</a></h2>
<p>There are a bunch of heuristics for picking variables to branch on, picking boolean values, etc. that are beyond the scope of this class. There is also a second brilliant idea that powers model solvers: <em>learning</em> from failure. In these solvers, reaching a conflict results in learning a &quot;conflict clause&quot; which is added to know the knowledge base, and the solver leverages this to backtrack further than one level of recursion if it's able.</p>
<p>If you're curious about how solvers are built, check out <a href="http://cs.brown.edu/courses/csci2951-o/">CSCI 2951-O</a>. </p>
<h2 id="converting-to-cnf"><a class="header" href="#converting-to-cnf">Converting to CNF</a></h2>
<p>How should we convert an arbitrary boolean formula to CNF? </p>
<h3 id="naive-approach-distributivity"><a class="header" href="#naive-approach-distributivity">Naive Approach: Distributivity</a></h3>
<p>We could start by using the distributive law: <code>x1 and (x2 or x3)</code> is equivalent to <code>(x1 or x2) and (x1 or x3)</code>.</p>
<p>So if we have:</p>
<p><code>(x1 and x2) or (x3 and x4)</code></p>
<p>We could convert it to CNF by applying the distributive law twice to get:</p>
<p><code>(x1 or x3) and (x1 or x4) and (x2 or x3) and (x2 and x4)</code></p>
<p>There's a fundamental problem here, though. What do you see?</p>
<details>
<summary>Think, then click!</summary>
<p>This process will increase formula size <em>exponentially</em> in the worst case. That's unacceptable. (Consider what happens if we keep adding terms to the above shape: making the inner <code>and</code> formulas bigger and adding more of them.)</p>
<p>This is again pretty disappointing: if there <em>is no</em> equivalent CNF available for some formulas that isn't exponentially bigger, how can we practically use the algorithm we just invented?</p>
</details>
<h3 id="the-tseitin-transformation"><a class="header" href="#the-tseitin-transformation">The Tseitin Transformation</a></h3>
<p>There's something else we could do. If we can't find an <em>equivalent</em> CNF, maybe we could make a trade-off. To help us on the way, here are a couple of definitions:</p>
<p>Two formulas A and B over some set of boolean variables V are said to be <em>logically equivalent</em> if they are satisfied by the exact same instances.</p>
<p>Two formulas A and B are said to be <em>equisatisfiable</em> when A is satisfiable if and only if B is satisfiable. Note that equisatisfiability doesn't require A and B to use the same variable sets; the instances can be over different variables. </p>
<div id="admonition-the-idea" class="admonition admonish-tip">
<div class="admonition-title">
<p>The Idea</p>
<p><a class="admonition-anchor-link" href="chapters/solvers/dpll.html#admonition-the-idea"></a></p>
</div>
<div>
<p>Of course, mere equisatisfiability doesn't immediately guarantee any structural connection between the two formulas. For this to work, we need to be able to map a solution to problem <code>B</code> back to the original problem <code>A</code>. So maybe there's a way we could productively <em>add variables</em> to the original, retaining the meaning of the original variables, and still somehow avoid the exponential blowup in CNF conversion?</p>
</div>
</div>
<p>Let's look at that formula again: <code>(x1 and x2) or (x3 and x4)</code>. View it as a boolean circuit. </p>
<p><img src="https://i.imgur.com/fDHDyEe.png" alt="" /></p>
<p>What if we assigned a new variable for every internal node of the tree? We'd have <code>a1</code> and <code>a2</code> for the <code>and</code> nodes, and <code>o1</code> for the <code>or</code> node. The formula is true if and only if the <code>or</code> node is, so we'd have a unit clause: <code>o1</code> in the new formula. </p>
<p>But what makes <code>o1</code> true? Here's a definition in 3 constraints:</p>
<ul>
<li><code>a1 implies o1</code>,</li>
<li><code>a2 implies o1</code>, and</li>
<li><code>o1 implies (a1 or a2)</code>.</li>
</ul>
<p>We can rewrite these in CNF:</p>
<ul>
<li><code>!a1 or o1</code>,</li>
<li><code>!a2 or o1</code>, and</li>
<li><code>!o1 or a1 or a2</code>.</li>
</ul>
<p>The <code>and</code> nodes have similar definitions:</p>
<ul>
<li><code>(x1 and x2) implies a1</code></li>
<li><code>a1 implies (x1 and x2)</code></li>
<li><code>(x3 and x4) implies a2</code></li>
<li><code>a2 implies (x3 and x4)</code>
which can be rewritten:</li>
<li><code>!x1 or !x2 or a1</code></li>
<li><code>!a1 or x1</code></li>
<li><code>!a1 or x2</code></li>
<li><code>!x3 or !x4 or a2</code></li>
<li><code>!a2 or x3</code></li>
<li><code>!a2 or x4</code></li>
</ul>
<p>Together, these constraints are <em>equisatisfiable</em> with the original formula. </p>
<p>Moreover, they're something more than equisatisfiable. Just like we wanted, there's a useful relationship between the original variables and the new variables. We can always read off the values of <code>x1</code>, <code>x2</code>, <code>x3</code>, and <code>x4</code> in a solution to the new constraints and get a solution to the original constraints. The values of the newly added variables express values for the intermediate nodes of the boolean circuit.</p>
<p>And that's how Forge's translation layer works.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="resolution-proofs"><a class="header" href="#resolution-proofs">Resolution Proofs</a></h1>
<p>This document contains a two-class sequence on resolution proofs and how they relate to boolean solvers. <strong>This material will be directly useful in your 2nd SAT homework.</strong></p>
<h2 id="context-proofs-vs-instances"><a class="header" href="#context-proofs-vs-instances">Context: Proofs vs. Instances</a></h2>
<p>Almost all of our work in 1710 so far has focused on <em>satisfiability</em>: given constraints, how can they be satisfied? Our conversations have a character that puts instances first---how are they related, how can they be changed, how can a partial instance be completed, etc. In the field of logic, this is called a <em>model-theoretic</em> view.</p>
<p>But there's a second perspective, one that focuses on necessity, deduction, and contradiction---on justifying unsatisfiability with <em>proof</em>. Today we'll start exploring the proof-theoretic side of 1710. But we'll do so in a way that's immediately applicable to what we already know. In particular, by the time we're done with this week, you'll understand a basic version of how a modern SAT solver can return a <em>proof</em> of unsatisfiability. This proof can be processed to produce cores like those Forge exposes via experimental <code>solver</code>, <code>core_minimization</code>, etc. options.</p>
<p>We'll start simple, from CNF and unit propagation, and move on from there.</p>
<h2 id="a-chain-rule-for-cnf"><a class="header" href="#a-chain-rule-for-cnf">A Chain Rule For CNF</a></h2>
<p>Suppose I know two things:</p>
<ul>
<li>it's raining today; and</li>
<li>if it's raining today, we can't hold class outside.</li>
</ul>
<p>I might write this more mathematically as the set of known facts: <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">¬</span><span class="mord mathnormal">c</span><span class="mclose">}</span></span></span></span>, where <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> means &quot;rain&quot; and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">c</span></span></span></span> means &quot;class outside&quot;. </p>
<div id="admonition-symbols" class="admonition admonish-note">
<div class="admonition-title">
<p>Symbols</p>
<p><a class="admonition-anchor-link" href="chapters/solvers/resolution.html#admonition-symbols"></a></p>
</div>
<div>
<p>Because the vast majority of the materials you might find on this topic are written using mathematical notation, I'm using <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.549em;vertical-align:-0.024em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2778em;"></span></span></span></span> for <code>implies</code> and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord">¬</span></span></span></span> for <code>not</code>. If you go reading elsewhere, you might also see <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5556em;"></span><span class="mord">∧</span></span></span></span> for <code>and</code> and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5556em;"></span><span class="mord">∨</span></span></span></span> for <code>or</code>.</p>
</div>
</div>
<p>Given this knowledge base, can we infer anything new? Yes! We know that if it's raining, we can't hold class outside. But we know it's raining, and therefore we can conclude class needs to be indoors. This intuition is embodied formally as a logical <em>rule of inference</em> called <em>modus ponens</em>:</p>
<center>
<p>
<p><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2694em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9244em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">A</span><span class="mspace mtight" style="margin-right:0.3253em;"></span><span class="mrel mtight">⟹</span><span class="mspace mtight" style="margin-right:0.3253em;"></span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></p>
</p>                
</center>
<p>The horizontal bar in this notation divides the inputs to the rule from the outputs. For <em>any</em> <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span> and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>, if we know <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span>, and we know <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7073em;vertical-align:-0.024em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>, we can use modus ponens to deduce <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>.</p>
<div id="admonition-does-this-remind-you-of-something" class="admonition admonish-tip">
<div class="admonition-title">
<p>Does this remind you of something?</p>
<p><a class="admonition-anchor-link" href="chapters/solvers/resolution.html#admonition-does-this-remind-you-of-something"></a></p>
</div>
<div>
<p>Modus ponens is very closely related to unit propagation. Indeed, that connection is what we're going to leverage to get our solvers to output proofs.</p>
</div>
</div>
<p>I like to think of rules of inference as little enzymes that operate on formula syntax. Modus ponens recognizes a specific pattern of syntax in our knowledge base and <em>rewrites</em> that pattern into something new. We can check rules like this for validity using a truth table:</p>
<div class="table-wrapper"><table><thead><tr><th><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span></th><th><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></th><th><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7073em;vertical-align:-0.024em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></th></tr></thead><tbody>
<tr><td>0</td><td>0</td><td>1</td></tr>
<tr><td>0</td><td>1</td><td>1</td></tr>
<tr><td>1</td><td>0</td><td>0</td></tr>
<tr><td>1</td><td>1</td><td>1</td></tr>
</tbody></table>
</div>
<p>In any world where both <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span> and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7073em;vertical-align:-0.024em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> are true, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> must be true.</p>
<div id="admonition-remember-that-implies-and-or-are-related" class="admonition admonish-warning">
<div class="admonition-title">
<p>Remember that <code>implies</code> and <code>or</code> are related!</p>
<p><a class="admonition-anchor-link" href="chapters/solvers/resolution.html#admonition-remember-that-implies-and-or-are-related"></a></p>
</div>
<div>
<p>In classical logic (our setting for most of 1710), <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7073em;vertical-align:-0.024em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> is equivalent to <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">¬</span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>. Either <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span> is false (and thus no obligation is incurred), <em>or</em> <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> is true (satisfying the obligation whether or not it exists). This will be very important soon.</p>
</div>
</div>
<h3 id="beyond-modus-ponens"><a class="header" href="#beyond-modus-ponens">Beyond Modus Ponens</a></h3>
<p>Suppose we don't have something as straightforward as <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">¬</span><span class="mord mathnormal">c</span><span class="mclose">}</span></span></span></span> to work with. Maybe we only have:</p>
<ul>
<li>if it's raining today, we can't hold class outside; and</li>
<li>if Tim is carrying an umbrella, then it's raining today.</li>
</ul>
<p>That is, we have a pair of implications: <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord mathnormal">u</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7194em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">¬</span><span class="mord mathnormal">c</span><span class="mclose">}</span></span></span></span>. We cannot conclude that it's raining from this knowledge base, but we can still conclude something: that <em>if</em> Tim is carrying an umbrella, <em>then</em> we can't hold class outside. We've learned something new, but it remains contingent: <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.549em;vertical-align:-0.024em;"></span><span class="mord mathnormal">u</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord">¬</span><span class="mord mathnormal">c</span></span></span></span>.</p>
<p>This generalization of modus ponens lets us chain together implications to generate new ones:</p>
<center>
<p>
<p><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2862em;vertical-align:-0.3618em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9244em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mspace mtight" style="margin-right:0.3253em;"></span><span class="mrel mtight">⟹</span><span class="mspace mtight" style="margin-right:0.3253em;"></span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mspace mtight" style="margin-right:0.3253em;"></span><span class="mrel mtight">⟹</span><span class="mspace mtight" style="margin-right:0.3253em;"></span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mspace mtight" style="margin-right:0.3253em;"></span><span class="mrel mtight">⟹</span><span class="mspace mtight" style="margin-right:0.3253em;"></span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3618em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></p>
</p>                
</center>
<p>Like before, we can check it with a truth table. This time, there are 8 rows because there are 3 inputs to the rule:</p>
<div class="table-wrapper"><table><thead><tr><th><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span></th><th><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></th><th><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span></th><th><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7073em;vertical-align:-0.024em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></th><th><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7073em;vertical-align:-0.024em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span></th><th><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7073em;vertical-align:-0.024em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span></th></tr></thead><tbody>
<tr><td>0</td><td>0</td><td>0</td><td>1</td><td>1</td><td>1</td></tr>
<tr><td>0</td><td>0</td><td>1</td><td>1</td><td>1</td><td>1</td></tr>
<tr><td>0</td><td>1</td><td>0</td><td>1</td><td>0</td><td>1</td></tr>
<tr><td>0</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td></tr>
<tr><td>1</td><td>0</td><td>0</td><td>0</td><td>1</td><td>0</td></tr>
<tr><td>1</td><td>0</td><td>1</td><td>0</td><td>1</td><td>1</td></tr>
<tr><td>1</td><td>1</td><td>0</td><td>1</td><td>0</td><td>0</td></tr>
<tr><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td></tr>
</tbody></table>
</div>
<p><strong>Note:</strong> This rule works no matter what form <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span>, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>, and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span> take, but for our purposes we'll think of them as literals (i.e., variables or their negation).</p>
<h2 id="propositional-resolution"><a class="header" href="#propositional-resolution">Propositional Resolution</a></h2>
<p>The <em>resolution rule</em> is a further generalization of what we just discovered. Here's the idea: because we can view an &quot;or&quot; as an implication, we should be able to apply this idea of chaining implications to <em>clauses</em>.</p>
<p>First, let's agree on how to phrase clauses of more than 2 elements as implications. Suppose we have a clause <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>. Recall that:</p>
<ul>
<li>a clause is a big &quot;or&quot; of literals;</li>
<li>a literal is either a variable or its negation; and </li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5556em;"></span><span class="mord">∨</span></span></span></span> is just another way of writing &quot;or&quot;.</li>
</ul>
<p>We might write <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> as an implication in a number of ways, e.g.:</p>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">))</span></span></span></span></li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">))</span></span></span></span></li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">))</span></span></span></span></li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">((</span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">((</span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">((</span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></li>
</ul>
<p>So if we have a large clause, there may be more ways of phrasing it as an implication than we'd want to write down. Instead, let's make this new rule something that works on clauses directly. </p>
<p>How would we recognize that two clauses can be combined like the above? Well, if we see something like these two clauses: </p>
<ul>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>; and </li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>
then, if we wanted to, we could rewrite them as:</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>; and </li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>
and then apply the rule above to get:</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>.
We could then rewrite the implication back into a clause:</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>.</li>
</ul>
<p>Notice what just happened. The two opposite literals have cancelled out, leaving us with a new clause containing <em>everything else</em> that was in the two original clauses.</p>
<center>
<p>
<p><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.53em;vertical-align:-0.52em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">A</span><span class="mbin mtight">∨</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">A</span><span class="mbin mtight">∨</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mopen mtight">(</span><span class="mord mtight">¬</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mbin mtight">∨</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></p>
</p>                
</center>
<p>This is called the <em>binary propositional resolution rule</em>. It generalizes to something like this (where I've labeled literals in the two clauses with a superscript to tell them apart):</p>
<center>
<p>
<p><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.7258em;vertical-align:-0.5916em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1341em;"><span style="top:-2.6264em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8051em;"><span style="top:-2.1885em;margin-left:-0.0197em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span><span style="top:-2.8448em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3115em;"><span></span></span></span></span></span></span><span class="mbin mtight">∨</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7463em;"><span style="top:-2.214em;margin-left:-0.0197em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286em;"><span></span></span></span></span></span></span><span class="mbin mtight">∨</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8051em;"><span style="top:-2.1885em;margin-left:-0.0197em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span><span style="top:-2.8448em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3115em;"><span></span></span></span></span></span></span><span class="mbin mtight">∨</span><span class="mord mtight">...</span><span class="mbin mtight">∨</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7463em;"><span style="top:-2.214em;margin-left:-0.0197em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">m</span></span></span><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.5102em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.214em;margin-left:-0.0197em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286em;"><span></span></span></span></span></span></span><span class="mbin mtight">∨</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.214em;margin-left:-0.0197em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286em;"><span></span></span></span></span></span></span><span class="mbin mtight">∨</span><span class="mord mtight">...</span><span class="mbin mtight">∨</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.214em;margin-left:-0.0197em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mopen mtight">(</span><span class="mord mtight">¬</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.0197em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">∨</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.214em;margin-left:-0.0197em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286em;"><span></span></span></span></span></span></span><span class="mbin mtight">∨</span><span class="mord mtight">...</span><span class="mbin mtight">∨</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.214em;margin-left:-0.0197em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">m</span></span></span><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5916em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></p>
</p>                
</center>
<p>This rule is a very powerful one. In particular, since unit propagation is a basic version of resolution (<strong>think about why!</strong>) we'll be able to use this idea in our SAT solvers to <em>prove</em> why an input CNF is unsatisfiable.</p>
<h3 id="resolution-proofs-1"><a class="header" href="#resolution-proofs-1">Resolution Proofs</a></h3>
<p>What is a proof? For our purposes today, it's a tree where:</p>
<ul>
<li>each leaf is a clause in some input CNF; and </li>
<li>each internal node is an application of the resolution rule to two other nodes.</li>
</ul>
<p>Here's an example resolution proof that shows the combination of a specific 4 clauses is contradictory:</p>
<p><img src="https://i.imgur.com/fEBkPm7.png" alt="" /></p>
<div id="admonition-proof-trees-are-data" class="admonition admonish-tip">
<div class="admonition-title">
<p>Proof trees are data!</p>
<p><a class="admonition-anchor-link" href="chapters/solvers/resolution.html#admonition-proof-trees-are-data"></a></p>
</div>
<div>
<p>This tree is not a paragraph of text, and it isn't even a picture written on a sheet of paper. It is a <em>data structure</em>, a computational object, which we can process and manipulate in a program.</p>
</div>
</div>
<h3 id="soundness-and-completeness"><a class="header" href="#soundness-and-completeness">Soundness and Completeness</a></h3>
<p>Resolution is a <em>sound</em> proof system. Any correct resolution proof tree shows that its root follows unavoidably from its leaves.</p>
<p>Resolution is also <em>refutation complete</em>. For any unsatisfiable CNF, there exists a resolution proof tree whose leaves are taken from that CNF and whose root is the empty clause. </p>
<p>Resolution is <strong>not</strong> complete in general; it can't be used to derive <em>every</em> consequence of the input. There may be other consequences of the input CNF that resolution can't produce. For a trivial example of this, notice that we cannot use resolution to produce a tautology like <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord">¬</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0197em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> from an empty input, even though a tautology is always true.</p>
<h3 id="getting-some-practice"><a class="header" href="#getting-some-practice">Getting Some Practice</a></h3>
<p>Here's a CNF:</p>
<pre><code>(-1, 2, 3)
(1)
(-2, 4)
(-3, 5)
(-4, -2)
(-5, -3)
</code></pre>
<p>Can you prove that there's a contradiction here?</p>
<details>
<summary>Prove, then click!</summary>
<p>Let's just start applying the rule and generating everything we can...</p>
<p><img src="https://i.imgur.com/o9sNUzk.png" alt="" /></p>
<p>Wow, this is a lot of work! Notice two things:</p>
<ul>
<li>we're going to end up with the same kind of 4-clause contradiction pattern as in the prior example; </li>
<li>it would be nice to have a way to guide generation of the proof, rather than just generating <em>every clause we can</em>. An early form of DPLL did just that, but the full algorithm added the branching and backtracking. So, maybe there's a way to use the structure of DPLL to guide proof generation...</li>
</ul>
</details>
<br/>
<p>Notice that one of the resolution steps you used was, effectively, a unit propagation step. This should help motivate the idea that unit propagation (into a clause were the unit is negated) is a special case of resolution:</p>
<center>
<p>
<p><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.53em;vertical-align:-0.52em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">...</span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">A</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mopen mtight">(</span><span class="mord mtight">¬</span><span class="mord mathnormal mtight">A</span><span class="mbin mtight">∨</span><span class="mord mtight">...</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></p>
</p>                
</center>
<p>You might wonder: what about the other aspect of unit propagation---the removal of clauses entirely when they're subsumed by others? </p>
<details>
<summary>Think, then click!</summary>
<p>This is a fair question! Resolution doesn't account for subsumption because proof is free to disregard clauses it doesn't need to use. So, while subsumption will be used in any solver, it's an optimization.</p>
</details>
<div id="admonition-one-variable-at-a-time" class="admonition admonish-warning">
<div class="admonition-title">
<p>One variable at a time!</p>
<p><a class="admonition-anchor-link" href="chapters/solvers/resolution.html#admonition-one-variable-at-a-time"></a></p>
</div>
<div>
<p>Don't try to &quot;run resolution on multiple variables at once&quot;. To see why not, try resolving the following two clauses:</p>
<pre><code>(1, 2, 3)
(-1, -2, 4)
</code></pre>
<p>It might initially appear that these are a good candidate for resolution. However, notice what happens if we try to resolve on both <code>1</code> and <code>2</code> at the same time. We would get:</p>
<pre><code>(3, 4)
</code></pre>
<p>which is <em>not</em> a consequence of the input! In fact, we've mis-applied the resolution rule. The rule says that if we have <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span></span></span></span> and we have <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">¬</span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mclose">)</span></span></span></span> we can deduce <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mclose">)</span></span></span></span>. These letters can correspond to any formula---but they have to match! If we pick (say) <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span> for <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span>, then we need a clause that contains <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">¬</span><span class="mord mathnormal">A</span></span></span></span>, which is <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">¬</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mclose">)</span></span></span></span>, but that's not possible to see in clause; a clause has to be a big &quot;or&quot; of literals only. So we simply cannot run resolution in this way. </p>
<p>Following the rule correctly, if we only resolve on one variable, we'd get something like this:</p>
<pre><code>(2, -2, 3, 4)
</code></pre>
<p>which is always true, and thus usless in our proof, but at least not unsound. So remember:</p>
<ul>
<li>always resolve on <em>one variable at a time</em>; and</li>
<li>if resolution produces a result that's tautologous, you can just ignore it.</li>
</ul>
</div>
</div>
<h2 id="learning-from-conflicts"><a class="header" href="#learning-from-conflicts">Learning From Conflicts</a></h2>
<p>Let's return to that CNF from before:</p>
<pre><code>(-1, 2, 3)
(1)
(-2, 4)
(-3, 5)
(-4, -2)
(-5, -3)
</code></pre>
<p>Instead of trying to build a <em>proof</em>, let's look at what your DPLL implementations might do when given this input. I'm going to try to sketch that here. Your own implementation may be slightly different. (That doesn't necessarily make it wrong!) If you've started the SAT1 assignment, then open up your implementation as you read, and follow along. If not, note down this example.</p>
<ul>
<li>Called on: <code>[(-1, 2, 3), (1), (-2, 4), (-3, 5), (-4, -2), (-5, -3)]</code></li>
<li>Unit-propagate <code>(1)</code> into <code>(-1, 2, 3)</code> to get <code>(2, 3)</code></li>
<li>There's no more unit-propagation to do, so we need to branch. We know the value of <code>1</code>, so let's branch on <code>2</code> and try <code>True</code> first.</li>
<li>Called on: <code>[(2), (2, 3), (1), (-2, 4), (-3, 5), (-4, -2), (-5, -3)]</code></li>
<li>Unit-propagate <code>(2)</code> into <code>(-2, 4)</code> to get <code>(4)</code>.</li>
<li>Remove <code>(2, 3)</code>, as it is subsumed by <code>(2)</code>.</li>
<li>Unit-propagate <code>(4)</code> into <code>(-4, -2)</code> to get <code>(-2)</code>.</li>
<li>Remove <code>(-2, 4)</code>, as it is subsumed by <code>(4)</code>.</li>
<li>Unit-propagate <code>(-2)</code> into <code>(2)</code> to get the empty clause. </li>
</ul>
<p>Upon deriving the empty clause, we've found a contradiction. <em>Some part</em> of the assumptions we've made so far (here, only that <code>2</code> is <code>True</code>) contradicts the input CNF.</p>
<p>If we wanted to, we could learn a new clause that applies <code>or</code> to (&quot;disjoins&quot;) all the assumptions made to reach this point. But there might be many assumptions in general, so it would be good to do some sort of fast blame analysis: learning a new clause with 5 literals is a lot better than learning a new clause with 20 literals!</p>
<p>Here's the idea: we're going to use the unit-propagation steps we recorded to derive a resolution proof that the input CNF <em>plus any current assumptions</em> lead to the empty clause. We'll then reduce that proof into a &quot;conflict clause&quot;. This is one of the key ideas behind a modern improvement to DPLL: CDCL, or Conflict Driven Clause Learning. We won't talk about all the tricks that CDCL uses here, nor will you have to implement them. If you're curious for more, consider shopping CSCI 2951-O. For now, it suffices to be aware that <strong>reasoning about <em>why</em> a conflict has been reached can be useful for performance.</strong></p>
<p>In the above case, what did we actually use to derive the empty clause? Let's work <em>backwards</em>. We'll try to produce a linear proof where the leaves are input clauses or assumptions, and the internal nodes are unit-propagation steps (remember that these are just a restricted kind of resolution). We ended with:</p>
<ul>
<li>Unit-propagate <code>(-2)</code> into <code>(2)</code> to get the empty clause. </li>
</ul>
<p>The <code>(2)</code> was an assumption. The <code>(-2)</code> was derived:</p>
<ul>
<li>Unit-propagate <code>(4)</code> into <code>(-4, -2)</code> to get <code>(-2)</code>.</li>
</ul>
<p>The <code>(-4, -2)</code> was an input clause. The <code>(4)</code> was derived:</p>
<ul>
<li>Unit-propagate <code>(2)</code> into <code>(-2, 4)</code> to get <code>(4)</code>.</li>
</ul>
<p>The <code>(-2, 4)</code> was an input clause. The <code>(2)</code> was an assumption.</p>
<p>Now we're done; we have a proof:</p>
<p><img src="https://i.imgur.com/H6iqwAf.png" alt="" /></p>
<p>Using only those two input clauses, we know that assuming <code>(2)</code> won't be productive, and (because we have a proof) we can explain why. And, crucially, because the proof is a data structure, we can manipulate it if we need to.</p>
<h2 id="explaining-unsatisfiable-results"><a class="header" href="#explaining-unsatisfiable-results">Explaining Unsatisfiable Results</a></h2>
<p>This is promising: we have a <em>piece</em> of the overall proof of unsatisfiability that we want. But we can't use it alone as a proof that the <em>input</em> is unsatisfiable: the proof currently has an assumption <code>(2)</code> in it. We'd like to convert this proof into one that derives <code>(-2)</code>---the negation of the assumption responsible---from <em>just</em> the input. </p>
<p>Let's rewrite the (contingent, because it relies on an assumption the solver tried) proof we generated before. We'll <em>remove</em> assumptions from the tree and recompute the result of every resolution step, resulting in a proof of something weaker that isn't contingent on any assumptions. To do this, we'll recursively walk the tree, treating inputs as the base case and resolution steps as the recursive case. In the end, we should get something like this:</p>
<p><img src="https://i.imgur.com/oAjYL8V.png" alt="" /></p>
<p>Notice that we need to re-run resolution <em>after processing each node's children</em> to produce the new result for that node. This suggests some of the structure we'll need:</p>
<ul>
<li>If one child is an assiumption, then &quot;promote&quot; the other child and use that value, without re-running resolution. (<strong>Think: Why is this safe to this? It has to do with the way DPLL makes guesses.</strong>) </li>
<li>Otherwise, recur on children first, then re-run resolution on the new child nodes, then return a new node with the new value. </li>
</ul>
<div id="admonition-implementation-advice" class="admonition admonish-note">
<div class="admonition-title">
<p>Implementation Advice</p>
<p><a class="admonition-anchor-link" href="chapters/solvers/resolution.html#admonition-implementation-advice"></a></p>
</div>
<div>
<p>Break down these operations into small helper functions, and write test cases for each of them. Really! It's easy for something to go wrong somewhere in the pipeline, and if your visibility into behavior is only at the top level of DPLL, you'll find it <em>much</em> harder to debug issues. </p>
<p>Remember that you can use PBT on these helpers as well. The assignment doesn't strictly require it, but it can be quite helpful. Use the testing tools that are available to you; they'll help find bugs during development.</p>
</div>
</div>
<h4 id="takeaway"><a class="header" href="#takeaway">Takeaway</a></h4>
<p>This should illustrate <strong>the power of being able to treat proofs as just another data structure</strong>. Resolution proofs are just trees. Because they are trees, we can manipulate them programatically. We just transformed a proof of the empty clause via assumptions into a proof of something else, without assumptions.</p>
<p>This is what you'll do for your homework. </p>
<h3 id="combining-sub-proofs"><a class="header" href="#combining-sub-proofs">Combining sub-proofs</a></h3>
<p>Suppose you ran DPLL on the false branch (assuming <code>(-2)</code>) next. Since the overall input is unsatisfiable, you'd get back a proof of <code>(2)</code> from the inputs. And, given a proof tree for <code>(-2)</code> and a proof tree for <code>(2)</code>, how could you combine them to show that the overall CNF is unsatisfiable? </p>
<details>
<summary>Think, then click!</summary>
<p>Just combine them with a resolution step! If you have a tree rooted in <code>(2)</code> and another tree rooted in <code>(-2)</code>, you'd produce a new resolution step node with those trees as its children, deriving the empty clause.</p>
</details>
<h3 id="property-based-testing-the-unsatisfiable-case"><a class="header" href="#property-based-testing-the-unsatisfiable-case">Property-Based Testing (the unsatisfiable case)</a></h3>
<p>Given one of these resolution proofs of unsatisfiability for an input CNF, you can now apply PBT to your solver's <code>False</code> results, because they are no longer <em>just</em> <code>False</code>.</p>
<p>What properties would you want to hold? </p>
<details>
<summary>Think, then click!</summary>
<p>For the tree to prove that the input is unsatisfiable, you'd need to check:</p>
<ul>
<li>the internal nodes of the tree are valid resolution steps;</li>
<li>the leaves of the tree are taken only from the input clauses; and</li>
<li>the root of the tree is the empty clause.</li>
</ul>
</details>
<!-- ## Pre-Registration!

Pre-registration is upon us soon! Some related courses include the following. I'll restrict myself to those about, or closely related to logic, formal methods, or programming languages, and which can count for the CSCI concentration as of the present version of the [Handbook](https://cs.brown.edu/degrees/undergrad/concentrating-in-cs/concentration-handbook/).

* CSCI 1010 (theory of computation)
* CSCI 1600 (real-time and embedded software)
* CSCI 1730 (programming languages)
* CSCI 1951X (formal proof and verification)
* PHIL 1630 (mathematical logic)
* PHIL 1880 (advanced deductive logic) 
* PHIL 1855 (modal logic)

There are many other great courses---some of which I might argue should also count as upper-level courses for the CSCI concentration, or which are only taught in the Spring semester. For instance, PHIL 1885 covers incompleteness and would be an interesting counterpoint to a more CSCI-focused course on computability.
 -->
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<p>This document is current as of <strong>Forge 3.5.1</strong>.</p>
<!-- Searching the Spring 2024 for relational operators wouldn't work, because the search was alphanumeric. But there is an advanced option -- e.g., `#[doc(alias = "x")]` -- will this work?

## A header on relational transpose

<!-- #[doc(alias = "~")] -->
<p>relational transpose <code>~</code> blah blah</p>
<p>A hidden annotation works for directing a search for <code>foobarbaz</code></p>
<pre><code class="language-forge"><span class="boring"> #[doc(alias = &quot;foobarbaz&quot;)]
</span>example using ~
...
...

</code></pre>
<p>But unfortunately, not for <code>~</code> itself:</p>
<pre><code class="language-forge"><span class="boring"> #[doc(alias = &quot;~&quot;)]
</span>example using ~
...
...

``` --&gt;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<h2 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h2>
<p>To run Forge, you will need to have installed:</p>
<ul>
<li><a href="https://download.racket-lang.org/all-versions.html">Racket</a> (we suggest the latest version, and certainly no lower than 8.7);</li>
<li>Java 11 or later (which you can get <a href="https://www.oracle.com/java/technologies/javase-downloads.html">here</a> if you don't have it); </li>
<li>A modern web-browser for visualizing output (we suggest, and primarily test on, Firefox).</li>
</ul>
<p>We strongly suggest using our VSCode extension to write Forge, although you can also run from the terminal or use DrRacket (Racket's built-in IDE). You can get VSCode <a href="https://code.visualstudio.com">here</a>.</p>
<h2 id="installing-forge"><a class="header" href="#installing-forge">Installing Forge</a></h2>
<p>To install Forge, you have two options. The first is to <strong>install from Racket’s package server</strong>, and the second is to <strong>install from Git</strong>, which also allows (but doesn't require) you to use the latest development build if you wish.</p>
<p>We recommend installing from Git, because this way you can pull updates immediately if you wish to. </p>
<h3 id="installing-from-git"><a class="header" href="#installing-from-git">Installing from Git</a></h3>
<p>To install via Git, open a terminal window. Then: </p>
<ul>
<li>clone our Git repository (<code>git clone https://github.com/tnelson/forge</code>);</li>
<li>change directory to the repository folder (<code>cd forge</code>);</li>
<li>install the <code>forge</code> and <code>froglet</code> packages (<code>raco pkg install ./forge ./froglet</code>).</li>
</ul>
<p>If you wish to switch to the development branch, you must:</p>
<ul>
<li>check out the development branch (<code>git checkout dev</code>);</li>
<li>rebuild Forge (<code>raco setup forge</code>).</li>
</ul>
<div id="admonition-using-" class="admonition admonish-warning">
<div class="admonition-title">
<p>Using ./</p>
<p><a class="admonition-anchor-link" href="docs/getting-started/installation.html#admonition-using-"></a></p>
</div>
<div>
<p>Note the <code>./</code> in the <code>install</code> command! If you write <code>raco pkg install forge froglet</code>, that will install both from the package server instead of your local directory. Adding prefix <code>./</code> tells <code>raco</code> that you're talking about folders instead. It's also important to have both <code>./forge</code> and <code>./froglet</code> in the single command; they depend on each other, so leaving one out will cause <code>raco</code> to &quot;helpfully&quot; install it from the package server, not your local drive.</p>
</div>
</div>
<h3 id="installing-from-rackets-package-servers"><a class="header" href="#installing-from-rackets-package-servers">Installing from Racket's Package Servers</a></h3>
<p>For the standard package-server installation, after installing Racket, run <code>raco pkg install forge froglet</code> from your command line. Alternatively, you can run Racket's IDE, DrRacket, and navigate to <em>File &gt; Install Package</em>. Type <code>forge</code> as the package name and choose <strong>Install</strong>, then do the same for <code>froglet</code> </p>
<p>If the package is already installed, you'll see an <strong>Update</strong> button instead of an <strong>Install</strong> button.</p>
<h4 id="forge-version"><a class="header" href="#forge-version">Forge Version</a></h4>
<p>When you run a Forge file (via <code>racket &lt;filename&gt;</code> at the command line), you'll be told the <em>Forge version</em> you're running. This is important information to include with questions, etc. If you're taking a class that uses Forge, you can expect a few Forge updates throughout the semester---<em>please keep Forge updated!</em></p>
<h2 id="installing-vscode-extension-for-forge"><a class="header" href="#installing-vscode-extension-for-forge">Installing VSCode Extension for Forge</a></h2>
<p>To get Forge's VSCode extension, open VSCode and click the Extensions button on the sidebar: </p>
<center>
<img src="docs/getting-started/./vscode_extension_button.png" width="10%"/>
</center>
<p>Then type <code>forge-language-server</code> in the search bar. You should see an extension with that title, under the developer name &quot;Siddhartha Prasad&quot;. Install it and reload VSCode.</p>
<div id="admonition-for-early-adopters" class="admonition admonish-warning">
<div class="admonition-title">
<p>For early adopters</p>
<p><a class="admonition-anchor-link" href="docs/getting-started/installation.html#admonition-for-early-adopters"></a></p>
</div>
<div>
<p>An early version of this extension was provided via Github, rather than the VSCode Marketplace. Please <strong>use the Marketplace version</strong> (and uninstall the other, if you have it) if for no other reason than it will automatically update when you restart VSCode.</p>
</div>
</div>
<h3 id="logging-in-vscode"><a class="header" href="#logging-in-vscode">Logging in VSCode</a></h3>
<p>If you're working in a file with the <code>.frg</code> extension, you should see an eye icon in your VSCode toolbar (usually on the upper right). This can be used to opt out of (and back into) logging. By default, we log the state of your Forge model whenever you click the run button in VSCode. This includes the contents of every <code>.frg</code> file being edited in VSCode. No other information is recorded, not even your identity. </p>
<div id="admonition-comparison-to-spring-2023" class="admonition admonish-note">
<div class="admonition-title">
<p>Comparison to Spring 2023</p>
<p><a class="admonition-anchor-link" href="docs/getting-started/installation.html#admonition-comparison-to-spring-2023"></a></p>
</div>
<div>
<p>In prior years, logging was done via annotations to <code>#lang</code> in homework files. We no longer do this. A major consequence is that we no longer know your identity from logs; we believe this is an improvement! However, it does mean we can't reach out if we see a problem happening. Please <em>report problems</em> if you see them.</p>
</div>
</div>
<p>We log primarily for two reasons. </p>
<ul>
<li>First, Forge is under active development---the majority of the codebase was written by undergraduate researchers working with Tim! This means that information about how Forge is used, what errors arise, etc. can be useful in making Forge better. </li>
<li>Second, Forge is mainly used in the classroom. It's easy for instructors to claim, anecdotally, that students &quot;like&quot; something or &quot;find it useful&quot; based on a handful of office-hours conversations. We want to hold ourselves to a higher standard. What proportion of students <em>actually uses</em> that feature? Is the hinting we provide on some problems <em>effective</em>? Questions like these are impossible to answer without knowing something about patterns of use. </li>
</ul>
<!-- ## Installing VSCode Extension for GPT-3

This extension allows you to write questions to GPT-3 from your editor. 

---
### Requirements

- Your Brown Provided API Key.
- Your Brown-provided User Id.

--- 

[Once downloaded, the extension can be installed following the instructions here.](https://code.visualstudio.com/docs/editor/extension-marketplace#_install-from-a-vsix)

When the extension is installed, a prompt will appear for you to enter in your API key and your User Id. You must use the extension **only with the API key provided by the course**, obtained from filling out the [responsible-use form](https://docs.google.com/forms/d/e/1FAIpQLSe18e5qNnaZm6JBMsAM3cNJiEC43ElsLyL6IJIN6U3WDOR1-w/viewform?usp=sf_link).

---


### Functionality
#### Ask GPT
Sends user input to GPT for processing. The response will appear in a modal.

> Default key binding set to `alt + g` (Windows) or `cmd + g` (Mac)
> Ask GPT in the Status Bar

#### Ask GPT inline
Queries GPT-3 with highlighted text. The response is automatically injected **below** the highlighted docs.

> Default key binding set to `alt + q` (Windows) or `cmd + q` (Mac)


#### Re-enter API Key

> - Open command palette and run `Update OpenAI API Key` (alt + m on Windows, cmd + m on Mac)
> - Enter your correct API Key into the prompt 
> - Reload VSCODE

#### Re-enter UserId

> - Open command palette and run `Update UserId` (alt + u on Windows, cmd + u on Mac)
> - Enter your correct UserId into the prompt 
> - Reload VSCODE
--- -->
<h2 id="checking-your-installation"><a class="header" href="#checking-your-installation">Checking your installation</a></h2>
<p>Once Racket, Forge, and Java are installed, you should confirm that everything is working properly. Create a text file <code>test.frg</code> with only the contents <code>#lang forge</code> and then, from your command line, type <code>racket test.frg</code>. If this runs without error, congratulations, Forge should now be installed!</p>
<p>If you encounter any issues installing, please report them. We'll do our best to get you help as soon as possible.</p>
<ul>
<li>If you're taking CSCI 1710 at Brown, a class that uses Forge, report bugs on EdStem. </li>
<li>If you don't have a course-related means of reporting bugs, please mail Tim (Tim_Nelson@brown.edu).</li>
</ul>
<h2 id="updating-forge"><a class="header" href="#updating-forge">Updating Forge</a></h2>
<p><strong>Please remember to update using the method appropriate for your install.</strong></p>
<h3 id="if-you-installed-via-rackets-package-system"><a class="header" href="#if-you-installed-via-rackets-package-system">If you installed via Racket's package system</a></h3>
<p>Do:</p>
<ul>
<li><code>raco pkg update forge</code> and </li>
<li><code>raco pkg update froglet</code>.<br />
or click <code>Update</code> for both in the DrRacket package manager.</li>
</ul>
<h3 id="if-you-installed-via-git"><a class="header" href="#if-you-installed-via-git">If you installed via Git</a></h3>
<p>Do:</p>
<ul>
<li><code>cd</code> to the location of the <code>Forge</code> repository on your system;</li>
<li>make sure you're in the branch you want (<code>main</code> for published updates, <code>dev</code> for our development build);</li>
<li><code>git pull</code> in the repository, and then </li>
<li><code>raco setup forge</code> and <code>raco setup froglet</code> (to rebuild the packages). </li>
</ul>
<div id="admonition-confirming-install-location" class="admonition admonish-tip">
<div class="admonition-title">
<p>Confirming install location</p>
<p><a class="admonition-anchor-link" href="docs/getting-started/installation.html#admonition-confirming-install-location"></a></p>
</div>
<div>
<p>Confirm that these packages are installed properly using <code>raco pkg show froglet</code> and <code>raco pkg show forge</code>. </p>
<p>If one is installed from a directory on your machine, and another via the Racket package system, issues can occur. Here's how to read the information that <code>raco</code> provides. If it says: </p>
<ul>
<li><code>link &lt;path on your machine&gt;</code> then the package is installed from a local folder; and </li>
<li><code>catalog ...</code> means the package is installed via Racket's servers.</li>
</ul>
</div>
</div>
<h2 id="known-installation-related-issues"><a class="header" href="#known-installation-related-issues">Known Installation-Related Issues</a></h2>
<h3 id="windows-visualizer-connectivity"><a class="header" href="#windows-visualizer-connectivity">Windows: Visualizer Connectivity</a></h3>
<p>If you use Windows, running Forge from <code>cmd</code> or PowerShell is not recommended (as of January 2024); we strongly suggest using the VSCode extension, DrRacket, the Windows Subsystem for Linux (<code>wsl</code>), Git <code>bash</code>, or Cygwin.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="overview"><a class="header" href="#overview">Overview</a></h1>
<p>Forge is a tool (and a set of languages) that allows us to define models of systems and explore instances of those models. But <strong><em>what does that mean</em></strong>? Let's break it down:</p>
<h2 id="systems"><a class="header" href="#systems">Systems</a></h2>
<p>A <strong>system</strong> can be generally thought of as a particular way that various entities interact.  A system isn't necessarily a <em>computer</em> system, although it can be. For example:</p>
<ul>
<li>The game of baseball is a system involving players, a ball, a field and bases, etc. along with rules that govern how those things interact with each other.</li>
<li>Family trees are a system where there are people, and rules that express how they are related to each other.</li>
<li>A cryptographic protocol is a system where there are parties, messages, cryptographic primitives, and rules that govern how messages can be encrypted, decrypted, sent, and received.</li>
<li>Binary search trees are a system where there are nodes, values, connections between nodes, and rules that govern how nodes can be created, removed, and positioned relative to one another.
<em>There is no limit to the type or complexity of a system that we can discuss</em>, although different tools and techniques are useful for working with and able to express different kinds of systems.</li>
</ul>
<hr />
<h2 id="models"><a class="header" href="#models">Models</a></h2>
<p>A <strong>model</strong> is a <em>representation</em> of a system that faithfully includes some but usually not all of the system's complexity. There are many different ways to model a system, all of which have different advantages and disadvantages. Think about what a car company does before it produces a new car design. Among other things, it creates multiple models. E.g.,</p>
<ul>
<li>it models the car in some computer-aided design tool; and then</li>
<li>creates a physical model of the car, perhaps with clay, for testing in wind tunnels etc.</li>
</ul>
<p>There may be many different models of a system, all of them focused on something different, and all of them useful for something. (As the statisticians say, &quot;all models are wrong, but some models are useful&quot;.)</p>
<p>Models define a notion of what kinds of things exist in the system and (some of) the &quot;rules&quot; governing the system. In a well-crafted model, we can explore what scenarios are possible in the system, which gives us insight and the ability to reason about the system itself---within the bounds of what the model expresses. </p>
<h3 id="example-friends"><a class="header" href="#example-friends">Example: Friends</a></h3>
<p>If we wanted to model a group of friends, we might define our model to have the following structure:</p>
<ul>
<li>There's a type of object, <code>Person</code>, in the system.</li>
<li>Each <code>Person</code> has a <code>bestFriend</code> field, possibly containing a <code>Person</code>.</li>
<li>Each <code>Person</code> has a best friend. </li>
</ul>
<p>These three items correspond to three different concepts in Forge: defining types (<code>sig</code>s), defining fields that those types have, and defining constraints. </p>
<h3 id="a-note-on-imperfect-representations"><a class="header" href="#a-note-on-imperfect-representations">A Note on Imperfect Representations</a></h3>
<p>It is very difficult to fully model some systems. That being said, <em>we don't need to fully model a system for the model to be useful</em>. We can simplify or omit concepts as needed to approximate the system while preserving the fundamentals that we're interested in.</p>
<p>We can see this principle applied in the car-manufacturing example above. You could use a solid clay model of a car to accurately determine the car's aerodynamics in a wind tunnel, but you'd have a hard time exploring how the doors of the car operate or how any of the interior parts work. What you can explore is limited by how the system is modeled. If all you care about is exploring the aerodynamic profile of a car, then we can safely abstract out the internals of the car and focus on the shape. </p>
<p>Likewise, in our &quot;friend group&quot; system example, we don't have to fully describe a <code>Person</code> in our model, we just have to describe the relevant properties of a <code>Person</code>. We abstract the idea of &quot;friendship,&quot; combining all types of friends (best friend, acquaintance, etc.) into a single concept of &quot;friend.&quot; We omit from our model the concept of a <code>Person</code>'s dietary restrictions and myriad other things. These are all choices that affect the scope of our model. If we wanted to distinguish between types of friends, or examine familial relationships as well, we would have to expand the model to include those concepts---and we could!</p>
<p>Learning how to model a system is a key skill for engineers; abstraction is one of our main tools in Computer Science, and modeling lies at the heart of abstraction.</p>
<hr />
<h2 id="instances"><a class="header" href="#instances">Instances</a></h2>
<p>An <strong>instance</strong> is a concrete scenario that abides by the rules of a model, containing specific objects (<em>atoms</em>) and their relationships with each other.</p>
<div id="admonition-analogy-to-oop" class="admonition admonish-warning">
<div class="admonition-title">
<p>Analogy to OOP</p>
<p><a class="admonition-anchor-link" href="docs/building-models/overview.html#admonition-analogy-to-oop"></a></p>
</div>
<div>
<p>We can draw a very rough analogy to object-oriented programming here. We might say:</p>
<ul>
<li>a <code>sig</code> definition, along with its fields, is like a class; and</li>
<li>atoms within an instance of a model are like objects (since each atom belongs to some <code>sig</code>).
This is a useful analogy! </li>
</ul>
<p>Just remember that <strong>it is an analogy and not the exact truth</strong>. There are important differences. For example, you might remember the heap from Java or some other language, and wonder how atoms (analogously to objects) are created or garbage-collected. But <em>there is no heap</em> in Forge instances, only a set of atoms for each <code>sig</code>. Similarly, you might wonder how a Forge model executes. But it doesn't! A Forge model defines a set of possible instances, which the tool searches for.</p>
</div>
</div>
<p>Each instance shows a single way that the constraints in the model can be satisfied. Here are two example instances, described in English:</p>
<ul>
<li>There are two people, <code>Tim</code> and <code>Nim</code>. <code>Tim</code> has <code>Nim</code> as a best friend, and <code>Nim</code> has <code>Tim</code> as a best friend. </li>
<li>There is one person, <code>Nim</code>, who has <code>Nim</code> as a best friend. </li>
<li>There are no people. </li>
</ul>
<p>Why do the second and third instance get produced? Because all we told Forge to enforce was:</p>
<ul>
<li>Each <code>Person</code> must have a best friend.</li>
</ul>
<p>If there are no people, there is nobody to be obligated to have friends. The empty instance satisfies this constraint.</p>
<h2 id="satisfiability-and-unsatisfiability"><a class="header" href="#satisfiability-and-unsatisfiability">Satisfiability and Unsatisfiability</a></h2>
<p>Semi-formally, we'll say that a model is <em>satisfied</em> by an instance if:</p>
<ul>
<li>it contains sets of atoms for every <code>sig</code> in the model; </li>
<li>each atom has fields appropriate to its <code>sig</code>; and </li>
<li>the instance obeys all of the model's constraints. </li>
</ul>
<p>A model is <em>satisfiable</em> if there exists some satisfying instance for it. A model is <em>unsatisfiable</em> if there is no instance that satisfies it. </p>
<div id="admonition-another-example" class="admonition admonish-example">
<div class="admonition-title">
<p>Another example</p>
<p><a class="admonition-anchor-link" href="docs/building-models/overview.html#admonition-another-example"></a></p>
</div>
<div>
<p>If you play Sudoku, you might imagine modeling the game as a set of constraints. Then add:</p>
<ul>
<li>constraints that express the starting puzzle; and </li>
<li>a constraint expressing the need to populate every square in the board.</li>
</ul>
<p>If the starting puzzle has a solution, the model will be satisfiable. If there is no solution, it will be unsatisfiable.</p>
</div>
</div>
<h2 id="next-steps"><a class="header" href="#next-steps">Next Steps</a></h2>
<p>In Forge, we use <a href="docs/building-models/./sigs.html"><code>sig</code>s</a> to define the types that exist in a system, and <a href="docs/building-models/./constraints.html">constraints</a> to define the &quot;rules&quot; of the system.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="addendum-for-alloy-users"><a class="header" href="#addendum-for-alloy-users">Addendum for Alloy Users</a></h1>
<p>All Forge languages (as of January 2024) are restricted versions of Alloy 6, with some added features. </p>
<p>Relational Forge syntax and semantics are nearly identical to Alloy 5. Similarly, Temporal Forge approximates Alloy 6. There are some minor differences. E.g.:</p>
<ul>
<li>All Forge languages eschew the <code>fact</code> construct and <code>sig</code>-facts in favor of using predicates throughout.</li>
<li>Forge disallows some complex field declarations. E.g., one cannot write a bijection as <code>f: A one -&gt; one A</code>. Instead, Forge fields always have exactly one multiplicity keyword and a product of sig names.</li>
<li>Forge introduces new <a href="docs/building-models/../testing-chapter/testing.html">syntax for testing</a>. It also supports <a href="docs/building-models/../running-models/concrete-instance-bounds.html">partial instances</a> via the <code>inst</code> keyword.</li>
<li>Due to user-experience concerns, we have changed the name of the <code>after</code> temporal operator to <code>next_state</code>. This avoids confusion due to Alloy (and Forge's) implicit conjunction; the <code>after</code> in <code>A after B</code> appears at first to be a binary operator, which it is not!</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="sigs"><a class="header" href="#sigs">Sigs</a></h1>
<p><em>Sigs</em> (short for &quot;signatures&quot;) are the basic building block of any model in Forge. They represent the types of the system being modeled. To declare one, use the <code>sig</code> keyword. </p>
<pre><code>sig &lt;name&gt; {}
</code></pre>
<p>A <code>sig</code> can also have one or more <em>fields</em>, which define relationships between members of that <code>sig</code> other atoms. The definition above has no fields because the braces are empty. In contrast, this <code>sig</code> definition would have many fields:</p>
<pre><code>sig &lt;name&gt; {
    &lt;field&gt;,
    &lt;field&gt;,
    ...
    &lt;field&gt;
}
</code></pre>
<div id="admonition-syntax-note" class="admonition admonish-note">
<div class="admonition-title">
<p>Syntax Note</p>
<p><a class="admonition-anchor-link" href="docs/building-models/sigs/sigs.html#admonition-syntax-note"></a></p>
</div>
<div>
<p>Ensure that there is a <strong>comma after every field except for the last one</strong>. This is a common source of compilation errors when first defining a model!</p>
</div>
</div>
<h2 id="fields"><a class="header" href="#fields">Fields</a></h2>
<p>Fields allow us to define relationships between a given <code>sig</code>s and other components of our model. Each <em>field</em> in a <code>sig</code> has:</p>
<ul>
<li>a <em><strong>name</strong></em> for the field;</li>
<li>a <a href="docs/building-models/sigs/./multiplicity.html"><em><strong>multiplicity</strong></em></a> (<code>one</code>, <code>lone</code>, <code>pfunc</code>, <code>func</code>, or, in Relational or Temporal Forge, <code>set</code>);</li>
<li>a <em><strong>type</strong></em> (a <code>-&gt;</code> separated list of <code>sig</code> names, including the built-in sig <a href="docs/building-models/sigs/../../forge-standard-library/constants-and-keywords.html"><code>Int</code></a>)<em><strong>.</strong></em></li>
</ul>
<div id="admonition-example-sig-definition" class="admonition admonish-example">
<div class="admonition-title">
<p>Example sig definition</p>
<p><a class="admonition-anchor-link" href="docs/building-models/sigs/sigs.html#admonition-example-sig-definition"></a></p>
</div>
<div>
<p>Here is a sig that defines the <code>Person</code> type from the <a href="docs/building-models/sigs/../overview.html">overview</a>.</p>
<pre><code>sig Person {
    bestFriend: lone Person
}
</code></pre>
<p>The <code>lone</code> <a href="docs/building-models/sigs/./multiplicity.html">multiplicity</a> says that the field may contain at most one atom. (Note that this example has yet to express the constraint that everyone has a friend!)</p>
</div>
</div>
<h3 id="more-examples"><a class="header" href="#more-examples">More Examples</a></h3>
<p>Let's look at a few more examples.</p>
<div id="admonition-example-sig-with-one-field" class="admonition admonish-example">
<div class="admonition-title">
<p>Example: Sig with one field</p>
<p><a class="admonition-anchor-link" href="docs/building-models/sigs/sigs.html#admonition-example-sig-with-one-field"></a></p>
</div>
<div>
<p><strong>Basic Sig with Fields (Linked List):</strong></p>
<p>A model of a circularly-linked list might have a <code>sig</code> called <code>Node</code>. <code>Node</code> might then have a field <code>next: one Node</code> to represent the contents of every <code>Node</code>'s <code>next</code> reference. We use <code>one</code> here since every <code>Node</code> always has exactly one successor in a <em>circularly</em> linked list. </p>
<pre><code>sig Node {
    next: one Node
}
</code></pre>
</div>
</div>
<div id="admonition-example-sig-with-multiple-fields" class="admonition admonish-example">
<div class="admonition-title">
<p>Example: Sig with multiple fields</p>
<p><a class="admonition-anchor-link" href="docs/building-models/sigs/sigs.html#admonition-example-sig-with-multiple-fields"></a></p>
</div>
<div>
<p><strong>Basic Sig with Fields (Binary Tree):</strong></p>
<p>A model of a binary tree might have a <code>sig</code> called <code>Node</code>. <code>Node</code> might then have three fields:</p>
<ul>
<li><code>left: lone Node</code> and <code>right: lone Node</code> to represent the <code>Node</code>'s children. We use <code>lone</code> here since the left/right child fields can either be empty or contain exactly one <code>Node</code>.</li>
<li><code>val: one Int</code> to represent the value of each Node, where we have decided that every <code>Node</code> should have an <code>Int</code>eger value. We use <code>one</code> here because each <code>Node</code> should have exactly one value.</li>
</ul>
<pre><code>sig Node {
    left: lone Node,
    right: lone Node,
    val: one Int
}
</code></pre>
<p><em><code>Int</code> is a built-in sig provided by Forge. To learn more about how Forge handles integers, see <a href="docs/building-models/sigs/../../forge-standard-library/integers.html">Integers in Forge</a>.</em></p>
</div>
</div>
<div id="admonition-example-sig-with-no-fields" class="admonition admonish-example">
<div class="admonition-title">
<p>Example: Sig with No Fields</p>
<p><a class="admonition-anchor-link" href="docs/building-models/sigs/sigs.html#admonition-example-sig-with-no-fields"></a></p>
</div>
<div>
<p><strong>Example - Basic Sig without Fields:</strong></p>
<p>Not every <code>sig</code> in a model needs to have fields to be a useful part of the model! <code>sig</code>s with no fields are often used in conjunction with other <code>sig</code>s that reference them. One such example might look like this:</p>
<pre><code>sig Student {}
sig Group {
    member: set Student
}
</code></pre>
<p>Note that the <code>set</code> multiplicity is only available in Relational and Temporal Forge, not Froglet.</p>
</div>
</div>
<div id="admonition-field-names-must-be-unique" class="admonition admonish-warning">
<div class="admonition-title">
<p>Field names must be unique</p>
<p><a class="admonition-anchor-link" href="docs/building-models/sigs/sigs.html#admonition-field-names-must-be-unique"></a></p>
</div>
<div>
<p>You cannot use the same field name within two different <code>sigs</code> in a model. This is because field names are globally available for writing constraints.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="inheritance"><a class="header" href="#inheritance">Inheritance</a></h1>
<p>Sigs may inherit from other sigs via the <code>extends</code> keyword:</p>
<pre><code class="language-clike">sig &lt;name&gt; extends &lt;parent sig name&gt; {
    &lt;additional fields&gt; ...
}
</code></pre>
<p>Sigs may only have <em>at most one parent sig</em>. Moreover, much like how no object can be belong to multiple top-level sigs, no object can belong to more than one immediate child of any sig. That is, any two sigs <code>A</code> and <code>B</code> will never contain an object in common unless one is a descendent of the other. </p>
<div id="admonition-different-kinds-of-cat" class="admonition admonish-example">
<div class="admonition-title">
<p>Different kinds of cat</p>
<p><a class="admonition-anchor-link" href="docs/building-models/sigs/inheritance.html#admonition-different-kinds-of-cat"></a></p>
</div>
<div>
<pre><code class="language-clike">sig Cat {
    favoriteFood: one Food
}
sig ActorCat extends Cat {
    playName: one Play
}
sig ProgrammerCat extends Cat {}
</code></pre>
<p>This means that any <code>ProgrammerCat</code> object is also a <code>Cat</code> object, and so will have a <code>favoriteFood</code> field. But only <code>ActorCat</code>s have the <code>playName</code> field. Moreover, any cat may be either an <code>ActorCat</code>, <code>ProgrammerCat</code>, or neither---but not both.</p>
</div>
</div>
<div id="admonition-inheritance-and-bounds" class="admonition admonish-warning">
<div class="admonition-title">
<p>Inheritance and Bounds</p>
<p><a class="admonition-anchor-link" href="docs/building-models/sigs/inheritance.html#admonition-inheritance-and-bounds"></a></p>
</div>
<div>
<p>Forge must have bounds for <em>every</em> sig, including child sigs. The default of 0-to-4 objects is applied to every top-level sig. Forge can often infer consistent bounds for child sigs, but it cannot always do so and will require you to provide them. This is most often the case in the presence of complex hierarchies involving <code>abstract</code> and <code>one</code> sigs. </p>
<p>More importantly, <code>example</code> and <code>inst</code> syntax require the contents of parent sigs to be defined once the contents of a single child are set. To see why, consider this example:</p>
<pre><code class="language-clike">example workingCats is {myPredicate} for {
    ActorCat = `ActorCat0 + `ActorCat1
    ProgrammerCat = `ProgrammerCat0 + `ProgrammerCat1
}
</code></pre>
<p>This produces an error: </p>
<blockquote>
<p>run: Please specify an upper bound for ancestors of ActorCat.</p>
</blockquote>
<p>This error occurs because Forge knows only that there are 2 specific actors and 2 specific programmers, and can't infer whether any <em>other</em> cats exist. To fix the error, provide bounds for the parent sig:</p>
<pre><code class="language-clike">example workingCats is {myPredicate} for {    
    ActorCat = `ActorCat0 + `ActorCat1
    ProgrammerCat = `ProgrammerCat0 + `ProgrammerCat1
    Cat = `ActorCat0 + `ActorCat1 + `ProgrammerCat0 + `ProgrammerCat1
}
</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="singleton-and-maybe-sigs"><a class="header" href="#singleton-and-maybe-sigs">Singleton and Maybe Sigs</a></h1>
<p>A sig declaration can be annotated to indicate:</p>
<ul>
<li>that there is always exactly one object of that sig (<code>one sig</code>);</li>
<li>that there is never more than one object of that sig (<code>lone sig</code>); or</li>
<li>that any object of that sig must also be a member of some child sig (<code>abstract sig</code>).</li>
</ul>
<div id="admonition-one-sig" class="admonition admonish-example">
<div class="admonition-title">
<p>One Sig</p>
<p><a class="admonition-anchor-link" href="docs/building-models/sigs/singleton-maybe-sigs.html#admonition-one-sig"></a></p>
</div>
<div>
<pre><code class="language-clike">sig Dog {}
-- &quot;Beauty without Vanity, Courage without Ferosity, Strength without Insolence&quot;
one sig Boatswain extends Dog {}
</code></pre>
<p>If you'd asked <a href="https://en.wikipedia.org/wiki/Epitaph_to_a_Dog">Lord Byron</a>, there was only one Boatswain---whose tomb was famously larger than Lord Byron's own.</p>
</div>
</div>
<div id="admonition-abstract-sig" class="admonition admonish-example">
<div class="admonition-title">
<p>Abstract Sig</p>
<p><a class="admonition-anchor-link" href="docs/building-models/sigs/singleton-maybe-sigs.html#admonition-abstract-sig"></a></p>
</div>
<div>
<pre><code class="language-clike">abstract sig Student {}
sig Undergrad, Grad extends Student {}
</code></pre>
<p>In this example, any <code>Student</code> must be either an <code>Undergrad</code> or <code>Grad</code> student.</p>
</div>
</div>
<div id="admonition-lone-sig" class="admonition admonish-example">
<div class="admonition-title">
<p>Lone Sig</p>
<p><a class="admonition-anchor-link" href="docs/building-models/sigs/singleton-maybe-sigs.html#admonition-lone-sig"></a></p>
</div>
<div>
<p>Lone sigs aren't used much; you can think of them in the same way you'd use a <code>one</code> sig, but with the possibility that the sig will be empty. This can sometimes be useful for efficiency. E.g., if we were modeling soup recipes:</p>
<pre><code class="language-clike">abstract sig Ingredient {}
lone sig Potatoes extends Ingredient {}
lone sig Carrots extends Ingredient {}
lone sig Celery extends Ingredient {}
lone sig Water extends Ingredient {}
// ...
</code></pre>
<p>There might be dozens of possible ingredients. But if we only want to use a few at a time, it can be useful to set a lower bound on <code>Ingredient</code> and allow un-used ingredients to simply not exist.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="field-multiplicity"><a class="header" href="#field-multiplicity">Field Multiplicity</a></h1>
<p>While types define what kinds of data can fit into a specific field, <em>multiplicities</em> define how that data can be arranged. For example, multiplicities will say whether or not a field can be empty.</p>
<h2 id="singleton-fields"><a class="header" href="#singleton-fields">Singleton fields</a></h2>
<p>If you're declaring a field that is meant to hold a single value, and not something like a function, there are two possible multiplicities: <code>one</code> (which means that a value must always be present) and <code>lone</code> (which means that a value <em>may</em> be present). </p>
<ul>
<li><code>one</code>: a singleton value (this field always contains a single object); and</li>
<li><code>lone</code>: either a singleton value or no value (this field contains 0 or 1 object).</li>
</ul>
<div id="admonition-examples" class="admonition admonish-example">
<div class="admonition-title">
<p>Examples</p>
<p><a class="admonition-anchor-link" href="docs/building-models/sigs/multiplicity.html#admonition-examples"></a></p>
</div>
<div>
<p>This definition of a <code>Student</code> sig enforces that every student has an advisor, but not every student has a concentration.</p>
<pre><code>sig Student {
    advisor: one Faculty, 
    concentration: lone Concentration
}
</code></pre>
<p>If we later write constraints about students, it is possible for a student's concentration to evaluate to <code>none</code>.</p>
</div>
</div>
<h2 id="set-fields-relational-and-temporal-forge-only"><a class="header" href="#set-fields-relational-and-temporal-forge-only">Set fields (Relational and Temporal Forge only)</a></h2>
<p>If you're declaring a field that holds a set of atoms, use the <code>set</code> multiplicity.</p>
<div id="admonition-examples-1" class="admonition admonish-example">
<div class="admonition-title">
<p>Examples</p>
<p><a class="admonition-anchor-link" href="docs/building-models/sigs/multiplicity.html#admonition-examples-1"></a></p>
</div>
<div>
<p>Let's add a field for the friends a student has at Brown:</p>
<pre><code>sig Student {
    advisor: one Faculty, 
    concentration: lone Concentration,
    friends: set Student -- in reality, perhaps not only students!
}
</code></pre>
<p>A student's friends may evaluate to <code>none</code>, just as in the <code>lone</code> multiplicity. But it might also evaluate to set of more than one student.</p>
</div>
</div>
<div id="admonition-no-sets-in-froglet" class="admonition admonish-warning">
<div class="admonition-title">
<p>No sets in Froglet!</p>
<p><a class="admonition-anchor-link" href="docs/building-models/sigs/multiplicity.html#admonition-no-sets-in-froglet"></a></p>
</div>
<div>
<p>Froglet does not support the <code>set</code> multiplicity, because sets add a layer of complexity to the language. If you <em>really</em> need to model sets in Froglet, you an approximate them using boolean-valued functions (see below).</p>
</div>
</div>
<h2 id="function-fields"><a class="header" href="#function-fields">Function Fields</a></h2>
<p>If you want a field that is a function or partial function, use the <code>func</code> or <code>pfunc</code> multiplicities. (If you view singleton fields as functions that take no arguments, <code>func</code> and <code>pfunc</code> are analogous to <code>one</code> and <code>lone</code>.) These multiplicities only work if the field's type involves more than one sig. Suppose we are defining a function field meant to map elements of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">...</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span> to elements of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span>. Then:</p>
<ul>
<li><code>func A -&gt; B -&gt; ... -&gt; Y -&gt; Z</code>: denotes a total function with the above domain and co-domain. Because it is a <em>total</em> function, every possible input must have exactly one output value.</li>
<li><code>pfunc A -&gt; B -&gt; ... -&gt; Y -&gt; Z</code>: denotes a partial function with the above domain and co-domain. Because the function may be partial, every possible input has either one output value or is not mapped by the function.</li>
</ul>
<div id="admonition-examples-2" class="admonition admonish-example">
<div class="admonition-title">
<p>Examples</p>
<p><a class="admonition-anchor-link" href="docs/building-models/sigs/multiplicity.html#admonition-examples-2"></a></p>
</div>
<div>
<p>Let's add a function that says what grade a student got in a given class. Because students don't take every course available, we might use a partial function for this:</p>
<pre><code>sig Student {
    advisor: one Faculty, 
    concentration: lone Concentration,
    grades: pfunc Course -&gt; Grade
}
</code></pre>
<p>If we later write constraints about students, it is possible for a student's grade in a particilar class to evaluate to <code>none</code>.</p>
</div>
</div>
<div id="admonition-intuition" class="admonition admonish-note">
<div class="admonition-title">
<p>Intuition</p>
<p><a class="admonition-anchor-link" href="docs/building-models/sigs/multiplicity.html#admonition-intuition"></a></p>
</div>
<div>
<p>Fields declared as <code>pfunc</code> are analogous to maps or dictionaries in an object-oriented programming language: some keys may not map to values, but if a key is mapped it is mapped to exactly one value. </p>
<p>Keep in mind that, unlike in (say) Java, the functions themselves are not objects on a heap, but rather just tables of values being mapped to other values.</p>
</div>
</div>
<h2 id="relation-fields-relational-and-temporal-forge-only"><a class="header" href="#relation-fields-relational-and-temporal-forge-only">Relation Fields (Relational and Temporal Forge only)</a></h2>
<p>If you want a field to represent an arbitrary <em>relation</em> that may or may not be a function, use the <code>set</code> multiplicity instead of <code>pfunc</code> or <code>func</code>.</p>
<div id="admonition-examples-3" class="admonition admonish-example">
<div class="admonition-title">
<p>Examples</p>
<p><a class="admonition-anchor-link" href="docs/building-models/sigs/multiplicity.html#admonition-examples-3"></a></p>
</div>
<div>
<p>Perhaps we want to keep track of the set of project partners a student had during a particular course:</p>
<pre><code>sig Student {
    advisor: one Faculty, 
    concentration: lone Concentration,
    partnersIn: set Course -&gt; Student
}
</code></pre>
<p>Now, for a given student, <code>partnersIn</code> might map to more than one student for a given class. Neither <code>func</code> nor <code>pfunc</code> would allow this.</p>
</div>
</div>
<div id="admonition-no-sets-in-froglet-1" class="admonition admonish-warning">
<div class="admonition-title">
<p>No sets in Froglet!</p>
<p><a class="admonition-anchor-link" href="docs/building-models/sigs/multiplicity.html#admonition-no-sets-in-froglet-1"></a></p>
</div>
<div>
<p>Froglet does not support the <code>set</code> multiplicity, because sets add a layer of complexity to the language. If you <em>really</em> need to model sets in Froglet, you an approximate them using boolean-valued functions (see below).</p>
</div>
</div>
<div id="admonition-approximating-sets-and-relations-in-froglet" class="admonition admonish-tip">
<div class="admonition-title">
<p>Approximating sets and relations in Froglet</p>
<p><a class="admonition-anchor-link" href="docs/building-models/sigs/multiplicity.html#admonition-approximating-sets-and-relations-in-froglet"></a></p>
</div>
<div>
<p>If you really need something like sets, but are working in Froglet, you can use the following trick.</p>
<pre><code>abstract sig Boolean {}
one sig True, False extends Boolean {}
sig Student {
    advisor: one Faculty, 
    concentration: lone Concentration,
    partnersIn: func (Course -&gt; Student) -&gt; Boolean
}
</code></pre>
<p>Alternatively, you can represent booleans <em>slightly</em> more efficiently as the presence (or non-presence) of a mapping in a partial function:</p>
<pre><code>one sig Yes {}
sig Student {
    advisor: one Faculty, 
    concentration: lone Concentration,
    partnersIn: pfunc (Course -&gt; Student) -&gt; Yes
}
</code></pre>
</div>
</div><div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="advanced-material-how-do-sigs-and-fields-work"><a class="header" href="#advanced-material-how-do-sigs-and-fields-work">Advanced Material (How do sigs and fields work?)</a></h1>
<p>In case you're curious, we include a very brief sketch of how sigs, fields, etc. relate to Forge's core solver engine. This information might be useful when debugging a tough problem or just for understanding the tool better.</p>
<div id="admonition-froglet" class="admonition admonish-warning">
<div class="admonition-title">
<p>Froglet</p>
<p><a class="admonition-anchor-link" href="docs/building-models/sigs/advanced.html#admonition-froglet"></a></p>
</div>
<div>
<p>If you are currently working in Froglet, you may see terms in this document that you aren't yet familiar with.</p>
</div>
</div>
<p>Forge's solver engine works entirely in terms of <em>sets</em>, regardless of which Forge language you are using. Each <code>sig</code> name corresponds to the set of atoms of that type in a given instance. Similarly, each field name <code>f</code> corresponds to a relation (set) with arity <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mclose">)</span></span></span></span>. (The extra column in the relation holds the atom the field value belongs to.) </p>
<div id="admonition-arity" class="admonition admonish-note">
<div class="admonition-title">
<p>Arity</p>
<p><a class="admonition-anchor-link" href="docs/building-models/sigs/advanced.html#admonition-arity"></a></p>
</div>
<div>
<p>The <em>arity</em> of a set is how many elements its member tuples contain. E.g., a set of atoms would have arity 1, but a set of pairs of atoms would have arity 2.</p>
</div>
</div>
<p>E.g.,</p>
<pre><code>sig B {}
sig A {
    myField: set A -&gt; B
}
</code></pre>
<p>is internally represented as a pair of sets <code>A</code> and <code>B</code> and a 3-ary relation named <code>myField</code> that must be a subset of <code>A -&gt; A -&gt; B</code> in any instance. </p>
<h2 id="the-role-of-bounds"><a class="header" href="#the-role-of-bounds">The role of bounds</a></h2>
<p>Because every <code>run</code> is always equipped with a finite bound on every sig, the solver is then able to convert Forge constraints to a purely boolean logic problem, where every <em>possible</em> membership in each set is assigned a unique boolean variable. </p>
<div id="admonition-compiling-a-forge-problem" class="admonition admonish-example">
<div class="admonition-title">
<p>Compiling a Forge problem</p>
<p><a class="admonition-anchor-link" href="docs/building-models/sigs/advanced.html#admonition-compiling-a-forge-problem"></a></p>
</div>
<div>
<pre><code class="language-clike">#lang forge
sig Person {
    bestFriend: one Person
}
run {
    all p: Person | { 
        some disj p1, p2: Person | {
            p1.bestFriend = p 
            p2.bestFriend = p
        }
    }
} for exactly 4 Person
</code></pre>
<p>This model defines two sets: </p>
<ul>
<li><code>Person</code>, of arity 1; and</li>
<li><code>bestFriend</code>, of arity 2.</li>
</ul>
<p>Since there are exactly 4 people allowed by the <code>run</code>, the contents of <code>Person</code> is fixed. But <code>bestFriend</code> may contain any pair of <code>Person</code> objects. There are <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">16</span></span></span></span> possible pairs, and so there are 16 boolean variables needed to define the <code>bestFriend</code> field.</p>
<p>You can see these reflected in the <em>primary variable</em> portion of the statistical output Forge gives when running this file:</p>
<pre><code>#vars: (size-variables 178); #primary: (size-primary 16); #clauses: (size-clauses 311)
</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="constraints"><a class="header" href="#constraints">Constraints</a></h1>
<p>Once the model has defined the kinds of objects it deals with, it defines <em>constraints</em> that limit how those objects can behave.</p>
<h2 id="rules-vs-instructions"><a class="header" href="#rules-vs-instructions">Rules vs. Instructions</a></h2>
<p>This idea of a <em>constraint</em> is key in Forge (and in many other modeling languages), and it's very different from programming in a language like Java, Pyret, or Python.</p>
<p>When you're programming traditionally, you give the computer a set of instructions and it follows those instructions. This is true whether you're programming functionally or imperatively, with or without objects, etc. In contrast, modeling languages like Forge work differently. The goal of a Forge model isn't to <em>run instructions</em>, but rather to <em>express the rules</em> that govern systems.</p>
<p>Here's a useful comparison to help reinforce the difference (with thanks to Daniel Jackson):</p>
<ul>
<li>Given a lack of <strong>instructions</strong>, a program <em>does</em> nothing.</li>
<li>Given a lack of <strong>constraints</strong>, a model <em>allows</em> everything.</li>
</ul>
<h2 id="example-concentration-requirements"><a class="header" href="#example-concentration-requirements">Example: Concentration Requirements</a></h2>
<p>Let's get concrete. <a href="https://cs.brown.edu/degrees/undergrad/concentrating-in-cs/concentration-requirements-2020/new-ab-requirements/">The concentration requirements for an A.B. in CSCI</a> state that to get an A.B., a student must (among other things) complete a pathway, which comprises two upper-level courses. We might rewrite this as:</p>
<blockquote>
<p>&quot;Every student who gets an A.B. must have passed two 1000-level courses in the same pathway.&quot;</p>
</blockquote>
<p>If we're modeling concentration requirements, we might decide to create <code>sig</code>s for <code>Student</code>, <code>Course</code>, <code>Pathway</code>, and so on, with fields you'd expect. For example, we might create:</p>
<pre><code>sig Student {
  -- dictionary of grades for courses taken and passed
  grades: pfunc Course -&gt; Grade
}
</code></pre>
<p>But this only describes the shape of the data, not the concentration requirements themselves! To do that, we need to create some constraints. The sentence above states a requirement for <em>every student</em>. Generally the department follows this rule. But it's possible to imagine some semester where the department makes a mistake, and gives an A.B. degrees to someone who hadn't actually finished a pathway. The sentence is something that could be true or false in any given semester:</p>
<blockquote>
<p>&quot;<span style="color:cyan">Every student</span> who gets an A.B. must have passed two 1000-level courses in the same pathway.&quot;</p>
</blockquote>
<p>In Forge, we'd write this for-all using a quantifier: </p>
<pre><code><span style="color:cyan">all s: Student</span> | ...
</code></pre>
<p>Then we have a condition that triggers a requirement: <em>if</em> a student has gotten an A.B., then something is required. In Forge, this becomes an implication inside the quantifier: </p>
<pre><code>all s: Student | s.degreeGranted = AB implies {...}
</code></pre>
<p>Let's look more closely at the part we wrote: <code>s.degreeGranted = AB</code>. For a given student, that is also either true or false. But something important is different inside the <code>=</code>: <code>s.degreeGranted</code> doesn't denote a boolean, but rather an <em>atom</em> in some instance (which will perhaps be equal to <code>AB</code>). These are very different kinds of syntax. A similar thing is true for <code>s</code>, <code>course1</code>, and <code>course2</code>. Let's finish writing the constraint and then color-code the different parts:</p>
<pre><code><span style="color:green">all <span style="color:red">s</span>: <span style="color:red">Student</span> |</span> <span style="color:red">s.degreeGranted</span> <span style="color:green">=</span> <span style="color:red">AB</span> <span style="color:green">implies { 
  some disj <span style="color:red">course1</span>, <span style="color:red">course2</span>: <span style="color:red">Course</span> |</span> <span style="color:red">course1.pathway</span> <span style="color:green">=</span> <span style="color:red">course2.pathway</span>
<span style="color:green">}</span>
</code>
</pre>
<p>The <span style="color:green">green</span> syntax is about whether something is true or false. The <span style="color:red">red</span> syntax is about identifying specific atoms in an instance. By using both kinds of syntax, you can express constraints about the shape of instances. </p>
<ul>
<li>without <span style="color:green">boolean-valued syntax</span>, you couldn't express implications, &quot;or&quot;, &quot;and&quot;, etc.</li>
<li>without <span style="color:red">atom-valued syntax</span>, you could only talk about abstract boolean values, not actual atoms in the world.</li>
</ul>
<h3 id="writing-constraints-formulas-vs-expressions"><a class="header" href="#writing-constraints-formulas-vs-expressions">Writing Constraints: Formulas vs. Expressions</a></h3>
<p>The top-level constraints that Forge works with must always evaluate to booleans, but the inner workings of constraints can speak about specific objects, the values of their fields, and so on. We'll make the distinction between these two different kinds of syntax:</p>
<ul>
<li><span style="color:green"><em>Formulas</em></span> always evaluate to booleans---i.e., either true or false; and</li>
<li><span style="color:red"><em>Expressions</em></span> always evaluate to objects or sets of objects. </li>
</ul>
<div id="admonition-forge-isnt-truthy" class="admonition admonish-warning">
<div class="admonition-title">
<p>Forge isn't 'truthy'</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/constraints.html#admonition-forge-isnt-truthy"></a></p>
</div>
<div>
<p>Unlike what would happen in a programming language like JavaScript or Python, attempting to use an expression in place of a formula, or vice versa, will produce an error in Forge when you try to run your model. For example, if we wrote the constraint <code>all s: Student | s.grades</code>, what would that mean? That every <code>s</code> exists? That every <code>s</code> has passed some class? Something different? To avoid this ambiguity, Forge doesn't try to infer your meaning, and just gives an error. </p>
<p><strong>Always ask, for every word you write: are you writing about what must be true, or naming some atom or set of atoms?</strong></p>
</div>
</div>
<h3 id="context-for-evaluating-constraints-instances"><a class="header" href="#context-for-evaluating-constraints-instances">Context for Evaluating Constraints: Instances</a></h3>
<p>Notice that there's always a context that helps us decide whether a constraint yields true or false. In the above example, the context is a collection of students, courses taken and degrees granted. For some other model, it might be a tic-tac-toe board, a run of a distributed system, a game of baseball, etc. We'll call these  <em>instances</em>. An instance contains:</p>
<ul>
<li>a set of atoms for each <code>sig</code> definition (the objects of that type in the world); and </li>
<li>a concrete function (or partial function) for each field of the appropriate type. 
Together, these give the context that makes it possible to tell whether constraints have been satisfied or not. </li>
</ul>
<div id="admonition-relational-forge" class="admonition admonish-note">
<div class="admonition-title">
<p>Relational Forge</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/constraints.html#admonition-relational-forge"></a></p>
</div>
<div>
<p>Once you move from Froglet to Relational Forge, the value of a field might be an arbitrary relation, and not a function.</p>
</div>
</div>
<hr />
<!--
_TODO: BEFORE TALKING ABOUT IMPL DETAILS OF CONSTRAINTS IN FORGE, LET'S TALK ABOUT HOW CONSTRAINTS PLAY INTO BUILDING MODELS BY LOOKING AT AN EXAMPLE_ -->
<!-- Let's bring back the [linked list](../../building-models/sigs/sigs.md#admonition-example-sig-w-one-field) example we saw when learning about sigs:

```
sig Node {
    next: one Node
}
```

If the point of modeling linked-lists is to learn things about the linked-list systems, we have to -->
<!--
![LinkedList-Normal](../../../images/constraints/LinkedList-normal.png)
![LL-Weird-A](../../images/constraints/LinkedList-weird-A.png) -->
<!-- ![Linked-List-Weird-B](../../images/constraints/LinkedList-weird-B.png)

Let's look at the example we first introduced when discussing sigs, [a linked list](../../building-models/sigs/sigs.md#admonition-example-sig-w-one-field)

We _constrain_ the acceptable outputs of the model by defining more rules and being more specific about the constraints of the model. In general, the more rules we add, the fewer acceptable outputs.

a model with a lack of rules just means that you are allowing lots of things to be acceptable instances of the model!

Forge will by default try and give you all possible instances -->
<!-- In Forge, the computer already has a set of instructions: construct instances of the model based on how you defined the "things" and "rules" of the model. -->
<h2 id="next-steps-1"><a class="header" href="#next-steps-1">Next Steps</a></h2>
<p>The next sections describe <a href="docs/building-models/constraints/./formulas/formulas.html">formula</a> and <a href="docs/building-models/constraints/./expressions/expressions.html">expression</a> syntax in more detail. A reader familiar with this syntax is free to skip to the section on <a href="docs/building-models/constraints/./instances.html">instances</a>, or progress to <a href="docs/building-models/constraints/../../running-models/running.html">running models</a> in Forge.</p>
<div id="admonition-temporal-forge" class="admonition admonish-info">
<div class="admonition-title">
<p>Temporal Forge</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/constraints.html#admonition-temporal-forge"></a></p>
</div>
<div>
<p>For more information on <em>temporal</em> operators, which are only supported in Relational Forge, see the page on <a href="docs/building-models/constraints/../../electrum/electrum-overview.html">Temporal Mode</a>. We maintain these in separate chapter because the meaning of constraints in this mode can differ subtly.</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="instances-1"><a class="header" href="#instances-1">Instances</a></h1>
<h2 id="intuition"><a class="header" href="#intuition">Intuition</a></h2>
<p>Forge <em>instances</em> give the context in which constraints are evaluated. E.g., an instance might describe:</p>
<ul>
<li>Tim's family tree, going back 3 generations;</li>
<li>CSCI courses offered at Brown this semester, with information on who teaches each;</li>
<li>the current state of a chessboard;</li>
<li>an entire game of tic-tac-toe;</li>
<li>etc.
What an instance contains depends on the current model. Family-tree instances would make sense if the model had defined people, a parenthood relationship, etc.---but not if it was about the game of chess!</li>
</ul>
<p>An instance gives concrete values for <code>sig</code>s and their fields. It says which atoms actually exist in the world, and what their fields contain. This is what gives constraints their meaning. We could write a model of tic-tac-toe in Forge, but statements like &quot;some player has won the game&quot; is neither true nor false by itself---<strong>it depends on the instance</strong>. </p>
<p>The remainder of this page defines instances more formally.</p>
<div id="admonition-warning" class="admonition admonish-warning">
<div class="admonition-title">
<p>Warning</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/instances.html#admonition-warning"></a></p>
</div>
<div>
<p>If you are working in Froglet, the remainder of this page may reference terms you are as yet unfamiliar with. Don't worry; this will be covered more in class. Informally, you might read &quot;relation&quot; as &quot;function&quot;.</p>
<pre><code>
&lt;/div&gt;
&lt;/div&gt;

## Formal Definition of Instances

Because `sig` definitions can involve concepts like inheritance, partial functions, and uniqueness, the precise definition is a bit involved.

Consider an arbitrary Forge model $M$ that defines some `sig`s and fields.

An _instance_ is a collection of finite sets for each `sig` and field in the model. For each `sig S` in the model, an instance contains a set $S$ where:
  - if `S` has a parent `sig P`, then the contents of $S$ must be a subset of the contents of $P$;
  - for any pair of child-sigs of `S`, `C1` and `C2`, $C_1$ and $C_2$ have no elements in common; 
  - if `S` is declared `abstract` and has child sigs, then any object in $S$ must also be present in $C$ for some `sig C` that extends `sig S`; and
  - if `S` is declared `one` or `lone`, then $S$ contains exactly one or at most one object, respectively.

For each field `f` of type `S1 -&gt; ... -&gt; Sn` of `sig S` in the model, an instance contains a set $f$ where:
  - $f$ is subset of the cross product $S\times S_1 \times ... \times S_N$;
  - if `f` is declared `one` or `lone`, then $f$ can only contain exactly one or at most one object, respectively;
  - if `f` is declared `func`, then there is exactly one entry in $f$ for each $(s, s_1, ..., s_{n-1})$ in $S\times S_1 \times ... \times S_{(n-1)}$.
  - if `f` is declared `pfunc`, then there is at most one entry in $f$ for each $(s, s_1, ..., s_{n-1})$ in $S\times S_1 \times ... \times S_{(n-1)}$.

The union over all `sig`-sets $S$ in an instance (including the built-in sig `Int`) is said to be the _universe_ of that instance.


&lt;div id=&quot;admonition-fields-are-not-objects&quot; class=&quot;admonition admonish-tip&quot;&gt;
&lt;div class=&quot;admonition-title&quot;&gt;

Fields are not objects

&lt;a class=&quot;admonition-anchor-link&quot; href=&quot;#admonition-fields-are-not-objects&quot;&gt;&lt;/a&gt;
&lt;/div&gt;
&lt;div&gt;

It is sometimes useful to use terminology from object-oriented programming to think about Forge models. For example, we can think of a `pfunc` field like a dictionary in Python or a map in Java. However, _a field is not an object_. This matters for at least two reasons:
- We can't write a constraint like &quot;every `pfunc` field in the model is non-empty&quot;, because there's no set of `pfunc` &quot;objects&quot; to examine.
- Two different objects in an instance will be considered non-equal in Forge, even if they belong to the same `sig` and have identical field contents. In contrast, two fields themselves are equal in Forge if they have identical contents; fields are relations that involve atoms, not objects themselves.

&lt;/div&gt;
&lt;/div&gt;
  

&lt;div id=&quot;admonition-tuples-arity&quot; class=&quot;admonition admonish-info&quot;&gt;
&lt;div class=&quot;admonition-title&quot;&gt;

Tuples, Arity

&lt;a class=&quot;admonition-anchor-link&quot; href=&quot;#admonition-tuples-arity&quot;&gt;&lt;/a&gt;
&lt;/div&gt;
&lt;div&gt;

An ordered list of elements is called a _tuple_, and we'll sometimes use that term to refer to elements of the `sig` and field sets in an instance. The number of elements in a tuple is called its _arity_. Since any single `sig` or field set will contain tuples with the same arity, we can safely talk about the arity of these sets as well. E.g., in the above definition, a field `f` of type `S1 -&gt; ... -&gt; Sn` in `sig S` would always correspond to a set with arity $n+1$.

&lt;/div&gt;
&lt;/div&gt;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="formulas"><a class="header" href="#formulas">Formulas</a></h1>
<p><em>Formulas</em> are a type of Forge syntax. Given an instance, every formula evaluates to a boolean value. If the formula is true of an instance, we say that the instance <em>satisfies</em> the formula.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="formula-combining-operators"><a class="header" href="#formula-combining-operators">Formula-Combining Operators</a></h1>
<p>Formula operators combine smaller formulas to produce new formulas. Many closely resemble similar operators from programming languages, like <code>&amp;&amp;</code>, <code>||</code>, and <code>!</code>.</p>
<h2 id="list-of-available-operators"><a class="header" href="#list-of-available-operators">List of Available Operators:</a></h2>
<p>For the following <code>&lt;fmla&gt;</code> means an arbitrary formula.</p>
<ul>
<li>Negation: <a href="docs/building-models/constraints/formulas/./operators.html#not"><code>not (!)</code></a></li>
<li>Conjunction: <a href="docs/building-models/constraints/formulas/./operators.html#and"><code>and (&amp;&amp;)</code></a></li>
<li>Disjunction: <a href="docs/building-models/constraints/formulas/./operators.html#or"><code>or (||)</code></a></li>
<li>Implication: <a href="docs/building-models/constraints/formulas/./operators.html#implies"><code>implies (=&gt;)</code></a>
<ul>
<li>If-then-else: <a href="docs/building-models/constraints/formulas/./operators.html#implies-else"><code>else</code></a></li>
</ul>
</li>
<li>If-and-only-if: <a href="docs/building-models/constraints/formulas/./operators.html#iff"><code>iff (&lt;=&gt;)</code></a></li>
</ul>
<div id="admonition-alternative-syntax" class="admonition admonish-note">
<div class="admonition-title">
<p>Alternative syntax</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/formulas/operators.html#admonition-alternative-syntax"></a></p>
</div>
<div>
<p>Some operators have alternative syntax (marked by <strong><em>alt</em></strong>) which are equivalent. Use whichever is most natural and convenient to you.</p>
</div>
</div>
<hr />
<h2 id="not-alt-"><a class="header" href="#not-alt-"><code>not</code> (<em>alt:</em> <code>!</code>)</a></h2>
<blockquote>
<p><code>not &lt;fmla&gt;</code></p>
<p><code>! &lt;fmla&gt;</code></p>
</blockquote>
<p><strong>true</strong> when <code>&lt;fmla&gt;</code> evaluates to <strong>false</strong></p>
<div id="admonition-example" class="admonition admonish-example">
<div class="admonition-title">
<p>Example</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/formulas/operators.html#admonition-example"></a></p>
</div>
<div>
<p>If <code>some p.spouse</code> is true when the person <code>p</code> is married, <code>not (some p.spouse)</code> denotes the opposite, being true whenever <code>p</code> is <em>not</em> married.</p>
</div>
</div>
<hr />
<h2 id="and-alt-"><a class="header" href="#and-alt-"><code>and</code> (<em>alt:</em> <code>&amp;&amp;</code>)</a></h2>
<blockquote>
<p><code>&lt;fmla-a&gt; and &lt;fmla-b&gt;</code></p>
<p><code>&lt;fmla-a&gt; &amp;&amp; &lt;fmla-b&gt;</code></p>
</blockquote>
<p><strong>true</strong> when both <code>&lt;fmla-a&gt;</code> and <code>&lt;fmla-b&gt;</code> evaluate to <strong>true</strong>.</p>
<div id="admonition-example-1" class="admonition admonish-example">
<div class="admonition-title">
<p>Example</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/formulas/operators.html#admonition-example-1"></a></p>
</div>
<div>
<p>If <code>some p.spouse</code> is true when the person <code>p</code> is married, and <code>p.spouse != p</code> is true when <code>p</code> is not married to themselves, then <code>some p.spouse and p.spouse != p</code> is true exactly when <code>p</code> is married, but not to themselves.</p>
</div>
</div>
<div id="admonition-implicit-and" class="admonition admonish-note">
<div class="admonition-title">
<p>Implicit and</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/formulas/operators.html#admonition-implicit-and"></a></p>
</div>
<div>
<p>Forge treats consecutive formulas within <code>{ ... }</code> as implicitly combined using <code>and</code>. For instance, the above example could also be written as:</p>
<pre><code>{
  some p.spouse
  p.spouse != p
}
</code></pre>
</div>
</div>
<hr />
<h2 id="or-alt-"><a class="header" href="#or-alt-"><code>or</code> (<em>alt:</em> <code>||</code>)</a></h2>
<blockquote>
<p><code>&lt;fmla-a&gt; or &lt;fmla-b&gt;</code></p>
<p><code>&lt;fmla-a&gt; || &lt;fmla-b&gt;</code></p>
</blockquote>
<p><strong>true</strong> when either <code>&lt;fmla-a&gt;</code> is <strong>true</strong> or <code>&lt;fmla-b&gt;</code> evaluates to <strong>true</strong>.</p>
<div id="admonition-example-2" class="admonition admonish-example">
<div class="admonition-title">
<p>Example</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/formulas/operators.html#admonition-example-2"></a></p>
</div>
<div>
<p>If <code>some p.spouse</code> is true when the person <code>p</code> is married, and <code>p.spouse != p</code> is true when <code>p</code> is not married to themselves, then <code>some p.spouse or p.spouse != p</code> is true exactly when <code>p</code> is <em>either</em>:</p>
<ul>
<li>married; or </li>
<li>not married to themselves (including the case where <code>p</code> is unmarried).</li>
</ul>
</div>
</div>
<hr />
<h2 id="implies-alt-"><a class="header" href="#implies-alt-"><code>implies</code> (<em>alt</em> <code>=&gt;</code>)</a></h2>
<blockquote>
<p><code>&lt;fmla-a&gt; implies &lt;fmla-b&gt;</code></p>
<p><code>&lt;fmla-a&gt; =&gt; &lt;fmla-b&gt;</code></p>
</blockquote>
<p><strong>true</strong> when either <code>&lt;fmla-a&gt;</code> evaluates to <strong>false</strong> or <code>&lt;fmla-b&gt;</code> evaluates to <strong>true</strong>.</p>
<div id="admonition-example-3" class="admonition admonish-example">
<div class="admonition-title">
<p>Example</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/formulas/operators.html#admonition-example-3"></a></p>
</div>
<div>
<p>If <code>some p.spouse</code> is true when the person <code>p</code> is married, and <code>p.spouse != p</code> is true when <code>p</code> is not married to themselves, then <code>some p.spouse implies p.spouse != p</code> is true exactly when <code>p</code> is <em>either</em>:</p>
<ul>
<li>unmarried; or </li>
<li>not married to themselves.</li>
</ul>
</div>
</div>
<hr />
<h3 id="implies-else-alt--else"><a class="header" href="#implies-else-alt--else"><code>implies else</code> (<em>alt:</em> <code>=&gt; else</code>)</a></h3>
<blockquote>
<p><code>{&lt;fmla-a&gt; implies &lt;fmla-b&gt; else &lt;fmla-c&gt;}</code></p>
<p><code>{&lt;fmla-a&gt; =&gt; &lt;fmla-b&gt; else &lt;fmla-c&gt;}</code></p>
</blockquote>
<p>takes the value of <code>&lt;fmla-b&gt;</code> when <code>&lt;fmla-a&gt;</code> evaluates to <strong>true</strong>, and takes the value of <code>&lt;fmla-c&gt;</code> otherwise.</p>
<div id="admonition-example-4" class="admonition admonish-example">
<div class="admonition-title">
<p>Example</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/formulas/operators.html#admonition-example-4"></a></p>
</div>
<div>
<p>If:</p>
<ul>
<li><code>some p.spouse</code> is true when the person <code>p</code> is married, </li>
<li><code>p.spouse != p</code> is true when <code>p</code> is not married to themselves, and</li>
<li><code>some p.parent1</code> is true when <code>p</code> has a <code>parent1</code> in the instance, </li>
</ul>
<p>then <code>some p.spouse =&gt; p.spouse != p else some p.parent1</code> is true exactly when:</p>
<ul>
<li><code>p</code> is married, and not to themselves; or</li>
<li><code>p</code> is not married and have a <code>parent1</code> in the instance.</li>
</ul>
</div>
</div>
<hr />
<h2 id="iff-alt-"><a class="header" href="#iff-alt-"><code>iff</code> (<em>alt:</em> <code>&lt;=&gt;</code>)</a></h2>
<blockquote>
<p><code>&lt;fmla-a&gt; iff &lt;fmla-b&gt;</code></p>
<p><code>&lt;fmla-a&gt; &lt;=&gt; &lt;fmla-b&gt;</code></p>
</blockquote>
<p>true when <code>&lt;fmla-a&gt;</code> evaluates to <strong>true</strong> exactly when <code>&lt;fmla-b&gt;</code> evaluates to <strong>true</strong>.</p>
<div id="admonition-iff" class="admonition admonish-note">
<div class="admonition-title">
<p>IFF</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/formulas/operators.html#admonition-iff"></a></p>
</div>
<div>
<p>The term <code>iff</code> is short for &quot;if and only if&quot;.</p>
</div>
</div>
<div id="admonition-example-5" class="admonition admonish-example">
<div class="admonition-title">
<p>Example</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/formulas/operators.html#admonition-example-5"></a></p>
</div>
<div>
<p>If <code>some p.spouse</code> is true when the person <code>p</code> is married, and <code>some p.parent1</code> is true when <code>p</code> has a <code>parent1</code> in the instance, then <code>some p.spouse iff some p.parent1</code> is true exactly when <em>either</em>:</p>
<ul>
<li><code>p</code> is married and has a <code>parent1</code> in the instance; or </li>
<li><code>p</code> is unmarried has no <code>parent1</code> in the instance.</li>
</ul>
</div>
</div>
<hr />
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="cardinality-and-membership"><a class="header" href="#cardinality-and-membership">Cardinality and Membership</a></h1>
<p>The following operators produce formulas from smaller expression arguments:</p>
<ul>
<li><code>no &lt;expr&gt;</code>: true when <code>&lt;expr&gt;</code> is <strong>empty</strong></li>
<li><code>lone &lt;expr&gt;</code>: true when <code>&lt;expr&gt;</code> contains <strong>zero or one</strong> elements</li>
<li><code>one &lt;expr&gt;</code>: true when <code>&lt;expr&gt;</code> contains <strong>exactly one</strong> element</li>
<li><code>some &lt;expr&gt;</code>: true when <code>&lt;expr&gt;</code> contains <strong>at least one</strong> element</li>
<li><code>&lt;expr-a&gt; in &lt;expr-b&gt;</code>: true when <code>&lt;expr-a&gt;</code> is a <strong>subset</strong> of or equal to <code>&lt;expr-b&gt;</code></li>
<li><code>&lt;expr-a&gt; = &lt;expr-b&gt;</code>: true when <code>&lt;expr-a&gt;</code> and <code>&lt;expr-b&gt;</code> contain exactly the <strong>same elements</strong></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="quantifiers"><a class="header" href="#quantifiers">Quantifiers</a></h1>
<p>In the following, <code>&lt;x&gt;</code> is a variable, <code>&lt;expr&gt;</code> is an expression of arity 1, and <code>&lt;fmla&gt;</code> is a formula (that can use the variable <code>&lt;x&gt;</code>). You can quantify over a unary set in the following ways:</p>
<ul>
<li><code>some &lt;x&gt;: &lt;expr&gt; | { &lt;fmla&gt; }</code>: true when <code>&lt;fmla&gt;</code> is true for at least one element in <code>&lt;expr&gt;</code>; and</li>
<li><code>all &lt;x&gt;: &lt;expr&gt; | { &lt;fmla&gt; }</code>: true when <code>&lt;fmla&gt;</code> is true for all elements in <code>&lt;expr&gt;</code></li>
</ul>
<p>If you want to quantify over several variables, you can also do the following:</p>
<ul>
<li><code>some &lt;x&gt;: &lt;expr-a&gt;, &lt;y&gt;: &lt;expr-b&gt; | { &lt;fmla&gt; }</code>; or</li>
<li><code>some &lt;x&gt;, &lt;y&gt;: &lt;expr&gt; | { &lt;fmla&gt; }</code>.</li>
</ul>
<p>The syntax is the same for other quantifiers, such as <code>all</code>.</p>
<h2 id="complex-quantifiers"><a class="header" href="#complex-quantifiers">Complex Quantifiers</a></h2>
<p>Forge also provides 3 additional quantifiers, which encode somewhat richer constraints than the above:</p>
<ul>
<li><code>no &lt;x&gt;: &lt;expr&gt; | { &lt;fmla&gt; }</code>: true when <code>&lt;fmla&gt;</code> is false for all elements in <code>&lt;expr&gt;</code></li>
<li><code>lone &lt;x&gt;: &lt;expr&gt; | { &lt;fmla&gt; }</code>: true when <code>&lt;fmla&gt;</code> is true for zero or one elements in <code>&lt;expr&gt;</code></li>
<li><code>one &lt;x&gt;: &lt;expr&gt; | { &lt;fmla&gt; }</code>: true when <code>&lt;fmla&gt;</code> is true for exactly one element in <code>&lt;expr&gt;</code></li>
</ul>
<p><strong>The above 3 quantifiers (<code>no</code>, <code>lone</code>, and <code>one</code>) should be used carefully.</strong> Because they invisibly encode extra constraints, they do not commute the same way <code>some</code> and <code>all</code> quantifiers do. E.g., <code>some x : A | some y : A | myPred[x,y]</code> is always equivalent to <code>some y : A | some x : A | myPred[x,y]</code>, but <code>one x : A | one y : A | myPred[x,y]</code> is <strong>NOT</strong> always equivalent to <code>one y : A | one x : A | myPred[x,y]</code>. (Why not? Try it out in Forge!)</p>
<div id="admonition-warning" class="admonition admonish-warning">
<div class="admonition-title">
<p>Warning</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/formulas/quantifiers.html#admonition-warning"></a></p>
</div>
<div>
<p>Beware combining the <code>no</code>, <code>one</code>, and <code>lone</code> quantifiers with multiple variables at once; the meaning of, e.g., <code>one x, y: A | ...</code> is &quot;there exists a <strong>unique pair</strong> <code>&lt;x, y&gt;</code> such that <code>...</code>&quot;. This is different from the meaning of <code>one x: A | one y: A | ...</code>, which is &quot;there is a unique <code>x</code> such that there is a unique <code>y</code> such that ...&quot;.</p>
</div>
</div>
<h2 id="quantifying-over-disjoint-objects"><a class="header" href="#quantifying-over-disjoint-objects">Quantifying Over Disjoint Objects</a></h2>
<p>Sometimes, it might be useful to try to quantify over all pairs of elements in <code>A</code>, where the two in the pair are distinct atoms. You can do that using the <code>disj</code> keyword, e.g.:</p>
<ul>
<li><code>some disj x, y : A | ...</code> (adds an implicit <code>x != y and ...</code>); and</li>
<li><code>all disj x, y : A | ...</code> (adds an implicit <code>x != y implies ...</code>)`</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="predicates"><a class="header" href="#predicates">Predicates</a></h1>
<p>If you have a set of constraints that you use often, or that you'd like to give a name to, you can define a <em>predicate</em> using the <code>pred</code> keyword. A predicate has the following form:</p>
<pre><code>pred &lt;pred-name&gt; {
   &lt;fmla-1&gt;
   &lt;fmla-2&gt;
   ...
   &lt;fmla-n&gt;
}
</code></pre>
<p>Newlines between formulas in a <code>pred</code> will be combined implicitly with <code>and</code>s, helping keep your predicates uncluttered. Predicates can also be defined with arguments, which will be evaluated via substitution. For instance, in a family-tree model, you could create:</p>
<pre><code>pred parentOrChildOf[p1, p2: Person] {
  p2 = p1.parent1 or
  p2 = p1.parent2 or
  p1 = p2.parent1 or
  p1 = p2.parent1
}
</code></pre>
<p>and then write something like <code>some p : Person | parentOrChildOf[Tim, p]</code>. Predicates may be used like this anywhere a formula can appear.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="expressions"><a class="header" href="#expressions">Expressions</a></h1>
<p>Given an instance, <em>expressions</em> in Forge evaluate to sets of atoms. </p>
<h2 id="froglet"><a class="header" href="#froglet">Froglet</a></h2>
<p>In Froglet, expressions must always denote a single atom or the empty set (<code>none</code>). This matches the abstraction where fields are always either total (<code>one</code>, <code>func</code>) or partial (<code>lone</code>, <code>pfunc</code>) functions.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="relational-operators"><a class="header" href="#relational-operators">Relational Operators</a></h1>
<p><em>Relational Operators</em> produce expressions (not formulas) from other expressions. </p>
<div id="admonition-froglet" class="admonition admonish-note">
<div class="admonition-title">
<p>Froglet</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/expressions/relational-expressions/relational-expressions.html#admonition-froglet"></a></p>
</div>
<div>
<p>If you are using Froglet, not all of these operators are available.</p>
</div>
</div>
<div id="admonition-relational-forge" class="admonition admonish-warning">
<div class="admonition-title">
<p>Relational Forge</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/expressions/relational-expressions/relational-expressions.html#admonition-relational-forge"></a></p>
</div>
<div>
<p>Recall that Forge treats every field of a sig as a relation of arity 1 higher than the arity of the field itself, with the object the field belongs to as the added left-most column. E.g., in this sig definition:</p>
<pre><code>sig City {
    roads: set City
}
</code></pre>
<p>the relation <code>roads</code> is an arity-2 set which contains ordered pairs of <code>City</code> objects.</p>
<p>This is what allows the dot operator in Forge to act as if it is field access when it is actually a <a href="docs/building-models/constraints/expressions/relational-expressions/./relational-expressions.html#-join">relational join</a>.</p>
</div>
</div>
<h3 id="list-of-relational-expression-operators"><a class="header" href="#list-of-relational-expression-operators">List of Relational Expression Operators:</a></h3>
<ul>
<li><a href="docs/building-models/constraints/expressions/relational-expressions/./relational-expressions.html#-union"><code>+ (union)</code></a></li>
<li><a href="docs/building-models/constraints/expressions/relational-expressions/./relational-expressions.html#--set-difference"><code>- (set difference)</code></a></li>
<li><a href="docs/building-models/constraints/expressions/relational-expressions/./relational-expressions.html#intersection"><code>&amp; (intersection)</code></a></li>
<li><a href="docs/building-models/constraints/expressions/relational-expressions/./relational-expressions.html#-and--relational-join"><code>.  [] (relational join)</code></a></li>
<li><a href="docs/building-models/constraints/expressions/relational-expressions/./relational-expressions.html#--cross-product"><code>-&gt; (cross product)</code></a></li>
<li><a href="docs/building-models/constraints/expressions/relational-expressions/./relational-expressions.html#-transpose"><code>~ (transpose)</code></a></li>
<li><a href="docs/building-models/constraints/expressions/relational-expressions/./relational-expressions.html#-transitive-closure"><code>^ (transitive closure)</code></a></li>
<li><a href="docs/building-models/constraints/expressions/relational-expressions/./relational-expressions.html#-reflexive-transitive-closure"><code>* (reflexive transitive closure)</code></a></li>
<li><a href="docs/building-models/constraints/expressions/relational-expressions/./relational-expressions.html#if-then-else"><code>=&gt; else</code></a></li>
<li><a href="docs/building-models/constraints/expressions/relational-expressions/./relational-expressions.html#set-comprehension"><code>set comprehension</code></a></li>
</ul>
<!-- (Unlike [Formula Operators](../../formulas/operators.md), the parentheticals are _not alternative syntax_. They are the mathematical names) -->
<hr />
<h2 id="-union"><a class="header" href="#-union"><code>+ (union)</code></a></h2>
<blockquote>
<p><code>&lt;expr-a&gt; + &lt;expr-b&gt;</code></p>
</blockquote>
<p>returns the <strong>union</strong> of the two exprs, i.e., the set containing all elements that are in either of the two exprs.</p>
<div id="admonition-union" class="admonition admonish-example">
<div class="admonition-title">
<p>Union</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/expressions/relational-expressions/relational-expressions.html#admonition-union"></a></p>
</div>
<div>
<p>The set of employees who work at Brown CS include both faculty and staff:</p>
<pre><code>BrownCS.employees = BrownCS.faculty + BrownCS.staff
</code></pre>
</div>
</div>
<hr />
<h2 id="--set-difference"><a class="header" href="#--set-difference"><code>- (set difference)</code></a></h2>
<blockquote>
<p><code>&lt;expr-a&gt; - &lt;expr-b&gt;</code></p>
</blockquote>
<p>returns the <strong>set difference</strong> of the two exprs, i.e., everything in <code>expr-a</code> that is <strong>not</strong> also in <code>expr-b</code>.</p>
<div id="admonition-difference" class="admonition admonish-example">
<div class="admonition-title">
<p>Difference</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/expressions/relational-expressions/relational-expressions.html#admonition-difference"></a></p>
</div>
<div>
<p>The set of students eligible to UTA includes all students except those who are already hired as head TAs:</p>
<pre><code>BrownCS.utaCandidates = Student - BrownCS.htaHires
</code></pre>
</div>
</div>
<hr />
<h2 id="intersection"><a class="header" href="#intersection"><code>&amp; (intersection)</code></a></h2>
<blockquote>
<p><code>&lt;expr-a&gt; &amp; &lt;expr-b&gt;</code></p>
</blockquote>
<p>returns the <strong>intersection</strong> of the two exprs, i.e., all elements in both <code>expr-a</code> and <code>expr-b</code>.</p>
<div id="admonition-intersection" class="admonition admonish-example">
<div class="admonition-title">
<p>Intersection</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/expressions/relational-expressions/relational-expressions.html#admonition-intersection"></a></p>
</div>
<div>
<p>Students in the &quot;AI/ML&quot; pathway must take multiple intermediate courses. In this (oversimplified) example, students can use the AI/ML pathway if they've taken both linear algebra and probability:</p>
<pre><code>BrownCS.canUseAIML = BrownCS.tookLinearAlgebra &amp; BrownCS.tookProbability 
</code></pre>
</div>
</div>
<hr />
<h2 id="--cross-product"><a class="header" href="#--cross-product"><code>-&gt; (cross product)</code></a></h2>
<blockquote>
<p><code>&lt;expr-a&gt; -&gt; &lt;expr-b&gt;</code></p>
</blockquote>
<p>returns the <strong>cross product</strong> of the two exprs. </p>
<div id="admonition-product-example-1" class="admonition admonish-example">
<div class="admonition-title">
<p>Product (example 1)</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/expressions/relational-expressions/relational-expressions.html#admonition-product-example-1"></a></p>
</div>
<div>
<p>If <code>roads</code> is a binary relation between <code>City</code> and itself, and <code>Providence</code> and <code>Pawtucket</code> are cities:</p>
<pre><code>sig City {
    roads: set City
}
one sig Providence, Pawtucket extends City {}
</code></pre>
<p>then <code>Providence -&gt; Pawtucket</code> is an arity-2, one-element set, which can be used with other operators. E.g.,  <code>roads + (Providence -&gt; Pawtucket)</code> represents the set of roads augmented with a new road (if it wasn't already there). </p>
<p>Likewise, <code>City -&gt; City</code> will produce an arity-2 set containing every possible pair-wise combination of cities.</p>
</div>
</div>
<hr />
<h2 id="-transpose"><a class="header" href="#-transpose"><code>~ (transpose)</code></a></h2>
<blockquote>
<p><code>~&lt;expr&gt;</code></p>
</blockquote>
<p>returns the transpose of <code>&lt;expr&gt;</code>, assuming it is has arity 2. (Attempting to use transpose on a different-arity relation will produce an error.)</p>
<div id="admonition-transpose" class="admonition admonish-example">
<div class="admonition-title">
<p>Transpose</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/expressions/relational-expressions/relational-expressions.html#admonition-transpose"></a></p>
</div>
<div>
<p>If <code>roads</code> is a binary relation between <code>City</code> and itself:</p>
<pre><code>sig City {
    roads: set City
}
</code></pre>
<p>then <code>~roads</code> is an arity-2, set that contains exactly the same elements in <code>roads</code> except reversed. E.g., if <code>Providence -&gt; Pawtucket</code> was in <code>roads</code>, then <code>Pawtucket -&gt; Providence</code> would be in <code>~roads</code>.</p>
</div>
</div>
---
<h2 id="set-comprehension"><a class="header" href="#set-comprehension">Set Comprehension</a></h2>
<p>A set-comprehension expression <code>{x1: T1, ..., xn: Tn | &lt;fmla&gt;}</code> evaluates to a set of arity-n tuples. A tuple of objects <code>o1, ... on</code> is in the set if and only if <code>&lt;fmla&gt;</code> is satisfied when <code>x1</code> takes the value <code>o1</code>, etc. </p>
<div id="admonition-set-comprehension" class="admonition admonish-example">
<div class="admonition-title">
<p>Set Comprehension</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/expressions/relational-expressions/relational-expressions.html#admonition-set-comprehension"></a></p>
</div>
<div>
<p>In a model with sigs for <code>Student</code>, <code>Faculty</code>, and <code>Course</code>, the expression</p>
<pre><code>{s: Student, i: Faculty | some c: Course | { some s.grades[c] and c.instructor = i} }
</code></pre>
<p>would evaluate to the set of student-faculty pairs where the student has taken a course from that faculty member.</p>
</div>
</div>
<hr />
<h2 id="-and--relational-join"><a class="header" href="#-and--relational-join"><code>.</code> <em>and</em> <code>[] (relational join)</code></a></h2>
<blockquote>
<p><code>&lt;expr-a&gt; . &lt;expr-b&gt;</code></p>
</blockquote>
<p>returns the <strong>relational join</strong> of the two exprs. It combines two relations by seeking out rows with common values in their rightmost and leftmost columns. Concretely, if <code>A</code> is an <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>-ary relation, and <code>B</code> is <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span>-ary, then <code>A.B</code> equals the <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span>-ary relation:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣∃</span><span class="mord mathnormal">x</span><span class="mord">∣</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">A</span><span class="mord text"><span class="mord"> and </span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">}</span></span></span></span></span></p>
<div id="admonition-product-example-1-1" class="admonition admonish-example">
<div class="admonition-title">
<p>Product (example 1)</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/expressions/relational-expressions/relational-expressions.html#admonition-product-example-1-1"></a></p>
</div>
<div>
<p>If <code>roads</code> is a binary relation between <code>City</code> and itself, and <code>Providence</code> is a city:</p>
<pre><code>sig City {
    roads: set City
}
one sig Providence extends City {}
</code></pre>
<p>then <code>roads.roads</code> is an arity-2 set and <code>Providence.roads</code> is an arity-1 set. </p>
<p>In the instance:</p>
<pre><code>inst joinExample {
    City = `Providence + `City0 + `City2
    roads = `Providence -&gt; `City0 +
            `City0 -&gt; `City1 +
            `City1 -&gt; Providence
}
</code></pre>
<p><code>roads.roads</code> would contain:</p>
<pre><code>`Providence -&gt; `City1   (because `Providence -&gt; `City0 and `City0 -&gt; `City1)
`City0 -&gt; `Providence (because `City0 -&gt; `City1 and `City1 -&gt; `Providence)
`City1 -&gt; `City0 (because `City1 -&gt; `Providence and `Providence -&gt; `City0)
</code></pre>
<p><code>Providence.roads</code> would contain:</p>
<pre><code>`City0 (because `Providence -&gt; `City0)
</code></pre>
</div>
</div>
<div id="admonition-forge-is-not-sql" class="admonition admonish-warning">
<div class="admonition-title">
<p>Forge is not SQL</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/expressions/relational-expressions/relational-expressions.html#admonition-forge-is-not-sql"></a></p>
</div>
<div>
<p>Relations in Forge don't have column <em>names</em> like they do in most databases. The join is always on the innermost columns of the two relations being joined.</p>
</div>
</div>
<!-- [TODOLINK]() -->
<p><strong>Alternative syntax:</strong> <code>&lt;expr-a&gt;[&lt;expr-b&gt;]</code>: is equivalent to <code>&lt;expr-b&gt; . &lt;expr-a&gt;</code>;</p>
<hr />
<h2 id="-transitive-closure"><a class="header" href="#-transitive-closure"><code>^ (transitive closure)</code></a></h2>
<blockquote>
<p><code>^&lt;expr&gt;</code></p>
</blockquote>
<p>returns the transitive closure of <code>&lt;expr&gt;</code>, assuming it is has arity 2. Attempting to apply <code>^</code> to a relation of different arity will produce an error. The transitive closure of a binary relation $r$ is defined as the <em>smallest</em> relation $t$ such that:</p>
<ul>
<li><code>r in t</code>; and </li>
<li>for all <code>a</code>, <code>b</code>, and <code>c</code>, if <code>a-&gt;b</code> is in <code>t</code> and <code>b-&gt;c</code> is in <code>t</code>, then <code>a-&gt;c</code> is in <code>t</code>.</li>
</ul>
<p>Informally, it is useful to think of <code>^r</code> as encoding <em>reachability</em> using <code>r</code>. It is equivalent to the (unbounded and thus inexpressible in Forge) union: <code>r + r.r + r.r.r + r.r.r.r + ...</code>. </p>
<div id="admonition-transitive-closure" class="admonition admonish-example">
<div class="admonition-title">
<p>Transitive Closure</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/expressions/relational-expressions/relational-expressions.html#admonition-transitive-closure"></a></p>
</div>
<div>
<p>If <code>roads</code> is a binary relation between <code>City</code> and itself, and <code>Providence</code> is a city:</p>
<pre><code>sig City {
    roads: set City
}
one sig Providence extends City {}
</code></pre>
<p>then <code>^roads</code> is the <em>reachability relation</em> between cities.</p>
</div>
</div>
<hr />
<h2 id="-reflexive-transitive-closure"><a class="header" href="#-reflexive-transitive-closure"><code>* (reflexive transitive closure)</code></a></h2>
<blockquote>
<p><code>*&lt;expr&gt;</code></p>
</blockquote>
<p>returns the reflexive-transitive closure of <code>&lt;expr&gt;</code>, assuming it is has arity 2. Attempting to apply <code>*</code> to a relation of different arity will produce an error.</p>
<p>For a given 2-ary relation <code>r</code>, <code>*r</code> is equivalent to <code>^r + iden</code>. </p>
<hr />
<h2 id="if-then-else"><a class="header" href="#if-then-else"><code>if then else</code></a></h2>
<blockquote>
<p><code>{&lt;fmla&gt; =&gt; &lt;expr-a&gt; else &lt;expr-b&gt;}</code> </p>
</blockquote>
<p>returns <code>&lt;expr-a&gt;</code> if <code>&lt;fmla&gt;</code> evaluates to true, and <code>&lt;expr-b&gt;</code> otherwise.</p>
<hr />
<h2 id="caveats-alloy-support"><a class="header" href="#caveats-alloy-support">Caveats: Alloy support</a></h2>
<p>Forge does not currently support the relational Alloy operators <code>&lt;:</code>, <code>:&gt;</code>, or <code>++</code>; if your models require them, please contact the Forge team.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="functions"><a class="header" href="#functions">Functions</a></h1>
<p>In the same way that <a href="docs/building-models/constraints/expressions/../formulas/predicates.html">predicates</a> define reusable formulas, <em>functions</em> define reusable expressions in Relational and Temporal Forge. Define functions with the <code>fun</code> keyword:</p>
<pre><code>fun &lt;fun-name&gt;[&lt;args&gt;]: &lt;result-type&gt; {
   &lt;expr&gt;
}
</code></pre>
<div id="admonition-helper-function" class="admonition admonish-example">
<div class="admonition-title">
<p>Helper function</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/expressions/functions.html#admonition-helper-function"></a></p>
</div>
<div>
<pre><code>fun inLawA[p: Person]: one Person {
  p.spouse.parent1
}
</code></pre>
</div>
</div>
<p>As with predicates, arguments will be evaluated via substitution. Functions may be used (with appropriate arguments) anywhere expressions can appear.</p>
<div id="admonition-helper-function-use" class="admonition admonish-example">
<div class="admonition-title">
<p>Helper function use</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/expressions/functions.html#admonition-helper-function-use"></a></p>
</div>
<div>
<pre><code>all p: Person | some inLawA[p]
</code></pre>
<p>This expands to:</p>
<pre><code>all p: Person | some (p.spouse.parent1)
</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="let-expressions"><a class="header" href="#let-expressions">Let-Expressions</a></h1>
<p>You can bind an expression to an identifier locally by using a <code>let</code> form:</p>
<pre><code>let &lt;id&gt; = &lt;expression&gt; |
  &lt;formula&gt;
</code></pre>
<p>This is useful to avoid code bloat due to re-use. E.g., if <code>s</code> is a state:</p>
<pre><code>let s2 = Traces.nextState[s] |
  canTransition[s, s2]
</code></pre>
<h2 id="using-let-in-the-evaluator"><a class="header" href="#using-let-in-the-evaluator">Using <code>let</code> in the evaluator</a></h2>
<p>A <code>let</code> expression can be useful when debugging a model using Sterling's evaluator. E.g., if you want to evaluate an internal subformula for a specific value of a quantifier:</p>
<pre><code>some p: Person | some p.spouse
</code></pre>
<p>you can check individual values by directly substituting (e.g., <code>some Person0.spouse</code>) but this is tiresome if the variable is used in multiple places. Instead, consider using let: </p>
<pre><code>let p = Person0 | some p.spouse
</code></pre>
<div id="admonition-concrete-atoms" class="admonition admonish-warning">
<div class="admonition-title">
<p>Concrete atoms</p>
<p><a class="admonition-anchor-link" href="docs/building-models/constraints/expressions/let-expressions.html#admonition-concrete-atoms"></a></p>
</div>
<div>
<p>This trick (referring to concrete objects) is only usable in the evaluator, because at that point a specific instance has been identified.</p>
</div>
</div><div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="comments"><a class="header" href="#comments">Comments</a></h1>
<p>Forge models support 3 different syntactic styles of comment:</p>
<ul>
<li>lines beginning with <code>--</code> are ignored;</li>
<li>lines beginning with <code>//</code> are ignored; and </li>
<li>all text between <code>/*</code> and <code>*/</code> are ignored. </li>
</ul>
<div id="admonition-no-nesting-comments" class="admonition admonish-warning">
<div class="admonition-title">
<p>No nesting comments</p>
<p><a class="admonition-anchor-link" href="docs/building-models/comments.html#admonition-no-nesting-comments"></a></p>
</div>
<div>
<p><code>/* ... */</code> comments may <strong>not</strong> be nested. E.g., </p>
<pre><code class="language-clike">/*
/*
*/
*/
</code></pre>
<p>would be a syntax error, because the first instance of <code>*/</code> terminates all preceding instances of `/*.</p>
</div>
</div><div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="running"><a class="header" href="#running">Running</a></h1>
<p>There are two primary ways of running your spec. You can either as Forge to show you instances that satisfy a predicate you wrote with the run command, or ask Forge to look for counterexamples to a predicate you wrote with the check command.</p>
<h4 id="run-1"><a class="header" href="#run-1">Run</a></h4>
<p>The run command can be used in a few different ways, show below:</p>
<pre><code>&lt;run-name&gt;: run &lt;pred&gt; for &lt;bounds&gt;
&lt;run-name&gt;: run { &lt;expr&gt; } for &lt;bounds&gt;
</code></pre>
<p>Note that the run-name is optional to provide, but is helpful to distinguish what different run commands are showing.</p>
<p>When using the run command, Forge will display possible worlds (instances) where the predicates or expressions you specified evaluate to true, within the given bounds. Instances are displayed in <a href="https://github.com/tnelson/Forge/wiki/Sterling-Visualizer">Sterling</a> If no such instances are found, &quot;UNSAT&quot; is displayed.</p>
<p>When no more satisfying instances can be found, Sterling displays &quot;No more instances found&quot;.</p>
<h4 id="check"><a class="header" href="#check">Check</a></h4>
<p>The check command is used to ask Forge to look for counterexamples to a given set of predicates, i.e. instances where the predicate or expression evaluates to false. The syntax is the same as for the run command, just with the keyword <code>check</code> instead:</p>
<pre><code>&lt;check-name&gt;: check &lt;pred&gt; for &lt;bounds&gt;
&lt;check-name&gt;: check { &lt;expr&gt; } for &lt;bounds&gt;
</code></pre>
<p>If no counterexamples are found, Sterling displays &quot;No counterexamples found. Assertion may be valid&quot;. When no more counterexamples can be found, Sterling displays &quot;No more instances found&quot;.</p>
<div id="admonition-common-mistake" class="admonition admonish-warning">
<div class="admonition-title">
<p>Common Mistake!</p>
<p><a class="admonition-anchor-link" href="docs/running-models/running.html#admonition-common-mistake"></a></p>
</div>
<div>
<p>Unless defined in the run/test statement, predicates don't take effect!</p>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="visualizing-and-evaluating-output"><a class="header" href="#visualizing-and-evaluating-output">Visualizing and Evaluating Output</a></h1>
<p>Forge uses a modified version of the <a href="https://sterling-js.github.io/">Sterling</a> model visualizer.</p>
<h2 id="visualizing-output"><a class="header" href="#visualizing-output">Visualizing Output</a></h2>
<p>When you execute your model, Forge will either look for instances that satisfy the predicates you wrote, or look for counterexamples to the assertion you wrote. If you used a <code>run</code> command, or if Forge found a counter-example to a <code>test</code>, <code>example</code>, or <code>assert</code> you wrote, Forge launches a window in your browser that displays the output. (See the run and check sections for the different displays Sterling has in various scenarios.)</p>
<p>The basic visualization of the model is a <strong>directed graph</strong> showing all the atoms in that instance and the relations between them. You can also view an alternate depiction of the instance in the <strong>table</strong> view tab. To keep visualizations neat, Sterling will not show you any <code>Int</code> atoms that are not used in the instance.</p>
<h3 id="theming"><a class="header" href="#theming">Theming</a></h3>
<p>The directed-graph view can be customized by clicking the <strong>Theme</strong> tray to the right of the Sterling window. Sterling supports two kinds of theming, listed below. </p>
<div id="admonition-saving-a-theme" class="admonition admonish-tip">
<div class="admonition-title">
<p>Saving a theme</p>
<p><a class="admonition-anchor-link" href="docs/running-models/sterling-visualizer.html#admonition-saving-a-theme"></a></p>
</div>
<div>
<p>You can save your theme in a file and re-load it later in a new session. To do this, click the &quot;Save As...&quot; or &quot;Choose File&quot; options at the very top of the theming tray. The file will be downloaded as <code>theme.json</code>. </p>
<p>If you get a fresh instance and lose your theming, reloading a saved theme is a fast fix.</p>
</div>
</div>
<h4 id="projections"><a class="header" href="#projections">Projections</a></h4>
<p><em>Projecting</em> over a <code>sig</code> hides atoms of that <code>sig</code> in the visualizer and shows the rest of the instance as if that were the only atom of the projected <code>sig</code>. This can be a very useful for simplifying (e.g.) finite-trace instances, since much of the clutter will be eliminated. When a projection is active, the theming window will give the option to change which atom is being used.</p>
<h4 id="styles"><a class="header" href="#styles">Styles</a></h4>
<p>Style attributes such as font and line thickness for each <code>sig</code> and field can be customized. For fields only, clicking the &quot;display as attribute&quot; checkbox will tell Sterling to stop visualizing the field as an edge in the graph, and display it as an annotation on nodes.</p>
<p>Clicking a <code>sig</code> or field name will expand the style selection box for that <code>sig</code> or field. Click the name again to collapse the box.</p>
<div id="admonition-changing-source-and-target-nodes" class="admonition admonish-tip">
<div class="admonition-title">
<p>Changing source and target nodes</p>
<p><a class="admonition-anchor-link" href="docs/running-models/sterling-visualizer.html#admonition-changing-source-and-target-nodes"></a></p>
</div>
<div>
<p>The default graph layout can sometimes be frustrating. For example, if you are modeling a weighted directed graph, you may have something like <code>sig Node { edges: set Node -&gt; Int }</code>. By default, Sterling will display each tuple in <code>edges</code> as an edge from the <em>first</em> tuple element to the <em>last</em> tuple element, meaning that you'll see a lot of arcs from nodes to numbers. </p>
<p>To fix this, set the &quot;Source Index&quot; and &quot;Target Index&quot; fields in the styling for a given field. In the above case, you would want a source index of <code>0</code> and a target index of <code>1</code>; Sterling would then move the weight to an edge label, resulting in a much more readable graph.</p>
</div>
</div>
<h3 id="visualizing-in-temporal-forge"><a class="header" href="#visualizing-in-temporal-forge">Visualizing in Temporal Forge</a></h3>
<p>In temporal mode, when the trace found is of length greater than 1, Sterling will enable a few new features:</p>
<ul>
<li>You can advance back and forth through the trace by using the arrow buttons in the <code>Time</code> drawer. Next to these buttons, Sterling will say which state the lasso loops back to. For instance, &quot;Loop: 1&quot; would mean that the lasso loops back to the second state (states are 0-indexed).</li>
<li>Rather than one &quot;Next&quot; button, you'll see two: one labeled &quot;Next&quot; and the other &quot;Next Config&quot;.
<ul>
<li>The &quot;Next Config&quot; button will ask the solver for a new trace that <em>varies the non-variable relations</em> of your model. If all your relations are variable, or if other constraints prevent a different non-variable subset of the instance from satisfying your run, this button will lead to a no-more-instances screen.</li>
<li>The &quot;Next&quot; button will ask the solver for a new trace that <em>holds the non-variable relations constant</em>. If there are no other traces possible without changing the non-variable relations, this button will lead to a no-more-instances screen.</li>
</ul>
</li>
</ul>
<p><img src="docs/running-models/../images/temporal-minimap.png" alt="The trace viewer shows a cycle of 4 states, with the final state looping back to the first. A header says &quot;State 1 of 4&quot; between a forward and backward button." title="The trace viewer for temporal Forge" /></p>
<h2 id="the-evaluator-1"><a class="header" href="#the-evaluator-1">The Evaluator</a></h2>
<p>The evaluator provides a prompt that lets you query instances with Forge expressions. You can open the evaluator by clicking the &quot;Evaluator&quot; drawer on the far right of the Sterling window. Type a Forge expression and the evaluator will return its value in the current instance (assuming that Forge is still running). E.g.:</p>
<p><img src="docs/running-models/../images/eval-ttt-places.png" alt="Evaluating an expression: the evaluator is open, and the user has just evaluated the expression \Board1.places. The result, ((A0 C0 X0))`, appears beneath the input box." title="Evaluating an Expression" /></p>
<p>Because the evaluator works with respect to a single instance, exact values of expressions are returned. These expressions are (as of January 2024) not always Forge syntax. E.g., relations are displayed using nested parentheses, and <code>false</code> is written as <code>#f</code>. Fields are displayed in row form, with every entry in the field grouped into a parenthesis; in the example above, the meaning is that there's only one move on the board: <code>X</code> moved at row <code>A</code>, column <code>C</code>.</p>
<div id="admonition-atoms-can-be-referenced" class="admonition admonish-tip">
<div class="admonition-title">
<p>Atoms can be referenced</p>
<p><a class="admonition-anchor-link" href="docs/running-models/sterling-visualizer.html#admonition-atoms-can-be-referenced"></a></p>
</div>
<div>
<p>Individual atoms can be directly referenced by name in the evaluator, like in <code>inst</code> blocks (remember to prefix atom names with a backquote!) E.g., in the above example, <code>`Board1</code> was an atom name.</p>
</div>
</div>
<!-- The evaluator can also be given commands like `--version` (`-v`) to show the version of Forge being used or `--help` (`-h`) to show the file being run. -->
<h3 id="the-evaluator-in-temporal-forge"><a class="header" href="#the-evaluator-in-temporal-forge">The Evaluator in Temporal Forge</a></h3>
<p>If running in temporal mode, the evaluator is run in the context of the <em>first state</em> of the trace shown. To ask about later traces, use the <code>'</code> or <code>next_state</code> operators. Remember that <code>next_state</code> applies to formulas, and <code>'</code> applies to relational expressions. So in a directed graph you could ask whether there are <code>edges</code> in the second state via <code>some edges'</code> or <code>after some edges</code>.</p>
<h2 id="custom-visualizations-script-view"><a class="header" href="#custom-visualizations-script-view">Custom Visualizations: Script View</a></h2>
<p>Sterling also allows you to write and run scripts that produce your own custom visualizations. This documentation site contains a basic example here:</p>
<ul>
<li><a href="docs/running-models/../example-models/vis/ttt.js">example visualization script</a></li>
<li><a href="docs/running-models/../example-models/ttt.frg">Tic-tac-toe model to run the script with</a></li>
</ul>
<p>If you want to try out this example, do the following:</p>
<p><strong>Step 1:</strong> Open the Forge model and run it (<code>racket ttt.frg</code>). Sterling should open in your web browser, defaulting to the directed-graph visualization---which isn't very useful for this model. You should see something like this: </p>
<p><img src="docs/running-models/../images/ttt-viz-1.png" alt="Default visualization for tic-tac-toe, comprising boxes and lines" title="Default Visualizer" /></p>
<p><strong>Step 2:</strong> Click the Script button on the upper-right of the window. This will switch to custom script view mode. Paste the script into the editor, then click the <code>Run</code> button. You should see something like this before clicking <code>Run</code>:</p>
<p><img src="docs/running-models/../images/ttt-viz-2.png" alt="Custom visualizer before running. There is an editor in the middle of the window where the script has been pasted, and a button marked &quot;run&quot; above it." title="Custom Visualizer" /></p>
<div id="admonition-drawers" class="admonition admonish-tip">
<div class="admonition-title">
<p>Drawers</p>
<p><a class="admonition-anchor-link" href="docs/running-models/sterling-visualizer.html#admonition-drawers"></a></p>
</div>
<div>
<p>If you don't like the &quot;Variables&quot; tab taking up space, just click the corresponding drawer on the far right. The tab should collapse, making more room for the editor and visualization area.</p>
</div>
</div>
<p>After running, you should see something like this, with a sequence of board states displayed on the left-hand side of the screen:</p>
<p><img src="docs/running-models/../images/ttt-viz-3.png" alt="Custom visualizer after running. To the left, there is a sequence of boxes, each showing a board state of tic-tac-toe." title="Custom Visualizer (Run)" /></p>
<h3 id="more-information"><a class="header" href="#more-information">More Information</a></h3>
<p>For more complex examples, library documentation, instructions on writing your own visualizers, etc. see <a href="docs/running-models/../sterling/custom-basics.html">Custom Visualizations</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="bounds"><a class="header" href="#bounds">Bounds</a></h1>
<p>Forge is a <em>bounded</em> model finder, meaning it can only look for instances up to a certain bound. You can specify bounds in two seperate ways in Forge: using numeric bounds or instance bounds.</p>
<hr />
<h2 id="numeric-bounds-also-called-scopes"><a class="header" href="#numeric-bounds-also-called-scopes">Numeric bounds (also called &quot;scopes&quot;)</a></h2>
<p>The most basic way of specifying bounds in Forge is providing a maximum number of objects for each <code>sig</code>. If no bound is specified, Forge defaults to allowing up to 4 of each <code>sig</code>. The default bound on <code>Int</code> is a <em>bitwidth</em> of 4 (16 integers total).</p>
<p>Numeric bounds can be provided explicitly per sig in a <code>run</code>, <code>assert</code>, etc. command by adding a trailing <code>for ...</code> after the constraint block (see <a href="docs/running-models/running.html">Running</a>). </p>
<div id="admonition-applying-a-numeric-bound" class="admonition admonish-example">
<div class="admonition-title">
<p>Applying a numeric bound</p>
<p><a class="admonition-anchor-link" href="docs/running-models/bounds.html#admonition-applying-a-numeric-bound"></a></p>
</div>
<div>
<p>E.g., to add a bound to a <code>run</code> command in a model with <code>Cat</code> and <code>Dog</code> sigs, you would write something like:</p>
<pre><code>run { ... } for 5 Cat
run { ... } for 5 Cat, 2 Dog
</code></pre>
<p>The first run will search for instances containing 0--5 cats and 0--4 dogs. The second run will search for instances containing 0--5 cats and 0--2 dogs.</p>
</div>
</div>
<p>Note that this sets an <strong>upper</strong> bound on the size of instances Forge will show you. In other words, Forge will search for instances of size <strong>up to</strong> the bound you specify. If you instead want to set an <strong>exact</strong> bound, you can add the <code>exactly</code> keyword per sig. You may mix and match exact and upper numeric bounds as desired.</p>
<div id="admonition-exact-and-upper-numeric-bounds" class="admonition admonish-example">
<div class="admonition-title">
<p>Exact and upper numeric bounds</p>
<p><a class="admonition-anchor-link" href="docs/running-models/bounds.html#admonition-exact-and-upper-numeric-bounds"></a></p>
</div>
<div>
<pre><code>run { ... } for exactly 5 Cat
run { ... } for exactly 5 Cat, 2 Dog
</code></pre>
<p>The first run will search for instances containing exactly 5 cats and 0--4 dogs. The second run will search for instances containing exactly 5 cats and 0--2 dogs.</p>
</div>
</div>
<div id="admonition-two-important-exceptions" class="admonition admonish-warning">
<div class="admonition-title">
<p>Two Important Exceptions</p>
<p><a class="admonition-anchor-link" href="docs/running-models/bounds.html#admonition-two-important-exceptions"></a></p>
</div>
<div>
<p>Although a numeric bound without <code>exact</code> generally means anything <strong>up to</strong> that bound, there are two important exceptions to this rule:</p>
<p>(1) The set of available integers is always fixed exactly by the bitwidth. E.g., <code>3 Int</code> corresponds to the 8 integers in the range -4 through 3 (inclusive). </p>
<p>(2) If the <code>&lt;field&gt; is linear</code> annotation is present, the <code>sig</code> to which the field belongs will become exact-bounded, even if you have not written <code>exactly</code> in the numeric bound.</p>
</div>
</div>
<h2 id="instance-bounds"><a class="header" href="#instance-bounds">Instance bounds</a></h2>
<p>Instance bounds allow you to encode specific partial instances that you want Forge to run on. When creating an instance bound, you give upper and lower bounds in terms of concrete objects, not numeric sizes. This allows you to test your predicates on a specific instance, which can be convenient (see <a href="docs/running-models/../testing-chapter/testing.html#examples">Examples</a>). It is also useful for optimization in some cases (see <a href="docs/running-models/./concrete-instance-bounds.html#instances">Partial Instances</a>, which use the same bounds syntax as examples). </p>
<div id="admonition-a-partial-instance" class="admonition admonish-example">
<div class="admonition-title">
<p>A partial instance</p>
<p><a class="admonition-anchor-link" href="docs/running-models/bounds.html#admonition-a-partial-instance"></a></p>
</div>
<div>
<p>If we have defined a single sig with a single field:</p>
<pre><code>sig Person {
    spouse: lone Person
}
</code></pre>
<p>then this <code>inst</code> describes an instance for our model:</p>
<pre><code>inst exampleInstance {
    Person = `Person0 + `Person1 + `Person2
    spouse = `Person0 -&gt; `Person1 + `Person1 + `Person0
}
</code></pre>
<p>Similarly, we could write an example using the same syntax (assuming that <code>marriageRules</code> is defined as a predicate):</p>
<pre><code>example myExample is {marriageRules} for {
    Person = `Person0 + `Person1 + `Person2
    spouse = `Person0 -&gt; `Person1 + `Person1 + `Person0
}
</code></pre>
</div>
</div>
<p>Note that Forge expects concrete object names to be prefixed with a backquote; this is mandatory, and used to distinguish object names (which only make sense in the context of an instance or instances) from sigs, fields, predicates, and other kinds of identifiers that make sense in arbitrary formulas. </p>
<p>Instances defined via <code>inst</code> can be used in <code>run</code>, <code>assert</code>, etc. and may be combined with numeric bounds, provided they are consistent. Bounds annotations, such as <code>is linear</code>, can be included in instance bounds as well. See the <a href="docs/running-models/./concrete-instance-bounds.html">Concrete Instances</a> section for more information about writing instance bounds.</p>
<div id="admonition-using-instance-bounds" class="admonition admonish-example">
<div class="admonition-title">
<p>Using Instance Bounds</p>
<p><a class="admonition-anchor-link" href="docs/running-models/bounds.html#admonition-using-instance-bounds"></a></p>
</div>
<div>
<p>You may give the entire instance bound verbatim:</p>
<pre><code>run {} for 3 Int for {
    Person = `Person0 + `Person1 + `Person2
    spouse = `Person0 -&gt; `Person1 + `Person1 + `Person0
}
</code></pre>
<p>or you may use the instance name directly:</p>
<pre><code>run {} for 3 Int for exampleInstance
</code></pre>
</div>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="concrete-instance-bounds"><a class="header" href="#concrete-instance-bounds">Concrete Instance Bounds</a></h1>
<p>The types of problems that Forge creates and solves consist of 3 mathematical objects:</p>
<ul>
<li>A set of signatures and relations (the <strong>language</strong> of the problem);</li>
<li>A set of logical/relational formulas (the <strong>constraints</strong> of the problem);</li>
<li>A set of bounds on sigs and relations (the <strong>bounds</strong> of the problem).</li>
</ul>
<h2 id="partial-instances"><a class="header" href="#partial-instances">Partial Instances</a></h2>
<p>Forge presents a syntax that helps users keep these concerns separated. The first two concerns are represented by <code>sig</code> and <code>pred</code> declarations. The third concern is often addressed by numeric bounds (also called &quot;scope&quot;), but numeric bounds are always converted (usually invisibly to the user!) into set-based bounds that concretely specify:</p>
<ul>
<li>the <em>lower</em> bounds, what <em>must</em> be in an instance; and </li>
<li>the <em>upper</em> bounds, what <em>may</em> be in an instance.</li>
</ul>
<p>The <code>inst</code> syntax provides the ability to manipulate these set-based bounds directly, instead of indirectly via numeric bounds. The same syntax is used in <code>example</code> tests. Because bounds declarations interface more directly with the solver than constraints, at times they can yield performance improvements.</p>
<p>Finally, because bounds declarations can concretely refer to atoms in the world, we will often refer to them as <em>partial instances</em>.</p>
<h2 id="inst-syntax"><a class="header" href="#inst-syntax"><code>inst</code> Syntax</a></h2>
<p>An <code>inst</code> declaration contains a <code>{}</code>-enclosed sequence of bind declarations.  A bind declaration is one of the following, where <code>A</code> is either a sig name or field name.</p>
<ul>
<li><code>#Int = k</code>: use bitwidth <code>k</code> (where <code>k</code> is an integer greater than zero); </li>
<li><code>A in &lt;bounds-expr&gt;</code>: specify <em>upper</em> bounds on a sig or field <code>A</code>;</li>
<li><code>A ni &lt;bounds-expr&gt;</code>: specify <em>lower</em> bounds on a sig or field <code>A</code>;</li>
<li><code>A = &lt;bounds-expr&gt;</code>: <em>exactly</em> specify the contents of the sig or field <code>A</code> (effectively setting both the lower and upper bounds to be the same);</li>
<li><code>no A</code>: specify that <code>A</code> is empty;</li>
<li><code>r is linear</code> : use bounds-based symmetry breaking to make sure field <code>r</code> is a linear ordering on its types (useful for optimizing model-checking queries in Forge); and</li>
<li><code>r is plinear</code> : similar to <code>r is linear</code>, but possibly not involving the entire contents of the sig. I.e., a total linear order on <code>A'</code>-&gt;<code>A'</code> for some subset <code>A'</code> of <code>A</code>.</li>
</ul>
<p>When binding fields, the binding can also be given <em>piecewise</em> per atom. Keep in mind that atom names should be prefixed by a backquote:</p>
<ul>
<li><code>AtomName.f in &lt;bounds-expr&gt;</code> (upper bound, restricted to <code>AtomName</code>);</li>
<li><code>AtomName.f ni &lt;bounds-expr&gt;</code> (lower bound, restricted to <code>AtomName</code>);</li>
<li><code>AtomName.f = &lt;bounds-expr&gt;</code> (exact bound, restricted to <code>AtomName</code>); and</li>
<li><code>no AtomName.f</code> (exact bound <em>contains nothing</em>, restricted to <code>AtomName</code>).
Piecewise bindings add no restrictions to <em>other</em> atoms, only those mentioned. They can improve readability if you're defining a field for many different atoms. There is an example below.</li>
</ul>
<p>The specifics of <code>&lt;bounds-expr&gt;</code> depend on which Forge language you are using. </p>
<div id="admonition-bounds-arent-the-same-as-constraints" class="admonition admonish-warning">
<div class="admonition-title">
<p>Bounds aren't the same as constraints!</p>
<p><a class="admonition-anchor-link" href="docs/running-models/concrete-instance-bounds.html#admonition-bounds-arent-the-same-as-constraints"></a></p>
</div>
<div>
<p>The syntax of partial <code>inst</code>ances is very similar to the syntax you use to write constraints in <code>pred</code>icates. Always keep in mind that <strong>they are not the same</strong>; bindings have a far more restrictive syntax but allow you to refer to atoms directly---something constraints don't allow.</p>
</div>
</div>
<h3 id="froglet-style-bind-expressions"><a class="header" href="#froglet-style-bind-expressions">Froglet Style Bind Expressions</a></h3>
<p>In Froglet:</p>
<ul>
<li>a <code>&lt;bounds-expr&gt;</code> for a <code>sig</code> is a <code>+</code>-separated list of atom names (each prefixed by backquote), <code>sig</code> names that have already been bounded, and integers (without backquotes).</li>
<li>a <code>&lt;bounds-expr&gt;</code> for a field is a <code>+</code>-separated list of entries in that field, using atom names (each prefixed by a backquote), <code>sig</code> names that have already been bounded, and integers (without backquotes). Entries are defined using the <code>(arg1, arg2, ...) -&gt; result</code> syntax, and may be either complete or piecewise. 
<ul>
<li>a <em>complete</em> bind for a field </li>
</ul>
</li>
</ul>
<div id="admonition-froglet-style-bounds" class="admonition admonish-example">
<div class="admonition-title">
<p>Froglet-style bounds</p>
<p><a class="admonition-anchor-link" href="docs/running-models/concrete-instance-bounds.html#admonition-froglet-style-bounds"></a></p>
</div>
<div>
<p>Suppose you have a Forge model like this:</p>
<pre><code>sig Person {
    gradeIn: pfunc Course -&gt; Grade
}
sig Course {}
abstract sig Grade {}
</code></pre>
<p>where <code>Person</code> has a partial-function field <code>gradeIn</code>, indicating which grade they got in a given course (if any).</p>
<p>Given this concrete bound for the <code>Person</code>, <code>Course</code>, and <code>Grade</code> <code>sig</code>s:</p>
<pre><code>Person = `Person0 + `Person1 + `Person2
Course = `Course0 + `Course1 + `Course2
Grade = `A + `B + `C 
</code></pre>
<p>you might define bounds for the <code>gradeIn</code> field of <code>Person</code> all at once, for everyone:</p>
<pre><code>gradeIn = (`Person0, `Course0) -&gt; `A + 
          (`Person0, `Course1) -&gt; `B + 
          (`Person1, `Course2) -&gt; `C
</code></pre>
<p>or piecewise, one <code>Person</code> at a time:</p>
<pre><code>`Person0.gradeIn = `Course0 -&gt; `A + 
                   `Course1 -&gt; `B
`Person1.gradeIn = `Course2 -&gt; `C
no `Person2.gradeIn
</code></pre>
<p>Note that in the piecewise version, we need to explicitly say that <code>\</code>Person2` hasn't taken courses; in the all-at-once version, that's implicit.</p>
<p><em>This model is available in full <a href="docs/running-models/../example-models/piecewise-bounds.frg">here</a>.</em></p>
</div>
</div>
<div id="admonition-atom-names" class="admonition admonish-warning">
<div class="admonition-title">
<p>Atom names</p>
<p><a class="admonition-anchor-link" href="docs/running-models/concrete-instance-bounds.html#admonition-atom-names"></a></p>
</div>
<div>
<p>Identifiers prefixed by a backquote (<code>\</code>) always denote atom names. You cannot name atoms like this in ordinary constraints! (Thus, in the example above there is no <code>one sig A extends Grade {}</code>; there is only the atom <code>\</code>A`.)</p>
</div>
</div>
<div id="admonition-in-vs-ni-vs-" class="admonition admonish-warning">
<div class="admonition-title">
<p><code>in</code> vs. <code>ni</code> vs. <code>=</code></p>
<p><a class="admonition-anchor-link" href="docs/running-models/concrete-instance-bounds.html#admonition-in-vs-ni-vs-"></a></p>
</div>
<div>
<p>Bound expressions must not mix the <code>=</code>, <code>in</code> and <code>ni</code> operators for the same <code>sig</code> or field, even within a piecewise definition. It's OK to use <code>ni</code> for one field and <code>in</code> for another, but always use exactly one of them for each field. You should also not mix operators between sigs that are related by <code>extends</code>.</p>
</div>
</div>
<p><strong>This style of bind expression is still allowed in Relational Forge, so if you prefer it, feel free to continue using it!</strong> </p>
<h3 id="relational-forge-style-bind-expressions"><a class="header" href="#relational-forge-style-bind-expressions">Relational-Forge Style Bind Expressions</a></h3>
<p>From the relational perspective, a <code>&lt;bounds-expr&gt;</code> is a union (<code>+</code>) of products (<code>-&gt;</code>) of object names (each prefixed by backquote), <code>sig</code> names, and integers. Bounds expressions must be of appropriate arity for the sig or field name they are bounding. </p>
<div id="admonition-relational-bounds-expressions" class="admonition admonish-example">
<div class="admonition-title">
<p>Relational bounds expressions</p>
<p><a class="admonition-anchor-link" href="docs/running-models/concrete-instance-bounds.html#admonition-relational-bounds-expressions"></a></p>
</div>
<div>
<pre><code>A = `Alice+`Alex+`Adam
f = `Alice-&gt;`Alex + 
    `Adam-&gt;`Alex
g in `Alice-&gt;2 
</code></pre>
<p>where <code>A</code> is a sig, <code>f</code> is a field of <code>A</code> with value in <code>A</code>, and <code>g</code> is a field of <code>A</code> with integer value. Note that integers should be used directly, without backquotes.</p>
</div>
</div>
<div id="admonition-common-errors" class="admonition admonish-tip">
<div class="admonition-title">
<p>Common errors</p>
<p><a class="admonition-anchor-link" href="docs/running-models/concrete-instance-bounds.html#admonition-common-errors"></a></p>
</div>
<div>
<p><strong>Arity mismatches between the left and right-hand sides.</strong> E.g., in a standard directed graph where <code>edges</code> is a binary relation on <code>Node</code>s:</p>
<pre><code>edges in Node
</code></pre>
<p>would produce an error, even though the way you declare the field in Forge hides the extra column in the relation:</p>
<pre><code>sig Node { edges: set Node }
</code></pre>
<p><strong>Leaving parent <code>sig</code>s unbounded.</strong> Forge currently (January 2024) will not permit binding a child <code>sig</code> without first binding its parent <code>sig</code>. E.g., this results in an error if <code>Student</code> is a child <code>sig</code> of <code>Person</code>:</p>
<pre><code>Student = `Student0 + `Student1
</code></pre>
<p>To fix the problem, just add the same kind of bound for <code>Person</code>:</p>
<pre><code>Student = `Student0 + `Student1
Person = Student + `Teacher0
</code></pre>
</div>
</div>
<h3 id="inst-in-temporal-forge"><a class="header" href="#inst-in-temporal-forge"><code>inst</code> in Temporal Forge</a></h3>
<p>Temporal Forge also supports <code>inst</code> using the same syntax above. </p>
<div id="admonition-bounds-apply-to-all-states-at-once" class="admonition admonish-warning">
<div class="admonition-title">
<p>Bounds apply to all states at once!</p>
<p><a class="admonition-anchor-link" href="docs/running-models/concrete-instance-bounds.html#admonition-bounds-apply-to-all-states-at-once"></a></p>
</div>
<div>
<p>If you use a partial instance with a Temporal Forge model, be aware that there's no way to bind sigs or fields <em>per state</em>. Each binding is applied globally, so they can be very useful for optimization, but don't try to write <code>example</code>s with <code>inst</code> in Temporal Forge---you have no recourse to temporal operators in binding expressions!</p>
</div>
</div>
<h2 id="notes-on-semantics"><a class="header" href="#notes-on-semantics">Notes on Semantics</a></h2>
<p>Bounds declarations are resolved <em>in order</em> before the problem is sent to the solver. The right-hand side of each declaration is evaluated given all preceding bounds declarations, which means that using <code>sig</code> names on the right-hand side is allowed so long as those sigs are <em>exact bounded</em> by some preceding bounds declaration. </p>
<p>A bounds declaration cannot define bounds for a sig unless bounds for its ancestors are also defined. Bounds inconsistencies will produce an error message.</p>
<h3 id="mixing-numeric-scope-and-inst"><a class="header" href="#mixing-numeric-scope-and-inst">Mixing Numeric Scope and <code>inst</code></a></h3>
<p>You can mix both styles; just give the set-based bounds after the numeric ones. </p>
<div id="admonition-example-run-mixing-both-styles" class="admonition admonish-example">
<div class="admonition-title">
<p>Example <code>run</code> mixing both styles</p>
<p><a class="admonition-anchor-link" href="docs/running-models/concrete-instance-bounds.html#admonition-example-run-mixing-both-styles"></a></p>
</div>
<div>
<pre><code>run {myPred} for 5 Person for {Class = `Class0 + `Class1}
</code></pre>
</div>
</div>
<p>However, beware of inconsistencies! Numeric and <code>inst</code> bounds are (as of January 2024) only reconciled right before the solver is invoked, so you might receive confusing error messages of &quot;last resort&quot; in case of inconsistency between the two. </p>
<!-- The semantics of comparison commands using `=`, `in`, or `ni` are asymmetrical.  -->
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="options"><a class="header" href="#options">Options</a></h1>
<p>Forge has a number of options that affect how it functions and how its solver is configured. They all have the same form: <code>option &lt;key&gt; &lt;value&gt;</code>. <strong>Settings are case sensitive.</strong> The available setting keys are:</p>
<ul>
<li><code>verbose</code>: governs the amount of information provided in the REPL. <code>1</code> is standard; <code>0</code> will omit statistical information (useful for test suites); <code>10</code> will print exceedingly verbose debugging information. Values between <code>1</code> and <code>10</code> gradually increase verbosity.</li>
<li><code>solver</code>: sets the solver used by Forge's worker process. The default is <code>SAT4J</code>, a Java-based solver. Other solvers can be more performant, and produce different instance orderings, depending on model. The <code>MiniSatProver</code> solver will enable extraction of unsat cores. Support for native solvers varies by OS. Currently: 
<ul>
<li>MacOS (x64 and arm64 <code>.dylib</code>):
<ul>
<li><code>MiniSat</code>, <code>MiniSatProver</code>, and <code>Glucose</code></li>
</ul>
</li>
<li>Linux (<code>.so</code>): 
<ul>
<li><code>MiniSat</code>, <code>MiniSatProver</code>, and <code>Glucose</code></li>
</ul>
</li>
<li>Windows (<code>.dll</code>):
<ul>
<li><code>MiniSatProver</code></li>
</ul>
</li>
<li>All: 
<ul>
<li><code>&quot;&lt;path-to-solver&gt;&quot;</code>, which lets you run a solver of your own that accepts DIMACS input (see the section below for instructions). </li>
</ul>
</li>
</ul>
</li>
<li><code>logtranslation</code>: controls how much of the translation from Forge to boolean logic is logged. The default is <code>0</code>; must be <code>1</code> or higher to extract unsatisfiable cores.</li>
<li><code>coregranularity</code>: controls how fine-grained an unsatisfiable core will be returned. Default is <code>0</code>. Suggested value is <code>1</code> if you want to see cores.</li>
<li><code>core_minimization</code>: controls whether cores are guaranteed minimal. Default is <code>off</code>. For minimal cores, use <code>rce</code>; <code>hybrid</code> is not guaranteed minimal but is often better than <code>off</code> while being faster than <code>rce</code>.</li>
<li><code>sb</code>: controls maximum size of symmetry-breaking predicate. <code>20</code> is default. Higher numbers increase Forge's ability to rule out equivalent instances, at a potential performance cost.</li>
<li><code>skolem_depth</code>: gives how many layers of universal quantifiers to Skolemize past. Default is <code>0</code>; to disable Skolemization, give <code>-1</code>.</li>
<li><code>engine_verbosity</code>: sets the Logger level used by Pardinus (default=0). The following table is current as of version 1.5.0 (when the option was added):</li>
</ul>
<pre><code>case 0 : return Level.OFF;
case 1 : return Level.SEVERE;
case 2 : return Level.WARNING;
case 3 : return Level.INFO;
case 4 : return Level.FINE;
case 5 : return Level.FINER;
case 6 : return Level.FINEST;
default : return Level.ALL;
</code></pre>
<ul>
<li><code>run_sterling</code>: decides whether to use the Sterling visualizer. Default is <code>on</code>. To disable, give <code>off</code>. Alternatively, pass a string containing the file path of a visualizer script to auto-load it in Sterling.</li>
<li><code>sterling_port</code>: sets the port used by the Racket web-server that Sterling connects to. The default picks an unused ephemeral port.</li>
<li><code>test_keep</code>: controls Forge's behavior when running test suites. The default (<code>first</code>) will cause Forge to stop immediately on the first test failure. The only currently-supported alternative (<code>last</code>) will cause Forge to run all tests and print a report at the end; only the <em>final test failure</em> will remain open for use with Sterling.</li>
<li><code>problem_type</code>: used to enable <code>temporal_mode</code> for Alloy6-style LTL support. <strong>This option is deprecated in favor of using <code>#lang forge/temporal</code> instead</strong>, and may be removed in future versions.</li>
<li><code>no_overflow</code> (default: <code>false</code>): when set to <code>true</code>, enables the Pardinus/Kodkod backend's overflow protection. This will <em>exclude</em> instances which satisfy the given problem only due to bitwidth overflow semantics. E.g., <code>Counter.x = add[2,2]</code> would not be satisfiable at bitwidth <code>3</code> with this option set to <code>true</code>, because <code>4</code> is greater than the maximum value available with 3 bits. </li>
</ul>
<div id="admonition-location-matters" class="admonition admonish-warning">
<div class="admonition-title">
<p>Location matters!</p>
<p><a class="admonition-anchor-link" href="docs/running-models/options.html#admonition-location-matters"></a></p>
</div>
<div>
<p>Options apply from the point they occur onward until either the file ends or the same setting is changed. For instance, only the second <code>run</code> command in this example will print verbose debugging information.</p>
<pre><code>sig Node {edges: set Node}
run {}
option verbose 10
run {}
option verbose 1
run {}
</code></pre>
</div>
</div>
<h2 id="custom-solvers"><a class="header" href="#custom-solvers">Custom Solvers</a></h2>
<p>Forge can use a solver of your choice to produce instances; this is most often used to experiment with the solver you build in the DPLL homework. There are a few factors to be aware of.</p>
<h3 id="limitations"><a class="header" href="#limitations">Limitations</a></h3>
<p>While the &quot;Next&quot; button will be enabled in Sterling, the custom solver functionlity will always return the <em>first</em> instance found by the custom solver. There is also no support for unsatisfiable-core extraction; the custom solver will only report &quot;unsat&quot; for an unsatisfiable problem. </p>
<h3 id="instructions"><a class="header" href="#instructions">Instructions</a></h3>
<p>To invoke a custom solver, provide a double-quoted filepath literal as the solver name:</p>
<pre><code>option solver &quot;&lt;filepath-to-solver&gt;&quot;
</code></pre>
<p>Note that:</p>
<ul>
<li>the file must exist at the path specified;</li>
<li>the file must be executable;</li>
<li>the file must implement the DIMACS input/output format given in the DPLL assignment stencil;</li>
<li>if the file is a script using a <code>#!</code> preamble, the preamble must point to the correct location. E.g., if the file is a Python script that begins with <code>#!/usr/bin/python3</code>, your Python 3 executable must reside at <code>/usr/bin/python3</code>. </li>
</ul>
<p>The solver engine doesn't return rich information in the case of failure. Should any of these conditions not be met, you'll see a generic Pardinus crash error. </p>
<div id="admonition-note" class="admonition admonish-note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="docs/running-models/options.html#admonition-note"></a></p>
</div>
<div>
<p>If you're using Windows directly (rather than the Linux subsystem), extensions like <code>.py</code> will not be treated as executable. It may be useful to create a batch file (<code>.bat</code> extension) that invokes your solver, and give that batch file as the path in <code>option solver</code> instead.</p>
</div>
</div>
<h3 id="examples-1"><a class="header" href="#examples-1">Examples</a></h3>
<p>If you want to create a batch script on MacOS or Linux, you might try something like this in a <code>run.sh</code> file: </p>
<pre><code>#!/bin/sh
python3 solver.py $1
</code></pre>
<p>On windows, you could try something like this, in a <code>run.bat</code> file:</p>
<pre><code>@ECHO OFF
python3 solver.py %1
</code></pre>
<p>You might then invoke your solver via a <code>.frg</code> file like this:</p>
<pre><code>#lang forge

-- MacOS or Linux:
option solver &quot;./run.sh&quot;

-- Windows:
-- option solver &quot;./run.bat&quot;


sig Node {edges: set Node}

test expect {
    s: {some edges} for 1 Node is sat
    u: {no edges 
        all n: Node | some n.edges} for exactly 1 Node is unsat
        
}

-- This will work, but will only ever show one instance:
--run {}
</code></pre>
<p>If your script can be executed directly, then you can replace <code>./run.sh</code> in the above with the path to your script, including filename. On Windows, you will only be able to reference <code>.bat</code> or <code>.exe</code> files in your Forge solver option.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="testing"><a class="header" href="#testing">Testing</a></h1>
<p>Forge supports several different testing constructs:</p>
<ul>
<li><code>example</code>, for expressing that specific instances should satisfy (or not satisfy) a predicate; </li>
<li><code>assert</code>, for expressing that a specific predicate should be necessary or sufficient for another; and </li>
<li><code>test expect</code>, an expressive and general form that can be somewhat more difficult to use.</li>
</ul>
<p>If tests pass, they do not open the visualizer, making them well-suited for building test suites for your Forge models.</p>
<p><strong>Note on terminology</strong>: we will sometimes refer to <code>assert</code> and (some) <code>test expect</code> tests as <em>property tests</em>. This is because they can be used to express sweeping expectations about predicates, rather than just the point-wise, single-instance expectations that <code>example</code> can. </p>
<div id="admonition-shared-context" class="admonition admonish-note">
<div class="admonition-title">
<p>Shared Context</p>
<p><a class="admonition-anchor-link" href="docs/testing-chapter/testing.html#admonition-shared-context"></a></p>
</div>
<div>
<p>All the subsections below contain tests for the same small model of tic-tac-toe:</p>
<pre><code>abstract sig Player {}
one sig X, O extends Player {}
sig Board { board: pfunc (Int -&gt; Int) -&gt; Player }
pred wellformed {
  all b: Board | all row, col: Int | {
    (row &lt; 0 or row &gt; 2 or col &lt; 0 or col &gt; 2) implies
      no b.board[row][col] 
  } 
}
</code></pre>
</div>
</div>
<h2 id="examples-2"><a class="header" href="#examples-2">Examples</a></h2>
<p>The <code>example</code> syntax lets you test whether a specific instance is satisfied by some predicate in your model. An <code>example</code> contains three parts:</p>
<ul>
<li>a name for the example;</li>
<li>which predicate the instance should satisfy (or not satisfy); and </li>
<li>the instance itself. </li>
</ul>
<div id="admonition-example" class="admonition admonish-example">
<div class="admonition-title">
<p>Example</p>
<p><a class="admonition-anchor-link" href="docs/testing-chapter/testing.html#admonition-example"></a></p>
</div>
<div>
<p>This <code>example</code>, named <code>diagonalPasses</code>, expresses that a board where X has moved in the upper-left, middle, and lower-right squares (and <code>O</code> has made no moves at all) should satisfy the <code>wellformed</code> predicate:</p>
<pre><code>example diagonalPasses is {wellformed} for {
  Board = `Board0
  X = `X0 
  O = `O0
  A = `A0
  B = `B0
  C = `C0
  `Board0.board = (0,0)-&gt;`X + (1,1)-&gt;`X + (2,2)-&gt;`X
}
</code></pre>
<p>Notice that the <code>example</code> needs to give a value for <em>all</em> <code>sig</code>s and <em>all</em> fields, even the <code>one sig</code>s.</p>
</div>
</div>
<p>Examples are analogous to unit tests in Forge. Every example says that if the instance were passed to the predicate, the predicate would return true (or false). This means that examples are a great way to explore potential design choices and map out your intent when modeling.</p>
<div id="admonition-temporal-forge" class="admonition admonish-warning">
<div class="admonition-title">
<p>Temporal Forge</p>
<p><a class="admonition-anchor-link" href="docs/testing-chapter/testing.html#admonition-temporal-forge"></a></p>
</div>
<div>
<p>The <code>example</code> keyword is not supported in Temporal Forge.</p>
</div>
</div>
<h4 id="how-do-examples-work"><a class="header" href="#how-do-examples-work">How do examples work?</a></h4>
<p>An example passes if and only if the instance given is consistent with the predicate given. </p>
<div id="admonition-total-vs-partial-instances" class="admonition admonish-warning">
<div class="admonition-title">
<p>Total vs. partial instances</p>
<p><a class="admonition-anchor-link" href="docs/testing-chapter/testing.html#admonition-total-vs-partial-instances"></a></p>
</div>
<div>
<p>If you leave a sig or field unbound in an <code>example</code>, Forge is free to assign that sig or field in any way to achieve consistency with the predicate. The consequence is that it is possible to write apparently contradictory examples that pass. E.g., in the above example, if we left out the binding for <code>board</code>:</p>
<pre><code>example exampleYes is {wellformed} for {
  Board = `Board0
  X = `X0 
  O = `O0
  A = `A0
  B = `B0
  C = `C0  
}
example exampleNo is {not wellformed} for {
  Board = `Board0
  X = `X0 
  O = `O0
  A = `A0
  B = `B0
  C = `C0  
}
</code></pre>
<p><strong>Both</strong> of these examples would pass vs. the <code>wellformed</code> predicate, because Forge can find values for the <code>board</code> field that either satisfy or dissatisfy the <code>wellformed</code> predicate.</p>
</div>
</div>
<h3 id="notes-on-example-syntax"><a class="header" href="#notes-on-example-syntax">Notes on Example Syntax</a></h3>
<p>The block within the second pair of braces must always be a concrete instance. That is, a series of assignments for each sig and field to some set of tuples, defined over atom names. Atom names must be preceded by a backquote; this reinforces the idea that they are atoms in a specific instance, rather than names in the model. You will not be able to refer to these atoms in predicates and most other Forge syntax.</p>
<p><em>Don't</em> try to assign to the same field twice. If you want a field to contain multiple entries, use <code>+</code> instead. Remember that <code>=</code> in the context of an instance is <em>assignment</em>, not a constraint, and that most constraints won't work inside an instance.</p>
<p>Names of <code>sig</code>s may be used on the right-hand-side of an assignment only if the block has previously defined the value of that `sig`` exactly, allowing straightforward substitution.</p>
<h2 id="assert"><a class="header" href="#assert">Assert</a></h2>
<p>The <code>assert</code> syntax allows you to write tests in terms of <em>necessary</em> and <em>sufficient</em> properties for a predicate. </p>
<div id="admonition-assertions" class="admonition admonish-example">
<div class="admonition-title">
<p>Assertions</p>
<p><a class="admonition-anchor-link" href="docs/testing-chapter/testing.html#admonition-assertions"></a></p>
</div>
<div>
<p>If we first define these two predicates:</p>
<pre><code>pred fullFirstRow {some b: Board | b.board[0][0] = X and b.board[0][1] = X and b.board[0][2] = X}
pred someMoveTaken {some b: Board, row, col: Int | some b.board[row][col] }
</code></pre>
<p>we can then write two assertions:</p>
<pre><code>assert fullFirstRow is sufficient for winning for 1 Board
assert someMoveTaken is necessary for winning for 1 Board
</code></pre>
<p>which should both pass, since:</p>
<ul>
<li>if <code>X</code> occupied the entire first row, it has won; and </li>
<li>if someone has won the game, there must be moves taken on the board.</li>
</ul>
</div>
</div>
<p>Assertions also support universal quantification (i.e. <code>all</code>, but not <code>some</code>, <code>one</code>, <code>lone</code>, etc). For example, if you instead wrote the predicates:</p>
<div id="admonition-assertionsquant" class="admonition admonish-example">
<div class="admonition-title">
<p>AssertionsQuant</p>
<p><a class="admonition-anchor-link" href="docs/testing-chapter/testing.html#admonition-assertionsquant"></a></p>
</div>
<div>
<pre><code>pred fullFirstRow[b : Board] {b.board[0][0] = X and b.board[0][1] = X and b.board[0][2] = X}
pred someMoveTaken[b : Board, row : Int, col : Int] {some b.board[row][col] }
</code></pre>
<p>You could write the assertions</p>
<pre><code>assert all b : Board | fullFirstRow[b] is sufficient for winning for 1 Board
assert all b : Board, row, col : Int | someMoveTaken[b, row, col] is necessary for winning for 1 Board
</code></pre>
</div>
</div>
<p>Assertions are an excellent way to check and document your goals and assumptions about your model. In a more complex setting, we might write assertions that enforce:</p>
<ul>
<li>Dijkstra's algorithm doesn't terminate until the destination vertex has been reached; </li>
<li>for a game of chess to be won, a king must be in check; or</li>
<li>someone must first be logged into Gmail to read their mail.</li>
</ul>
<h3 id="notes-on-assert-syntax"><a class="header" href="#notes-on-assert-syntax">Notes on Assert Syntax</a></h3>
<p>Both the left- and right-hand-side of the assertion must be predicate names. That is, you <em>cannot</em> provide arbitrary formulas enclosed in brackets to an <code>assert</code>. This restriction eases some analysis but also encourages you to create reusable predicates.</p>
<h2 id="test-expect-blocks"><a class="header" href="#test-expect-blocks">Test-Expect Blocks</a></h2>
<p>Forge's <code>test expect</code> blocks are the most general, but also the most complex, form of testing in the tool. You don't need to provide a concrete, specific instance for <code>test expect</code>, and can check general properties. </p>
<p>Every <code>test expect</code> contains a set of individual checks. Each has:</p>
<ul>
<li>an optional test name;</li>
<li>a predicate block; and </li>
<li>an intention (<code>is sat</code>, <code>is unsat</code>, <code>is checked</code>, or—rarely!—<code>is forge_error</code>). </li>
</ul>
<p>The meaning of each intention is:</p>
<ul>
<li><code>is sat</code>: the predicate block is satisfiable under the given bounds; </li>
<li><code>is unsat</code>: the predicate block is unsatisfiable under the given bounds; and </li>
<li><code>is checked</code>: the predicate block's <em>negation</em> is unsatisfiable under the given bounds.</li>
<li><code>is forge_error</code>: running the predicate block under the given bounds results in a Forge error message. This is primarily used in our internal test suites. This intention allows an optional string that must match a substring of the actual error message. E.g., <code>... is forge_error &quot;very bad&quot;</code> would pass if the run produced a Forge error containing the substring <code>&quot;very bad&quot;</code>. </li>
</ul>
<p>Like the other test forms, each test may be accompanied by numeric scopes and <code>inst</code> bounds.</p>
<div id="admonition-test-expect" class="admonition admonish-example">
<div class="admonition-title">
<p>Test expect</p>
<p><a class="admonition-anchor-link" href="docs/testing-chapter/testing.html#admonition-test-expect"></a></p>
</div>
<div>
<p>This expresses that it's possible to satisfy the <code>someMoveTaken</code> predicate:</p>
<pre><code>test expect { possibleToMove: {someMoveTaken} is sat }  
</code></pre>
</div>
</div>
<div id="admonition-we-encourage-assert-over-test-expect-where-possible" class="admonition admonish-warning">
<div class="admonition-title">
<p>We encourage <code>assert</code> over <code>test expect</code> where possible</p>
<p><a class="admonition-anchor-link" href="docs/testing-chapter/testing.html#admonition-we-encourage-assert-over-test-expect-where-possible"></a></p>
</div>
<div>
<p>Sometimes, <code>test expect</code> is the only way to write a test for satisfiability without undue effort. But, if your test is really an assertion that something <em>cannot</em> happen, use an <code>assert</code> instead. Yes, a <code>test expect</code> with <code>is unsat</code> can express the same thing that an <code>assert</code> can, but we find that the <code>assert</code> form is more intuitive.</p>
</div>
</div>
<h2 id="suites-organizing-your-tests"><a class="header" href="#suites-organizing-your-tests">Suites: Organizing Your Tests</a></h2>
<p>You should organize your tests into <code>test suite</code>s for each predicate you plan to test.</p>
<div id="admonition-test-suite" class="admonition admonish-example">
<div class="admonition-title">
<p>Test Suite</p>
<p><a class="admonition-anchor-link" href="docs/testing-chapter/testing.html#admonition-test-suite"></a></p>
</div>
<div>
<p>For example, you could combine all the above forms into one suite for the <code>winning</code> predicate:</p>
<pre><code>test suite for winning {
  assert fullFirstRow is sufficient for winning for 1 Board
  assert someMoveTaken is necessary for winning for 1 Board
  
  test expect { possibleToWin_withoutFullFirstRow: {winning and not fullFirstRow} is sat } 
  
  example diagonalWin is {winning} for {
    Board = `Board0
    X = `X0 
    O = `O0
    A = `A0
    B = `B0
    C = `C0
    `Board0.board = (0,0)-&gt;`X + (1,1)-&gt;`X + (2,2)-&gt;`X
  }
}   
</code></pre>
</div>
</div>
<p><strong>Test suites can only contain tests of the above forms, and all tests should reference the predicate under test.</strong></p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="integers"><a class="header" href="#integers">Integers</a></h1>
<p>Forge supports <em>bit-vector</em> integers. That is, the Forge <code>Int</code> sig does not contain an infinite set of mathematical integers. Rather, an instance's <code>Int</code> sig contains a representation of a <em>subset</em> of the integers following <a href="https://en.wikipedia.org/wiki/Two%27s_complement">two's-complement encoding</a> for a specific number of bits. Concretely, if the bitwidth is <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>, the integers in an instance will be the interval <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0991em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">−</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>. The default bitwidth is 4.</p>
<div id="admonition-bitwidths" class="admonition admonish-example">
<div class="admonition-title">
<p>Bitwidths</p>
<p><a class="admonition-anchor-link" href="docs/forge-standard-library/integers.html#admonition-bitwidths"></a></p>
</div>
<div>
<p>If we run with a bitwidth of <code>2</code>, we only expect <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span></span></span></span> available integers: <code>-2</code> through <code>1</code>, inclusive.</p>
</div>
</div>
<div id="admonition-bounded-integers-and-overflow" class="admonition admonish-warning">
<div class="admonition-title">
<p>Bounded integers and overflow</p>
<p><a class="admonition-anchor-link" href="docs/forge-standard-library/integers.html#admonition-bounded-integers-and-overflow"></a></p>
</div>
<div>
<p>Remember that a bound on <code>Int</code> is the <em>bitwidth</em> allowed, not the number of integers! This is different from all other types in Forge.</p>
<p>Moreover, performing arithmetic on Forge integers may trigger integer overflow or underflow.</p>
<p><strong>Example</strong>: With a bitwidth of <code>4</code>, <code>add[7, 1]</code> evaluates to <code>-8</code>.</p>
<p>For more on integer bounds, see [[Bounds|Bounds]].</p>
</div>
</div>
<h2 id="remark"><a class="header" href="#remark">Remark</a></h2>
<p>There are <em>technically</em> two types of &quot;integers&quot; in Forge: integer <strong>values</strong> (e.g. 4) and integer <strong>atoms</strong> (e.g. the atom representing 4 in a given instance). You can think of this as roughly similar to the primitive-<code>int</code> vs. object-<code>Integer</code> distinction in Java, although the analogy is not perfect. Forge will usually be able to automatically convert between these two, and you shouldn't usually have to think about the difference. We still mention it here for completeness.</p>
<h2 id="integer-operators"><a class="header" href="#integer-operators">Integer Operators</a></h2>
<p>In the following, <code>&lt;atoms&gt;</code> represents a set of integer atoms and <code>&lt;value&gt;</code>, <code>&lt;value-a&gt;</code> and <code>&lt;value-b&gt;</code> are integer values. </p>
<ul>
<li><code>add[&lt;value-a&gt;, &lt;value-b&gt; ...]</code>: returns the value of the sum <code>value-a</code> + <code>value-b</code> + ...</li>
<li><code>subtract[&lt;value-a&gt;, &lt;value-a&gt; ...]</code>: returns the value of the difference <code>value-a</code> - <code>value-b</code> - ... </li>
<li><code>multiply[&lt;value-a&gt;, &lt;value-b&gt; ...]</code>: returns the value of the product <code>value-a</code> * <code>value-b</code> * ...</li>
<li><code>divide[&lt;value-a&gt;, &lt;value-b&gt; ...]</code>: returns the value of the left-associative integer quotient (<code>value-a</code> / <code>value-b</code>) / ...</li>
<li><code>remainder[&lt;value-a&gt;, &lt;value-b&gt;]</code>: returns the remainder for doing integer division. Note that if <code>value-a</code> is negative, the result will also be negative, and that integer wrap-around may affect the answer.</li>
<li><code>abs[&lt;value&gt;]</code>: returns the absolute value of <code>value</code></li>
<li><code>sign[&lt;value&gt;]</code>: returns 1 if <code>value</code> is &gt; 0, 0 if <code>value</code> is 0, and -1 if <code>value</code> is &lt; 0</li>
</ul>
<h2 id="comparison-operators-on-values"><a class="header" href="#comparison-operators-on-values">Comparison operators on values</a></h2>
<p>You can compare integer values using the usual <code>=</code>, <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;</code>, and <code>&gt;=</code>.</p>
<h2 id="counting"><a class="header" href="#counting">Counting</a></h2>
<p>Given an arbitrary expression <code>e</code>, the expression <code>#e</code> evaluates to the cardinality of (i.e., number of elements in) <code>e</code>. In Froglet, this is nearly always either <code>0</code> or <code>1</code>, although full Forge allows expressions that evaluate to sets of arbitrary size.</p>
<div id="admonition-if-youre-counting-check-the-bitwidth" class="admonition admonish-warning">
<div class="admonition-title">
<p>If you're counting, check the bitwidth!</p>
<p><a class="admonition-anchor-link" href="docs/forge-standard-library/integers.html#admonition-if-youre-counting-check-the-bitwidth"></a></p>
</div>
<div>
<p>Forge only represents <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span></span></span> possible integers, where <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> is the bitwidth. If you attempt to count beyond that (or do arithmetic that falls outside the available integers) Forge's solver will follow the two's complement convention and <em>wrap</em>. Thus, at a bitwidth of <code>4</code>, which allows counting between <code>-8</code> and <code>7</code> (inclusive), <code>add[7,1]</code> is <code>-8.</code></p>
</div>
</div>
<h3 id="counting-in-froglet"><a class="header" href="#counting-in-froglet">Counting in Froglet</a></h3>
<p>It is often useful to count even in Froglet, where expressions usually evaluate to either <code>none</code> or some singleton object. For example, in a tic-tac-toe model we might want to count the number of <code>X</code> entries on the board. In both Froglet and Forge, we can write this using a combination of <code>#</code> and <a href="docs/forge-standard-library/../building-models/constraints/expressions/relational-expressions/relational-expressions.html">set comprehension</a> (normally not available in Froglet): <code>#{row, col: Int | b.board[row][col] = X}</code>. </p>
<p>Concretely:</p>
<blockquote>
<p><code>#{x1: T1, ..., xn: Tn | &lt;fmla&gt;}</code> </p>
</blockquote>
<p>evaluates to an integer value reflecting the number of tuples <code>o1, ... on</code> where <code>&lt;fmla&gt;</code> is satisfied when <code>x1</code> takes the value <code>o1</code>, etc. </p>
<h2 id="aggregation-and-conversion"><a class="header" href="#aggregation-and-conversion">Aggregation and Conversion</a></h2>
<p>To convert between sets of integer atoms and integer values there are the following operations:</p>
<ul>
<li><code>sing[&lt;value&gt;]</code>: returns an integer atom representing the given value;</li>
<li><code>sum[&lt;atoms&gt;]</code>: returns an integer value: the sum of the values that are represented by each of the int atoms in the set;</li>
<li><code>max[&lt;atoms&gt;]</code>: returns an integer value: the maximum of all the values represented by the int atoms in the set; and</li>
<li><code>min[&lt;atoms&gt;]</code>: returns an integer value: the minimum of all the values represented by the int atoms in the set.</li>
</ul>
<p>While you might use <code>sum</code>, <code>max</code>, and <code>min</code>, you shouldn't need to use <code>sing</code>---Forge automatically converts between integer values and integer objects. If you do find you need to use <code>sing</code>, notify us ASAP!</p>
<h2 id="sum-aggregator"><a class="header" href="#sum-aggregator">Sum Aggregator</a></h2>
<p>You should be cautious using <code>sum[...]</code> once you start using the Relational Forge language. Suppose you have <code>sig A { i: one Int }</code>, and want to sum over all of the <code>i</code> values for every <code>A</code>. Duplicate values for <code>i</code> may exist across multiple <code>A</code> atoms. Then <code>sum[A.i]</code> would <em>not</em> count duplicates separately, since <code>A.i</code> evaluates to a <em>set</em>, which can have no duplicates!</p>
<p>Because of this problem, Forge provides a second way to use <code>sum</code> which does count duplicates:</p>
<pre><code>sum &lt;x&gt;: &lt;set&gt; | { &lt;int-expr&gt; }
</code></pre>
<p>Above, <code>x</code> is a variable name, <code>set</code> is the set you are quantifying over (currently only arity-1 sets are supported), and <code>int-expr</code> is an expression that evaluates to an <strong>integer value</strong>. The result of this entire expression is also an <strong>integer value</strong>. This counts duplicate integer values provided the atoms (of any type) in &quot;relation&quot; are different. The following example illustrates the difference between the two different uses of <code>sum</code>.</p>
<div id="admonition-sum-aggregator" class="admonition admonish-example">
<div class="admonition-title">
<p>Sum aggregator</p>
<p><a class="admonition-anchor-link" href="docs/forge-standard-library/integers.html#admonition-sum-aggregator"></a></p>
</div>
<div>
<p>In the instance:</p>
<pre><code>inst duplicates {
    A = `A0 + `A1
    time = `A0 -&gt; 1 + `A1 -&gt; 1
}
</code></pre>
<ul>
<li><code>sum[A.time]</code> evaluates to the value 1; and</li>
<li><code>sum a: A | sum[a.time]</code>  evaluates to the value 2.</li>
</ul>
</div>
</div>
<div id="admonition-only-one-variable-at-a-time" class="admonition admonish-warning">
<div class="admonition-title">
<p>Only one variable at a time</p>
<p><a class="admonition-anchor-link" href="docs/forge-standard-library/integers.html#admonition-only-one-variable-at-a-time"></a></p>
</div>
<div>
<p>The <code>sum</code> aggregator doesn't support multiple variables at once. If you want to express something like <code>sum x, y: A | ...</code>, write <code>sum x: A | sum y : A | ...</code> instead.</p>
</div>
</div>
<h2 id="the-successor-relation"><a class="header" href="#the-successor-relation">The Successor Relation</a></h2>
<p>Forge also provides a successor relation, <code>succ</code> (<code>Int -&gt; Int</code>) where each <code>Int</code> atom points to its successor (e.g. the <code>Int</code> atom 4 points to 5). The maximum <code>Int</code> atom does not point to anything.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="constants--keywords"><a class="header" href="#constants--keywords">Constants &amp; Keywords</a></h1>
<h2 id="constants"><a class="header" href="#constants">Constants</a></h2>
<p>Forge provides a few built-in constants:</p>
<ul>
<li><code>univ</code> (arity 1): the set of all objects in the universe (including <code>Int</code>s);</li>
<li><code>none</code> (arity 1): the empty set (to produce higher-arity empty relations, use the <code>-&gt;</code> operator. E.g., a 2-ary empty relation would be represented as <code>none -&gt; none</code> 
);</li>
<li><code>iden</code>: the identity relation (a total function from all objects in the universe to themselves, including <code>Ints</code>);</li>
<li><code>Int</code>: the set of available integer objects. By default it contains <code>-8</code> to <code>7</code> inclusive, since the default bitwidth is <code>4</code>. See <a href="docs/forge-standard-library/../forge-standard-library/integers.html">Integers</a> for more information.</li>
</ul>
<h2 id="keywords"><a class="header" href="#keywords">Keywords</a></h2>
<p>The following is a list of keywords in Forge that may not be used as names for relations, sigs, predicates, and runs. These include:</p>
<ul>
<li><code>state</code>, <code>transition</code> (reserved for future use)</li>
<li><code>sig</code>, <code>pred</code>, <code>fun</code></li>
<li><code>test</code>, <code>expect</code>, <code>assert</code>, <code>run</code>, <code>check</code>, <code>is</code>, <code>for</code></li>
<li>names of arithmetic operators, helpers, and built-in constants (e.g., <code>add</code>, <code>univ</code>, and <code>reachable</code>)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="helpers"><a class="header" href="#helpers">Helpers</a></h1>
<p>Forge and Frglet provide a number of built-in helpers to ease your work in the language.</p>
<h2 id="sequences"><a class="header" href="#sequences">Sequences</a></h2>
<p>A sequence is a field <code>f</code> of the form <code>f: pfunc Int -&gt; A</code> (where <code>A</code> can be any <code>sig</code>) such that:</p>
<ul>
<li><code>f</code> is a partial function (i.e., each <code>Int</code> has at most one corresponding entry);</li>
<li>no index <code>Int</code> is less than zero; and</li>
<li>indexes are contiguous (e.g., if there are entries at index <code>1</code> and index <code>3</code>, there must be one at index <code>2</code>).</li>
</ul>
<p>You can think of sequences as roughly analogous to fixed-size arrays in a language like Java. To tell Forge that a partial-function field <code>f</code> is a sequence, use the <code>isSeqOf</code> predicate.</p>
<p>Hint: make sure that you use <code>isSeqOf</code> in any test or run that you want to enforce that <code>f</code> is a sequence. The <code>isSeqOf</code> predicate is just another constraint: it's not a persistent declaration like <code>pfunc</code> is.</p>
<h4 id="isseqof"><a class="header" href="#isseqof">isSeqOf</a></h4>
<ul>
<li><code>isSeqOf[f, A]</code>: a predicate that holds if and only if <code>f</code> is a sequence of values in <code>A</code>.</li>
</ul>
<h3 id="sequence-helpers"><a class="header" href="#sequence-helpers">Sequence Helpers</a></h3>
<p>The following helpers are also available, but should only be used when <code>f</code> is a sequence:</p>
<h4 id="sequence-helper-functions"><a class="header" href="#sequence-helper-functions">Sequence Helper Functions:</a></h4>
<ul>
<li><code>seqFirst[f]</code>: returns the first element of <code>f</code>, i.e. <code>f[0]</code>.</li>
<li><code>seqLast[f]</code>: returns the last element of <code>f</code>.</li>
<li><code>indsOf[f, e]</code>: returns all the indices of <code>e</code> in <code>f</code>.</li>
<li><code>idxOf[f, e]</code>: returns the first index of <code>e</code> in <code>f</code>.</li>
<li><code>lastIdxOf[f, e]</code>: returns the last index of <code>e</code> in <code>f</code>.</li>
<li><code>elems[f]</code>: returns all the elements of <code>f</code>.</li>
<li><code>inds[f]</code>: returns all the indices of <code>f</code>.</li>
</ul>
<h4 id="sequence-helper-predicates"><a class="header" href="#sequence-helper-predicates">Sequence Helper Predicates:</a></h4>
<ul>
<li><code>isEmpty[f]</code>: true if and only if sequence <code>f</code> is empty.</li>
<li><code>hasDups[f]</code>: true if and only if sequence <code>f</code> has duplicates (i.e., there are at least two indices that point to the same value).</li>
</ul>
<h2 id="reachability"><a class="header" href="#reachability">Reachability</a></h2>
<p>Forge provides a convenient way to speak of an object being reachable via fields of other objects.</p>
<ul>
<li><code>reachable[a, b, f]</code>: object <code>a</code> is reachable from <code>b</code> through recursively applying field <code>f</code>. This predicate only works if <code>a.f</code> is well-defined.</li>
<li><code>reachable[a, b, f1, f2, ...]</code>: an extended version of <code>reachable</code> which supports using more than one field to reach <code>a</code> from <code>b</code>.</li>
</ul>
<p>The extended version of reachable is useful if you wish to model, e.g., binary trees where nodes have a <code>left</code> and <code>right</code> field. In such a model, if you want to quantify over all descendents of a <code>parent</code> node, you might write <code>all n: Node | reachable[n, parent, left, right]</code>.</p>
<div id="admonition-order-matters" class="admonition admonish-note">
<div class="admonition-title">
<p>Order matters!</p>
<p><a class="admonition-anchor-link" href="docs/forge-standard-library/helpers.html#admonition-order-matters"></a></p>
</div>
<div>
<p>Beware: the order of arguments in <code>reachable</code> matters! The first argument is the object <em>to be reached</em>, and the second argument is the <em>starting object</em>. Getting these reversed is a common source of errors.</p>
</div>
</div>
<div id="admonition-the-value-none-is-reachable-from-anything" class="admonition admonish-note">
<div class="admonition-title">
<p>The value <code>none</code> is reachable from anything</p>
<p><a class="admonition-anchor-link" href="docs/forge-standard-library/helpers.html#admonition-the-value-none-is-reachable-from-anything"></a></p>
</div>
<div>
<p>Beware: if you pass something that might be <code>none</code> as the first argument of <code>reachable</code>, in such cases <code>reachable</code> will evaluate to true. E.g., <code>reachable[p.spouse, p, father]</code> will evaluate to true if <code>p</code> happens to be unmarried.</p>
</div>
</div><div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="temporal-forge-overview"><a class="header" href="#temporal-forge-overview">Temporal Forge Overview</a></h1>
<p>Temporal mode extends Forge with temporal operators to ease specification and checking of dynamic systems. This mode draws heavily on the <a href="http://haslab.github.io/Electrum/">Electrum work</a> by INESC TEC and ONERA, and the newer Alloy 6 version, but there are (slight) differences.</p>
<p>To use Temporal Forge, just use <code>#lang forge/temporal</code>. This will cause a number of changes in how Forge processes your models, the largest one being that it will now always search for <strong>lasso traces</strong> (see below) rather than arbitrary instances. The maximum length of the trace is given by <code>option max_tracelength &lt;k&gt;</code> and defaults to <code>5</code>. The minimum length of the trace is given by <code>option min_tracelength &lt;k&gt;</code> and defaults to <code>1</code>. </p>
<div id="admonition-using-minimum-trace-length" class="admonition admonish-info">
<div class="admonition-title">
<p>Using Minimum Trace Length</p>
<p><a class="admonition-anchor-link" href="docs/electrum/electrum-overview.html#admonition-using-minimum-trace-length"></a></p>
</div>
<div>
<p>The temporal solver works by iterative deepening: try length 1, then length 2, ... and so <em>sometimes</em> (not always) a longer minimum trace length can speed up the process.</p>
</div>
</div>
<h2 id="variable-state-var"><a class="header" href="#variable-state-var">Variable state (<code>var</code>)</a></h2>
<p>Electrum mode allows <code>var</code> annotations to be placed on <code>sig</code> and field definitions. Such an annotation indicates that the contents of the corresponding relation may vary over time. Any sigs or fields that are not declared <code>var</code> will <em>not</em> vary over time.</p>
<div id="admonition-importance-of-var" class="admonition admonish-warning">
<div class="admonition-title">
<p>Importance of <code>var</code></p>
<p><a class="admonition-anchor-link" href="docs/electrum/electrum-overview.html#admonition-importance-of-var"></a></p>
</div>
<div>
<p>If no sigs or fields are declared <code>var</code>, the temporal solver cannot change anything from state to state.</p>
</div>
</div>
<div id="admonition-var-declarations" class="admonition admonish-example">
<div class="admonition-title">
<p><code>var</code> declarations</p>
<p><a class="admonition-anchor-link" href="docs/electrum/electrum-overview.html#admonition-var-declarations"></a></p>
</div>
<div>
<p>Writing <code>sig Vertex { var edges: set Vertex }</code> defines a directed graph whose edge relation may vary. </p>
<p>Writing <code>var sig Student {}</code> denotes that the set of students need not remain constant.</p>
</div>
</div>
<h2 id="temporal-mode-semantics-informally"><a class="header" href="#temporal-mode-semantics-informally">Temporal Mode Semantics (Informally)</a></h2>
<p>When the temporal solver is enabled, instances are always traces, and a trace is an <strong>infinite</strong> object, containing a state for every natural number <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>. However, the solver underlying Forge needs to finitize the problem in order to solve it. The solution to this, given a finite state-space, is to invoke the Pigeonhole Principle and seek traces that end in a loop: &quot;lassos&quot;.</p>
<div id="admonition-lassos-must-loop-back" class="admonition admonish-warning">
<div class="admonition-title">
<p>Lassos must loop back!</p>
<p><a class="admonition-anchor-link" href="docs/electrum/electrum-overview.html#admonition-lassos-must-loop-back"></a></p>
</div>
<div>
<p>If your system needs more steps before it loops back than the maximum trace length (e.g., an integer counter that overflows with a small trace length), Forge may tell you that there are no traces. Always pay attention to your <code>max_tracelength</code> option, and be convinced that it is sufficient to include the lassos you're interested in.</p>
</div>
</div>
<p>Temporal formulas and expressions are always evaluated with respect to a state index. At the top level of any formula, the index is <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> (the first state of the trace). Temporal operators either change or &quot;fan out&quot; across multiple state indexes to let you express things like:</p>
<ul>
<li>&quot;in the next state, ...&quot; (add 1 to the state index)</li>
<li>at some point in the future, ... (search for <code>some</code> state index)</li>
<li>at all points in the future, ... (check <code>all</code> future indexes)</li>
<li>...</li>
</ul>
<h2 id="added-relational-operators-priming"><a class="header" href="#added-relational-operators-priming">Added relational operators: priming</a></h2>
<p>Electrum mode adds one relational operator: priming (<code>'</code>). Any relational expression that is primed implicitly means &quot;this expression <strong>in the next state</strong>&quot;. Thus, you can use priming to concisely write transition effects. </p>
<div id="admonition-priming" class="admonition admonish-example">
<div class="admonition-title">
<p>Priming</p>
<p><a class="admonition-anchor-link" href="docs/electrum/electrum-overview.html#admonition-priming"></a></p>
</div>
<div>
<p>Writing <code>cookies' in cookies</code> would mean that in every transition, the set of <code>cookies</code> never grows over time (will either shrink or remain the same).</p>
</div>
</div>
<h2 id="added-formula-operators"><a class="header" href="#added-formula-operators">Added formula operators</a></h2>
<p>Electrum mode adds a number of formula operators, corresponding to those present in Linear Temporal Logic (LTL) and Past-Time Linear Temporal Logic.</p>
<h3 id="traditional-ltl-future-time"><a class="header" href="#traditional-ltl-future-time">Traditional LTL (future time)</a></h3>
<h4 id="next-state"><a class="header" href="#next-state">Next State</a></h4>
<ul>
<li><code>next_state &lt;fmla&gt;</code> is true in a state <code>i</code> if and only if: <code>fmla</code> holds in state <code>i+1</code>.</li>
</ul>
<div id="admonition-next_state" class="admonition admonish-example">
<div class="admonition-title">
<p>next_state</p>
<p><a class="admonition-anchor-link" href="docs/electrum/electrum-overview.html#admonition-next_state"></a></p>
</div>
<div>
<p>In a model with <code>one sig Nim { var cookies: set Cookie }</code>, writing <code>next_state no Nim.cookies</code> expresses the sad fact that, in the next state, Nim has no cookies.</p>
</div>
</div>
<div id="admonition-let-and-temporal-operators" class="admonition admonish-warning">
<div class="admonition-title">
<p>Let and temporal operators</p>
<p><a class="admonition-anchor-link" href="docs/electrum/electrum-overview.html#admonition-let-and-temporal-operators"></a></p>
</div>
<div>
<p>Don't try to write something like:</p>
<pre><code>let oldCount = Counter.count | 
    next_state Counter.count = add[oldCount, 1]
</code></pre>
<p>The <code>let</code> construct is implemented with substitution, and so the above will be rewritten to:</p>
<pre><code>next_state Counter.count = add[Counter.count, 1]
</code></pre>
<p>which expresses that, in the next state, the counter must be one greater than itself. This will be unsatisfiable.</p>
</div>
</div>
<h4 id="always-now-and-in-the-future"><a class="header" href="#always-now-and-in-the-future">Always (now and in the future)</a></h4>
<ul>
<li><code>always &lt;fmla&gt;</code> is true in a state <code>i</code> if and only if: <code>fmla</code> holds in every state <code>&gt;=i</code>.</li>
</ul>
<div id="admonition-always" class="admonition admonish-example">
<div class="admonition-title">
<p>always</p>
<p><a class="admonition-anchor-link" href="docs/electrum/electrum-overview.html#admonition-always"></a></p>
</div>
<div>
<p>In a model with <code>one sig Nim { var cookies: set Cookie }</code>, writing <code>always no Nim.cookies</code> expresses an alarming universal truth: from now on, Nim will never have any cookies.</p>
<p>Of course, operators like <code>always</code> can be used inside other operators. So this lamentable destiny might be avoided. E.g., <code>not always no Nim.cookies</code> would mean the reverse: at some point, Nim will in fact have cookies.</p>
</div>
</div>
<h4 id="eventually-now-or-sometime-in-the-future"><a class="header" href="#eventually-now-or-sometime-in-the-future">Eventually (now or sometime in the future)</a></h4>
<ul>
<li><code>eventually &lt;fmla&gt;</code> is true in a state <code>i</code> if and only if: <code>fmla</code> holds in some state <code>&gt;=i</code>.</li>
</ul>
<div id="admonition-eventually" class="admonition admonish-example">
<div class="admonition-title">
<p>eventually</p>
<p><a class="admonition-anchor-link" href="docs/electrum/electrum-overview.html#admonition-eventually"></a></p>
</div>
<div>
<p>In a model with <code>one sig Nim { var cookies: set Cookie }</code>, writing <code>eventually no Nim.cookies</code> expresses that at some point either now or in the future, Nim will lack cookies. Before and after that point, nothing prevents Nim from acquiring cookies.</p>
</div>
</div>
<h4 id="until-and-release-obligations"><a class="header" href="#until-and-release-obligations">Until and Release (obligations)</a></h4>
<ul>
<li><code>&lt;fmla-a&gt; until &lt;fmla-b&gt;</code> is true in a state <code>i</code> if and only if: <code>fmla-b</code> holds in some state <code>j&gt;=i</code> and <code>fmla-a</code> holds in all states <code>k</code> where <code>i &lt;= k &lt; j</code>. Note that the obligation to see <code>fmla-a</code> ceases in the state where <code>fmla-b</code> holds.</li>
</ul>
<div id="admonition-until" class="admonition admonish-example">
<div class="admonition-title">
<p>until</p>
<p><a class="admonition-anchor-link" href="docs/electrum/electrum-overview.html#admonition-until"></a></p>
</div>
<div>
<p>In a model with <code>one sig Nim { var cookies: set Cookie }</code>, writing <code>no Nim.cookies until some Nim.vegetables</code> expresses that, <em>starting at this point in time</em>, Nim must have no cookies until they also have vegetables. Once Nim obtains vegetables (including at this point in time), the obligation ends (and thus after that point Nim may have only cookies but no vegetables).</p>
</div>
</div>
<p>A natural question to ask is: what happens if <code>fmla-b</code> holds at multiple points in the future? However, this turns out not to matter: the definition says that the <code>until</code> formula is true in the current state if <code>fmla-b</code> holds at <strong>some</strong> point in the future (and <code>fmla-a</code> holds until then).</p>
<p>There is an alternative way to express obligations, which we won't use much:</p>
<ul>
<li><code>&lt;fmla-a&gt; releases &lt;fmla-b&gt;</code> is true in a state <code>i</code> if and only if: <code>fmla-a</code> holds in some state <code>j&gt;=i</code> and <code>fmla-b</code> holds in all states <code>k</code> where <code>i &lt;= k &lt;= j</code>, or <code>fmla-a</code> never occurs in a later state and <code>fmla-b</code> holds forever after. Note that the intuitive role of the two formulas is reversed between <code>until</code> and <code>releases</code>, and that, unlike <code>until</code>, the obligation extends to the state where <code>fmla-a</code> holds.</li>
</ul>
<h3 id="past-time-ltl"><a class="header" href="#past-time-ltl">Past-time LTL</a></h3>
<p><em>Past-time</em> operators are useful for concisely expressing some constraints. They don't add more expressive power to the temporal language, but they do sometimes make it easier to avoid adding state, etc.</p>
<h4 id="previous-state"><a class="header" href="#previous-state">Previous State</a></h4>
<ul>
<li><code>prev_state &lt;fmla&gt;</code> is true in a state <code>i</code> if and only if: <code>fmla</code> holds in state <code>i-1</code>. </li>
</ul>
<div id="admonition-there-is-nothing-before-the-first-state" class="admonition admonish-warning">
<div class="admonition-title">
<p>There is nothing before the first state</p>
<p><a class="admonition-anchor-link" href="docs/electrum/electrum-overview.html#admonition-there-is-nothing-before-the-first-state"></a></p>
</div>
<div>
<p>The formula <code>prev_state &lt;fmla&gt;</code> is canonically false if <code>i=0</code>, since there is no prior state. This holds regardless of what <code>&lt;fmla&gt;</code> contains; <code>prev_state</code> asserts the existence of a prior state.</p>
</div>
</div>
<h4 id="historically-always-in-the-past"><a class="header" href="#historically-always-in-the-past">Historically (always in the past)</a></h4>
<ul>
<li><code>historically &lt;fmla&gt;</code> is true in a state <code>i</code> if and only if: <code>fmla</code> holds in every state <code>&lt;=i</code>.</li>
</ul>
<h4 id="once-at-some-point-in-the-past"><a class="header" href="#once-at-some-point-in-the-past">Once (at some point in the past)</a></h4>
<ul>
<li><code>once &lt;fmla&gt;</code> is true in a state <code>i</code> if and only if: <code>fmla</code> holds in some state <code>&lt;=i</code>.</li>
</ul>
<h2 id="note-for-alloy-users"><a class="header" href="#note-for-alloy-users">Note for Alloy Users</a></h2>
<p>Alloy 6 and Electrum use the keywords <code>after</code> and <code>before</code> where Forge uses <code>next_state</code> and <code>prev_state</code>. We changed Forge to use these (admittedly more verbose) keywords in the hopes they are more clear. For example, <code>after</code> sounds like it could be a binary operator; in English, we might say &quot;turn left after 3 stops&quot;. Also, <code>next_state</code> is definitely a formula about the following state whereas <code>after</code> does not communicate the same sense of immediacy.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="custom-visualization-basics"><a class="header" href="#custom-visualization-basics">Custom Visualization Basics</a></h1>
<p>As seen in the <a href="docs/sterling/../running-models/sterling-visualizer.html">Sterling Visualizer</a> section, Forge uses an adapted version of the <a href="https://sterling-js.github.io/">Sterling</a> visualization tool. One of the advantages of using Sterling is that users can create their own custom visualization scripts.</p>
<h2 id="script-view-and-modes"><a class="header" href="#script-view-and-modes">Script View and Modes</a></h2>
<p>When viewing an instance in Sterling, there are three options for viewing an instance: Graph, Table, and Script. To swap to script-view mode, click on Script. Most of the screen will be taken up by 3 new panes:</p>
<ul>
<li>the visualization canvas (blank by default); </li>
<li>the script editor; and </li>
<li>a list of available variables that are available for scripts to use.</li>
</ul>
<p>Where the &quot;Next&quot; button was in the graph visualizer, there will now be 4 more buttons: </p>
<ul>
<li>Run executes the visualization script when clicked.</li>
<li><code>&lt;div&gt;</code>, <code>&lt;canvas&gt;</code> and <code>&lt;svg&gt;</code> swap between visualization modes. The default is <code>&lt;svg&gt;</code>. 
This documentation focuses on the <code>&lt;svg&gt;</code> mode, because that is where most of the library support is. </li>
</ul>
<div id="admonition-a-basic-script" class="admonition admonish-example">
<div class="admonition-title">
<p>A Basic Script</p>
<p><a class="admonition-anchor-link" href="docs/sterling/custom-basics.html#admonition-a-basic-script"></a></p>
</div>
<div>
<p>Try entering some visualization code in the script window and clicking &quot;Run&quot;:</p>
<pre><code>const stage = new Stage()
stage.add(new TextBox({
  text: 'Hello!', 
  coords: {x:100, y:100},
  color: 'black',
  fontSize: 16
}))
stage.render(svg, document)
</code></pre>
<p>This will create a <code>TextBox</code> in the visualization area that says &quot;Hello!&quot;.</p>
</div>
</div>
<p>Custom scripts are written in JavaScript. JavaScript constructs like looping, mapping over lists, etc. are all available for your use.</p>
<div id="admonition-javascript" class="admonition admonish-warning">
<div class="admonition-title">
<p>JavaScript</p>
<p><a class="admonition-anchor-link" href="docs/sterling/custom-basics.html#admonition-javascript"></a></p>
</div>
<div>
<p>At the moment (February 2023), the script editor works only with &quot;vanilla&quot; JavaScript; Sterling will not run (e.g.) a TypeScript compiler on the code. Moreover, importing external libraries is somewhat restricted.</p>
</div>
</div>
<h2 id="working-with-an-instance"><a class="header" href="#working-with-an-instance">Working with an Instance</a></h2>
<p>Sterling uses a number of JavaScript classes to represent an instance. <a href="https://alloy-js.github.io/alloy-ts/">The <code>alloy-ts</code> library documentation</a> describes these in more detail, but you should be aware of the following:</p>
<h3 id="the-instance"><a class="header" href="#the-instance">The Instance</a></h3>
<p>The <code>instance</code> variable provides access to the current instance. If temporal mode is active, <code>instance</code> will refer to the current state; to get the entire list of states, use <code>instances</code> instead (which is only available in temporal mode). </p>
<h3 id="accessing-sigs-and-fields"><a class="header" href="#accessing-sigs-and-fields">Accessing Sigs and Fields</a></h3>
<p>You can use the <code>.signature(name)</code> method of an instance to obtain an object representing a <code>sig</code> in the instance. Likewise, <code>.field(name)</code> will yield an object representing a particular field. </p>
<div id="admonition-a-basic-script-1" class="admonition admonish-example">
<div class="admonition-title">
<p>A Basic Script</p>
<p><a class="admonition-anchor-link" href="docs/sterling/custom-basics.html#admonition-a-basic-script-1"></a></p>
</div>
<div>
<p>If you're viewing an instance of the <a href="https://csci1710.github.io/2023/livecode/feb15_feb17_binarysearch.frg">binary search model</a> from class, you can run this script directly. (If you use this model, uncomment the <code>run</code> at the bottom of the file!)</p>
<pre><code>const stage = new Stage()
stage.add(new TextBox({
  text: `${instance.signature('IntArray')}`, 
  coords: {x:100, y:100},
  color: 'black',
  fontSize: 16
}))
stage.render(svg, document)
</code></pre>
<p>This will create a <code>TextBox</code> in the visualization area whose text is a string representation of the <code>Int</code> sig in whatever instance you're viewing. The string won't be very useful yet; it will be something like &quot;[IntArray]&quot;. Next, change <code>instance.signature('IntArray')</code> to <code>instance.signature('IntArray').atoms()[0]</code>---the first (and in this case, only) <code>IntArray</code> object in the instance. You'll see the sig name become an object id like <code>[IntArray0]</code>.</p>
<p>All <code>IntArray</code> objects have an <code>elements</code> field. We can get access to the field and print its contents by <em>joining</em> the object to its field:</p>
<pre><code>const stage = new Stage()
const theArray = instance.signature('IntArray').atoms()[0]
const elementsField = instance.field('elements')
stage.add(new TextBox({
  text: `${theArray.join(elementsField)}`, 
  coords: {x:100, y:100},
  color: 'black',
  fontSize: 16}))
stage.render(svg, document)
</code></pre>
<p>This should display something like &quot;1, 7 2, 7 3, 7 4, 7 5, 7 6, 7 7, 7&quot;. Again, not very useful. Sterling is printing the contents of the array in <code>index,value</code> form, but separating elements with space. We can fix this, though!</p>
</div>
</div>
<hr />
<h2 id="built-in-library-shapes"><a class="header" href="#built-in-library-shapes">Built-in Library Shapes</a></h2>
<p>Scripts in <code>&lt;svg&gt;</code> mode use the <a href="https://d3-graph-gallery.com/graph/shape.html">D3 visualization library</a> by default. However, D3 can be fairly complex to use, and so various <a href="docs/sterling/./d3fx.html">built-in helpers</a> are also available. We encourage using the helper library, although in more advanced cases you may wish to use D3 directly.</p>
<hr />
<h2 id="potential-pitfalls-and-debugging"><a class="header" href="#potential-pitfalls-and-debugging">Potential Pitfalls and Debugging</a></h2>
<p>Sterling presents a &quot;full Forge&quot; view of instances, and one that's closer to the way the solver works. All sigs and fields are represented as <em>sets</em> in the instance. Each set contains <code>AlloyTuple</code> objects, which themselves contain lists of <code>AlloyAtom</code>s. Because (at the moment) there is no support for types in the script editor, it can sometimes be troublesome to remember which kind of datum you're working with. The <code>alloy-ts</code> docs below provide much more detail, but in brief:</p>
<ul>
<li>if the object has an <code>.atoms()</code> method, it's an <code>AlloyTuple</code>;</li>
<li>if the object has an <code>.id()</code> method, it's an <code>AlloyAtom</code>; and</li>
<li>signatures, fields, tuples, and atoms are all <code>AlloySets</code> and provide a <code>.tuples()</code> method.</li>
</ul>
<p>In order to do a Froglet-style field access, you should use the <code>.join</code> method. (E.g., in the example above, we wrote <code>theArray.join(elementsField)</code> rather than <code>theArray.elementsField</code> or <code>theArray.elements</code>.)</p>
<p>We suggest using <code>TextBox</code>es to visualize debugging information. As a fallback, you can also use <code>console.log(...)</code> as normally in JavaScript, but the web-developer console in Sterling can be somewhat congested. Printing raw <code>AlloySet</code> objects via <code>console.log</code> will also not be immediately useful, since Sterling uses a proxy to manage the difference between the set as <em>Forge syntax</em> and the set as <em>a value in the instance</em>.</p>
<hr />
<h2 id="further-resources-and-examples"><a class="header" href="#further-resources-and-examples">Further Resources and Examples</a></h2>
<p>Further chapters:</p>
<ul>
<li><a href="docs/sterling/./d3fx_apr23.html">Visualization Helper Library</a> describes helpers (e.g., text boxes, grids, etc.) for visualization that don't require D3 knowledge.</li>
<li><a href="docs/sterling/./svg-tips.html">Working with SVG and Imports</a> explains how to (e.g.) increase the size of the rendering area.</li>
</ul>
<p>External resources:</p>
<ul>
<li><a href="https://www.w3schools.com/graphics/svg_intro.asp">What is the SVG format?</a></li>
<li><a href="https://docs.google.com/document/d/10pqJuWVp6ap-6JoEE5nDqrCKFpYcuzN81oItnYO3yS4/edit#heading=h.4p6wkcmc113e">D3FX helpers design documentation</a>---<strong>beware, this is actively being worked on and edited, and thus subject to change!</strong></li>
</ul>
<p>Examples using D3:</p>
<ul>
<li><a href="https://github.com/miasantomauro/lets-get-visual">Mia Santomauro's 2021 Guide</a> for custom visualization in Forge is still useful, but was made before most of the helper functions and classes above existed. If you're interested in using D3 directly with Sterling, it's a great starting point.</li>
<li>Tim's 2022 visualizer script examples also use D3 directly, rather than leveraging helpers, but may also be a useful reference:
<ul>
<li><a href="https://github.com/csci1710/public-examples/tree/main/2022/sudoku_opt_viz">Sudoku Synthesizer</a></li>
<li><a href="https://github.com/csci1710/public-examples/tree/main/2022/queue">Queue</a></li>
<li><a href="https://github.com/csci1710/public-examples/tree/main/2022/lights_puzzle">Lights Puzzle (temporal mode)</a> </li>
</ul>
</li>
<li>Tim and Mia also wrote a <a href="https://github.com/miasantomauro/mia-isp-spring-2021/tree/main/musical%20scales">&quot;visualizer&quot; that plays musical scales</a> generated by a model Tim wrote to understand music a bit better.</li>
</ul>
<div id="admonition-collaborators" class="admonition admonish-note">
<div class="admonition-title">
<p>Collaborators</p>
<p><a class="admonition-anchor-link" href="docs/sterling/custom-basics.html#admonition-collaborators"></a></p>
</div>
<div>
<p>Work on custom visualization in Sterling is an ongoing collaborative effort. We are grateful to Tristan Dyer for working to expand Sterling for Forge. We are also grateful for contributions from (in alphabetic order):</p>
<ul>
<li>Ethan Bove</li>
<li>Sidney LeVine</li>
<li>Mia Santomauro</li>
</ul>
</div>
</div><div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="d3fx-helpers"><a class="header" href="#d3fx-helpers">D3FX Helpers</a></h1>
<p>The D3FX helpers library was designed as an interface between Sterling users and the D3 visualization library in Javascript. D3 was originally the primary way that Forge users wrote custom visualizations. However, we have found that using D3 in Sterling can involve a large amount of learning and prep time--especially for those without much experience with JavaScript.</p>
<p>D3FX was created to ease writing custom visualizations in Sterling. It contains a library of shapes and objects that were commonly used in the past, such as grid layouts and labeled arrows. Since custom visualizations are still written in JavaScript, using D3FX requires some knowledge of the language, but its object-oriented design is meant to ease basic use for those who might be familiar with languages like Java or Python.</p>
<p>This page contains documentation for all classes in D3FX, along with small examples of how to create and work with them. Complete, runnable examples can be found in the Forge repository's <a href="https://github.com/tnelson/Forge/tree/dev/viz-examples"><code>viz-examples</code> directory</a>. </p>
<div id="admonition-warning" class="admonition admonish-warning">
<div class="admonition-title">
<p>Warning</p>
<p><a class="admonition-anchor-link" href="docs/sterling/d3fx_apr23.html#admonition-warning"></a></p>
</div>
<div>
<p>There has been one major change in the library since the start of Spring 2023. Constructors now take a single object, rather than a varying number of parameters. This makes it easier to add new parameters without breaking existing code, and avoids confusion about how to order parameters. However, this required a one-time breaking change. </p>
<p>If you've already written some visualizations based on the old method, converting should be easy. For example, our Dining Smiths lab visualization created a new text box with: </p>
<pre><code>new TextBox(`State:${idx}${lb}`,{x:0,y:0},'black',16)
</code></pre>
<p>This would need to be updated to :</p>
<pre><code>new TextBox({text: `State:${idx}${lb}`, coords: {x:0,y:0}, color: 'black', fontSize: 16})
</code></pre>
</div>
</div>
<h2 id="further-resources"><a class="header" href="#further-resources">Further Resources</a></h2>
<p>In addition to this page, you can view supplementary examples in the Forge repository <a href="https://github.com/tnelson/Forge/tree/dev/viz-examples">here</a>. Each contains both a Forge model to run (<code>.frg</code>) and the corresponding script file (<code>.js</code>).</p>
<h2 id="the-stage-and-visualobjects"><a class="header" href="#the-stage-and-visualobjects">The <code>Stage</code> and <code>VisualObjects</code></a></h2>
<p>Every element D3FX displays on the screen is represented by a <code>VisualObject</code>, which includes shapes like squares or circles, as well as more complicated objects like grids or trees.</p>
<p>To render visual objects, a <code>Stage</code> object needs to be created to contain them. After creating, the user can call <code>stage.add(...)</code> to place the visual object in the stage. To render all added <code>VisualObject</code>s, call <code>stage.render(...)</code>. Below is some important information for interacting with these objects, specifically for those without JavaScript experience.</p>
<div id="admonition-note" class="admonition admonish-note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="docs/sterling/d3fx_apr23.html#admonition-note"></a></p>
</div>
<div>
<p>Most commonly, <code>render</code> takes two parameters which are already defined in the script environment: <code>stage.render(svg, document)</code>.</p>
</div>
</div>
<h3 id="props-and-optional-parameters"><a class="header" href="#props-and-optional-parameters">Props and Optional Parameters</a></h3>
<p>All <code>VisualObject</code>s will take in a <em>props</em> (short for &quot;properties&quot;) object. Props objects have a number of fields with designated types. These fields can be entered in any order with their corresponding names. For example:</p>
<pre><code>new Rectangle({
    height: 100,
    width: 200,
    coords: {x: 100, y: 50},
    color: 'red',
    label: 'Hello'
})
</code></pre>
<p>For ease of use, we've written out a template for each of these props objects in terms of an <code>interface</code>, like the following:</p>
<pre><code>interface Coords {
    x: number,
    y: number
}
</code></pre>
<p>Fields in such interface declarations may include a <code>?</code>. This denotes that the field is <em>optional</em>.</p>
<div id="admonition-warning-1" class="admonition admonish-warning">
<div class="admonition-title">
<p>Warning</p>
<p><a class="admonition-anchor-link" href="docs/sterling/d3fx_apr23.html#admonition-warning-1"></a></p>
</div>
<div>
<p>While these definitions are useful tools, and these <code>interface</code> structures do exist in TypeScript (the language we wrote D3FX in), they <strong>do not</strong> exist in the raw JavaScript you'll use to write your visualizations! </p>
<p>That said, instantiating a props object with <code>{field1: value, field2: value, ...}</code> will still be understood by the library as if JavaScript understood this wider interface system. Just don't include types, or try to reference the interfaces directly.</p>
</div>
</div>
<div id="admonition-note-1" class="admonition admonish-note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="docs/sterling/d3fx_apr23.html#admonition-note-1"></a></p>
</div>
<div>
<p>When implementing one of the classes listed later on, you may be prompted with a type hint of the form <code>text: string | () =&gt; string</code>. This means that the field <code>text</code> can take in either or a string, or an anonymous funtion that produces a string. For simple use, you can more or less ignore this distinction, and choose only to pass in a string. For ease of reading, any type of this form (<code>T | () =&gt; T</code>) has been collapsed to just <code>T</code> in all library documentation.</p>
</div>
</div>
<h2 id="primitive-objects"><a class="header" href="#primitive-objects">Primitive Objects</a></h2>
<p>A <em>primitive</em> object is one that doesn't visually contain any other D3FX objects. </p>
<h3 id="textbox"><a class="header" href="#textbox"><code>TextBox</code></a></h3>
<p>Text boxes render text to the screen at a given location. Their constructor accepts a props object of the following form:</p>
<pre><code>interface TextBoxProps {
    text? : string,
    coords?: Coords,
    color?: string,
    fontSize?: number
}
</code></pre>
<p>Here is an example <code>TextBox</code> using these props:</p>
<pre><code>let text = new TextBox({
    text: 'hello',
    coords: {x: 50, y:50},
    color: 'black',
    fontSize: 12
}) 
</code></pre>
<div id="admonition-note-2" class="admonition admonish-note">
<div class="admonition-title">
<p>Note</p>
<p><a class="admonition-anchor-link" href="docs/sterling/d3fx_apr23.html#admonition-note-2"></a></p>
</div>
<div>
<p>All parameters can be changed after initiation with corresponding setter methods. These methods are in the typical OO style of <code>setX(newValue: Type)</code>, and should be suggested by the text editor for ease of use.</p>
</div>
</div>
<p>Additionally, <code>TextBox</code> supports script-defined callbacks. You can register <em>events</em> using the <code>events</code> prop. Supported events are described <a href="https://developer.mozilla.org/en-US/docs/Web/Events">here</a>.</p>
<div id="admonition-textbox-with-events" class="admonition admonish-example">
<div class="admonition-title">
<p>TextBox with events</p>
<p><a class="admonition-anchor-link" href="docs/sterling/d3fx_apr23.html#admonition-textbox-with-events"></a></p>
</div>
<div>
<pre><code>new TextBox({
    text: 'hello',
    coords: {x: 50, y:50},
    color: 'black',
    fontSize: 12,
    events: [
        {event: 'click', callback: () =&gt; {console.log('clicked!')}}
    ]
}) 
</code></pre>
</div>
</div>
<h3 id="imagebox"><a class="header" href="#imagebox">ImageBox</a></h3>
<p>An <code>ImageBox</code> contains an image loaded from a URL. </p>
<div id="admonition-imagebox" class="admonition admonish-example">
<div class="admonition-title">
<p>ImageBox</p>
<p><a class="admonition-anchor-link" href="docs/sterling/d3fx_apr23.html#admonition-imagebox"></a></p>
</div>
<div>
<pre><code>const stage = new Stage()
const box = new ImageBox({
    coords: {x:100,y:100}, 
    url: &quot;https://csci1710.github.io/2024/static/media/LFS_FROG.8de0a0795d10898e5fe9.png&quot;, 
    width:200, 
    height:200})
stage.add(box)
stage.render(svg)
</code></pre>
</div>
</div>
<h3 id="primitive-shapes"><a class="header" href="#primitive-shapes">Primitive Shapes</a></h3>
<p>The primitive object types <code>Rectangle</code>, <code>Circle</code>, and <code>Polygon</code> are all instances of a wider class called <code>Shape</code>. As a result, their props objects all implement the following interface:</p>
<pre><code>interface ShapeProps {
  color?: string,
  borderWidth?: number,
  borderColor?: string,
  label?: string,
  labelColor?: string,
  labelSize?: number,
  opacity?: number
}
</code></pre>
<p>For ease of reading, these fields will be rewritten later on where applicable.</p>
<h4 id="rectangle"><a class="header" href="#rectangle"><code>Rectangle</code></a></h4>
<p>Rectangles take in a pair of coordinates corresponding to the top left corner of the shape, along with a width and height. The props object is of the following form:</p>
<pre><code>interface RectangleProps extends shape {
    height: number,
    width: number,
    labelLocation?: string,
    coords?: Coords,

    // Borrowed from shape
    color?: string,
    borderWidth?: number,
    borderColor?: string,
    label?: string,
    labelColor?: string,
    labelSize?: number,
    opacity?: number
}
</code></pre>
<p>The value of <code>label-location</code> can be <code>&quot;center&quot;</code> (default). Other options include <code>&quot;topLeft&quot;</code>, <code>&quot;topRight&quot;</code>, <code>&quot;bottomLeft&quot;</code>, and <code>&quot;bottomRight&quot;</code>, which will generate text outside the rectangle in these locations. </p>
<p>Here is an example <code>Rectangle</code> using these props:</p>
<pre><code>let rect = new Rectangle({
    coords: {x: 100, y:100},
    height: 20,
    width: 20,
    color: &quot;pink&quot;,
    borderColor: &quot;black&quot;,
    borderWidth: 2,
    label: &quot;5&quot;
})
</code></pre>
<p>Which renders the following:</p>
<p><img src="docs/sterling/../images/d3-examples/rectangle.png" alt="Small, light blue circle." /></p>
<h4 id="circle"><a class="header" href="#circle"><code>Circle</code></a></h4>
<p>Circles take in a pair of coordinates as the center and a radius, along with the rest of the following props object:</p>
<pre><code>interface CircleProps extends ShapeProps {
    radius: number,

    // Borrowed from shape
    color?: string,
    borderWidth?: number,
    borderColor?: string,
    label?: string,
    labelColor?: string,
    labelSize?: number,
    opacity?: number
}
</code></pre>
<p>The text in the <code>label</code> will render in the center of the circle. Here is an example circle:</p>
<pre><code>let circ = new Circle({
    radius: 10, 
    center: {x: 100, y:100}, 
    color: 'aqua', 
    borderWidth: 2, 
    borderColor: 'black', 
}); 
</code></pre>
<p>Which renders the following:</p>
<p><img src="docs/sterling/../images/d3-examples/circle.png" alt="Small, light blue circle." /></p>
<h4 id="polygon"><a class="header" href="#polygon"><code>Polygon</code></a></h4>
<p>Polygons are the most generic of the primitive shapes offered in D3FX. They take in any list of points and create a shape with those points on the perimeter. The props are of the form:</p>
<pre><code>export interface PolygonProps extends ShapeProps {
    points: Coords[]

    // Borrowed from shape
    color?: string,
    borderWidth?: number,
    borderColor?: string,
    label?: string,
    labelColor?: string,
    labelSize?: number,
    opacity?: number
}
</code></pre>
<p>The label will be generated in roughly the center of the shape (the mean of the points entered). Here is an example of a polygon being used to create a (nonconvex) pentagon. </p>
<pre><code>polypoints = [
    {x:100, y:200},
    {x:200, y:200},
    {x:175, y:150},
    {x:200, y:100},
    {x:100, y:100}
]

let poly = new Polygon({
    points: polypoints, 
    color: 'orange', 
    borderWidth: 2, 
    borderColor: 'black', 
    label: &quot;Hi!&quot;,
    labelColor: &quot;black&quot; ,
    opacity: 0.7
});
</code></pre>
<p>Which will render the following pentagon:</p>
<p><img src="docs/sterling/../images/d3-examples/polygon.png" alt="Concave pentagon labelled 'Hi!'." /></p>
<h4 id="line"><a class="header" href="#line"><code>Line</code></a></h4>
<p>A <code>Line</code> takes in a series of points and creates a line passing through said points. </p>
<pre><code>interface LineProps {
  points?: Coords[], 
  arrow?: boolean,
  color?: string, 
  width?: number,
  opacity?: number
  style?: string
}
</code></pre>
<p>If <code>arrow</code> is true, the end of the line will have a small arrowhead. Style can take the values of <code>'dotted'</code> or <code>'dashed'</code>Here's an example line:</p>
<pre><code>polypoints = [
    {x:100, y:100},
    {x:125, y:100},
    {x:150, y:75},
    {x:200, y:125},
    {x:225, y:100},
    {x:250, y:100}
]

let line = new Line({
    points: polypoints, 
    color: 'black', 
    width: 2, 
    labelColor: &quot;blue&quot;,
    arrow: true,
    style: &quot;dotted&quot;
});
</code></pre>
<p>Which will render:</p>
<p><img src="docs/sterling/../images/d3-examples/line.png" alt="Jagged, dotted line with an arrowhead." /></p>
<h2 id="compound-objects"><a class="header" href="#compound-objects">Compound Objects</a></h2>
<p>While the above objects are good for simple visualizations, managing the relationship between many primitive objects manually can be difficult.  With this in mind, D3FX provides a number of <em>compound</em> objects, which automatically group their child objects in a particular way. </p>
<div id="admonition-warning-2" class="admonition admonish-warning">
<div class="admonition-title">
<p>Warning</p>
<p><a class="admonition-anchor-link" href="docs/sterling/d3fx_apr23.html#admonition-warning-2"></a></p>
</div>
<div>
<p>Compound objects are responsible for rendering their children. If an object is a child of another object, don't <code>add</code> it to the stage as well. If you do so, there may be unexpected consequences when rendering, since the child object would then be rendered twice in two different contexts.</p>
<p>In other words, avoid code like the following:</p>
<pre><code>circ = new Circle({...})
comp = new SomeCompoundObject({innerObject: circ, ...}) // circ is a child object

stage.add(comp) // the stage will render comp, which then renders its child circ
stage.add(circ) // the stage will render circ (again)
</code></pre>
</div>
</div>
<h3 id="grid"><a class="header" href="#grid"><code>Grid</code></a></h3>
<p>Grids place visual objects into a 2-dimensional arrangement of cells. The grid constructor takes in the following props:</p>
<pre><code>interface gridProps {
    grid_location: Coords, // Top left corner
    cell_size:{
        x_size:number,
        y_size:number
    },
    grid_dimensions:{
        x_size:number,
        y_size:number
    },
}
</code></pre>
<p>The <code>grid_dimensions</code> field should be a pair of positive integers, referring to the horizontal and vertical capacity of the array, respectively. The <code>cell_size</code>, in pixels, will be the size allocated for each of these objects in the rendered grid. Grids also offer the <code>add</code> method to fill these cells with <code>VisualObject</code>s:</p>
<pre><code>add(
    coords: Coords, 
    add_object:VisualObject, 
    ignore_warning?:boolean
)
</code></pre>
<p>The coordinates should be integers designating which row and column of the grid to add the child object to. Notably, <em>the child object's visual location will immediately be adjusted to fit the cell.</em></p>
<p>Adding a child object will produce an error if the child object does not fit into the given cell. To ignore this error, set the <code>ignore_warning</code> prop to true. </p>
<p>Here is an example of a simple grid:</p>
<pre><code>let grid = new Grid({
    grid_location: {x: 50, y:50},
    cell_size: {x_size: 30, y_size: 30},
    grid_dimensions: {x_size: 4, y_size: 5}
})

grid.add({x: 0, y: 1}, new Circle({radius: 10, color: &quot;red&quot;}))
grid.add({x: 3, y: 3}, new Circle({radius: 10, color: &quot;blue&quot;}))
</code></pre>
<p>Here we have a 4x4 grid of 30x30 pixel squares, into two of which we place circles. Note that the circles added to the grid do not have coordinates. This is because the coordinates of these shapes are immediately changed to be in the center of the given squares in the grid. This renders as follows:</p>
<p><img src="docs/sterling/../images/d3-examples/grid.png" alt="Example grid with circles at (0, 1) and (3, 3)." /></p>
<h3 id="tree"><a class="header" href="#tree"><code>Tree</code></a></h3>
<p>The <code>Tree</code> object renders a branching data structure. While in principle Sterling's default visualization can produce trees, the <code>Tree</code> object in D3FX allows a finer degree of control. </p>
<p>The nodes in a <code>Tree</code> object are themselves visual objects, which will then automatically be rendered with lines between them. The props for <code>Tree</code> are as follows:</p>
<pre><code>interface TreeProps {
    root: VisTree, 
    height: number, 
    width: number, 
    coords?: Coords, 
    edgeColor?: string, 
    edgeWidth?: number
}
</code></pre>
<p>Where the <code>VisTree</code> interface logically represents a tree and its subtrees in recursive fashion:</p>
<pre><code>interface VisTree{
    visualObject: VisualObject,
    children: VisTree[]
}
</code></pre>
<p>When rendered, the tree will be adjusted to exactly fit into the box with top-left corner designated by <code>coords</code> and dimensions designated by <code>height</code> and <code>width</code>. Here is an example tree with four layers:</p>
<pre><code>let obj1 = new Circle({radius: 10, color: 'red', borderColor: &quot;black&quot;, label: '1'});
let obj2 = new Circle({radius: 10, color: 'red', borderColor: &quot;black&quot;, label: '2'});
let obj3 = new Rectangle({height: 20, width: 20, color: 'green', borderColor: &quot;black&quot;, label: '3'});
let obj4 = new Circle({radius: 10, color: 'red', borderColor: &quot;black&quot;, label: '4'});
let obj5 = new Circle({radius: 10, color: 'red', borderColor: &quot;black&quot;, label: '5'});
let obj6 = new Circle({radius: 10, color: 'red', borderColor: &quot;black&quot;, label: '6'});
let obj7 = new Circle({radius: 10, color: 'blue', borderColor: &quot;black&quot;, label: '7'});
let obj8 = new Circle({radius: 10, color: 'blue', borderColor: &quot;black&quot;, label: '8'});

let visTree = {
  visualObject: obj1,
  children: [
    {
      visualObject: obj2,
      children: [
        { visualObject: obj4, children: [] },
        {
          visualObject: obj5,
          children: [{ visualObject: obj8, children: [] }]
        },
        { visualObject: obj7, children: [] }
      ]
    },
    {
      visualObject: obj3,
      children: [{ visualObject: obj6, children: [] }]
    }
  ]
};

let tree = new Tree({
    root: visTree, 
    height: 200, 
    width: 200, 
    coords: { x: 100, y: 100 }
    });
</code></pre>
<p>which renders as:</p>
<p><img src="docs/sterling/../images/d3-examples/tree.png" alt="A rendering of a grid with 7 circles and 1 square, arranged as stated in the code." /></p>
<h3 id="edge"><a class="header" href="#edge"><code>Edge</code></a></h3>
<p>Edges display relationships between objects, without requiring manual management of those objects' locations---unlike the primitive <code>Line</code>. Edge objects take in the following props:</p>
<pre><code>export interface EdgeProps {
  obj1: VisualObject;
  obj2: VisualObject;
  lineProps: LineProps;
  textProps: TextBoxProps;
  textLocation: string;
}
</code></pre>
<p>Here, <code>obj1</code> represents the first visual object, or the source of the edge, and <code>obj2</code> is the sink. Styling, color, width, and more attributes of the edge itself can be designated in <code>lineProps</code>, which contains all the information that would normally be passed to a <code>Line</code>.  Similarly, the label for the line is designated by <code>textProps</code>, which supports all relevant features used in the label's underlying <code>TextBox</code> object.</p>
<div id="admonition-warning-3" class="admonition admonish-warning">
<div class="admonition-title">
<p>Warning</p>
<p><a class="admonition-anchor-link" href="docs/sterling/d3fx_apr23.html#admonition-warning-3"></a></p>
</div>
<div>
<p>Unlike with other compound objects, <code>Edge</code> <em>does not</em> render its children. This is because each object should only be rendered once, but an object might be referenced by multiple edges, such as in visualizing a graph. </p>
<p>Thus, the objects that an edge spans must still be added to the stage, or to some other appropriate and unique container.</p>
</div>
</div>
<p>Lastly, <code>textLocation</code> allows for freedom in determining the location of the label. By default, the label will appear in the exact center of the line. However, passing in <code>right</code>, <code>left</code>, <code>above</code>, or <code>below</code> will offset the location by whatever orthogonal direction closest to the input. There is also support for <code>clockwise</code> or <code>counterclockwise</code>, which place the label in the stated location from the perspective of the source object. Here is an example of a few edges between visualObjects:</p>
<pre><code>const rect = new Rectangle({width: 20, height: 20, coords: {x:200, y:50}})
const circ1 = new Circle({radius: 10, center: {x:150, y:200}})
const circ2 = new Circle({radius: 10, center: {x:250, y:200}})

const edge1 = new Edge({
    obj1: rect, obj2: circ1,
    textProps: {text: &quot;e1&quot;, fontSize: 11},
    textLocation: &quot;above&quot;
})
const edge2 = new Edge({obj1: circ1, obj2: rect,
    textProps: {text: &quot;e2&quot;, fontSize: 11},
    textLocation: &quot;below&quot;})
const edge3 = new Edge({obj1: circ1, obj2: circ2,
    textProps: {text: &quot;e3&quot;, fontSize: 11},
    lineProps: {color: &quot;green&quot;},
    textLocation: &quot;above&quot;})
const edge4 = new Edge({obj1: rect, obj2: circ2,
    lineProps: {arrow: true},
    textProps: {text: &quot;e4&quot;, fontSize: 11},
    textLocation: &quot;above&quot;})

// Adding all objects and circles to the stage individually before rendering. 
</code></pre>
<p>This renders as:</p>
<p><img src="docs/sterling/../images/d3-examples/edges.png" alt="A rendering of a rectangle and two circles, with edges between them as specified in the above code." /></p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="working-with-svg"><a class="header" href="#working-with-svg">Working with SVG</a></h1>
<h2 id="expanding-the-svg-region"><a class="header" href="#expanding-the-svg-region">Expanding the SVG Region</a></h2>
<p>If the default <code>svg</code> area is not the right size for your needs, you can change its dimensions. </p>
<p>The <code>&lt;svg&gt;</code> element that scripts render to is contained within an element called <code>svg-container</code>, whose only child is the render area. Thus, the render area can be obtained with:</p>
<pre><code>const renderArea = document.getElementById('svg-container').getElementsByTagName('svg')[0]
</code></pre>
<p>You can then set the <code>style.width</code> and <code>style.height</code> attributes of the rendering area. </p>
<div id="admonition-changing-the-rendering-area-size" class="admonition admonish-example">
<div class="admonition-title">
<p>Changing the rendering area size</p>
<p><a class="admonition-anchor-link" href="docs/sterling/svg-tips.html#admonition-changing-the-rendering-area-size"></a></p>
</div>
<div>
<p>This code changes the available space in the <code>&lt;svg&gt;</code> element, giving us 5 times the original vertical space to work with: </p>
<pre><code>const svgContainer = document.getElementById('svg-container')
svgContainer.getElementsByTagName('svg')[0].style.height = '500%'
svgContainer.getElementsByTagName('svg')[0].style.width = '100%'
</code></pre>
</div>
</div>
<div id="admonition-resizing-in-the-script" class="admonition admonish-warning">
<div class="admonition-title">
<p>Resizing in the script</p>
<p><a class="admonition-anchor-link" href="docs/sterling/svg-tips.html#admonition-resizing-in-the-script"></a></p>
</div>
<div>
<p>If you're using the helper library, you may need to resize <em>after</em> calling <code>stage.render</code>.</p>
</div>
</div>
<h3 id="alternative-method"><a class="header" href="#alternative-method">Alternative Method</a></h3>
<p>You also have access to set the <a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/viewBox"><code>viewBox</code> attribute</a> of the <code>&lt;svg&gt;</code> region. However, we don't suggest making this specific kind of low-level change if you're working only with D3FX.</p>
<div id="admonition-1000-by-1000-viewbox" class="admonition admonish-example">
<div class="admonition-title">
<p>1000 by 1000 viewbox</p>
<p><a class="admonition-anchor-link" href="docs/sterling/svg-tips.html#admonition-1000-by-1000-viewbox"></a></p>
</div>
<div>
<pre><code>require('d3')
d3.select(svg).attr(&quot;viewBox&quot;, &quot;0 0 1000 1000&quot;)
</code></pre>
</div>
</div>
<h2 id="importing-modules"><a class="header" href="#importing-modules">Importing modules</a></h2>
<p>Sterling uses the <a href="https://github.com/d3/d3-require"><code>d3-require</code></a> and <a href="https://www.jsdelivr.com/">jsdelivr</a> systems to import external libraries. These should be given in the first lines of the script (before any comments!) and be enclosed in a single <code>require</code> form per library. E.g., to import the <code>d3-array</code> and <code>d3-format</code> libraries:</p>
<pre><code>require(&quot;d3-array&quot;)
require(&quot;d3-format&quot;)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="attribute-based-access-control"><a class="header" href="#attribute-based-access-control">Attribute-Based Access Control</a></h1>
<p>The Attribute-Based Access Control (ABAC) language can be enabled via <code>#lang forge/domains/abac</code> on the first line of a file. The syntax of the language is totally distinct from Froglet, Relational Forge, and Temporal forge. </p>
<h2 id="purpose"><a class="header" href="#purpose">Purpose</a></h2>
<p>ABAC policies describe whether <em>requests</em> should be permitted or denied. Requests comprise three <em>variables</em>:</p>
<ul>
<li><code>s</code>: the subject (i.e., the individual or program making the request);</li>
<li><code>a</code>: the action (i.e., the type of access being requested); and</li>
<li><code>r</code>: the resource (i.e., the file or other object being acted upon by the request).</li>
</ul>
<div id="admonition-example" class="admonition admonish-example">
<div class="admonition-title">
<p>Example</p>
<p><a class="admonition-anchor-link" href="docs/dsl/abac.html#admonition-example"></a></p>
</div>
<div>
<pre><code>policy original
  // Administrators can read and write anything
  permit if: s is admin, a is read.
  permit if: s is admin, a is write.
  // Files being audited can't be changed by customers
  deny   if: a is write, r is file, r is under-audit.
  // Customers have full access to files they own
  permit if: s is customer, a is read, s is owner-of r.
  permit if: s is customer, a is write, s is owner-of r.
end;
</code></pre>
</div>
</div>
<h2 id="policy-syntax"><a class="header" href="#policy-syntax">Policy Syntax</a></h2>
<p>A policy declaration comprises a name and a set of a rules. The form is:</p>
<pre><code>policy &lt;NAME&gt;
  &lt;RULE1&gt;
  &lt;RULE2&gt;
  ...
end;
</code></pre>
<h2 id="rule-syntax"><a class="header" href="#rule-syntax">Rule Syntax</a></h2>
<p>A rule contains a decision and a sequence of conditions, terminated by a period. </p>
<pre><code>&lt;DECISION&gt; if: &lt;CONDITION1&gt;, &lt;CONDITION2&gt;, ... .
</code></pre>
<p>Decisions may be either:</p>
<ul>
<li><code>permit</code>; or </li>
<li><code>deny</code>. </li>
</ul>
<h2 id="condition-syntax"><a class="header" href="#condition-syntax">Condition Syntax</a></h2>
<p>Finally, a condition expresses a requirement involving one of the three request variables. If the condition involves only one variable, it takes the form <code>&lt;var&gt; is &lt;attribute&gt;</code>. If the condition involves two variables, it takes the form <code>&lt;var 2&gt; is &lt;attribute&gt; &lt;var 2&gt;</code>.</p>
<p>For the moment, the ABAC language is built for a specific assignment. Thus, the vocabulary of the language is restricted to the following attributes: </p>
<ul>
<li>for subjects: <code>admin</code>, <code>accountant</code>, and <code>customer</code>;</li>
<li>for actions: <code>read</code> and <code>write</code>;</li>
<li>for resources: <code>file</code>. </li>
<li>for combinations of subject and resource: <code>owner-of</code> and <code>under-audit</code>.</li>
</ul>
<h2 id="analysis-commands"><a class="header" href="#analysis-commands">Analysis Commands</a></h2>
<p>For the purposes of this assignment, only one command should be necessary:</p>
<h3 id="comparing-policies"><a class="header" href="#comparing-policies">Comparing Policies</a></h3>
<p>The <code>compare</code> command uses Forge to run a &quot;semantic diff&quot; on two policies. It will produce a single scenario that describes a request where the two policies differ in their decisions, along with which rule applied to cause the difference. </p>
<p>Like policies, commands must be terminated with a semicolon. </p>
<div id="admonition-comparing-two-policies" class="admonition admonish-example">
<div class="admonition-title">
<p>Comparing two policies</p>
<p><a class="admonition-anchor-link" href="docs/dsl/abac.html#admonition-comparing-two-policies"></a></p>
</div>
<div>
<p>To compare two policies named <code>original</code> and <code>modified</code>:</p>
<pre><code>compare original modified;
</code></pre>
<p>In this case, the output might resemble:</p>
<pre><code>Comparing policies original and modified...

-----------------------------------
Found example request involving...
a subject &lt;s&gt; that is:  Accountant, Employee
an action &lt;a&gt; that is:  Read
a resource &lt;r&gt; that is: File
Also,
  &lt;r&gt; is Audit

This rule applied in the second policy:
    permit if: s is accountant, a is read, r is under-audit.
Decisions: modified permitted; original denied
</code></pre>
<p>This indicates that the two policies aren't equivalent. Furthermore, a request
from an accountant to read a file that is under audit will be handled differently
by the two policies---demonstrating the inequivalence.</p>
</div>
</div>
<h3 id="other-commands"><a class="header" href="#other-commands">Other Commands</a></h3>
<ul>
<li><code>info</code> prints the names of policies currently defined. </li>
<li><code>query</code> can query the behavior of a single policy given a condition. </li>
</ul>
<div id="admonition-an-example-query" class="admonition admonish-example">
<div class="admonition-title">
<p>An example query</p>
<p><a class="admonition-anchor-link" href="docs/dsl/abac.html#admonition-an-example-query"></a></p>
</div>
<div>
<p>To ask for scenarios where the <code>original</code> policy permits a request
involving someone who is not an administrator:</p>
<pre><code>query original yields permit where s is not admin;
</code></pre>
</div>
</div>
<h2 id="implementation-notes"><a class="header" href="#implementation-notes">Implementation Notes</a></h2>
<p>At the moment, there is no way to get <em>another</em> example from <code>compare</code> or <code>query</code>; in practice it would be implemented the same way that Forge's &quot;next&quot; button is. </p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="what-should-i-do-if"><a class="header" href="#what-should-i-do-if">What should I do if...?</a></h1>
<h2 id="pardinus-cli-shut-down-unexpectedly"><a class="header" href="#pardinus-cli-shut-down-unexpectedly">Pardinus CLI shut down unexpectedly</a></h2>
<p>This means that the backend solver process (Pardinus) has terminated early. Usually there is an error message, or at least some error state that is displayed. If you don't see anything, turn on <code>option verbosity 2</code>, which will echo back the info messages that Pardinus sends. </p>
<h3 id="arity-too-large"><a class="header" href="#arity-too-large">Arity too large</a></h3>
<p>You might see an info message like this:</p>
<pre><code>(info &quot;Arity too large 5 for a universe of size 131 line 10, pos 56:
r:posture [-&gt; none -&gt; none -&gt; none -&gt; none none :: {130 128 129 129 128}]
                                                       ^
&quot;)
</code></pre>
<p>This is a low-level translation error, and it comes from the fact that Pardinus needs to index all possible tuples in every relation. Even tuples that cannot exist because of typing constraints must have an index. But indexes can only go as high as Java's <code>Integer.MAX_VALUE</code>—just over 4 billion.</p>
<p>To see this happening, you can try running this small example. The problem can happen when you have &quot;wide&quot; fields like this. It's natural to want to model a router or firewall as a wide relation or function:</p>
<pre><code class="language-forge">#lang forge
option verbosity 2
sig Interface {}
sig IP {}
sig ForwardingTable {
  posture: set Interface -&gt; IP -&gt; IP -&gt; Interface
}
run {} for 1 Interface, 1 IP, 1 ForwardingTable, 7 Int
</code></pre>
<p>In principle, there is only <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> possible tuple that could inhabit <code>posture</code>, because there are never more than 1 of each of the non-integer types. This should be <em>easy</em> to solve! But Pardinus crashes with the above error. Why? Because at <code>7 Int</code>, there are <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">7</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">128</span></span></span></span> integer atoms, and thus <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">131</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">131</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">131</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">131</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">131</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">13</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"></span><span class="mord">38</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">579</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">489</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">651</span></span></span></span> tuples in the indexable space that Pardinus will try to optimize. But this is far above Java's <code>Integer.MAX_VALUE</code>. </p>
<p>Adding constraints or more typing information won't solve this problem. Not even a partial <code>inst</code> will help. There are effectively only two things you can do:</p>
<ul>
<li>reduce the number of potential atoms in any instance; or </li>
<li>reduce the arity of your model's relations.
Neither of these are ideal, but you can often make progress by reducing scopes on your <code>sig</code>s, especially <code>Int</code>. If you don't need <code>Int</code>, reduce the bitwidth to the minimum: <code>1 Int</code>. That may reduce the number of atoms enough. 
You can also try refactoring your model to make relations smaller. </li>
</ul>
<p>This is, unfortunately, a low-level issue that the Forge team can't easily fix. And it's a rare problem. But when it occurs, it can be a big problem. Hence this entry. </p>
<h3 id="errors-related-to-bounds"><a class="header" href="#errors-related-to-bounds">Errors Related to Bounds</a></h3>
<h4 id="please-specify-an-upper-bound-for-ancestors-of-"><a class="header" href="#please-specify-an-upper-bound-for-ancestors-of-">Please specify an upper bound for ancestors of ...</a></h4>
<p>If <code>A</code> is a <code>sig</code>, and you get an error that says &quot;Please specify an upper bound for ancestors of A&quot;, this means that, while you've defined the contents of <code>A</code>, Forge cannot infer corresponding contents for the parent <code>sig</code> of <code>A</code> and needs you to provide a binding. </p>
<div id="admonition-example" class="admonition admonish-example">
<div class="admonition-title">
<p>Example</p>
<p><a class="admonition-anchor-link" href="docs/glossary.html#admonition-example"></a></p>
</div>
<div>
<p>Given this definition:</p>
<pre><code>sig Course {}
sig Intro, Intermediate, UpperLevel extends Course {} 
</code></pre>
<p>and this example:</p>
<pre><code>example someIntro is {wellformed} for {
    Intro = `CSCI0150
}
</code></pre>
<p>the above error will be produced. Add a bound for <code>Course</code>:</p>
<pre><code>example someIntro is {wellformed} for {
    Intro = `CSCI0150
    Course = `CSCI0150
}
</code></pre>
</div>
</div>
<h3 id="errors-related-to-testing"><a class="header" href="#errors-related-to-testing">Errors Related to Testing</a></h3>
<h4 id="invalid-example--the-instance-specified-is-impossible-"><a class="header" href="#invalid-example--the-instance-specified-is-impossible-">Invalid example ... the instance specified is impossible ...</a></h4>
<p>If an <code>example</code> fails, Forge will attempt to disambiguate between:</p>
<ul>
<li>it actually fails the <em>predicate under test</em>; and </li>
<li>it fails because it violates the type declarations for sigs and fields. </li>
</ul>
<p>Consider this example: </p>
<pre><code class="language-forge">#lang forge/bsl 

abstract sig Grade {} 
one sig A, B, C, None extends Grade {} 
sig Course {} 
sig Person { 
    grades: func Course -&gt; Grade,
    spouse: lone Person 
}

pred wellformed { 
    all p: Person | p != p.spouse 
    all p1,p2: Person | p1 = p2.spouse implies p2 = p1.spouse
}

example selfloopNotWellformed is {wellformed} for {
    Person = `Tim + `Nim 
    Course = `CSCI1710 + `CSCI0320
    A = `A   B = `B   C = `C   None = `None 
    Grade = A + B + C + None

    -- this violates wellformed
    `Tim.spouse = `Tim 
    
    -- but this violates the definition: &quot;grades&quot; is a total function
    -- from courses to grades; there's no entry for `CSCI0320.
    `Tim.grades = (`CSCI1710) -&gt; B
</code></pre>
<p>If you receive this message, it means your example does something like the above, where some type declaration unrelated to the predicate under test is being violated.</p>
<h3 id="errors-related-to-syntax"><a class="header" href="#errors-related-to-syntax">Errors related to syntax</a></h3>
<h4 id="unexpected-type-or-contract-violation"><a class="header" href="#unexpected-type-or-contract-violation">Unexpected type or Contract Violation</a></h4>
<p>In Forge there are 2 kinds of constraint syntax for use in predicates:</p>
<ul>
<li>formulas, which evaluate to true or false; and </li>
<li>expressions, which evaluate to values like specific atoms. </li>
</ul>
<p>If you write something like this:</p>
<div id="admonition-contract-violation" class="admonition admonish-example">
<div class="admonition-title">
<p>Contract Violation</p>
<p><a class="admonition-anchor-link" href="docs/glossary.html#admonition-contract-violation"></a></p>
</div>
<div>
<pre><code>#lang forge/bsl 
sig Person {spouse: lone Person}
run { some p: Person | p.spouse}
</code></pre>
<p>produces (along with a filename, row, and column location):</p>
<pre><code>some quantifier body expected a formula, got (join p (Relation spouse))
</code></pre>
<p>In older versions of Forge, it would produce:</p>
<pre><code>some: contract violation
  expected: formula?
  given: (join p (Relation spouse))
</code></pre>
</div>
</div>
<p>The syntax is invalid: the <code>some</code> quantifier expects a <em>formula</em> after its such-that bar, but <code>p.spouse</code> is an expression. Something like <code>some p.spouse</code> is OK. </p>
<p>Likewise:</p>
<div id="admonition-unexpected-type" class="admonition admonish-example">
<div class="admonition-title">
<p>Unexpected Type</p>
<p><a class="admonition-anchor-link" href="docs/glossary.html#admonition-unexpected-type"></a></p>
</div>
<div>
<pre><code>sig Person {spouse: lone Person}
run { all p1,p2: Person | p1.spouse = p2.spouse implies p2.spouse}
</code></pre>
<p>results in (along with a filename, row, and column location):</p>
<pre><code>argument 2 of 2 to =&gt; had unexpected type. Expected boolean-valued formula, got (p2.spouse), which was atom- or set-valued expression.
</code></pre>
<p>Older versions of Forge would produce something like:</p>
<pre><code>=&gt;: argument to =&gt; had unexpected type. 
  expected #&lt;procedure:node/formula?&gt;,
  got (join p2 (Relation spouse))
</code></pre>
</div>
</div>
<p>Since <code>implies</code> is a boolean operator, it takes a <em>formula</em> as its argument. Unfortunately, <code>p2.spouse</code> is an expression, not a formula. To fix this, express what you really meant was <em>implied</em>. </p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>

        <script src="ace.js"></script>
        <script src="editor.js"></script>
        <script src="mode-rust.js"></script>
        <script src="theme-dawn.js"></script>
        <script src="theme-tomorrow_night.js"></script>

        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
